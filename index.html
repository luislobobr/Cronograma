<!DOCTYPE html>
<html lang="pt-BR" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Projetos - Vinci Highways</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --background-color: #f3f4f6; --text-color: #374151; --card-bg: #ffffff; --card-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); --border-color: #e5e7eb; }
        html.dark { --background-color: #111827; --text-color: #d1d5db; --card-bg: #1f2937; --card-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.2), 0 2px 4px -2px rgb(0 0 0 / 0.2); --border-color: #374151; }
        body { 
            background-color: var(--background-color); 
            color: var(--text-color); 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-feature-settings: 'kern' 1, 'liga' 1;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background-color 0.3s ease, color 0.3s ease; 
        }
        @import url('https://rsms.me/inter/inter.css');
        .gantt-chart-container { display: grid; grid-template-columns: 250px 1fr; overflow-x: auto; position: relative; }
        .gantt-task-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .gantt-bar { position: absolute; height: 24px; border-radius: 4px; color: white; font-size: 12px; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer; z-index: 10; }
        .gantt-bar-parent { height: 12px; top: 8px; }
        #gantt-dependency-lines { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; overflow: visible; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; z-index: 9999; backdrop-filter: blur(4px); transition: opacity 0.3s ease; }
        html.dark #loader { background-color: rgba(17, 24, 39, 0.8); }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-transition { transition: opacity 0.3s ease, transform 0.3s ease; }
        .modal-hidden { opacity: 0; transform: scale(0.95); pointer-events: none; }
        .modal-visible { opacity: 1; transform: scale(1); }
        #toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 100; display: flex; flex-direction: column; gap: 0.75rem; }
        .toast { display: flex; align-items: center; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); transform: translateX(120%); opacity: 0; transition: all 0.4s cubic-bezier(0.21, 1.02, 0.73, 1); }
        .toast.show { transform: translateX(0); opacity: 1; }
        @media print { 
            .no-print { display: none !important; } 
            body { background-color: #ffffff !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; } 
            .container, #dashboard-view, main#content-area, .bg-white { padding: 0 !important; margin: 0 !important; max-width: 100% !important; box-shadow: none !important; border: none !important; } 
            .gantt-timeline-container, .overflow-x-auto { overflow: visible !important; } 
            .gantt-bar { color: #000 !important; font-weight: bold; }
            .bg-blue-500 { background-color: #3b82f6 !important; }
            .bg-green-500 { background-color: #10b981 !important; }
            .bg-red-500 { background-color: #ef4444 !important; }
            .bg-gray-500 { background-color: #6b7280 !important; }
        }
        .modal-z-50 { z-index: 50; }
        .modal-z-60 { z-index: 60; }
        .comment-item { position: relative; }
        .comment-actions { position: absolute; right: 0; top: 0; display: none; }
        .comment-item:hover .comment-actions { display: flex; }
        .edit-comment-input { width: 100%; border: 1px solid #d1d5db; border-radius: 4px; padding: 4px 8px; }
        .import-error-row { background-color: #fef2f2 !important; }
        .import-valid-row { background-color: #f0fdf4 !important; }
        .chart-tooltip { position: absolute; background: rgba(0, 0, 0, 0.8); color: white; padding: 8px 12px; border-radius: 4px; font-size: 12px; pointer-events: none; z-index: 1000; max-width: 300px; }
        .assigned-users-container { max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; padding: 8px; }
        .user-checkbox-item { display: flex; align-items: center; padding: 4px 0; }
        .user-checkbox-item input { margin-right: 8px; }
        .draggable-subtask { cursor: grab; transition: all 0.2s ease; position: relative; }
        .draggable-subtask:active { cursor: grabbing; }
        .draggable-subtask.dragging { opacity: 0.6; background-color: #f0f9ff !important; transform: scale(1.02); z-index: 1000; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
        .draggable-subtask.drag-over { background-color: #e0f2fe !important; border-top: 2px solid #0ea5e9 !important; }
        .drag-handle { cursor: grab; color: #6b7280; font-size: 12px; margin-right: 8px; user-select: none; padding: 4px 6px; border-radius: 4px; transition: all 0.2s ease; }
        .drag-handle:active { cursor: grabbing; }
        .drag-handle:hover { background-color: #e5e7eb; color: #374151; }
        html.dark .drag-handle:hover { background-color: #4b5563; color: #f3f4f6; }
        tr.dragging { opacity: 0.6; background-color: #f3f4f6 !important; }
        tr.drag-over { background-color: #dbeafe !important; border-top: 2px solid #3b82f6 !important; }
        .subtask-row { background-color: #f9fafb; }
        html.dark .subtask-row { background-color: #374151; }
        html.dark .draggable-subtask.drag-over { background-color: #1e3a8a !important; }
        html.dark .draggable-subtask.dragging { background-color: #1e40af !important; }
        .drag-indicator { width: 16px; height: 16px; display: inline-flex; align-items: center; justify-content: center; margin-right: 8px; }
        .project-date-editable { cursor: pointer; transition: all 0.2s ease; }
        .project-date-editable:hover { background-color: #f0f9ff; border-radius: 4px; padding: 2px 4px; }
        .project-date-locked { color: #6b7280; cursor: not-allowed; }
        .project-overdue { background-color: #fef2f2 !important; border-left: 4px solid #ef4444 !important; }
        html.dark .project-overdue { background-color: #7f1d1d !important; }
        
        /* MELHORIA: Tipografia melhorada para grﾃ｡ficos */
        .dashboard-chart-text {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 600;
        }
        
        .chart-center-text {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 700;
            font-size: 20px;
        }
        
        .chart-label-text {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 500;
            font-size: 12px;
        }

        /* NOVO: Estilos para tarefas em execuﾃｧﾃ｣o hoje */
        .today-running-task {
            background-color: rgba(34, 197, 94, 0.1) !important;
            border-left: 4px solid #10b981 !important;
            animation: pulse-highlight 2s infinite;
        }
        
        html.dark .today-running-task {
            background-color: rgba(34, 197, 94, 0.2) !important;
            border-left: 4px solid #34d399 !important;
        }
        
        @keyframes pulse-highlight {
            0%, 100% {
                background-color: rgba(34, 197, 94, 0.1);
            }
            50% {
                background-color: rgba(34, 197, 94, 0.2);
            }
        }
        
        html.dark @keyframes pulse-highlight {
            0%, 100% {
                background-color: rgba(34, 197, 94, 0.2);
            }
            50% {
                background-color: rgba(34, 197, 94, 0.3);
            }
        }
        
        .today-running-task:hover {
            background-color: rgba(34, 197, 94, 0.3) !important;
        }
        
        html.dark .today-running-task:hover {
            background-color: rgba(34, 197, 94, 0.4) !important;
        }

        /* NOVO: Estilo para a logo */
        .logo-header {
            height: 40px;
            margin-bottom: 1rem;
        }
        
        .logo-container {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
            padding-top: 1rem;
        }

        /* NOVO: Estilo para informaﾃｧﾃｵes de tarefas no card */
        .task-info-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 4px;
        }
        
        .today-task-badge {
            background-color: #10b981;
            color: white;
        }
        
        .overdue-task-badge {
            background-color: #ef4444;
            color: white;
        }
        
        .task-info-container {
            margin-top: 8px;
            font-size: 0.8rem;
        }

        /* MELHORIA: Estilos para o modal de tarefa melhorado */
        @media (max-width: 768px) {
            #task-modal .max-w-4xl {
                margin: 1rem;
                max-height: calc(100vh - 2rem);
            }
            
            #task-modal .grid-cols-1 {
                grid-template-columns: 1fr;
            }
            
            #task-modal .md\:grid-cols-2 > * {
                grid-column: span 1;
            }
            
            #task-modal .md\:col-span-2 {
                grid-column: span 1;
            }
        }

        /* Melhorias visuais para os campos */
        #task-modal input, 
        #task-modal select, 
        #task-modal textarea {
            transition: all 0.2s ease;
        }

        #task-modal input:focus, 
        #task-modal select:focus, 
        #task-modal textarea:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        /* Estilo para o range de progresso */
        #task-progress-range {
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            background: #e5e7eb;
            outline: none;
        }

        #task-progress-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
        }

        #task-progress-range::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: none;
        }

        /* Estilo para seﾃｧﾃｵes do formulﾃ｡rio */
        #task-modal .bg-gray-50 {
            transition: all 0.2s ease;
        }

        #task-modal .bg-gray-50:hover {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* NOVO: Estilos para o sistema de notificaﾃｧﾃｵes */
        .notification-bell {
            position: relative;
            cursor: pointer;
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .notification-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            width: 400px;
            max-height: 500px;
            overflow-y: auto;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 100;
            display: none;
        }
        
        .notification-dropdown.show {
            display: block;
        }
        
        .notification-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .notification-item:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }
        
        .notification-item.unread {
            background-color: rgba(59, 130, 246, 0.05);
            font-weight: 500;
        }
        
        .notification-item.read {
            opacity: 0.7;
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .notification-message {
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.8;
        }
        
        .notification-time {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }
        
        .notification-actions {
            display: flex;
            justify-content: space-between;
            padding: 12px 16px;
            border-top: 1px solid var(--border-color);
        }
        
        .notification-empty {
            padding: 24px;
            text-align: center;
            color: #6b7280;
        }
        
        .notification-icon {
            width: 16px;
            height: 16px;
        }
        
        .notification-project {
            font-size: 12px;
            background-color: #e5e7eb;
            color: #374151;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
        }
        
        html.dark .notification-project {
            background-color: #4b5563;
            color: #d1d5db;
        }

        /* NOVO: Estilos para anexos */
        .attachments-container {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 8px;
        }
        
        .attachment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s ease;
        }
        
        .attachment-item:last-child {
            border-bottom: none;
        }
        
        .attachment-item:hover {
            background-color: rgba(59, 130, 246, 0.05);
        }
        
        .attachment-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0;
        }
        
        .attachment-icon {
            flex-shrink: 0;
            width: 16px;
            height: 16px;
        }
        
        .attachment-name {
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }
        
        .attachment-actions {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }
        
        .attachment-btn {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        
        .attachment-download {
            background-color: #3b82f6;
            color: white;
        }
        
        .attachment-download:hover {
            background-color: #2563eb;
        }
        
        .attachment-delete {
            background-color: #ef4444;
            color: white;
        }
        
        .attachment-delete:hover {
            background-color: #dc2626;
        }
        
        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 12px;
        }
        
        .upload-area:hover {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.05);
        }
        
        .upload-area.dragover {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.1);
        }
        
        .upload-icon {
            font-size: 24px;
            margin-bottom: 8px;
            color: #6b7280;
        }
        
        .upload-text {
            font-size: 14px;
            color: #6b7280;
        }
        
        .upload-input {
            display: none;
        }

        /* NOVO: Estilos para menﾃｧﾃｵes */
        .mention-suggestions {
            position: absolute;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .mention-suggestion {
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .mention-suggestion:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }
        
        .mention-suggestion.active {
            background-color: rgba(59, 130, 246, 0.2);
        }
        
        .mention-highlight {
            background-color: #fef3c7;
            color: #92400e;
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: 500;
        }
        
        html.dark .mention-highlight {
            background-color: #78350f;
            color: #fef3c7;
        }

        /* NOVO: Estilos para abas de atividade */
        .tab-container {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 16px;
        }
        
        .tab {
            padding: 8px 16px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }
        
        .tab.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 500;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .activity-item {
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-time {
            font-size: 12px;
            color: #6b7280;
            margin-top: 2px;
        }
    </style>
</head>
<body class="antialiased">
    <div id="loader" class="no-print"><div class="spinner"></div></div>
    
    <div id="toast-container" class="no-print"></div>

    <!-- Modal de Autenticaﾃｧﾃ｣o -->
    <div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50 modal-transition modal-visible">
        <div class="bg-[var(--card-bg)] rounded-xl shadow-2xl p-8 w-full max-w-md">
            <!-- NOVO: Logo no modal de autenticaﾃｧﾃ｣o -->
            <div class="logo-container">
                <img src="https://viacristais.com.br/wp-content/themes/viacristais/resources/images/logo-topo.png" alt="Vinci Highways" class="logo-header">
            </div>
            <h2 class="text-3xl font-bold mb-2 text-blue-600 text-center">Vinci Highways Projects</h2>
            <p class="text-gray-400 mb-6 text-center">Acesso restrito ao domﾃｭnio @vinci-highways.com.br</p>

            <form id="auth-form" class="space-y-4">
                <input type="email" id="auth-email" placeholder="E-mail (@vinci-highways.com.br)" class="mt-1 block w-full border border-[var(--border-color)] rounded-md shadow-sm p-3 bg-transparent" required>
                <input type="password" id="auth-password" placeholder="Senha" class="mt-1 block w-full border border-[var(--border-color)] rounded-md shadow-sm p-3 bg-transparent" required>
                
                <div id="secret-code-container" class="hidden">
                    <input type="text" id="auth-secret-code" placeholder="Cﾃｳdigo de Acesso (Apenas Gestor)" class="mt-1 block w-full border border-yellow-400 rounded-md shadow-sm p-3 bg-transparent">
                    <p class="text-xs text-yellow-500 mt-1">Use "MASTER_GESTOR" no registro para obter o papel de Gestor.</p>
                </div>

                <div class="flex justify-between items-center">
                    <button type="button" id="toggle-auth-mode" class="text-sm text-blue-500 hover:underline transition-colors">Precisa de uma conta? Registrar</button>
                    <button type="button" id="toggle-secret-code" class="text-xs text-gray-500 hover:underline transition-colors">Cﾃｳdigo Secreto?</button>
                </div>

                <div class="flex justify-end gap-2">
                    <button type="submit" id="auth-submit-btn" class="w-full bg-blue-600 text-white px-4 py-3 rounded-md font-semibold hover:bg-blue-700 transition-colors">Login</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Cadastro de Usuﾃ｡rio -->
    <div id="add-user-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center no-print modal-transition modal-hidden modal-z-60">
        <div class="bg-[var(--card-bg)] rounded-lg shadow-xl p-6 w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4 text-[var(--text-color)]">Cadastrar Novo Usuﾃ｡rio</h2>
            <form id="add-user-form">
                <div class="mb-4">
                    <label for="new-user-name" class="block text-sm font-medium text-gray-400">Nome Completo</label>
                    <input type="text" id="new-user-name" class="mt-1 block w-full border border-[var(--border-color)] rounded-md shadow-sm p-2 bg-transparent">
                    <p class="text-xs text-gray-500 mt-1">Opcional - serﾃ｡ preenchido automaticamente com o nome do e-mail</p>
                </div>
                <div class="mb-4">
                    <label for="new-user-email" class="block text-sm font-medium text-gray-400">E-mail</label>
                    <input type="email" id="new-user-email" class="mt-1 block w-full border border-[var(--border-color)] rounded-md shadow-sm p-2 bg-transparent" required>
                    <p class="text-xs text-gray-500 mt-1">Deve terminar com @vinci-highways.com.br</p>
                </div>
                <div class="mb-4">
                    <label for="new-user-role" class="block text-sm font-medium text-gray-400">Papel</label>
                    <select id="new-user-role" class="mt-1 block w-full border border-[var(--border-color)] bg-[var(--card-bg)] rounded-md shadow-sm p-2">
                        <option value="Usuario">Usuﾃ｡rio</option>
                        <option value="Gestor">Gestor</option>
                    </select>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" class="cancel-btn bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Cadastrar Usuﾃ｡rio</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Gestﾃ｣o de Usuﾃ｡rios -->
    <div id="user-management-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center no-print modal-transition modal-hidden modal-z-50">
        <div class="bg-[var(--card-bg)] rounded-lg shadow-xl p-6 w-full max-w-6xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-[var(--text-color)]">Gestﾃ｣o de Utilizadores e Papﾃｩis</h2>
                <button id="add-user-btn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    Cadastrar Usuﾃ｡rio
                </button>
            </div>
            <div id="user-list-container" class="overflow-y-auto max-h-96">
                <table class="w-full text-sm text-left text-gray-400">
                    <thead class="text-xs uppercase bg-gray-700 text-gray-400 sticky top-0">
                        <tr>
                            <th class="p-3">Nome</th>
                            <th class="p-3">E-mail</th>
                            <th class="p-3">Papel Atual</th>
                            <th class="p-3">Status</th>
                            <th class="p-3 text-center">Aﾃｧﾃｵes</th>
                        </tr>
                    </thead>
                    <tbody id="user-management-table-body">
                    </tbody>
                </table>
            </div>
            <div class="flex justify-end mt-4">
                <button type="button" class="cancel-btn bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Ajustes de Importaﾃｧﾃ｣o -->
    <div id="import-adjustment-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 no-print modal-transition modal-hidden">
        <div class="bg-[var(--card-bg)] rounded-lg shadow-xl p-6 w-full max-w-6xl max-h-[90vh] overflow-hidden">
            <h2 class="text-2xl font-bold mb-4 text-[var(--text-color)]">Ajustar Tarefas Importadas</h2>
            
            <div class="mb-4 p-4 bg-yellow-100 dark:bg-yellow-900 rounded-lg">
                <h3 class="font-bold text-yellow-800 dark:text-yellow-200 mb-2">Problemas Encontrados:</h3>
                <div id="import-errors-list" class="text-sm text-yellow-700 dark:text-yellow-300"></div>
            </div>
            
            <div class="overflow-y-auto max-h-96 mb-4">
                <table class="w-full text-sm text-left text-gray-400">
                    <thead class="text-xs uppercase bg-gray-700 text-gray-400 sticky top-0">
                        <tr>
                            <th class="p-2">Linha</th>
                            <th class="p-2">Tarefa</th>
                            <th class="p-2">Data Inﾃｭcio</th>
                            <th class="p-2">Data Tﾃｩrmino</th>
                            <th class="p-2">Status</th>
                            <th class="p-2">Responsﾃ｡veis</th>
                            <th class="p-2">Tarefa Pai</th>
                            <th class="p-2">Problemas</th>
                            <th class="p-2 text-center">Aﾃｧﾃｵes</th>
                        </tr>
                    </thead>
                    <tbody id="import-adjustment-table-body">
                    </tbody>
                </table>
            </div>
            
            <div class="flex justify-between items-center">
                <div class="text-sm text-gray-400">
                    <span id="import-valid-count">0</span> tarefas vﾃ｡lidas de 
                    <span id="import-total-count">0</span> total
                </div>
                <div class="flex gap-2">
                    <button id="cancel-import-btn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">
                        Cancelar
                    </button>
                    <button id="confirm-import-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        Importar Tarefas Vﾃ｡lidas (<span id="confirm-count">0</span>)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Projeto -->
    <div id="project-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 no-print modal-transition modal-hidden">
        <div class="bg-[var(--card-bg)] rounded-lg shadow-xl p-6 w-full max-w-md">
            <h2 id="project-modal-title" class="text-2xl font-bold mb-4 text-[var(--text-color)]">Novo Projeto</h2>
            <form id="project-form">
                <div class="mb-4">
                    <label for="project-name" class="block text-sm font-medium text-gray-400">Nome do Projeto</label>
                    <input type="text" id="project-name" class="mt-1 block w-full border border-[var(--border-color)] rounded-md shadow-sm p-2 bg-transparent" required>
                </div>
                <div class="mb-4">
                    <label for="project-manager" class="block text-sm font-medium text-gray-400">Responsﾃ｡vel</label>
                    <select id="project-manager" class="mt-1 block w-full border border-[var(--border-color)] rounded-md shadow-sm p-2 bg-transparent" required>
                        <option value="">Selecione um responsﾃ｡vel</option>
                    </select>
                </div>
                <!-- NOVO: Campos de data de inﾃｭcio e tﾃｩrmino do projeto -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="project-start-date" class="block text-sm font-medium text-gray-400">Data de Inﾃｭcio</label>
                        <input type="date" id="project-start-date" class="mt-1 block w-full border border-[var(--border-color)] bg-transparent rounded-md shadow-sm p-2" required>
                    </div>
                    <div>
                        <label for="project-end-date" class="block text-sm font-medium text-gray-400">Data de Tﾃｩrmino</label>
                        <input type="date" id="project-end-date" class="mt-1 block w-full border border-[var(--border-color)] bg-transparent rounded-md shadow-sm p-2" required>
                    </div>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" class="cancel-btn bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Salvar Projeto</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Ediﾃｧﾃ｣o de Data do Projeto -->
    <div id="project-date-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 no-print modal-transition modal-hidden">
        <div class="bg-[var(--card-bg)] rounded-lg shadow-xl p-6 w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4 text-[var(--text-color)]">Editar Datas do Projeto</h2>
            <form id="project-date-form">
                <input type="hidden" id="edit-project-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="edit-project-start-date" class="block text-sm font-medium text-gray-400">Data de Inﾃｭcio</label>
                        <input type="date" id="edit-project-start-date" class="mt-1 block w-full border border-[var(--border-color)] bg-transparent rounded-md shadow-sm p-2" required>
                    </div>
                    <div>
                        <label for="edit-project-end-date" class="block text-sm font-medium text-gray-400">Data de Tﾃｩrmino</label>
                        <input type="date" id="edit-project-end-date" class="mt-1 block w-full border border-[var(--border-color)] bg-transparent rounded-md shadow-sm p-2" required>
                    </div>
                </div>
                <div class="mb-4 p-3 bg-blue-50 dark:bg-blue-900 rounded-md">
                    <p class="text-sm text-blue-700 dark:text-blue-300">
                        <strong>Atenﾃｧﾃ｣o:</strong> Alterar as datas do projeto pode afetar todas as tarefas vinculadas.
                    </p>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" class="cancel-btn bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Salvar Alteraﾃｧﾃｵes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Tarefa - VERSﾃグ MELHORADA COM ANEXOS E ATIVIDADE -->
    <div id="task-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 no-print modal-transition modal-hidden">
        <div class="bg-[var(--card-bg)] rounded-lg shadow-xl p-6 w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
            <h2 id="modal-title" class="text-2xl font-bold mb-6 text-[var(--text-color)]">Adicionar Nova Tarefa</h2>
            
            <form id="task-form" class="space-y-6">
                <input type="hidden" id="task-id">
                <input type="hidden" id="parent-id">
                
                <!-- SEﾃﾃグ 1: Informaﾃｧﾃｵes Bﾃ｡sicas -->
                <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-4 text-[var(--text-color)] border-b pb-2">Informaﾃｧﾃｵes Bﾃ｡sicas</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Nome da Tarefa -->
                        <div class="md:col-span-2">
                            <label for="task-name" class="block text-sm font-medium text-gray-400 mb-1">Nome da Tarefa *</label>
                            <input type="text" id="task-name" class="w-full border border-[var(--border-color)] bg-transparent rounded-md shadow-sm p-3" required placeholder="Digite o nome da tarefa">
                        </div>
                        
                        <!-- Prioridade e Status -->
                        <div>
                            <label for="task-priority" class="block text-sm font-medium text-gray-400 mb-1">Prioridade</label>
                            <select id="task-priority" class="w-full border border-[var(--border-color)] bg-[var(--card-bg)] rounded-md shadow-sm p-3">
                                <option value="Baixa">Baixa</option>
                                <option value="Mﾃｩdia">Mﾃｩdia</option>
                                <option value="Alta">Alta</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="task-status" class="block text-sm font-medium text-gray-400 mb-1">Status</label>
                            <select id="task-status" class="w-full border border-[var(--border-color)] bg-[var(--card-bg)] rounded-md shadow-sm p-3">
                                <option value="Nﾃ｣o Iniciada">Nﾃ｣o Iniciada</option>
                                <option value="Em Andamento">Em Andamento</option>
                                <option value="Concluﾃｭda">Concluﾃｭda</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- SEﾃﾃグ 2: Datas e Prazos -->
                <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-4 text-[var(--text-color)] border-b pb-2">Datas e Prazos</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="start-date" class="block text-sm font-medium text-gray-400 mb-1">Data de Inﾃｭcio *</label>
                            <input type="date" id="start-date" class="w-full border border-[var(--border-color)] bg-transparent rounded-md shadow-sm p-3" required>
                        </div>
                        
                        <div>
                            <label for="end-date" class="block text-sm font-medium text-gray-400 mb-1">Data de Tﾃｩrmino *</label>
                            <input type="date" id="end-date" class="w-full border border-[var(--border-color)] bg-transparent rounded-md shadow-sm p-3" required>
                        </div>
                    </div>
                    
                    <div id="reschedule-button-container" class="mt-2 hidden">
                        <button type="button" id="reschedule-btn" class="text-sm text-blue-500 hover:underline flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                            </svg>
                            Reprogramar Datas
                        </button>
                    </div>
                    
                    <div id="date-history-container" class="mt-4 hidden">
                        <h4 class="text-sm font-medium text-gray-400 mb-2">Histﾃｳrico de Prazos</h4>
                        <div id="date-history-list" class="text-xs text-gray-500 max-h-20 overflow-y-auto bg-gray-100 dark:bg-gray-800 p-2 rounded"></div>
                    </div>
                </div>
                
                <!-- SEﾃﾃグ 3: Atribuiﾃｧﾃ｣o e Dependﾃｪncias -->
                <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-4 text-[var(--text-color)] border-b pb-2">Atribuiﾃｧﾃ｣o e Dependﾃｪncias</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Responsﾃ｡veis -->
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Atribuﾃｭdo a (Utilizadores)</label>
                            <div id="assigned-users-container" class="assigned-users-container border border-[var(--border-color)] rounded-md p-3 bg-[var(--card-bg)] max-h-40 overflow-y-auto">
                                <!-- Checkboxes serﾃ｣o inseridos aqui dinamicamente -->
                            </div>
                        </div>
                        
                        <!-- Dependﾃｪncias e Risco -->
                        <div class="space-y-4">
                            <div>
                                <label for="task-dependency" class="block text-sm font-medium text-gray-400 mb-1">Depende de</label>
                                <select id="task-dependency" class="w-full border border-[var(--border-color)] bg-[var(--card-bg)] rounded-md shadow-sm p-3">
                                    <option value="">Nenhuma</option>
                                </select>
                            </div>
                            
                            <div class="flex items-center">
                                <input type="checkbox" id="task-risk" class="h-5 w-5 text-red-600 border-gray-300 rounded focus:ring-red-500">
                                <label for="task-risk" class="ml-2 text-sm font-medium text-gray-400">Marcar como Tarefa em Risco</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- SEﾃﾃグ 4: Progresso e Comentﾃ｡rios/Atividade -->
                <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-4 text-[var(--text-color)] border-b pb-2">Progresso e Comunicaﾃｧﾃ｣o</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Progresso -->
                        <div>
                            <label for="task-progress" class="block text-sm font-medium text-gray-400 mb-1">Progresso (%)</label>
                            <div class="flex items-center space-x-3">
                                <input type="range" id="task-progress-range" min="0" max="100" class="flex-1" value="0">
                                <input type="number" id="task-progress" min="0" max="100" class="w-20 border border-[var(--border-color)] bg-transparent rounded-md shadow-sm p-2 text-center" value="0" required>
                                <span class="text-gray-400">%</span>
                            </div>
                            <p id="progress-info" class="text-xs text-gray-500 mt-1 hidden">O progresso de tarefas-pai ﾃｩ calculado automaticamente.</p>
                        </div>
                        
                        <!-- Abas de Comentﾃ｡rios e Atividade -->
                        <div>
                            <div class="tab-container">
                                <div class="tab active" data-tab="comments">Comentﾃ｡rios</div>
                                <div class="tab" data-tab="activity">Atividade</div>
                            </div>
                            
                            <!-- Conteﾃｺdo das Abas -->
                            <div class="tab-content active" id="comments-tab">
                                <div id="comments-list" class="text-sm text-gray-500 max-h-40 overflow-y-auto bg-gray-100 dark:bg-gray-800 p-3 rounded shadow-inner mb-3"></div>
                                
                                <div class="flex gap-2 relative">
                                    <input type="text" id="new-comment-input" class="flex-grow border border-[var(--border-color)] bg-transparent rounded-md shadow-sm p-2" placeholder="Adicionar comentﾃ｡rio...">
                                    <button type="button" id="add-comment-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                    <!-- Sugestﾃｵes de Menﾃｧﾃｵes -->
                                    <div id="mention-suggestions" class="mention-suggestions"></div>
                                </div>
                            </div>
                            
                            <div class="tab-content" id="activity-tab">
                                <div id="activity-list" class="text-sm text-gray-500 max-h-40 overflow-y-auto bg-gray-100 dark:bg-gray-800 p-3 rounded shadow-inner">
                                    <!-- Histﾃｳrico de atividade serﾃ｡ inserido aqui -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- NOVA SEﾃﾃグ: Anexos -->
                <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-4 text-[var(--text-color)] border-b pb-2">Anexos</h3>
                    
                    <div class="upload-area" id="upload-area">
                        <div class="upload-icon">梼</div>
                        <div class="upload-text">Arraste arquivos aqui ou clique para fazer upload</div>
                        <input type="file" id="file-upload" class="upload-input" multiple>
                    </div>
                    
                    <div id="attachments-container" class="attachments-container">
                        <!-- Lista de anexos serﾃ｡ inserida aqui -->
                    </div>
                </div>
                
                <!-- Botﾃｵes de Aﾃｧﾃ｣o -->
                <div class="flex justify-end gap-3 pt-4 border-t border-[var(--border-color)]">
                    <button type="button" class="cancel-btn bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 px-6 py-3 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors font-medium">
                        Cancelar
                    </button>
                    <button type="submit" class="bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 transition-colors font-medium flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        Salvar Tarefa
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Confirmaﾃｧﾃ｣o -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 no-print modal-transition modal-hidden">
        <div class="bg-[var(--card-bg)] rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h2 id="confirm-modal-title" class="text-xl font-bold mb-4 text-[var(--text-color)]">Confirmar Aﾃｧﾃ｣o</h2>
            <p id="confirm-modal-body" class="mb-6 text-gray-400">Vocﾃｪ tem certeza?</p>
            <div class="flex justify-end gap-2">
                <button id="confirm-cancel-btn" class="bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500">Cancelar</button>
                <button id="confirm-ok-btn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmaﾃｧﾃ｣o de Data de Subtarefa -->
    <div id="subtask-date-confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 no-print modal-transition modal-hidden">
        <div class="bg-[var(--card-bg)] rounded-lg shadow-xl p-6 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4 text-[var(--text-color)]">Ajustar Data da Tarefa Pai</h2>
            <p id="subtask-date-confirm-body" class="mb-6 text-gray-400">
                A data de inﾃｭcio da subtarefa ﾃｩ anterior ﾃ data da tarefa pai. 
                Deseja alterar a data da tarefa pai?
            </p>
            <div class="flex justify-between items-center mb-4">
                <label class="flex items-center">
                    <input type="checkbox" id="update-parent-dates" class="h-4 w-4 text-blue-600 border-gray-300 rounded" checked>
                    <span class="ml-2 text-sm font-medium">Atualizar datas da tarefa pai</span>
                </label>
            </div>
            <div class="flex justify-end gap-2">
                <button id="subtask-date-cancel-btn" class="bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500">Cancelar</button>
                <button id="subtask-date-confirm-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Conteﾃｺdo Principal -->
    <div class="relative min-h-screen">
        <input type="file" id="import-excel-input" class="hidden" accept=".xlsx, .xls">
        <div id="logged-in-container" class="hidden">
            <!-- NOVO: Botﾃ｣o de notificaﾃｧﾃｵes -->
            <div class="notification-bell no-print fixed top-4 right-40 z-50">
                <button id="notification-btn" class="p-2 rounded-full bg-blue-500 text-white hover:bg-blue-600 transition-colors relative">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
                    </svg>
                    <div id="notification-badge" class="notification-badge hidden">0</div>
                </button>
                <div id="notification-dropdown" class="notification-dropdown">
                    <div class="notification-header p-4 border-b border-[var(--border-color)]">
                        <h3 class="font-bold text-lg">Notificaﾃｧﾃｵes</h3>
                    </div>
                    <div id="notification-list" class="max-h-80 overflow-y-auto">
                        <!-- Notificaﾃｧﾃｵes serﾃ｣o inseridas aqui -->
                    </div>
                    <div class="notification-actions">
                        <button id="mark-all-read-btn" class="text-sm text-blue-500 hover:underline">Marcar todas como lidas</button>
                        <button id="clear-notifications-btn" class="text-sm text-gray-500 hover:underline">Limpar</button>
                    </div>
                </div>
            </div>
            
            <button id="theme-toggle" class="no-print fixed top-4 right-4 z-50 p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                <svg id="theme-icon-sun" class="h-6 w-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <svg id="theme-icon-moon" class="h-6 w-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
            <button id="user-management-btn" class="no-print fixed top-4 right-16 z-50 p-2 rounded-full bg-yellow-500 text-white hover:bg-yellow-600 transition-colors hidden" title="Gerir Utilizadores">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.38 0 2.5 1.12 2.5 2.5S13.38 10 12 10 9.5 8.88 9.5 7.5 10.62 5 12 5zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.8 6-3.8s5.97 1.81 6 3.8c-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
            </button>
            <button id="logout-btn" class="no-print fixed top-4 right-28 z-50 p-2 rounded-full bg-red-500 text-white hover:bg-red-600 transition-colors" title="Logout">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5-5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
            </button>
        </div>
        
        <!-- Vista de Projetos -->
        <div id="project-view" class="container mx-auto p-4 md:p-8 hidden">
            <!-- NOVO: Logo na pﾃ｡gina principal -->
            <div class="logo-container">
                <img src="https://viacristais.com.br/wp-content/themes/viacristais/resources/images/logo-topo.png" alt="Vinci Highways" class="logo-header">
            </div>
            
            <header class="mb-8">
                <h1 class="text-4xl font-bold">Cronogramas</h1>
                <p class="text-gray-400">Selecione um projeto para gerenciar ou crie um novo.</p>
                <p id="user-role-display" class="text-sm font-semibold mt-2 px-3 py-1 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded-full inline-block">Papel: Carregando...</p>
            </header>
            
            <!-- Dashboard Grﾃ｡fico -->
            <div id="main-dashboard" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Os grﾃ｡ficos serﾃ｣o inseridos aqui dinamicamente -->
            </div>
            
            <div class="flex justify-between items-center mb-6">
                <button id="add-project-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    Novo Projeto
                </button>
                
                <!-- Botﾃｵes de visualizaﾃｧﾃ｣o posicionados no canto direito -->
                <div class="flex items-center gap-3" id="project-view-mode-controls">
                    <button id="view-cards-btn" class="px-4 py-2 rounded-md bg-blue-600 text-white flex items-center gap-2 hover:bg-blue-700">
                        <span>筏</span> Cards
                    </button>
                    <button id="view-list-btn" class="px-4 py-2 rounded-md bg-gray-300 text-gray-800 flex items-center gap-2 hover:bg-gray-400">
                        <span>搭</span> Lista
                    </button>
                </div>
            </div>
            
            <!-- Vista Cards (padrﾃ｣o) -->
            <div id="project-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            
            <!-- Vista Lista (oculta inicialmente) -->
            <div id="project-list-table" class="hidden bg-[var(--card-bg)] border border-[var(--border-color)] rounded-lg shadow-md p-4 no-print">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs uppercase bg-gray-700 text-gray-300">
                            <tr>
                                <th class="p-3">Projeto</th>
                                <th class="p-3">Responsﾃ｡vel</th>
                                <th class="p-3">Progresso</th>
                                <th class="p-3">Status</th>
                                <th class="p-3">Inﾃｭcio</th>
                                <th class="p-3">Tﾃｩrmino</th>
                                <th class="p-3 text-center">Aﾃｧﾃｵes</th>
                            </tr>
                        </thead>
                        <tbody id="project-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Vista do Dashboard do Projeto -->
        <div id="dashboard-view" class="container mx-auto p-4 md:p-8 hidden">
            <!-- NOVO: Logo na pﾃ｡gina do dashboard -->
            <div class="logo-container">
                <img src="https://viacristais.com.br/wp-content/themes/viacristais/resources/images/logo-topo.png" alt="Vinci Highways" class="logo-header">
            </div>
            
             <header class="mb-8">
                <button id="back-to-projects-btn" class="text-sm text-blue-500 hover:underline mb-2 flex items-center gap-1 no-print">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
                   Voltar para Cronogramas
                </button>
                <div class="flex justify-between items-start">
                    <div>
                        <h1 id="project-title" class="text-4xl font-bold">Nome do Projeto</h1>
                        <p class="text-gray-400">Painel de controle com o cronograma de execuﾃｧﾃ｣o.</p>
                    </div>
                    <!-- NOVO: Botﾃ｣o para editar datas do projeto -->
                    <button id="edit-project-dates-btn" class="no-print bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" />
                        </svg>
                        Editar Datas do Projeto
                    </button>
                </div>
                <!-- NOVO: Exibiﾃｧﾃ｣o das datas do projeto -->
                <div id="project-dates-display" class="mt-2 text-sm text-gray-500">
                    <span id="project-start-date-display"></span> a <span id="project-end-date-display"></span>
                    <span id="project-date-auto" class="ml-2 text-xs bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 px-2 py-1 rounded hidden">Datas automﾃ｡ticas</span>
                    <span id="project-date-manual" class="ml-2 text-xs bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 px-2 py-1 rounded hidden">Datas manuais</span>
                </div>
                <!-- NOVO: Informaﾃｧﾃ｣o das tarefas de hoje -->
                <div id="today-tasks-info" class="mt-2"></div>
            </header>
            <div id="kpi-dashboard" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-8"></div>
            
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">
                <div class="lg:col-span-3 bg-[var(--card-bg)] p-4 rounded-lg shadow-md flex flex-wrap items-center justify-between gap-4 no-print border border-[var(--border-color)]">
                    <div class="flex items-center gap-4 flex-wrap">
                        <button id="add-task-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center gap-2">Nova Tarefa</button>
                        <button id="import-excel-btn" class="bg-teal-600 text-white px-4 py-2 rounded-md hover:bg-teal-700 flex items-center gap-2">Importar</button>
                        <button id="download-template-btn" class="text-sm text-blue-500 hover:underline">Baixar Template</button>
                        <!-- NOVO: Botﾃ｣o para filtrar tarefas de hoje -->
                        <button id="filter-today-btn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                            </svg>
                            Tarefas de Hoje
                        </button>
                    </div>
                    <div class="relative">
                        <input type="text" id="task-filter-input" placeholder="Filtrar tarefas..." class="border border-[var(--border-color)] bg-transparent rounded-md shadow-sm p-2 pl-8 text-sm">
                        <svg class="absolute left-2 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2"><label for="view-switcher" class="text-sm font-medium">Visualizaﾃｧﾃ｣o:</label><select id="view-switcher" class="border border-[var(--border-color)] rounded-md p-2 text-sm bg-[var(--card-bg)]"><option value="table" selected>Tabela</option><option value="gantt">Gantt</option></select></div>
                        <button id="export-excel-btn" class="bg-green-600 text-white px-3 py-2 rounded-md hover:bg-green-700" title="Exportar para Excel">Excel</button>
                        <button id="generate-pdf-report-btn" class="bg-red-600 text-white px-3 py-2 rounded-md hover:bg-red-700" title="Gerar Relatﾃｳrio PDF">PDF</button>
                        <button id="print-view-btn" class="bg-gray-500 text-white px-3 py-2 rounded-md hover:bg-gray-600" title="Imprimir">Imprimir</button>
                    </div>
                </div>
                 <div id="assignee-summary" class="bg-[var(--card-bg)] p-4 rounded-lg shadow-md border border-[var(--border-color)] no-print">
                    <h3 class="font-bold mb-2">Tarefas por Responsﾃ｡vel</h3>
                    <div id="assignee-summary-list" class="text-sm space-y-2 max-h-48 overflow-y-auto"></div>
                </div>
            </div>
            <main id="content-area" class="bg-[var(--card-bg)] p-4 rounded-lg shadow-md border border-[var(--border-color)]">
                <div id="table-view">
                     <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-400">
                            <thead class="text-xs uppercase bg-gray-700 text-gray-400">
                                <tr>
                                    <th class="p-3 min-w-[250px]">Tarefa</th>
                                    <th class="p-3">Duraﾃｧﾃ｣o (dias)</th>
                                    <th class="p-3">Data de Inﾃｭcio</th>
                                    <th class="p-3">Data de Tﾃｩrmino</th>
                                    <th class="p-3">Status</th>
                                    <th class="p-3">Responsﾃ｡vel</th>
                                    <th class="p-3">Comentﾃ｡rios</th>
                                    <th class="p-3 text-center no-print">Aﾃｧﾃｵes</th>
                                </tr>
                            </thead>
                            <tbody id="task-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <div id="gantt-view" class="hidden">
                     <div class="gantt-chart-container border border-[var(--border-color)] rounded-lg">
                        <svg id="gantt-dependency-lines" width="100%" height="100%"></svg>
                        <div class="gantt-tasks bg-gray-700 bg-opacity-20 border-r border-[var(--border-color)] p-2 font-bold">
                            <div class="h-10 flex items-center">Tarefa</div><div id="gantt-task-names" class="relative"></div>
                        </div>
                        <div class="gantt-timeline-container overflow-x-auto">
                            <div id="gantt-header" class="sticky top-0 bg-gray-700 bg-opacity-20 z-10 border-b border-[var(--border-color)]"></div><div id="gantt-timeline-body" class="relative"></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setDoc, doc, collection, onSnapshot, addDoc, deleteDoc, query, collectionGroup, getDoc, getDocs, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        
        // Variﾃ｡veis Globais de Firebase
        let firebaseApp;
        let db;
        let auth;
        let storage;
        let unsubscribeProjects = () => {};
        let unsubscribeUsers = () => {};
        let unsubscribeNotifications = () => {};
        
        // --- CONSTANTES E CONFIGURAﾃﾃグ ---
        const ALLOWED_DOMAIN = "@vinci-highways.com.br";
        const GESTOR_SECRET_CODE = "MASTER_GESTOR";
        
        // SUAS CREDENCIAIS DO BANCO DE DADOS
        const appId = "cronograma-85bf4"; 
        const firebaseConfig = {
            apiKey: "AIzaSyDB_q9kdQGNiLf34PPZFL2YuBDOj7XdwkA",
            authDomain: "cronograma-85bf4.firebaseapp.com",
            projectId: "cronograma-85bf4",
            storageBucket: "cronograma-85bf4.firebasestorage.app",
            messagingSenderId: "802190123207",
            appId: "1:802190123207:web:adaf51b25010f677bbdee2"
        };

        // NOVO: Serviﾃｧo para gerenciar tarefas
        const taskService = {
            isTaskRunningToday: function(task) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const latestDates = dataService.getLatestDates(task);
                if (!latestDates.startDate || !latestDates.endDate) return false;
                
                const startDate = new Date(latestDates.startDate + 'T00:00:00');
                const endDate = new Date(latestDates.endDate + 'T00:00:00');
                
                // Verificar se hoje estﾃ｡ entre inﾃｭcio e tﾃｩrmino E status ﾃｩ "Em Andamento"
                return task.status === 'Em Andamento' && 
                       today >= startDate && 
                       today <= endDate;
            },
            
            getTodayRunningTasks: function(project) {
                if (!project || !project.tasks) return [];
                return project.tasks.filter(task => this.isTaskRunningToday(task));
            },

            // NOVA FUNﾃﾃグ: Obter tarefas atrasadas
            getOverdueTasks: function(project) {
                if (!project || !project.tasks) return [];
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                return project.tasks.filter(task => {
                    const latestDates = dataService.getLatestDates(task);
                    if (!latestDates.endDate) return false;
                    
                    const endDate = new Date(latestDates.endDate + 'T00:00:00');
                    return task.status !== 'Concluﾃｭda' && endDate < today;
                });
            },

            // NOVA FUNﾃﾃグ: Obter primeira tarefa do dia
            getFirstTodayTask: function(project) {
                const todayTasks = this.getTodayRunningTasks(project);
                if (todayTasks.length === 0) return null;
                
                // Ordenar por data de inﾃｭcio e retornar a primeira
                return todayTasks.sort((a, b) => {
                    const aStart = new Date(dataService.getLatestDates(a).startDate);
                    const bStart = new Date(dataService.getLatestDates(b).startDate);
                    return aStart - bStart;
                })[0];
            }
        };

        // dataService Interface
        const dataService = {
            projects: [],
            users: [], 
            currentProjectId: null,
            userId: null,
            userRole: null, 
            isAuthReady: false,
            taskService: taskService, // NOVO: Adicionar serviﾃｧo de tarefas
            notifications: [], // NOVO: Array para armazenar notificaﾃｧﾃｵes
            
            // --- FIREBASE IMPLEMENTATIONS ---
            initFirebase: async () => {
                try {
                    firebaseApp = initializeApp(firebaseConfig);
                    db = getFirestore(firebaseApp);
                    auth = getAuth(firebaseApp);
                    storage = getStorage(firebaseApp); // NOVO: Inicializar Storage

                    // Listener do estado de autenticaﾃｧﾃ｣o inicia o fluxo da UI
                    onAuthStateChanged(auth, async (user) => {
                        if (user && user.email?.endsWith(ALLOWED_DOMAIN)) {
                            // Usuﾃ｡rio autenticado e com domﾃｭnio correto
                            dataService.userId = user.uid;
                            dataService.isAuthReady = true;
                            
                            await dataService.getUserProfile(user.uid); 
                            
                            uiService.showView('project-view');
                            document.getElementById('logged-in-container').classList.remove('hidden');
                            uiService.closeModal('auth-modal');
                            document.getElementById('loader').style.display = 'none';

                            dataService.listenToUsers();
                            dataService.listenToProjects();
                            dataService.listenToNotifications(); // NOVO: Iniciar listener de notificaﾃｧﾃｵes

                            uiService.updateUserRoleDisplay();
                        } else {
                            // Nenhuma autenticaﾃｧﾃ｣o ou domﾃｭnio invﾃ｡lido
                            dataService.userId = null;
                            dataService.isAuthReady = true; 
                            dataService.projects = [];
                            dataService.userRole = null;
                            dataService.notifications = []; // NOVO: Limpar notificaﾃｧﾃｵes
                            
                            document.getElementById('logged-in-container').classList.add('hidden');
                            uiService.openModal('auth-modal');
                            document.getElementById('loader').style.display = 'none';
                            unsubscribeProjects();
                            unsubscribeUsers();
                            unsubscribeNotifications(); // NOVO: Parar listener de notificaﾃｧﾃｵes
                        }
                    });
                } catch (error) {
                    console.error("Erro na inicializaﾃｧﾃ｣o do Firebase:", error);
                    uiService.showToast('Erro ao conectar ao banco de dados! Verifique a API Key e a configuraﾃｧﾃ｣o.', 'error');
                    document.getElementById('loader').style.display = 'none';
                }
            },

            // --- USER MANAGEMENT ---
            getUserProfile: async (uid) => {
                const userDocRef = doc(db, 'users_data', uid);
                const userSnapshot = await getDoc(userDocRef); 

                if (userSnapshot.exists()) {
                    dataService.userRole = userSnapshot.data().role;
                } else {
                    dataService.userRole = 'Usuario';
                }
            },
            
            listenToUsers: () => {
                unsubscribeUsers();
                if (!dataService.isAuthReady) return;

                const usersRef = collection(db, 'users_data');

                unsubscribeUsers = onSnapshot(usersRef, (snapshot) => {
                    dataService.users = [];
                    snapshot.forEach(doc => {
                        if (doc.data().email && doc.data().email.endsWith(ALLOWED_DOMAIN)) {
                           dataService.users.push({ id: doc.id, ...doc.data() });
                        }
                    });

                    if (document.getElementById('user-management-modal').classList.contains('modal-visible') && dataService.userRole === 'Gestor') {
                         uiService.renderUserManagementTable();
                    }
                    uiService.populateAssignedUsersCheckboxes();
                }, (error) => {
                    console.error("Erro ao ouvir usuﾃ｡rios:", error);
                });
            },
            
            updateUserRole: async (uid, newRole) => {
                try {
                    const userDocRef = doc(db, 'users_data', uid);
                    await setDoc(userDocRef, { role: newRole }, { merge: true });

                    await auth.currentUser.getIdToken(true);
                    
                    uiService.showToast(`Papel de ${dataService.users.find(u => u.id === uid)?.email} atualizado para ${newRole}.`);
                } catch (error) {
                    console.error("Erro ao atualizar papel:", error);
                    uiService.showToast('Falha ao atualizar papel do utilizador.', 'error');
                }
            },

            // --- CADASTRO DE USUﾃヽIOS PELO GESTOR ---
            createUserByGestor: async (userData) => {
                try {
                    const { name, email, role } = userData;
                    
                    if (!email.endsWith(ALLOWED_DOMAIN)) {
                        throw new Error(`E-mail deve terminar com ${ALLOWED_DOMAIN}`);
                    }

                    // Verificar se usuﾃ｡rio jﾃ｡ existe
                    const usersSnapshot = await getDocs(collection(db, 'users_data'));
                    const existingUser = usersSnapshot.docs.find(doc => doc.data().email === email);
                    
                    if (existingUser) {
                        throw new Error('Este e-mail jﾃ｡ estﾃ｡ cadastrado no sistema');
                    }

                    // MELHORIA 02: Usar nome do e-mail se nome nﾃ｣o for fornecido
                    const userName = name || email.split('@')[0];
                    
                    // Gerar senha temporﾃ｡ria
                    const tempPassword = Math.random().toString(36).slice(-8) + 'A1!';
                    
                    // Criar usuﾃ｡rio no Authentication
                    const userCredential = await createUserWithEmailAndPassword(auth, email, tempPassword);
                    const newUserId = userCredential.user.uid;

                    // Salvar dados do usuﾃ｡rio no Firestore
                    await setDoc(doc(db, 'users_data', newUserId), {
                        name: userName,
                        email: email,
                        role: role,
                        appId: appId,
                        createdAt: new Date().toISOString(),
                        createdBy: dataService.userId
                    });

                    // Enviar email de boas-vindas com instruﾃｧﾃｵes de login
                    await dataService.sendWelcomeEmail(email, userName, tempPassword);
                    
                    // Fazer logout do usuﾃ｡rio temporﾃ｡rio criado
                    await signOut(auth);
                    
                    // Refazer login do gestor
                    const currentUser = auth.currentUser;
                    if (currentUser) {
                        await signInWithEmailAndPassword(auth, currentUser.email, document.getElementById('auth-password').value);
                    }

                    return { success: true, tempPassword };
                } catch (error) {
                    console.error("Erro ao criar usuﾃ｡rio:", error);
                    throw error;
                }
            },

            sendWelcomeEmail: async (email, name, tempPassword) => {
                // Simulaﾃｧﾃ｣o de envio de email
                console.log(`透 Email enviado para: ${email}`);
                console.log(`窓 Conteﾃｺdo do email:
                    
                    Olﾃ｡ ${name},
                    
                    Bem-vindo(a) ao Vinci Highways Projects!
                    
                    Sua conta foi criada com sucesso.
                    
                    Seus dados de acesso:
                    E-mail: ${email}
                    Senha temporﾃ｡ria: ${tempPassword}
                    
                    Por seguranﾃｧa, recomendamos que altere sua senha no primeiro acesso.
                    
                    Acesse o sistema em: ${window.location.origin}
                    
                    Atenciosamente,
                    Equipe Vinci Highways
                `);

                return true;
            },

            resetUserPassword: async (email) => {
                try {
                    await sendPasswordResetEmail(auth, email);
                    uiService.showToast(`Email de redefiniﾃｧﾃ｣o de senha enviado para ${email}`);
                } catch (error) {
                    console.error("Erro ao enviar email de redefiniﾃｧﾃ｣o:", error);
                    uiService.showToast('Falha ao enviar email de redefiniﾃｧﾃ｣o de senha.', 'error');
                }
            },

            // --- PROJECT DATA ACCESS ---
            getProjectCollectionRef: (uid) => {
                const targetUid = uid || dataService.userId;
                if (!targetUid) throw new Error("Usuﾃ｡rio nﾃ｣o autenticado.");
                return collection(db, 'artifacts', appId, 'users', targetUid, 'projects');
            },

            listenToProjects: () => {
                unsubscribeProjects(); 
                if (!dataService.isAuthReady) return;
                
                let projectsQuery;
                
                if (dataService.userRole === 'Gestor') {
                    projectsQuery = query(collectionGroup(db, 'projects'));
                } else {
                    projectsQuery = query(dataService.getProjectCollectionRef());
                }
                
                unsubscribeProjects = onSnapshot(projectsQuery, (snapshot) => {
                    console.log("逃 Dados recebidos do Firebase:", snapshot.size, "documentos");
                    
                    snapshot.forEach(doc => {
                        console.log("塘 Documento:", doc.id, doc.data());
                    });

                    let newProjects = [];
                    snapshot.forEach(doc => {
                        const projectData = doc.data();
                        const creatorId = projectData.creatorId || doc.ref.parent.parent.id; 
                        
                        const tasksWithDefaults = projectData.tasks?.map(t => ({
                            ...t,
                            assignedUsers: t.assignedUsers || [], 
                        })) || [];

                        const project = { 
                            id: doc.id, 
                            manager: projectData.manager || 'Nﾃ｣o Definido', 
                            creatorId: creatorId, 
                            tasks: tasksWithDefaults,
                            startDate: projectData.startDate || '', // NOVO: Data de inﾃｭcio
                            endDate: projectData.endDate || '',     // NOVO: Data de tﾃｩrmino
                            dateMode: projectData.dateMode || 'manual', // NOVO: Modo de data (manual/auto)
                            ...projectData 
                        };
                        newProjects.push(project); 
                    });

                    // NOVO: Filtragem automﾃ｡tica para usuﾃ｡rios comuns
                    if (dataService.userRole === 'Usuario') {
                        newProjects = newProjects.filter(project => {
                            const isCreator = project.creatorId === dataService.userId;
                            const isAssigned = project.tasks.some(task => 
                                (task.assignedUsers || []).includes(dataService.userId)
                            );
                            return isCreator || isAssigned;
                        });
                    }

                    dataService.projects = newProjects;
                    dataService.recalculateAllProgress();
                    
                    if (dataService.currentProjectId) {
                        const currentProject = dataService.getProjectById(dataService.currentProjectId);
                        if (currentProject) {
                            uiService.renderProjectDashboard(currentProject, document.getElementById('task-filter-input').value);
                        } else {
                            App.showProjectView(); 
                        }
                    } else {
                        App.showProjectView();
                    }
                }, (error) => {
                    console.error("Erro ao ouvir projetos:", error);
                    uiService.showToast('Erro de sincronizaﾃｧﾃ｣o em tempo real.', 'error');
                });
            },
            
            getLatestDates: (task) => {
                if (!task.dateHistory || task.dateHistory.length === 0) return { startDate: '', endDate: '' };
                return task.dateHistory[task.dateHistory.length - 1];
            },
            
            getProjectById: (id) => { return dataService.projects.find(p => p.id === id); },
            getCurrentProject: () => { return dataService.getProjectById(dataService.currentProjectId); },
            
            getProjectOwnerUid: (projectId) => {
                const project = dataService.getProjectById(projectId);
                return project ? project.creatorId : dataService.userId;
            },

            // --- CRUD HELPERS ---
            addProject: async (projectData) => {
                try {
                    const projectCollection = dataService.getProjectCollectionRef();
                    const newProjectData = { 
                        name: projectData.name, 
                        manager: projectData.manager, 
                        startDate: projectData.startDate, // NOVO: Salvar data de inﾃｭcio
                        endDate: projectData.endDate,     // NOVO: Salvar data de tﾃｩrmino
                        dateMode: 'manual', // NOVO: Inicialmente manual
                        tasks: [],
                        creatorId: dataService.userId
                    };
                    await addDoc(projectCollection, newProjectData);
                } catch (error) {
                    console.error("Erro ao adicionar projeto:", error);
                    uiService.showToast('Falha ao adicionar projeto.', 'error');
                }
            },

            // NOVA FUNﾃﾃグ: Atualizar datas do projeto
            updateProjectDates: async (projectId, startDate, endDate, dateMode = 'manual') => {
                try {
                    const project = dataService.getProjectById(projectId);
                    if (!project) throw new Error('Projeto nﾃ｣o encontrado');
                    
                    const ownerUid = dataService.getProjectOwnerUid(projectId);
                    const projectDocRef = doc(dataService.getProjectCollectionRef(ownerUid), projectId);

                    await setDoc(projectDocRef, { 
                        startDate: startDate,
                        endDate: endDate,
                        dateMode: dateMode
                    }, { merge: true });

                    return true;
                } catch (error) {
                    console.error("Erro ao atualizar datas do projeto:", error);
                    throw error;
                }
            },

            deleteProject: async (projectId) => {
                try {
                    const ownerUid = dataService.getProjectOwnerUid(projectId);
                    const projectDocRef = doc(dataService.getProjectCollectionRef(ownerUid), projectId);
                    await deleteDoc(projectDocRef);
                } catch (error) {
                    console.error("Erro ao deletar projeto:", error);
                    uiService.showToast('Falha ao deletar projeto. Verifique suas permissﾃｵes.', 'error');
                }
            },
            
            saveProjectDocument: async (project) => {
                try {
                    const projectId = project.id; 
                    const ownerUid = project.creatorId; 
                    const projectDocRef = doc(dataService.getProjectCollectionRef(ownerUid), projectId);

                    await setDoc(projectDocRef, { 
                        name: project.name, 
                        manager: project.manager, 
                        startDate: project.startDate, // NOVO: Salvar data de inﾃｭcio
                        endDate: project.endDate,     // NOVO: Salvar data de tﾃｩrmino
                        dateMode: project.dateMode || 'manual', // NOVO: Salvar modo de data
                        tasks: project.tasks,
                        creatorId: ownerUid
                    }, { merge: true });

                } catch (error) {
                    console.error("Erro ao salvar projeto/tarefas:", error);
                    uiService.showToast('Falha ao salvar dados. Verifique a conexﾃ｣o.', 'error');
                }
            },

            // NOVA FUNﾃﾃグ: Calcular datas automﾃ｡ticas do projeto baseado nas tarefas
            calculateProjectDatesFromTasks: function(project) {
                if (!project.tasks || project.tasks.length === 0) {
                    return { startDate: project.startDate, endDate: project.endDate };
                }

                // Encontrar a data de inﾃｭcio mais antiga e data de tﾃｩrmino mais recente
                let earliestStartDate = null;
                let latestEndDate = null;

                project.tasks.forEach(task => {
                    const taskDates = this.getLatestDates(task);
                    if (taskDates.startDate && taskDates.endDate) {
                        const taskStart = new Date(taskDates.startDate);
                        const taskEnd = new Date(taskDates.endDate);

                        if (!earliestStartDate || taskStart < earliestStartDate) {
                            earliestStartDate = taskStart;
                        }
                        if (!latestEndDate || taskEnd > latestEndDate) {
                            latestEndDate = taskEnd;
                        }
                    }
                });

                if (earliestStartDate && latestEndDate) {
                    return {
                        startDate: earliestStartDate.toISOString().split('T')[0],
                        endDate: latestEndDate.toISOString().split('T')[0]
                    };
                }

                return { startDate: project.startDate, endDate: project.endDate };
            },

            // NOVA FUNﾃﾃグ: Verificar se projeto tem subtarefas
            projectHasSubtasks: function(project) {
                return project.tasks && project.tasks.some(task => task.parentId !== null && task.parentId !== undefined);
            },

            // NOVA FUNﾃﾃグ: Verificar se tarefa tem subtarefas
            taskHasSubtasks: function(project, taskId) {
                return project.tasks && project.tasks.some(task => task.parentId === taskId);
            },

            // NOVA FUNﾃﾃグ: Calcular datas automﾃ｡ticas de tarefa pai
            calculateParentTaskDates: function(project, parentTaskId) {
                const childTasks = project.tasks.filter(t => t.parentId === parentTaskId);
                if (childTasks.length === 0) return null;

                let earliestStartDate = null;
                let latestEndDate = null;

                childTasks.forEach(child => {
                    const childDates = this.getLatestDates(child);
                    if (childDates.startDate && childDates.endDate) {
                        const childStart = new Date(childDates.startDate);
                        const childEnd = new Date(childDates.endDate);

                        if (!earliestStartDate || childStart < earliestStartDate) {
                            earliestStartDate = childStart;
                        }
                        if (!latestEndDate || childEnd > latestEndDate) {
                            latestEndDate = childEnd;
                        }
                    }
                });

                if (earliestStartDate && latestEndDate) {
                    return {
                        startDate: earliestStartDate.toISOString().split('T')[0],
                        endDate: latestEndDate.toISOString().split('T')[0]
                    };
                }

                return null;
            },

            // NOVA FUNﾃﾃグ: Validar data de tarefa contra projeto
            validateTaskDateAgainstProject: function(taskStartDate, projectStartDate) {
                if (!taskStartDate || !projectStartDate) return true;
                
                const taskStart = new Date(taskStartDate);
                const projectStart = new Date(projectStartDate);
                
                return taskStart >= projectStart;
            },

            // NOVA FUNﾃﾃグ: Validar data de subtarefa contra tarefa pai
            validateSubtaskDateAgainstParent: function(subtaskStartDate, parentStartDate) {
                if (!subtaskStartDate || !parentStartDate) return true;
                
                const subtaskStart = new Date(subtaskStartDate);
                const parentStart = new Date(parentStartDate);
                
                return subtaskStart >= parentStart;
            },

            // NOVA FUNﾃﾃグ: Resolver conflito de datas ao re-parentar tarefa
            resolveReparentingDateConflict: async function(movingTaskId, newParentId) {
                const project = dataService.getCurrentProject();
                if (!project) return false;

                const movingTask = project.tasks.find(t => t.id === movingTaskId);
                const newParent = project.tasks.find(t => t.id === newParentId);

                if (!movingTask || !newParent) return false;

                const movingTaskDates = this.getLatestDates(movingTask);
                const parentDates = this.getLatestDates(newParent);

                // Verificar se hﾃ｡ conflito
                if (new Date(movingTaskDates.startDate) < new Date(parentDates.startDate)) {
                    // CONFLITO: A tarefa sendo movida comeﾃｧa antes da nova tarefa pai
                    
                    // Opﾃｧﾃ｣o B: Aplicar roll-up automﾃ｡tico
                    const shouldUpdateParent = await uiService.showSubtaskDateConfirmModal(
                        movingTask.name,
                        movingTaskDates.startDate,
                        movingTaskDates.endDate,
                        parentDates.startDate,
                        parentDates.endDate
                    );
                    
                    if (shouldUpdateParent) {
                        // Atualizar a tarefa pai para acomodar a subtarefa
                        const updatedTasks = project.tasks.map(t => {
                            if (t.id === newParentId) {
                                const updatedTask = { ...t };
                                const newParentStart = new Date(Math.min(
                                    parentStart.getTime(),
                                    childStart.getTime()
                                )).toISOString().split('T')[0];
                                const newParentEnd = new Date(Math.max(
                                    parentEnd.getTime(),
                                    childEnd.getTime()
                                )).toISOString().split('T')[0];
                                
                                if (updatedTask.dateHistory && updatedTask.dateHistory.length > 0) {
                                    const latestDates = updatedTask.dateHistory[updatedTask.dateHistory.length - 1];
                                    if (latestDates.startDate !== newParentStart || latestDates.endDate !== newParentEnd) {
                                        updatedTask.dateHistory = [
                                            ...updatedTask.dateHistory,
                                            { startDate: newParentStart, endDate: newParentEnd }
                                        ];
                                    }
                                } else {
                                    updatedTask.dateHistory = [{ startDate: newParentStart, endDate: newParentEnd }];
                                }
                                return updatedTask;
                            }
                            return t;
                        });

                        project.tasks = updatedTasks;
                        return true;
                    } else {
                        // Usuﾃ｡rio cancelou - nﾃ｣o permitir o re-parenting
                        return false;
                    }
                }

                return true; // Sem conflito
            },

            // NOVA FUNﾃﾃグ: Atualizar automaticamente datas do projeto quando em modo automﾃ｡tico
            updateProjectDatesIfAuto: function(project) {
                if (project.dateMode === 'auto') {
                    const calculatedDates = this.calculateProjectDatesFromTasks(project);
                    if (calculatedDates.startDate !== project.startDate || calculatedDates.endDate !== project.endDate) {
                        project.startDate = calculatedDates.startDate;
                        project.endDate = calculatedDates.endDate;
                        return true;
                    }
                }
                return false;
            },

            // NOVA FUNﾃﾃグ: Atualizar automaticamente datas de tarefas pai
            updateParentTaskDatesIfNeeded: function(project, taskId) {
                const task = project.tasks.find(t => t.id === taskId);
                if (!task || !task.parentId) return false;

                const parentTask = project.tasks.find(t => t.id === task.parentId);
                if (!parentTask) return false;

                const calculatedDates = this.calculateParentTaskDates(project, task.parentId);
                if (!calculatedDates) return false;

                const parentDates = this.getLatestDates(parentTask);
                if (calculatedDates.startDate !== parentDates.startDate || calculatedDates.endDate !== parentDates.endDate) {
                    // Atualizar a tarefa pai
                    const updatedTasks = project.tasks.map(t => {
                        if (t.id === task.parentId) {
                            const updatedTask = { ...t };
                            if (updatedTask.dateHistory && updatedTask.dateHistory.length > 0) {
                                const latestDates = updatedTask.dateHistory[updatedTask.dateHistory.length - 1];
                                if (latestDates.startDate !== calculatedDates.startDate || latestDates.endDate !== calculatedDates.endDate) {
                                    updatedTask.dateHistory = [
                                        ...updatedTask.dateHistory,
                                        { startDate: calculatedDates.startDate, endDate: calculatedDates.endDate }
                                    ];
                                }
                            } else {
                                updatedTask.dateHistory = [{ 
                                    startDate: calculatedDates.startDate, 
                                    endDate: calculatedDates.endDate 
                                }];
                            }
                            return updatedTask;
                        }
                        return t;
                    });

                    project.tasks = updatedTasks;
                    return true;
                }

                return false;
            },

            // FUNﾃﾃグ saveTask ATUALIZADA com todas as validaﾃｧﾃｵes
            saveTask: async (taskData) => {
                const project = dataService.getCurrentProject();
                if (!project) return;

                const { newStartDate, newEndDate, dependsOn, ...restOfTaskData } = taskData;
                
                // VALIDAﾃﾃグ 1: Verificar se a data ﾃｩ anterior ﾃ data do projeto
                if (!dataService.validateTaskDateAgainstProject(newStartDate, project.startDate)) {
                    uiService.showToast(`A data de inﾃｭcio nﾃ｣o pode ser anterior ﾃ data de inﾃｭcio do projeto (${new Date(project.startDate).toLocaleDateString('pt-BR')}).`, 'error');
                    return;
                }

                // VALIDAﾃﾃグ 2: Se houver dependﾃｪncia, define a tarefa pai
                if (dependsOn) {
                    // Encontra a tarefa da qual esta depende
                    const parentTask = project.tasks.find(t => t.id === dependsOn);
                    if (parentTask) {
                        // Define esta tarefa como filha da tarefa pai
                        restOfTaskData.parentId = dependsOn;
                        
                        // Validaﾃｧﾃ｣o de datas conforme jﾃ｡ existe
                        const parentDates = dataService.getLatestDates(parentTask);
                        const parentStart = new Date(parentDates.startDate);
                        const parentEnd = new Date(parentDates.endDate);
                        const childStart = new Date(newStartDate);
                        const childEnd = new Date(newEndDate);

                        // VALIDAﾃﾃグ 3: Verificar se subtarefa comeﾃｧa antes da tarefa pai
                        if (childStart < parentStart || childEnd > parentEnd) {
                            const shouldUpdateParent = await uiService.showSubtaskDateConfirmModal(
                                restOfTaskData.name,
                                newStartDate,
                                newEndDate,
                                parentDates.startDate,
                                parentDates.endDate
                            );
                            
                            if (shouldUpdateParent) {
                                // Atualizar a tarefa pai para acomodar a subtarefa
                                const updatedTasks = project.tasks.map(t => {
                                    if (t.id === restOfTaskData.parentId) {
                                        const updatedTask = { ...t };
                                        const newParentStart = new Date(Math.min(
                                            parentStart.getTime(),
                                            childStart.getTime()
                                        )).toISOString().split('T')[0];
                                        const newParentEnd = new Date(Math.max(
                                            parentEnd.getTime(),
                                            childEnd.getTime()
                                        )).toISOString().split('T')[0];
                                        
                                        if (updatedTask.dateHistory && updatedTask.dateHistory.length > 0) {
                                            const latestDates = updatedTask.dateHistory[updatedTask.dateHistory.length - 1];
                                            if (latestDates.startDate !== newParentStart || latestDates.endDate !== newParentEnd) {
                                                updatedTask.dateHistory = [
                                                    ...updatedTask.dateHistory,
                                                    { startDate: newParentStart, endDate: newParentEnd }
                                                ];
                                            }
                                        } else {
                                            updatedTask.dateHistory = [{ startDate: newParentStart, endDate: newParentEnd }];
                                        }
                                        return updatedTask;
                                    }
                                    return t;
                                });
                                project.tasks = updatedTasks;
                            } else {
                                return; // Nﾃ｣o salvar se o usuﾃ｡rio cancelar
                            }
                        }
                    }
                }

                let updatedTasks;

                if (taskData.id) { 
                    updatedTasks = project.tasks.map(t => {
                        if (t.id === restOfTaskData.id) {
                            const updatedTask = { ...t, ...restOfTaskData };
                            // Remove dependsOn se agora ﾃｩ uma subtarefa
                            if (updatedTask.parentId) {
                                updatedTask.dependsOn = null;
                            }
                            if (newStartDate && newEndDate) {
                                const latestDates = dataService.getLatestDates(t);
                                if (latestDates.startDate !== newStartDate || latestDates.endDate !== newEndDate) {
                                    updatedTask.dateHistory = [...(updatedTask.dateHistory || []), { startDate: newStartDate, endDate: newEndDate }];
                                }
                            }
                            return updatedTask;
                        }
                        return t;
                    });
                } else { 
                    const newTask = { 
                        ...restOfTaskData, 
                        id: Date.now() + Math.random(),
                        dateHistory: [{ startDate: newStartDate, endDate: newEndDate }],
                        comments: taskData.comments || [],
                        // Garante que dependsOn seja limpo se ﾃｩ uma subtarefa
                        dependsOn: restOfTaskData.parentId ? null : dependsOn,
                        // NOVO: Adicionar ordem para drag and drop
                        order: project.tasks.filter(t => t.parentId === restOfTaskData.parentId).length
                    };
                    updatedTasks = [...project.tasks, newTask];
                }
                
                project.tasks = updatedTasks;
                
                // ATUALIZAﾃﾃグ AUTOMﾃゝICA: Atualizar datas da tarefa pai se necessﾃ｡rio
                if (restOfTaskData.parentId) {
                    dataService.updateParentTaskDatesIfNeeded(project, restOfTaskData.id || newTask.id);
                }
                
                // ATUALIZAﾃﾃグ AUTOMﾃゝICA: Atualizar datas do projeto se em modo automﾃ｡tico
                dataService.updateProjectDatesIfAuto(project);
                
                dataService.recalculateAllProgress();
                await dataService.saveProjectDocument(project);
                
                // NOVO: Enviar notificaﾃｧﾃｵes para usuﾃ｡rios atribuﾃｭdos
                if (restOfTaskData.assignedUsers && restOfTaskData.assignedUsers.length > 0) {
                    await dataService.sendTaskAssignmentNotifications(
                        restOfTaskData.id || newTask.id,
                        restOfTaskData.name,
                        project.id,
                        project.name,
                        restOfTaskData.assignedUsers
                    );
                }
            },

            // NOVA FUNﾃﾃグ: Reordenar subtarefas via drag and drop
            reorderSubtasks: async function(parentTaskId, subtaskIdsInOrder) {
                const project = dataService.getCurrentProject();
                if (!project) return;

                const updatedTasks = project.tasks.map(task => {
                    if (task.parentId === parentTaskId) {
                        const newOrder = subtaskIdsInOrder.indexOf(task.id);
                        if (newOrder !== -1) {
                            return { ...task, order: newOrder };
                        }
                    }
                    return task;
                });

                project.tasks = updatedTasks;
                await dataService.saveProjectDocument(project);
                
                // Atualizar a UI
                uiService.renderProjectDashboard(project, document.getElementById('task-filter-input').value);
            },

            // MELHORIA 01: Funﾃｧﾃ｣o para atualizar datas da tarefa pai
            updateParentTaskDates: function(parentTaskId) {
                const project = dataService.getCurrentProject();
                if (!project) return;

                const parentTask = project.tasks.find(t => t.id === parentTaskId);
                if (!parentTask) return;

                const childTasks = project.tasks.filter(t => t.parentId === parentTaskId);
                if (childTasks.length === 0) return;

                // Encontrar a data de inﾃｭcio mais antiga e data de tﾃｩrmino mais recente entre as subtarefas
                let earliestStartDate = null;
                let latestEndDate = null;

                childTasks.forEach(child => {
                    const childDates = dataService.getLatestDates(child);
                    const childStart = new Date(childDates.startDate);
                    const childEnd = new Date(childDates.endDate);

                    if (!earliestStartDate || childStart < earliestStartDate) {
                        earliestStartDate = childStart;
                    }
                    if (!latestEndDate || childEnd > latestEndDate) {
                        latestEndDate = childEnd;
                    }
                });

                if (earliestStartDate && latestEndDate) {
                    const parentDates = dataService.getLatestDates(parentTask);
                    const parentStart = new Date(parentDates.startDate);
                    const parentEnd = new Date(parentDates.endDate);

                    // Atualizar apenas se as datas forem diferentes
                    if (earliestStartDate.getTime() !== parentStart.getTime() || 
                        latestEndDate.getTime() !== parentEnd.getTime()) {
                        
                        const newStartDate = earliestStartDate.toISOString().split('T')[0];
                        const newEndDate = latestEndDate.toISOString().split('T')[0];

                        // Atualizar a tarefa pai
                        const updatedTasks = project.tasks.map(t => {
                            if (t.id === parentTaskId) {
                                const updatedTask = { ...t };
                                if (updatedTask.dateHistory && updatedTask.dateHistory.length > 0) {
                                    const latestDates = updatedTask.dateHistory[updatedTask.dateHistory.length - 1];
                                    if (latestDates.startDate !== newStartDate || latestDates.endDate !== newEndDate) {
                                        updatedTask.dateHistory = [
                                            ...updatedTask.dateHistory,
                                            { startDate: newStartDate, endDate: newEndDate }
                                        ];
                                    }
                                } else {
                                    updatedTask.dateHistory = [{ startDate: newStartDate, endDate: newEndDate }];
                                }
                                return updatedTask;
                            }
                            return t;
                        });

                        project.tasks = updatedTasks;
                    }
                }
            },

            deleteTask: async (taskId) => {
                const project = dataService.getCurrentProject();
                if (!project) return;
                
                const idsToDelete = [taskId];
                const findChildren = (pid) => { 
                    project.tasks.filter(t => t.parentId === pid).forEach(c => { 
                        idsToDelete.push(c.id); findChildren(c.id); 
                    }); 
                };
                findChildren(taskId);
                
                let updatedTasks = project.tasks.filter(t => !idsToDelete.includes(t.id));
                
                updatedTasks = updatedTasks.map(t => {
                    if (idsToDelete.includes(t.dependsOn)) { t.dependsOn = null; }
                    return t;
                });

                project.tasks = updatedTasks;
                
                // ATUALIZAﾃﾃグ AUTOMﾃゝICA: Atualizar datas do projeto se em modo automﾃ｡tico
                dataService.updateProjectDatesIfAuto(project);
                
                dataService.recalculateAllProgress();
                await dataService.saveProjectDocument(project);
            },
            
            // --- CALCULATION LOGIC ---
            recalculateAllProgress: () => {
                dataService.projects.forEach(project => {
                    const tasks = project.tasks;
                    if (!tasks || tasks.length === 0) return;
                    const taskMap = new Map(tasks.map(t => [t.id, t]));
                    const childrenMap = new Map([...taskMap.keys()].map(k => [k, []]));
                    tasks.forEach(t => { if (t.parentId && childrenMap.has(t.parentId)) childrenMap.get(t.parentId).push(t.id); });

                    const calculateTaskProgress = (taskId) => {
                        const childrenIds = childrenMap.get(taskId);
                        const task = taskMap.get(taskId);
                        if (!childrenIds || childrenIds.length === 0) return task.progress;
                        
                        const childrenProgress = childrenIds.map(childId => calculateTaskProgress(childId));
                        const totalProgress = childrenProgress.reduce((sum, prog) => sum + prog, 0);
                        const averageProgress = Math.round(totalProgress / childrenIds.length);
                        
                        task.progress = averageProgress;
                        if (averageProgress === 100) task.status = 'Concluﾃｭda';
                        else if (averageProgress > 0) task.status = 'Em Andamento';
                        else task.status = 'Nﾃ｣o Iniciada';

                        return averageProgress;
                    };
                    tasks.filter(t => t.parentId === null).forEach(t => calculateTaskProgress(t.id));
                });
            },
            getProjectProgress: (tasks) => {
                if (!tasks || tasks.length === 0) return 0;
                const topLevelTasks = tasks.filter(t => t.parentId === null);
                if (topLevelTasks.length === 0) return 0;
                const totalProgress = topLevelTasks.reduce((sum, task) => sum + task.progress, 0);
                return Math.round(totalProgress / topLevelTasks.length);
            },

            // NOVA FUNﾃﾃグ: Obter nome do responsﾃ｡vel pelo UID
            getManagerName: (managerUid) => {
                if (!managerUid) return 'Nﾃ｣o definido';
                const user = dataService.users.find(u => u.id === managerUid);
                return user ? (user.name || user.email.split('@')[0]) : `UID:${managerUid.substring(0,4)}`;
            },

            // NOVA FUNﾃﾃグ: Obter nomes dos usuﾃ｡rios atribuﾃｭdos
            getAssignedUserNames: (assignedUsers) => {
                if (!assignedUsers || assignedUsers.length === 0) return '-';
                return assignedUsers.map(uid => {
                    const user = dataService.users.find(u => u.id === uid);
                    return user ? (user.name || user.email.split('@')[0]) : `UID:${uid.substring(0,4)}`;
                }).join(', ');
            },

            // NOVA FUNﾃﾃグ: Processar importaﾃｧﾃ｣o com validaﾃｧﾃ｣o detalhada
            processImportWithValidation: async function(file) {
                try {
                    const project = dataService.getCurrentProject();
                    if (!project) {
                        throw new Error('Nenhum projeto selecionado');
                    }

                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        
                        reader.onload = async (e) => {
                            try {
                                const data = new Uint8Array(e.target.result);
                                const workbook = XLSX.read(data, { type: 'array' });
                                
                                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                                
                                if (jsonData.length === 0) {
                                    throw new Error('A planilha estﾃ｡ vazia');
                                }

                                const importResults = {
                                    validTasks: [],
                                    invalidTasks: [],
                                    errors: [],
                                    taskNameMap: new Map()
                                };

                                // Mapear tarefas existentes
                                project.tasks.forEach(task => {
                                    importResults.taskNameMap.set(task.name.trim().toLowerCase(), task.id);
                                });

                                // Validar cada linha
                                jsonData.forEach((row, index) => {
                                    const result = this.validateImportRow(row, index + 2, importResults.taskNameMap, project.startDate);
                                    if (result.isValid) {
                                        importResults.validTasks.push(result.task);
                                    } else {
                                        importResults.invalidTasks.push({
                                            row: index + 2,
                                            data: row,
                                            errors: result.errors,
                                            task: result.task
                                        });
                                    }
                                });

                                // Se hﾃ｡ tarefas invﾃ｡lidas, mostrar modal de ajustes
                                if (importResults.invalidTasks.length > 0) {
                                    uiService.showImportAdjustmentModal(importResults);
                                    resolve({ needsAdjustment: true, results: importResults });
                                } else {
                                    // Todas vﾃ｡lidas, importar diretamente
                                    await this.finalizeImport(importResults.validTasks, project);
                                    resolve({ needsAdjustment: false, count: importResults.validTasks.length });
                                }

                            } catch (error) {
                                reject(error);
                            }
                        };

                        reader.onerror = (error) => reject(error);
                        reader.readAsArrayBuffer(file);
                    });

                } catch (error) {
                    console.error('Erro na importaﾃｧﾃ｣o:', error);
                    throw error;
                }
            },

            // FUNﾃﾃグ: Validar linha individual (ATUALIZADA com validaﾃｧﾃ｣o de data do projeto)
            validateImportRow: function(row, rowNumber, taskNameMap, projectStartDate) {
                const errors = [];
                const task = {};

                // Validar nome da tarefa
                const taskName = row['Tarefa']?.toString().trim();
                if (!taskName) {
                    errors.push('Nome da tarefa ﾃｩ obrigatﾃｳrio');
                } else {
                    task.name = taskName;
                }

                // Validar e converter datas
                const startDate = this.parseExcelDate(row['Data Inﾃｭcio']);
                const endDate = this.parseExcelDate(row['Data Termino']);
                
                if (!startDate) errors.push('Data de inﾃｭcio invﾃ｡lida');
                if (!endDate) errors.push('Data de tﾃｩrmino invﾃ｡lida');
                
                if (startDate && endDate) {
                    if (new Date(startDate) > new Date(endDate)) {
                        errors.push('Data de inﾃｭcio nﾃ｣o pode ser posterior ﾃ data de tﾃｩrmino');
                    } else {
                        // NOVA VALIDAﾃﾃグ: Verificar se data ﾃｩ anterior ao projeto
                        if (projectStartDate && new Date(startDate) < new Date(projectStartDate)) {
                            errors.push(`Data de inﾃｭcio nﾃ｣o pode ser anterior ﾃ data do projeto (${new Date(projectStartDate).toLocaleDateString('pt-BR')})`);
                        } else {
                            task.startDate = startDate;
                            task.endDate = endDate;
                        }
                    }
                }

                // Validar status
                const status = row['Status']?.toString().trim();
                const validStatuses = ['Nﾃ｣o Iniciada', 'Em Andamento', 'Concluﾃｭda'];
                if (status && validStatuses.includes(status)) {
                    task.status = status;
                } else if (status) {
                    errors.push(`Status invﾃ｡lido: "${status}". Use: ${validStatuses.join(', ')}`);
                } else {
                    task.status = 'Nﾃ｣o Iniciada';
                }

                // Validar progresso
                const progress = parseInt(row['Progresso (%)']) || 0;
                if (progress < 0 || progress > 100) {
                    errors.push('Progresso deve estar entre 0 e 100');
                } else {
                    task.progress = progress;
                }

                // Validar prioridade
                const priority = row['Prioridade']?.toString().trim();
                const validPriorities = ['Baixa', 'Mﾃｩdia', 'Alta'];
                if (priority && validPriorities.includes(priority)) {
                    task.priority = priority;
                } else if (priority) {
                    errors.push(`Prioridade invﾃ｡lida: "${priority}". Use: ${validPriorities.join(', ')}`);
                } else {
                    task.priority = 'Mﾃｩdia';
                }

                // Processar responsﾃ｡veis
                const assignedNames = row['Atribuﾃｭdo a (Nomes Separados por Vﾃｭrgula)']?.toString();
                if (assignedNames) {
                    task.assignedUsers = this.findUserIdsByNames(assignedNames.split(',').map(name => name.trim()));
                    if (task.assignedUsers.length === 0) {
                        errors.push('Nenhum responsﾃ｡vel vﾃ｡lido encontrado');
                    }
                } else {
                    task.assignedUsers = [];
                }

                // Validar risco
                const risk = row['Risco (Sim/Nao)']?.toString().trim().toLowerCase();
                task.risk = risk === 'sim';

                // Processar tarefa pai
                const parentTaskName = row['Tarefa Pai (Nome)']?.toString().trim();
                if (parentTaskName) {
                    task.parentId = taskNameMap.get(parentTaskName.toLowerCase());
                    if (!task.parentId) {
                        errors.push(`Tarefa pai nﾃ｣o encontrada: "${parentTaskName}"`);
                    }
                } else {
                    task.parentId = null;
                }

                // CORREﾃﾃグ: Gerar ID ﾃｺnico usando Math.random() para evitar duplicaﾃｧﾃ｣o
                task.id = Date.now() + Math.random();
                task.comments = [];
                task.dateHistory = [{ startDate: task.startDate, endDate: task.endDate }];

                return {
                    isValid: errors.length === 0,
                    task: task,
                    errors: errors
                };
            },

            // FUNﾃﾃグ: Finalizar importaﾃｧﾃ｣o
            finalizeImport: async function(validTasks, project) {
                project.tasks = [...project.tasks, ...validTasks];
                
                // ATUALIZAﾃﾃグ AUTOMﾃゝICA: Atualizar datas do projeto se em modo automﾃ｡tico
                dataService.updateProjectDatesIfAuto(project);
                
                dataService.recalculateAllProgress();
                await dataService.saveProjectDocument(project);
                return validTasks.length;
            },

            // Funﾃｧﾃ｣o auxiliar para converter datas do Excel
            parseExcelDate: function(excelDate) {
                if (!excelDate) return null;
                
                try {
                    // Se for nﾃｺmero (formato Excel)
                    if (typeof excelDate === 'number') {
                        const date = new Date((excelDate - 25569) * 86400 * 1000);
                        return date.toISOString().split('T')[0];
                    }
                    
                    // Se for string, tentar parse
                    if (typeof excelDate === 'string') {
                        // Remover espaﾃｧos e tentar diferentes formatos
                        const cleanDate = excelDate.trim();
                        
                        // Formato YYYY-MM-DD
                        if (/^\d{4}-\d{2}-\d{2}$/.test(cleanDate)) {
                            return cleanDate;
                        }
                        
                        // Formato DD/MM/YYYY
                        if (/^\d{2}\/\d{2}\/\d{4}$/.test(cleanDate)) {
                            const parts = cleanDate.split('/');
                            return `${parts[2]}-${parts[1]}-${parts[0]}`;
                        }
                        
                        // Tentar parse automﾃ｡tico
                        const parsedDate = new Date(cleanDate);
                        if (!isNaN(parsedDate.getTime())) {
                            return parsedDate.toISOString().split('T')[0];
                        }
                    }
                    
                    return null;
                } catch (error) {
                    console.warn('Erro ao converter data:', excelDate, error);
                    return null;
                }
            },

            // Funﾃｧﾃ｣o para encontrar IDs de usuﾃ｡rio pelos nomes
            findUserIdsByNames: function(names) {
                return names.map(name => {
                    const user = dataService.users.find(u => 
                        u.name?.toLowerCase().includes(name.toLowerCase()) || 
                        u.email.toLowerCase().includes(name.toLowerCase())
                    );
                    return user?.id || null;
                }).filter(id => id !== null);
            },

            // --- NOVO: SISTEMA DE NOTIFICAﾃﾃ髭S ---
            
            // Funﾃｧﾃ｣o para escutar notificaﾃｧﾃｵes do usuﾃ｡rio atual
            listenToNotifications: function() {
                unsubscribeNotifications();
                if (!dataService.isAuthReady || !dataService.userId) return;

                const notificationsRef = collection(db, 'users_data', dataService.userId, 'notifications');
                
                unsubscribeNotifications = onSnapshot(notificationsRef, (snapshot) => {
                    dataService.notifications = [];
                    snapshot.forEach(doc => {
                        dataService.notifications.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Ordenar notificaﾃｧﾃｵes por data (mais recentes primeiro)
                    dataService.notifications.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    
                    // Atualizar a UI das notificaﾃｧﾃｵes
                    uiService.updateNotificationUI();
                }, (error) => {
                    console.error("Erro ao ouvir notificaﾃｧﾃｵes:", error);
                });
            },

            // Funﾃｧﾃ｣o para enviar notificaﾃｧﾃｵes de atribuiﾃｧﾃ｣o de tarefas
            sendTaskAssignmentNotifications: async function(taskId, taskName, projectId, projectName, assignedUserIds) {
                try {
                    const currentUser = dataService.users.find(u => u.id === dataService.userId);
                    const currentUserName = currentUser?.name || currentUser?.email.split('@')[0] || 'Um utilizador';
                    
                    for (const userId of assignedUserIds) {
                        // Nﾃ｣o enviar notificaﾃｧﾃ｣o para o prﾃｳprio usuﾃ｡rio
                        if (userId === dataService.userId) continue;
                        
                        const notification = {
                            type: 'task_assignment',
                            title: 'Nova tarefa atribuﾃｭda',
                            message: `${currentUserName} atribuiu a tarefa "${taskName}" a vocﾃｪ`,
                            projectId: projectId,
                            projectName: projectName,
                            taskId: taskId,
                            taskName: taskName,
                            read: false,
                            createdAt: new Date().toISOString(),
                            createdBy: dataService.userId
                        };
                        
                        const userNotificationsRef = collection(db, 'users_data', userId, 'notifications');
                        await addDoc(userNotificationsRef, notification);
                    }
                    
                    console.log(`鐙 Notificaﾃｧﾃｵes de atribuiﾃｧﾃ｣o enviadas para ${assignedUserIds.length - (assignedUserIds.includes(dataService.userId) ? 1 : 0)} utilizadores`);
                } catch (error) {
                    console.error("Erro ao enviar notificaﾃｧﾃｵes:", error);
                }
            },

            // Funﾃｧﾃ｣o para marcar notificaﾃｧﾃ｣o como lida
            markNotificationAsRead: async function(notificationId) {
                try {
                    const notificationRef = doc(db, 'users_data', dataService.userId, 'notifications', notificationId);
                    await updateDoc(notificationRef, {
                        read: true,
                        readAt: new Date().toISOString()
                    });
                } catch (error) {
                    console.error("Erro ao marcar notificaﾃｧﾃ｣o como lida:", error);
                }
            },

            // Funﾃｧﾃ｣o para marcar todas as notificaﾃｧﾃｵes como lidas
            markAllNotificationsAsRead: async function() {
                try {
                    const unreadNotifications = dataService.notifications.filter(n => !n.read);
                    
                    for (const notification of unreadNotifications) {
                        await dataService.markNotificationAsRead(notification.id);
                    }
                    
                    uiService.showToast('Todas as notificaﾃｧﾃｵes marcadas como lidas', 'success');
                } catch (error) {
                    console.error("Erro ao marcar todas as notificaﾃｧﾃｵes como lidas:", error);
                    uiService.showToast('Erro ao marcar notificaﾃｧﾃｵes como lidas', 'error');
                }
            },

            // Funﾃｧﾃ｣o para limpar todas as notificaﾃｧﾃｵes
            clearAllNotifications: async function() {
                try {
                    const notificationsRef = collection(db, 'users_data', dataService.userId, 'notifications');
                    const snapshot = await getDocs(notificationsRef);
                    
                    const deletePromises = snapshot.docs.map(doc => deleteDoc(doc.ref));
                    await Promise.all(deletePromises);
                    
                    uiService.showToast('Todas as notificaﾃｧﾃｵes foram removidas', 'success');
                } catch (error) {
                    console.error("Erro ao limpar notificaﾃｧﾃｵes:", error);
                    uiService.showToast('Erro ao limpar notificaﾃｧﾃｵes', 'error');
                }
            },

            // Funﾃｧﾃ｣o para obter o nﾃｺmero de notificaﾃｧﾃｵes nﾃ｣o lidas
            getUnreadNotificationCount: function() {
                return dataService.notifications.filter(n => !n.read).length;
            },

            // --- NOVO: SISTEMA DE ANEXOS ---
            
            // Funﾃｧﾃ｣o para fazer upload de arquivo
            uploadAttachment: async function(file, taskId, projectId) {
                try {
                    // Criar referﾃｪncia no Storage
                    const storageRef = ref(storage, `projetos/${projectId}/${taskId}/${file.name}`);
                    
                    // Fazer upload do arquivo
                    const snapshot = await uploadBytes(storageRef, file);
                    
                    // Obter URL de download
                    const downloadURL = await getDownloadURL(snapshot.ref);
                    
                    return {
                        name: file.name,
                        url: downloadURL,
                        size: file.size,
                        type: file.type,
                        uploadedAt: new Date().toISOString(),
                        uploadedBy: dataService.userId
                    };
                } catch (error) {
                    console.error("Erro ao fazer upload do arquivo:", error);
                    throw error;
                }
            },

            // Funﾃｧﾃ｣o para excluir anexo
            deleteAttachment: async function(fileName, taskId, projectId) {
                try {
                    // Criar referﾃｪncia no Storage
                    const storageRef = ref(storage, `projetos/${projectId}/${taskId}/${fileName}`);
                    
                    // Excluir arquivo
                    await deleteObject(storageRef);
                    
                    return true;
                } catch (error) {
                    console.error("Erro ao excluir arquivo:", error);
                    throw error;
                }
            },

            // Funﾃｧﾃ｣o para obter ﾃｭcone do arquivo baseado na extensﾃ｣o
            getFileIcon: function(fileName) {
                const extension = fileName.split('.').pop().toLowerCase();
                const iconMap = {
                    'pdf': '燈',
                    'doc': '祷',
                    'docx': '祷',
                    'xls': '痘',
                    'xlsx': '痘',
                    'ppt': '等',
                    'pptx': '等',
                    'jpg': '名ｸ',
                    'jpeg': '名ｸ',
                    'png': '名ｸ',
                    'gif': '名ｸ',
                    'zip': '逃',
                    'rar': '逃',
                    'txt': '塘',
                    'csv': '投'
                };
                
                return iconMap[extension] || '梼';
            },

            // --- NOVO: SISTEMA DE MENﾃﾃ髭S ---
            
            // Funﾃｧﾃ｣o para enviar notificaﾃｧﾃ｣o de menﾃｧﾃ｣o
            sendMentionNotification: async function(mentionedUserId, taskId, taskName, projectId, projectName, commentText) {
                try {
                    const currentUser = dataService.users.find(u => u.id === dataService.userId);
                    const currentUserName = currentUser?.name || currentUser?.email.split('@')[0] || 'Um utilizador';
                    
                    const notification = {
                        type: 'mention',
                        title: 'Vocﾃｪ foi mencionado',
                        message: `${currentUserName} mencionou vocﾃｪ em um comentﾃ｡rio na tarefa "${taskName}": "${commentText.substring(0, 100)}${commentText.length > 100 ? '...' : ''}"`,
                        projectId: projectId,
                        projectName: projectName,
                        taskId: taskId,
                        taskName: taskName,
                        read: false,
                        createdAt: new Date().toISOString(),
                        createdBy: dataService.userId
                    };
                    
                    const userNotificationsRef = collection(db, 'users_data', mentionedUserId, 'notifications');
                    await addDoc(userNotificationsRef, notification);
                    
                    console.log(`鐙 Notificaﾃｧﾃ｣o de menﾃｧﾃ｣o enviada para ${mentionedUserId}`);
                } catch (error) {
                    console.error("Erro ao enviar notificaﾃｧﾃ｣o de menﾃｧﾃ｣o:", error);
                }
            },

            // Funﾃｧﾃ｣o para processar menﾃｧﾃｵes em comentﾃ｡rios
            processMentions: async function(commentText, taskId, taskName, projectId, projectName) {
                const mentionRegex = /@\[([^\]]+)\]\(([^)]+)\)/g;
                let match;
                const mentionedUserIds = [];
                
                while ((match = mentionRegex.exec(commentText)) !== null) {
                    const userId = match[2];
                    mentionedUserIds.push(userId);
                    
                    // Enviar notificaﾃｧﾃ｣o para o usuﾃ｡rio mencionado
                    await this.sendMentionNotification(userId, taskId, taskName, projectId, projectName, commentText);
                }
                
                return mentionedUserIds;
            },

            // --- NOVO: SISTEMA DE HISTﾃ迭ICO DE ATIVIDADE ---
            
            // Funﾃｧﾃ｣o para registrar atividade
            logActivity: async function(taskId, projectId, action, details, oldValue = null, newValue = null) {
                try {
                    const currentUser = dataService.users.find(u => u.id === dataService.userId);
                    const currentUserName = currentUser?.name || currentUser?.email.split('@')[0] || 'Um utilizador';
                    
                    const activity = {
                        action: action,
                        details: details,
                        oldValue: oldValue,
                        newValue: newValue,
                        userId: dataService.userId,
                        userName: currentUserName,
                        timestamp: new Date().toISOString(),
                        taskId: taskId,
                        projectId: projectId
                    };
                    
                    // Salvar atividade no Firestore (subcoleﾃｧﾃ｣o da tarefa)
                    const activityRef = collection(db, 'artifacts', appId, 'users', dataService.getProjectOwnerUid(projectId), 'projects', projectId, 'tasks', taskId.toString(), 'activity');
                    await addDoc(activityRef, activity);
                    
                    console.log(`統 Atividade registrada: ${action} para tarefa ${taskId}`);
                } catch (error) {
                    console.error("Erro ao registrar atividade:", error);
                }
            },

            // Funﾃｧﾃ｣o para obter histﾃｳrico de atividade
            getActivityHistory: async function(taskId, projectId) {
                try {
                    const activityRef = collection(db, 'artifacts', appId, 'users', dataService.getProjectOwnerUid(projectId), 'projects', projectId, 'tasks', taskId.toString(), 'activity');
                    const snapshot = await getDocs(activityRef);
                    
                    const activities = [];
                    snapshot.forEach(doc => {
                        activities.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Ordenar por data (mais recente primeiro)
                    activities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    return activities;
                } catch (error) {
                    console.error("Erro ao obter histﾃｳrico de atividade:", error);
                    return [];
                }
            }
        };

        // App Controller
        const App = {
            async init() {
                document.getElementById('loader').style.display = 'flex';
                await dataService.initFirebase(); 
                uiService.initTheme();
                this.bindEvents();
            },
            
            async logout() {
                document.getElementById('loader').style.display = 'flex';
                await signOut(auth);
                document.getElementById('loader').style.display = 'none';
                uiService.showToast('Sessﾃ｣o encerrada com sucesso.', 'success');
            },

            showProjectView() {
                dataService.currentProjectId = null;
                uiService.showView('project-view');
                uiService.renderProjectList(dataService.projects);
                uiService.updateMainDashboard(dataService.projects);
            },
            
            openProject(projectId) {
                dataService.currentProjectId = projectId; 
                const project = dataService.getProjectById(dataService.currentProjectId);
                if (project) {
                    uiService.showView('dashboard-view');
                    uiService.renderProjectDashboard(project);
                }
            },

            bindEvents() {
                document.getElementById('theme-toggle').addEventListener('click', () => uiService.toggleTheme());
                document.getElementById('logout-btn').addEventListener('click', () => App.logout());
                document.getElementById('user-management-btn').addEventListener('click', () => uiService.openUserManagementModal());
                
                // NOVO: Event listeners para o sistema de notificaﾃｧﾃｵes
                document.getElementById('notification-btn').addEventListener('click', () => uiService.toggleNotificationDropdown());
                document.getElementById('mark-all-read-btn').addEventListener('click', () => dataService.markAllNotificationsAsRead());
                document.getElementById('clear-notifications-btn').addEventListener('click', () => dataService.clearAllNotifications());
                
                // CORREﾃﾃグ: Fechar modal de gestﾃ｣o antes de abrir cadastro
                document.getElementById('add-user-btn').addEventListener('click', () => {
                    uiService.closeModal('user-management-modal');
                    setTimeout(() => {
                        uiService.openAddUserModal();
                    }, 300);
                });

                // --- CORREﾃﾃ髭S ADICIONADAS ---
                // CORREﾃﾃグ 1: Botﾃｵes de fechar funcionais para todos os modais
                document.querySelectorAll('.cancel-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const modal = e.target.closest('.modal-transition');
                        if (modal) {
                            uiService.closeModal(modal.id);
                        }
                    });
                });

                // CORREﾃﾃグ 2: Fechar modal de gestﾃ｣o de usuﾃ｡rios
                document.querySelector('#user-management-modal .cancel-btn').addEventListener('click', () => {
                    uiService.closeModal('user-management-modal');
                });

                // CORREﾃﾃグ 3: Fechar modal de adicionar usuﾃ｡rio
                document.querySelector('#add-user-modal .cancel-btn').addEventListener('click', () => {
                    uiService.closeModal('add-user-modal');
                });

                // CORREﾃﾃグ 4: Fechar modal de projeto
                document.querySelector('#project-modal .cancel-btn').addEventListener('click', () => {
                    uiService.closeModal('project-modal');
                });

                // CORREﾃﾃグ 5: Fechar modal de datas do projeto
                document.querySelector('#project-date-modal .cancel-btn').addEventListener('click', () => {
                    uiService.closeModal('project-date-modal');
                });

                // --- AUTENTICAﾃﾃグ ---
                const authForm = document.getElementById('auth-form');
                const authEmail = document.getElementById('auth-email');
                const authPassword = document.getElementById('auth-password');
                const authSecretCode = document.getElementById('auth-secret-code');
                const authSubmitBtn = document.getElementById('auth-submit-btn');
                const secretCodeContainer = document.getElementById('secret-code-container');
                let isLoginMode = true;

                document.getElementById('toggle-auth-mode').addEventListener('click', (e) => {
                    isLoginMode = !isLoginMode;
                    authSubmitBtn.textContent = isLoginMode ? 'Login' : 'Registrar';
                    e.target.textContent = isLoginMode ? 'Precisa de uma conta? Registrar' : 'Jﾃ｡ tenho conta. Login';
                    secretCodeContainer.classList.add('hidden'); // Esconde o cﾃｳdigo secreto ao alternar
                });
                document.getElementById('toggle-secret-code').addEventListener('click', () => {
                    if (!isLoginMode) { // Sﾃｳ permite ver o campo no modo Registro
                         secretCodeContainer.classList.toggle('hidden');
                    }
                });

                authForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = authEmail.value;
                    const password = authPassword.value;
                    const secretCode = authSecretCode.value;

                    if (!email.endsWith(ALLOWED_DOMAIN)) {
                        uiService.showToast(`E-mail invﾃ｡lido. Use o domﾃｭnio ${ALLOWED_DOMAIN}.`, 'error');
                        return;
                    }

                    document.getElementById('loader').style.display = 'flex';
                    try {
                        let userCredential;
                        if (isLoginMode) {
                            userCredential = await signInWithEmailAndPassword(auth, email, password);
                        } else {
                            userCredential = await createUserWithEmailAndPassword(auth, email, password);
                            let role = 'Usuario';
                            if (secretCode === GESTOR_SECRET_CODE) {
                                role = 'Gestor';
                            }
                            await setDoc(doc(db, 'users_data', userCredential.user.uid), {
                                email: email,
                                role: role,
                                appId: appId
                            });
                        }
                    } catch (error) {
                        let errorMessage = error.message;
                        if (error.code === 'auth/email-already-in-use') errorMessage = 'Este e-mail jﾃ｡ estﾃ｡ em uso.';
                        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') errorMessage = 'Credenciais invﾃ｡lidas.';
                        if (error.code === 'auth/weak-password') errorMessage = 'A senha deve ter pelo menos 6 caracteres.';
                        uiService.showToast(`Erro de Autenticaﾃｧﾃ｣o: ${errorMessage}`, 'error');
                        document.getElementById('loader').style.display = 'none';
                    }
                });
                // --- FIM AUTENTICAﾃﾃグ ---
                
                // --- CADASTRO DE USUﾃヽIOS ---
                document.getElementById('add-user-form').addEventListener('submit', async (event) => {
                    event.preventDefault();
                    const name = document.getElementById('new-user-name').value.trim();
                    const email = document.getElementById('new-user-email').value.trim();
                    const role = document.getElementById('new-user-role').value;

                    if (!email) {
                        uiService.showToast('Preencha o e-mail.', 'error');
                        return;
                    }

                    if (!email.endsWith(ALLOWED_DOMAIN)) {
                        uiService.showToast(`E-mail deve terminar com ${ALLOWED_DOMAIN}`, 'error');
                        return;
                    }

                    document.getElementById('loader').style.display = 'flex';
                    try {
                        await dataService.createUserByGestor({ name, email, role });
                        uiService.closeModal('add-user-modal');
                        uiService.showToast('Usuﾃ｡rio cadastrado com sucesso! Email de boas-vindas enviado.', 'success');
                        document.getElementById('add-user-form').reset();
                        
                        // Reabrir modal de gestﾃ｣o apﾃｳs cadastro
                        setTimeout(() => {
                            uiService.openUserManagementModal();
                        }, 500);
                        
                    } catch (error) {
                        console.error('Erro ao cadastrar usuﾃ｡rio:', error);
                        uiService.showToast(`Erro ao cadastrar usuﾃ｡rio: ${error.message}`, 'error');
                    } finally {
                        document.getElementById('loader').style.display = 'none';
                    }
                });

                // MELHORIA 02: Preencher automaticamente o nome do e-mail
                document.getElementById('new-user-email').addEventListener('blur', function() {
                    const email = this.value.trim();
                    const nameInput = document.getElementById('new-user-name');
                    
                    if (email && email.endsWith(ALLOWED_DOMAIN) && (!nameInput.value || nameInput.value === '')) {
                        const nameFromEmail = email.split('@')[0];
                        // Capitalizar primeira letra
                        const capitalizedName = nameFromEmail.charAt(0).toUpperCase() + nameFromEmail.slice(1);
                        nameInput.value = capitalizedName;
                    }
                });
                
                document.getElementById('add-project-btn').addEventListener('click', () => {
                    uiService.populateProjectManagerSelect(); // NOVA LINHA - Popula o select de responsﾃ｡veis
                    uiService.openModal('project-modal');
                });
                
                document.getElementById('project-form').addEventListener('submit', event => {
                    event.preventDefault();
                    const name = document.getElementById('project-name').value.trim();
                    const manager = document.getElementById('project-manager').value;
                    const startDate = document.getElementById('project-start-date').value; // NOVO: Data de inﾃｭcio
                    const endDate = document.getElementById('project-end-date').value;     // NOVO: Data de tﾃｩrmino
                    
                    if (name && manager && startDate && endDate) {
                        if (new Date(startDate) > new Date(endDate)) {
                            uiService.showToast('Data de inﾃｭcio nﾃ｣o pode ser posterior ﾃ data de tﾃｩrmino!', 'error');
                            return;
                        }
                        
                        dataService.addProject({ name, manager, startDate, endDate });
                        uiService.closeModal('project-modal');
                        uiService.showToast('Projeto criado com sucesso! Sincronizando...', 'success');
                    } else {
                        uiService.showToast('Preencha todos os campos obrigatﾃｳrios.', 'error');
                    }
                });
                
                // NOVO: Event listener para ediﾃｧﾃ｣o de datas do projeto
                document.getElementById('edit-project-dates-btn').addEventListener('click', () => {
                    uiService.openProjectDateModal();
                });
                
                // NOVO: Event listener para formulﾃ｡rio de ediﾃｧﾃ｣o de datas do projeto
                document.getElementById('project-date-form').addEventListener('submit', async (event) => {
                    event.preventDefault();
                    const projectId = document.getElementById('edit-project-id').value;
                    const startDate = document.getElementById('edit-project-start-date').value;
                    const endDate = document.getElementById('edit-project-end-date').value;
                    
                    if (!startDate || !endDate) {
                        uiService.showToast('Preencha ambas as datas.', 'error');
                        return;
                    }
                    
                    if (new Date(startDate) > new Date(endDate)) {
                        uiService.showToast('Data de inﾃｭcio nﾃ｣o pode ser posterior ﾃ data de tﾃｩrmino!', 'error');
                        return;
                    }
                    
                    document.getElementById('loader').style.display = 'flex';
                    try {
                        await dataService.updateProjectDates(projectId, startDate, endDate, 'manual');
                        uiService.closeModal('project-date-modal');
                        uiService.showToast('Datas do projeto atualizadas com sucesso!', 'success');
                    } catch (error) {
                        console.error('Erro ao atualizar datas do projeto:', error);
                        uiService.showToast('Erro ao atualizar datas do projeto.', 'error');
                    } finally {
                        document.getElementById('loader').style.display = 'none';
                    }
                });
                
                document.getElementById('project-list').addEventListener('click', event => {
                    const deleteBtn = event.target.closest('.delete-project-btn');
                    
                    if (deleteBtn) {
                        event.stopPropagation();
                        const projectId = deleteBtn.dataset.projectId;
                        uiService.showConfirmModal('Excluir este projeto e todas as suas tarefas? Esta aﾃｧﾃ｣o ﾃｩ permanente.', async () => {
                            document.getElementById('loader').style.display = 'flex';
                            await dataService.deleteProject(projectId);
                            document.getElementById('loader').style.display = 'none';
                            uiService.showToast('Projeto excluﾃｭdo. Sincronizando...', 'error');
                        });
                        return; 
                    }
                    
                    const card = event.target.closest('.project-card-link');
                    if (card) {
                        this.openProject(card.dataset.projectId);
                    }
                });
                
                document.getElementById('back-to-projects-btn').addEventListener('click', () => this.showProjectView());
                document.getElementById('add-task-btn').addEventListener('click', () => uiService.openTaskModal('add'));
                
                // NOVO: Event listener para o botﾃ｣o de filtrar tarefas de hoje
                document.getElementById('filter-today-btn').addEventListener('click', () => {
                    const project = dataService.getCurrentProject();
                    if (!project) return;
                    
                    const todayTasks = dataService.taskService.getTodayRunningTasks(project);
                    uiService.renderTaskTable(todayTasks);
                    
                    // Atualizar o contador no filtro
                    const taskFilterInput = document.getElementById('task-filter-input');
                    taskFilterInput.value = '';
                    taskFilterInput.placeholder = `Filtrando: ${todayTasks.length} tarefa(s) de hoje`;
                    
                    uiService.showToast(`Mostrando ${todayTasks.length} tarefa(s) em execuﾃｧﾃ｣o hoje`, 'success');
                });
                
                document.getElementById('task-form').addEventListener('submit', async event => {
                    event.preventDefault();
                    const taskData = uiService.getTaskFormData();
                    
                    // Validaﾃｧﾃ｣o bﾃ｡sica de datas
                    if (new Date(taskData.newStartDate) > new Date(taskData.newEndDate)) {
                        uiService.showToast('Data de Inﾃｭcio nﾃ｣o pode ser posterior ﾃ Data de Tﾃｩrmino!', 'error');
                        return;
                    }

                    // MELHORIA 01: Validaﾃｧﾃ｣o adicional para subtarefas
                    if (taskData.parentId) {
                        const project = dataService.getCurrentProject();
                        const parentTask = project.tasks.find(t => t.id === taskData.parentId);
                        if (parentTask) {
                            const parentDates = dataService.getLatestDates(parentTask);
                            const parentStart = new Date(parentDates.startDate);
                            const childStart = new Date(taskData.newStartDate);

                            if (childStart < parentStart) {
                                uiService.showToast('A subtarefa nﾃ｣o pode comeﾃｧar antes da tarefa pai!', 'error');
                                return;
                            }
                        }
                    }
                    
                    document.getElementById('loader').style.display = 'flex';
                    await dataService.saveTask(taskData); 
                    document.getElementById('loader').style.display = 'none';

                    uiService.closeModal('task-modal');
                    uiService.showToast('Tarefa salva! Sincronizando...');
                });

                document.getElementById('add-comment-btn').addEventListener('click', () => {
                    const input = document.getElementById('new-comment-input');
                    const text = input.value.trim();
                    if(text) {
                        uiService.addComment(text);
                        input.value = '';
                    }
                });
                
                document.getElementById('new-comment-input').addEventListener('keypress', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault(); 
                        document.getElementById('add-comment-btn').click(); 
                    }
                });


                document.getElementById('task-table-body').addEventListener('click', event => {
                    const button = event.target.closest('button');
                    const taskNameEl = event.target.closest('.task-edit-trigger');

                    if (taskNameEl) {
                        const taskId = parseFloat(taskNameEl.dataset.taskId); // CORREﾃﾃグ: Usar parseFloat para IDs com decimais
                        uiService.openTaskModal('edit', { taskId });
                        return;
                    }

                    if (!button) return;
                    const taskId = parseFloat(button.dataset.taskId); // CORREﾃﾃグ: Usar parseFloat para IDs com decimais
                    const parentId = parseFloat(button.dataset.parentId);
                    
                    if (button.classList.contains('add-subtask-btn')) uiService.openTaskModal('add', { parentId });
                    if (button.classList.contains('edit-task-btn')) uiService.openTaskModal('edit', { taskId });
                    
                    if (button.classList.contains('delete-task-btn')) {
                        uiService.showConfirmModal('Excluir esta tarefa e suas subtarefas?', async () => {
                            document.getElementById('loader').style.display = 'flex';
                            await dataService.deleteTask(taskId);
                            document.getElementById('loader').style.display = 'none';
                            uiService.showToast('Tarefa excluﾃｭda. Sincronizando...', 'error');
                        });
                    }
                });

                document.getElementById('task-filter-input').addEventListener('input', (e) => {
                    uiService.renderProjectDashboard(dataService.getCurrentProject(), e.target.value);
                });

                document.getElementById('view-switcher').addEventListener('change', (e) => uiService.switchView(e.target.value));
                document.getElementById('export-excel-btn').addEventListener('click', () => reportService.exportExcel(dataService.getCurrentProject()));
                document.getElementById('generate-pdf-report-btn').addEventListener('click', () => reportService.generatePdf(dataService.getCurrentProject()));
                document.getElementById('print-view-btn').addEventListener('click', () => window.print());
                document.getElementById('download-template-btn').addEventListener('click', () => reportService.downloadExcelTemplate());
                document.getElementById('import-excel-btn').addEventListener('click', () => document.getElementById('import-excel-input').click());
                
                // ATUALIZADO: Evento de importaﾃｧﾃ｣o com nova funcionalidade
                document.getElementById('import-excel-input').addEventListener('change', async (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        document.getElementById('loader').style.display = 'flex';
                        try {
                            // Usar a nova funﾃｧﾃ｣o de importaﾃｧﾃ｣o com validaﾃｧﾃ｣o
                            const result = await dataService.processImportWithValidation(file);
                            
                            if (!result.needsAdjustment) {
                                uiService.showToast(`${result.count} tarefas importadas com sucesso!`, 'success');
                            }
                            // Se needsAdjustment = true, o modal de ajustes jﾃ｡ foi aberto automaticamente
                            
                        } catch (error) {
                            console.error('Erro na importaﾃｧﾃ｣o:', error);
                            
                            // Mensagens de erro mais especﾃｭficas
                            let errorMessage = 'Erro ao importar arquivo. ';
                            
                            if (error.message.includes('vazia')) {
                                errorMessage += 'A planilha estﾃ｡ vazia.';
                            } else if (error.message.includes('formato')) {
                                errorMessage += 'Formato de arquivo invﾃ｡lido. Use .xlsx ou .xls.';
                            } else if (error.message.includes('projeto')) {
                                errorMessage += 'Nenhum projeto selecionado.';
                            } else {
                                errorMessage += `Detalhes: ${error.message}`;
                            }
                            
                            uiService.showToast(errorMessage, 'error');
                        } finally {
                            document.getElementById('loader').style.display = 'none';
                            event.target.value = '';
                        }
                    }
                });

                // NOVO: Event listeners para o modal de confirmaﾃｧﾃ｣o de datas de subtarefas
                document.getElementById('subtask-date-cancel-btn').addEventListener('click', () => {
                    uiService.closeModal('subtask-date-confirm-modal');
                    uiService.subtaskDateConfirmResolve(false);
                });

                document.getElementById('subtask-date-confirm-btn').addEventListener('click', () => {
                    const updateParent = document.getElementById('update-parent-dates').checked;
                    uiService.closeModal('subtask-date-confirm-modal');
                    uiService.subtaskDateConfirmResolve(updateParent);
                });

                // NOVO: Event listeners para os botﾃｵes de visualizaﾃｧﾃ｣o Cards/Lista
                document.getElementById('view-cards-btn').addEventListener('click', () => {
                    uiService.switchProjectView('cards');
                });

                document.getElementById('view-list-btn').addEventListener('click', () => {
                    uiService.switchProjectView('list');
                });

                // NOVO: Sincronizar range com input numﾃｩrico de progresso
                document.getElementById('task-progress-range').addEventListener('input', function() {
                    document.getElementById('task-progress').value = this.value;
                });

                document.getElementById('task-progress').addEventListener('input', function() {
                    document.getElementById('task-progress-range').value = this.value;
                });

                // NOVO: Event listeners para abas de comentﾃ｡rios/atividade
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabName = tab.dataset.tab;
                        uiService.switchTab(tabName);
                    });
                });

                // NOVO: Event listeners para sistema de anexos
                document.getElementById('upload-area').addEventListener('click', () => {
                    document.getElementById('file-upload').click();
                });

                document.getElementById('file-upload').addEventListener('change', (event) => {
                    uiService.handleFileUpload(event.target.files);
                });

                // NOVO: Drag and drop para ﾃ｡rea de upload
                const uploadArea = document.getElementById('upload-area');
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    uiService.handleFileUpload(e.dataTransfer.files);
                });

                // NOVO: Event listener para menﾃｧﾃｵes
                document.getElementById('new-comment-input').addEventListener('input', (e) => {
                    uiService.handleMentionInput(e);
                });

                document.getElementById('new-comment-input').addEventListener('keydown', (e) => {
                    uiService.handleMentionKeydown(e);
                });
            }
        };

        // UI Service - Manages all DOM interactions
        const uiService = {
            mainDashboardCharts: {},
            editingCommentId: null, // Para controle de ediﾃｧﾃ｣o de comentﾃ｡rios
            subtaskDateConfirmResolve: null, // Para resolver a Promise do modal de confirmaﾃｧﾃ｣o
            notificationDropdownVisible: false, // NOVO: Controla visibilidade do dropdown de notificaﾃｧﾃｵes
            mentionSuggestionsVisible: false, // NOVO: Controla visibilidade das sugestﾃｵes de menﾃｧﾃ｣o
            currentMentionStart: -1, // NOVO: Posiﾃｧﾃ｣o inicial da menﾃｧﾃ｣o atual
            mentionedUsers: [], // NOVO: Usuﾃ｡rios mencionados no comentﾃ｡rio atual

            // --- AUTH UI ---
            updateUserRoleDisplay: () => {
                const roleEl = document.getElementById('user-role-display');
                const btn = document.getElementById('user-management-btn');
                
                if (dataService.userRole) {
                    roleEl.textContent = `Papel: ${dataService.userRole}`;
                    roleEl.classList.remove('bg-blue-100', 'dark:bg-blue-900', 'text-blue-700', 'dark:text-blue-300', 'bg-green-100', 'dark:bg-green-900', 'text-green-700', 'dark:text-green-300');
                    
                    if (dataService.userRole === 'Gestor') {
                        roleEl.classList.add('bg-green-100', 'dark:bg-green-900', 'text-green-700', 'dark:text-green-300');
                        btn.classList.remove('hidden');
                    } else {
                         roleEl.classList.add('bg-blue-100', 'dark:bg-blue-900', 'text-blue-700', 'dark:text-blue-300');
                         btn.classList.add('hidden');
                    }
                }
            },
            
            // --- USER MANAGEMENT UI (Gestor) ---
            openUserManagementModal: () => {
                if (dataService.userRole !== 'Gestor') {
                    uiService.showToast('Acesso negado: Apenas Gestores podem gerir utilizadores.', 'error');
                    return;
                }
                uiService.renderUserManagementTable();
                uiService.openModal('user-management-modal');
            },

            openAddUserModal: () => {
                if (dataService.userRole !== 'Gestor') {
                    uiService.showToast('Acesso negado: Apenas Gestores podem cadastrar usuﾃ｡rios.', 'error');
                    return;
                }
                document.getElementById('add-user-form').reset();
                uiService.openModal('add-user-modal');
            },
            
            // NOVA FUNﾃﾃグ: Abrir modal de ediﾃｧﾃ｣o de datas do projeto
            openProjectDateModal: function() {
                const project = dataService.getCurrentProject();
                if (!project) return;
                
                document.getElementById('edit-project-id').value = project.id;
                document.getElementById('edit-project-start-date').value = project.startDate;
                document.getElementById('edit-project-end-date').value = project.endDate;
                
                // Verificar se o projeto tem subtarefas para determinar se pode editar manualmente
                const hasSubtasks = dataService.projectHasSubtasks(project);
                
                if (hasSubtasks && project.dateMode === 'auto') {
                    document.getElementById('edit-project-start-date').disabled = true;
                    document.getElementById('edit-project-end-date').disabled = true;
                    uiService.showToast('As datas do projeto sﾃ｣o automﾃ｡ticas devido ﾃs subtarefas existentes.', 'info');
                } else {
                    document.getElementById('edit-project-start-date').disabled = false;
                    document.getElementById('edit-project-end-date').disabled = false;
                }
                
                this.openModal('project-date-modal');
            },
            
            renderUserManagementTable: () => {
                const tbody = document.getElementById('user-management-table-body');
                tbody.innerHTML = '';

                dataService.users.forEach(user => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-[var(--border-color)]';
                    
                    const roleOptions = ['Usuario', 'Gestor'].map(role => 
                        `<option value="${role}" ${user.role === role ? 'selected' : ''}>${role}</option>`
                    ).join('');

                    // Desabilita a ediﾃｧﾃ｣o do prﾃｳprio papel
                    const isSelf = user.id === dataService.userId;
                    const isDisabled = isSelf ? 'disabled' : '';

                    row.innerHTML = `
                        <td class="p-3 font-medium">${user.name || 'Nﾃ｣o informado'}</td>
                        <td class="p-3">${user.email}</td>
                        <td class="p-3">
                            <select data-user-id="${user.id}" class="user-role-select border border-[var(--border-color)] rounded-md p-1 bg-[var(--card-bg)] text-gray-800 dark:text-gray-200" ${isDisabled}>
                                ${roleOptions}
                            </select>
                        </td>
                        <td class="p-3">
                            <span class="px-2 py-1 rounded-full text-xs ${user.role === 'Gestor' ? 'bg-green-600 text-white' : 'bg-blue-600 text-white'}">
                                ${user.role}
                            </span>
                        </td>
                        <td class="p-3 text-center">
                            <div class="flex justify-center gap-2">
                                <button data-user-id="${user.id}" class="save-role-btn bg-blue-500 text-white px-3 py-1 rounded-md text-xs ${isDisabled ? 'opacity-50 cursor-not-allowed' : ''}" ${isDisabled}>Salvar Papel</button>
                                <button data-user-email="${user.email}" class="reset-password-btn bg-orange-500 text-white px-3 py-1 rounded-md text-xs hover:bg-orange-600">Redefinir Senha</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                tbody.querySelectorAll('.save-role-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const uid = btn.dataset.userId;
                        const selectEl = tbody.querySelector(`select[data-user-id="${uid}"]`);
                        const newRole = selectEl.value;
                        
                        document.getElementById('loader').style.display = 'flex';
                        await dataService.updateUserRole(uid, newRole);
                        document.getElementById('loader').style.display = 'none';
                    });
                });

                tbody.querySelectorAll('.reset-password-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const email = btn.dataset.userEmail;
                        uiService.showConfirmModal(`Enviar email de redefiniﾃｧﾃ｣o de senha para ${email}?`, async () => {
                            document.getElementById('loader').style.display = 'flex';
                            await dataService.resetUserPassword(email);
                            document.getElementById('loader').style.display = 'none';
                        });
                    });
                });
            },

            // --- TASK UI HELPERS ---
            populateAssignedUsersCheckboxes: function() {
                const container = document.getElementById('assigned-users-container');
                container.innerHTML = '';
                
                dataService.users.filter(u => u.email).forEach(user => {
                    const checkboxItem = document.createElement('div');
                    checkboxItem.className = 'user-checkbox-item';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = user.id;
                    checkbox.id = `user-${user.id}`;
                    checkbox.className = 'user-checkbox';
                    
                    const label = document.createElement('label');
                    label.htmlFor = `user-${user.id}`;
                    label.textContent = `${user.name || user.email.split('@')[0]} (${user.role})`;
                    label.className = 'text-sm text-gray-700 dark:text-gray-300';
                    
                    checkboxItem.appendChild(checkbox);
                    checkboxItem.appendChild(label);
                    container.appendChild(checkboxItem);
                });
            },

            // NOVA FUNﾃﾃグ: Popula o select de responsﾃ｡veis do projeto
            populateProjectManagerSelect: function() {
                const selectEl = document.getElementById('project-manager');
                selectEl.innerHTML = '<option value="">Selecione um responsﾃ｡vel</option>';
                
                dataService.users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.name || user.email.split('@')[0]} (${user.role})`;
                    selectEl.appendChild(option);
                });
            },

            // NOVA FUNﾃﾃグ: Mostrar modal de confirmaﾃｧﾃ｣o para datas de subtarefas
            showSubtaskDateConfirmModal: function(subtaskName, subtaskStartDate, subtaskEndDate, parentStartDate, parentEndDate) {
                return new Promise((resolve) => {
                    this.subtaskDateConfirmResolve = resolve;
                    
                    const body = document.getElementById('subtask-date-confirm-body');
                    body.innerHTML = `
                        A subtarefa "<strong>${subtaskName}</strong>" possui datas fora do intervalo da tarefa pai.<br><br>
                        <strong>Subtarefa:</strong> ${new Date(subtaskStartDate).toLocaleDateString('pt-BR')} - ${new Date(subtaskEndDate).toLocaleDateString('pt-BR')}<br>
                        <strong>Tarefa Pai:</strong> ${new Date(parentStartDate).toLocaleDateString('pt-BR')} - ${new Date(parentEndDate).toLocaleDateString('pt-BR')}<br><br>
                        Deseja ajustar as datas da tarefa pai para acomodar a subtarefa?
                    `;
                    
                    this.openModal('subtask-date-confirm-modal');
                });
            },

            // NOVA FUNﾃﾃグ: Mostrar modal de ajustes de importaﾃｧﾃ｣o
            showImportAdjustmentModal: function(importResults) {
                this.openModal('import-adjustment-modal');
                
                // Atualizar contadores
                document.getElementById('import-valid-count').textContent = importResults.validTasks.length;
                document.getElementById('import-total-count').textContent = importResults.validTasks.length + importResults.invalidTasks.length;
                document.getElementById('confirm-count').textContent = importResults.validTasks.length;
                
                // Listar erros gerais
                const errorsList = document.getElementById('import-errors-list');
                const errorMessages = [...new Set(importResults.invalidTasks.flatMap(item => item.errors))];
                errorsList.innerHTML = errorMessages.map(error => 
                    `<div>窶｢ ${error}</div>`
                ).join('');
                
                // Preencher tabela de ajustes
                const tableBody = document.getElementById('import-adjustment-table-body');
                tableBody.innerHTML = '';
                
                importResults.invalidTasks.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-[var(--border-color)] import-error-row';
                    
                    // Buscar opﾃｧﾃｵes de tarefas pai
                    const parentOptions = this.getParentTaskOptions(importResults.taskNameMap);
                    
                    row.innerHTML = `
                        <td class="p-2">${item.row}</td>
                        <td class="p-2">
                            <input type="text" class="adjust-task-name border border-[var(--border-color)] rounded p-1 w-full text-black" 
                                   value="${item.data['Tarefa'] || ''}" data-index="${index}">
                        </td>
                        <td class="p-2">
                            <input type="date" class="adjust-start-date border border-[var(--border-color)] rounded p-1 w-full text-black" 
                                   value="${item.task.startDate || ''}" data-index="${index}">
                        </td>
                        <td class="p-2">
                            <input type="date" class="adjust-end-date border border-[var(--border-color)] rounded p-1 w-full text-black" 
                                   value="${item.task.endDate || ''}" data-index="${index}">
                        </td>
                        <td class="p-2">
                            <select class="adjust-status border border-[var(--border-color)] rounded p-1 w-full text-black" data-index="${index}">
                                <option value="Nﾃ｣o Iniciada" ${item.task.status === 'Nﾃ｣o Iniciada' ? 'selected' : ''}>Nﾃ｣o Iniciada</option>
                                <option value="Em Andamento" ${item.task.status === 'Em Andamento' ? 'selected' : ''}>Em Andamento</option>
                                <option value="Concluﾃｭda" ${item.task.status === 'Concluﾃｭda' ? 'selected' : ''}>Concluﾃｭda</option>
                            </select>
                        </td>
                        <td class="p-2">
                            <input type="text" class="adjust-assigned border border-[var(--border-color)] rounded p-1 w-full text-black" 
                                   value="${item.data['Atribuﾃｭdo a (Nomes Separados por Vﾃｭrgula)'] || ''}" 
                                   placeholder="Nomes separados por vﾃｭrgula" data-index="${index}">
                        </td>
                        <td class="p-2">
                            <select class="adjust-parent border border-[var(--border-color)] rounded p-1 w-full text-black" data-index="${index}">
                                <option value="">Nenhuma</option>
                                ${parentOptions}
                            </select>
                        </td>
                        <td class="p-2 text-red-500 text-xs">
                            ${item.errors.join(', ')}
                        </td>
                        <td class="p-2 text-center">
                            <button class="validate-row-btn bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600" data-index="${index}">
                                Validar
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                    
                    // Configurar tarefa pai se existir
                    if (item.data['Tarefa Pai (Nome)']) {
                        const parentSelect = row.querySelector('.adjust-parent');
                        const parentName = item.data['Tarefa Pai (Nome)'].toLowerCase();
                        Array.from(parentSelect.options).forEach(option => {
                            if (option.text.toLowerCase() === parentName) {
                                option.selected = true;
                            }
                        });
                    }
                });
                
                // Configurar event listeners
                this.setupImportAdjustmentEvents(importResults);
            },

            // FUNﾃﾃグ: Obter opﾃｧﾃｵes de tarefas pai
            getParentTaskOptions: function(taskNameMap) {
                let options = '';
                taskNameMap.forEach((id, name) => {
                    // Capitalizar nome para exibiﾃｧﾃ｣o
                    const displayName = name.charAt(0).toUpperCase() + name.slice(1);
                    options += `<option value="${id}">${displayName}</option>`;
                });
                return options;
            },

            // FUNﾃﾃグ: Configurar eventos do modal de ajustes
            setupImportAdjustmentEvents: function(importResults) {
                let currentResults = importResults;
                
                // Botﾃ｣o validar linha
                document.querySelectorAll('.validate-row-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        this.validateSingleRow(index, currentResults);
                    });
                });
                
                // Botﾃ｣o cancelar
                document.getElementById('cancel-import-btn').onclick = () => {
                    this.closeModal('import-adjustment-modal');
                    uiService.showToast('Importaﾃｧﾃ｣o cancelada', 'error');
                };
                
                // Botﾃ｣o confirmar importaﾃｧﾃ｣o
                document.getElementById('confirm-import-btn').onclick = async () => {
                    document.getElementById('loader').style.display = 'flex';
                    try {
                        await dataService.finalizeImport(currentResults.validTasks, dataService.getCurrentProject());
                        this.closeModal('import-adjustment-modal');
                        uiService.showToast(`${currentResults.validTasks.length} tarefas importadas com sucesso!`, 'success');
                    } catch (error) {
                        console.error('Erro ao finalizar importaﾃｧﾃ｣o:', error);
                        uiService.showToast('Erro ao importar tarefas', 'error');
                    } finally {
                        document.getElementById('loader').style.display = 'none';
                    }
                };
            },

            // FUNﾃﾃグ: Validar linha individual no modal
            validateSingleRow: function(rowIndex, importResults) {
                const row = importResults.invalidTasks[rowIndex];
                const rowElement = document.querySelectorAll('#import-adjustment-table-body tr')[rowIndex];
                
                // Coletar dados atualizados
                const updatedData = {
                    'Tarefa': rowElement.querySelector('.adjust-task-name').value,
                    'Data Inﾃｭcio': rowElement.querySelector('.adjust-start-date').value,
                    'Data Termino': rowElement.querySelector('.adjust-end-date').value,
                    'Status': rowElement.querySelector('.adjust-status').value,
                    'Atribuﾃｭdo a (Nomes Separados por Vﾃｭrgula)': rowElement.querySelector('.adjust-assigned').value,
                    'Tarefa Pai (Nome)': rowElement.querySelector('.adjust-parent').selectedOptions[0]?.text || ''
                };
                
                // Validar novamente
                const project = dataService.getCurrentProject();
                const validationResult = dataService.validateImportRow(updatedData, row.row, importResults.taskNameMap, project.startDate);
                
                if (validationResult.isValid) {
                    // Mover para vﾃ｡lidas
                    importResults.validTasks.push(validationResult.task);
                    importResults.invalidTasks.splice(rowIndex, 1);
                    
                    // Atualizar UI
                    this.showImportAdjustmentModal(importResults);
                    uiService.showToast('Linha corrigida e validada!', 'success');
                } else {
                    // Atualizar erros
                    row.errors = validationResult.errors;
                    const errorCell = rowElement.querySelector('td:nth-child(8)');
                    errorCell.innerHTML = validationResult.errors.join(', ');
                    errorCell.className = 'p-2 text-red-500 text-xs';
                    
                    uiService.showToast('Ainda hﾃ｡ problemas na linha', 'error');
                }
            },

            // NOVA FUNﾃﾃグ: Modal de confirmaﾃｧﾃ｣o que retorna uma Promise
            showConfirmModalPromise: function(message, title = 'Confirmar Aﾃｧﾃ｣o') {
                return new Promise((resolve) => {
                    const modal = document.getElementById('confirm-modal');
                    const titleEl = document.getElementById('confirm-modal-title');
                    const bodyEl = document.getElementById('confirm-modal-body');
                    const okBtn = document.getElementById('confirm-ok-btn');
                    const cancelBtn = document.getElementById('confirm-cancel-btn');

                    titleEl.textContent = title;
                    bodyEl.textContent = message;

                    // Remover event listeners anteriores
                    const newOkBtn = okBtn.cloneNode(true);
                    const newCancelBtn = cancelBtn.cloneNode(true);
                    okBtn.parentNode.replaceChild(newOkBtn, okBtn);
                    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

                    const cleanup = () => {
                        newOkBtn.removeEventListener('click', onConfirm);
                        newCancelBtn.removeEventListener('click', onCancel);
                        this.closeModal('confirm-modal');
                    };

                    const onConfirm = () => {
                        cleanup();
                        resolve(true);
                    };

                    const onCancel = () => {
                        cleanup();
                        resolve(false);
                    };

                    newOkBtn.addEventListener('click', onConfirm);
                    newCancelBtn.addEventListener('click', onCancel);

                    this.openModal('confirm-modal');
                });
            },

            // NOVA FUNﾃﾃグ: Alternar entre visualizaﾃｧﾃ｣o Cards/Lista
            switchProjectView: function(viewType) {
                const cardsBtn = document.getElementById('view-cards-btn');
                const listBtn = document.getElementById('view-list-btn');
                const cardView = document.getElementById('project-list');
                const listView = document.getElementById('project-list-table');

                if (viewType === 'cards') {
                    // Ativar cards
                    cardsBtn.classList.add('bg-blue-600', 'text-white');
                    cardsBtn.classList.remove('bg-gray-300', 'text-gray-800');
                    
                    listBtn.classList.add('bg-gray-300', 'text-gray-800');
                    listBtn.classList.remove('bg-blue-600', 'text-white');
                    
                    // Mostrar cards, ocultar lista
                    cardView.classList.remove('hidden');
                    listView.classList.add('hidden');
                    
                } else if (viewType === 'list') {
                    // Ativar lista
                    listBtn.classList.add('bg-blue-600', 'text-white');
                    listBtn.classList.remove('bg-gray-300', 'text-gray-800');
                    
                    cardsBtn.classList.add('bg-gray-300', 'text-gray-800');
                    cardsBtn.classList.remove('bg-blue-600', 'text-white');
                    
                    // Mostrar lista, ocultar cards
                    listView.classList.remove('hidden');
                    cardView.classList.add('hidden');
                    
                    // Renderizar a lista se necessﾃ｡rio
                    this.renderProjectListTable(dataService.projects);
                }
            },

            // NOVA FUNﾃﾃグ: Renderizar lista de projetos em formato de tabela
            renderProjectListTable: function(projects) {
                const body = document.getElementById("project-table-body");

                if (!projects || projects.length === 0) {
                    body.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-gray-400">Nenhum projeto encontrado.</td></tr>`;
                    return;
                }

                body.innerHTML = projects.map(p => {
                    const progress = dataService.getProjectProgress(p.tasks);
                    const manager = dataService.getManagerName(p.manager) || "Nﾃ｣o informado";
                    const start = p.startDate ? new Date(p.startDate).toLocaleDateString("pt-BR") : "窶";
                    const end = p.endDate ? new Date(p.endDate).toLocaleDateString("pt-BR") : "窶";
                    const status = progress === 100 ? "Concluﾃｭdo" : progress > 0 ? "Em Andamento" : "Nﾃ｣o iniciado";
                    
                    // Verificar se o projeto estﾃ｡ atrasado
                    const today = new Date();
                    const endDate = p.endDate ? new Date(p.endDate) : null;
                    const isOverdue = endDate && endDate < today && progress < 100;
                    const rowClass = isOverdue ? 'project-overdue' : '';

                    return `
                        <tr class="border-b border-[var(--border-color)] ${rowClass}">
                            <td class="p-3 font-medium">${p.name}</td>
                            <td class="p-3">${manager}</td>
                            <td class="p-3">
                                <div class="flex items-center gap-2">
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                        <div class="bg-blue-600 h-2 rounded-full" style="width: ${progress}%"></div>
                                    </div>
                                    <span class="text-sm">${progress}%</span>
                                </div>
                            </td>
                            <td class="p-3">
                                <span class="px-2 py-1 rounded-full text-xs ${isOverdue ? 'bg-red-600 text-white' : status === 'Concluﾃｭdo' ? 'bg-green-600 text-white' : status === 'Em Andamento' ? 'bg-yellow-500 text-black' : 'bg-gray-500 text-white'}">
                                    ${isOverdue ? 'Atrasado' : status}
                                </span>
                            </td>
                            <td class="p-3">${start}</td>
                            <td class="p-3">${end}</td>
                            <td class="p-3 text-center">
                                <button class="open-project bg-blue-600 text-white px-2 py-1 rounded text-xs hover:bg-blue-700" data-id="${p.id}">Abrir</button>
                                <button class="delete-project bg-red-600 text-white px-2 py-1 rounded text-xs hover:bg-red-700 ml-2" data-id="${p.id}">Excluir</button>
                            </td>
                        </tr>`;
                }).join("");

                // Adicionar event listeners
                setTimeout(() => {
                    document.querySelectorAll(".open-project").forEach(btn => {
                        btn.addEventListener("click", () => App.openProject(btn.dataset.id));
                    });

                    document.querySelectorAll(".delete-project").forEach(btn => {
                        btn.addEventListener("click", () => {
                            uiService.showConfirmModal("Excluir o projeto?", async () => {
                                document.getElementById('loader').style.display = 'flex';
                                await dataService.deleteProject(btn.dataset.id);
                                document.getElementById('loader').style.display = 'none';
                                uiService.showToast("Projeto excluﾃｭdo", "error");
                            });
                        });
                    });
                }, 20);
            },

            // NOVA FUNﾃﾃグ: Configurar drag and drop para subtarefas (CORRIGIDA)
            setupSubtasksDragAndDrop: function() {
                const tableBody = document.getElementById('task-table-body');
                
                // Limpar event listeners anteriores
                tableBody.querySelectorAll('tr').forEach(row => {
                    row.removeEventListener('dragstart', this.handleDragStart);
                    row.removeEventListener('dragover', this.handleDragOver);
                    row.removeEventListener('drop', this.handleDrop);
                    row.removeEventListener('dragend', this.handleDragEnd);
                    row.draggable = false;
                });

                // Encontrar todas as linhas que sﾃ｣o subtarefas
                const subtaskRows = Array.from(tableBody.querySelectorAll('tr')).filter(row => {
                    const taskNameCell = row.querySelector('td:first-child');
                    if (!taskNameCell) return false;
                    
                    // Verificar se tem o ﾃｭcone de drag handle
                    const hasDragHandle = taskNameCell.querySelector('.drag-handle');
                    return hasDragHandle !== null;
                });

                console.log(`肌 Configurando drag and drop para ${subtaskRows.length} subtarefas`);

                // Configurar drag and drop para cada subtarefa
                subtaskRows.forEach(row => {
                    row.setAttribute('draggable', 'true');
                    row.addEventListener('dragstart', this.handleDragStart.bind(this));
                    row.addEventListener('dragover', this.handleDragOver.bind(this));
                    row.addEventListener('drop', this.handleDrop.bind(this));
                    row.addEventListener('dragend', this.handleDragEnd.bind(this));
                    
                    // Adicionar feedback visual
                    row.style.transition = 'all 0.2s ease';
                });
            },

            // Handlers para drag and drop (ATUALIZADOS)
            handleDragStart: function(e) {
                const row = e.target.closest('tr');
                if (!row) return;

                // Encontrar o ID da tarefa
                const taskNameElement = row.querySelector('.task-edit-trigger');
                if (!taskNameElement) return;

                const taskId = parseFloat(taskNameElement.dataset.taskId);
                e.dataTransfer.setData('text/plain', taskId.toString());
                e.dataTransfer.effectAllowed = 'move';
                
                row.classList.add('dragging');
                row.style.opacity = '0.6';
                row.style.background = '#f0f9ff';
                
                console.log(`噫 Iniciando drag da tarefa: ${taskId}`);
            },

            handleDragOver: function(e) {
                e.preventDefault();
                const row = e.target.closest('tr');
                if (!row) return;

                const draggingTaskId = parseFloat(e.dataTransfer.getData('text/plain'));
                const targetTaskId = this.getTaskIdFromRow(row);
                
                if (this.canReorder(draggingTaskId, targetTaskId)) {
                    e.dataTransfer.dropEffect = 'move';
                    row.classList.add('drag-over');
                    row.style.background = '#e0f2fe';
                    row.style.borderTop = '2px solid #0ea5e9';
                } else {
                    e.dataTransfer.dropEffect = 'none';
                    row.classList.remove('drag-over');
                    row.style.background = '';
                    row.style.borderTop = '';
                }
            },

            handleDrop: function(e) {
                e.preventDefault();
                const targetRow = e.target.closest('tr');
                if (!targetRow) return;

                const draggingTaskId = parseFloat(e.dataTransfer.getData('text/plain'));
                const targetTaskId = this.getTaskIdFromRow(targetRow);
                
                if (!this.canReorder(draggingTaskId, targetTaskId)) {
                    this.cleanupDragState();
                    return;
                }

                console.log(`識 Soltando tarefa ${draggingTaskId} na posiﾃｧﾃ｣o da tarefa ${targetTaskId}`);
                
                // Reordenar as subtarefas
                this.reorderSubtasks(draggingTaskId, targetTaskId);
                this.cleanupDragState();
            },

            handleDragEnd: function(e) {
                console.log('爆 Drag finalizado');
                this.cleanupDragState();
            },

            cleanupDragState: function() {
                const tableBody = document.getElementById('task-table-body');
                tableBody.querySelectorAll('tr').forEach(row => {
                    row.classList.remove('dragging', 'drag-over');
                    row.style.opacity = '';
                    row.style.background = '';
                    row.style.borderTop = '';
                });
            },

            getTaskIdFromRow: function(row) {
                const taskNameElement = row.querySelector('.task-edit-trigger');
                return taskNameElement ? parseFloat(taskNameElement.dataset.taskId) : null;
            },

            canReorder: function(draggingTaskId, targetTaskId) {
                if (!draggingTaskId || !targetTaskId) {
                    console.log('笶 IDs invﾃ｡lidos para reordenamento');
                    return false;
                }
                if (draggingTaskId === targetTaskId) {
                    console.log('笶 Nﾃ｣o pode reordenar para a mesma tarefa');
                    return false;
                }

                const project = dataService.getCurrentProject();
                if (!project) {
                    console.log('笶 Nenhum projeto encontrado');
                    return false;
                }

                const draggingTask = project.tasks.find(t => t.id === draggingTaskId);
                const targetTask = project.tasks.find(t => t.id === targetTaskId);

                if (!draggingTask || !targetTask) {
                    console.log('笶 Tarefas nﾃ｣o encontradas');
                    return false;
                }

                // Sﾃｳ pode reordenar se ambas as tarefas tiverem o mesmo pai
                const canReorder = draggingTask.parentId === targetTask.parentId;
                console.log(`剥 Pode reordenar? ${canReorder} (parentId: ${draggingTask.parentId} vs ${targetTask.parentId})`);
                
                return canReorder;
            },

            reorderSubtasks: async function(draggingTaskId, targetTaskId) {
                const project = dataService.getCurrentProject();
                if (!project) {
                    console.log('笶 Nenhum projeto encontrado para reordenar');
                    return;
                }

                const draggingTask = project.tasks.find(t => t.id === draggingTaskId);
                const targetTask = project.tasks.find(t => t.id === targetTaskId);

                if (!draggingTask || !targetTask || draggingTask.parentId !== targetTask.parentId) {
                    console.log('笶 Condiﾃｧﾃｵes invﾃ｡lidas para reordenamento');
                    return;
                }

                const parentTaskId = draggingTask.parentId;
                console.log(`売 Reordenando subtarefas do parent: ${parentTaskId}`);
                
                const subtasks = project.tasks
                    .filter(t => t.parentId === parentTaskId)
                    .sort((a, b) => (a.order || 0) - (b.order || 0));

                console.log(`搭 Subtarefas antes:`, subtasks.map(t => ({id: t.id, name: t.name, order: t.order})));

                // Remover a tarefa que estﾃ｡ sendo arrastada
                const filteredSubtasks = subtasks.filter(t => t.id !== draggingTaskId);
                
                // Encontrar a posiﾃｧﾃ｣o da tarefa alvo
                const targetIndex = filteredSubtasks.findIndex(t => t.id === targetTaskId);
                
                if (targetIndex === -1) {
                    console.log('笶 ﾃ肱dice alvo nﾃ｣o encontrado');
                    return;
                }

                // Inserir a tarefa arrastada na nova posiﾃｧﾃ｣o
                const reorderedSubtasks = [
                    ...filteredSubtasks.slice(0, targetIndex),
                    draggingTask,
                    ...filteredSubtasks.slice(targetIndex)
                ];

                // Atualizar a ordem
                const subtaskIdsInOrder = reorderedSubtasks.map((task, index) => {
                    task.order = index; // Atualizar a ordem diretamente no objeto
                    return task.id;
                });
                
                console.log(`搭 Subtarefas depois:`, reorderedSubtasks.map(t => ({id: t.id, name: t.name, order: t.order})));

                document.getElementById('loader').style.display = 'flex';
                try {
                    await dataService.reorderSubtasks(parentTaskId, subtaskIdsInOrder);
                    uiService.showToast('Subtarefas reordenadas com sucesso!');
                } catch (error) {
                    console.error('Erro ao reordenar subtarefas:', error);
                    uiService.showToast('Erro ao reordenar subtarefas', 'error');
                } finally {
                    document.getElementById('loader').style.display = 'none';
                }
            },

            // --- NOVO: SISTEMA DE NOTIFICAﾃﾃ髭S ---
            
            // Funﾃｧﾃ｣o para atualizar a UI das notificaﾃｧﾃｵes
            updateNotificationUI: function() {
                const badge = document.getElementById('notification-badge');
                const notificationList = document.getElementById('notification-list');
                const unreadCount = dataService.getUnreadNotificationCount();
                
                // Atualizar badge
                if (unreadCount > 0) {
                    badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
                
                // Atualizar lista de notificaﾃｧﾃｵes
                if (dataService.notifications.length === 0) {
                    notificationList.innerHTML = `
                        <div class="notification-empty">
                            <p>Nenhuma notificaﾃｧﾃ｣o</p>
                            <p class="text-sm mt-2">Vocﾃｪ serﾃ｡ notificado quando houver novas atividades</p>
                        </div>
                    `;
                } else {
                    notificationList.innerHTML = dataService.notifications.map(notification => {
                        const timeAgo = this.getTimeAgo(notification.createdAt);
                        const icon = this.getNotificationIcon(notification.type);
                        const projectBadge = notification.projectName ? 
                            `<span class="notification-project">${notification.projectName}</span>` : '';
                        
                        return `
                            <div class="notification-item ${notification.read ? 'read' : 'unread'}" data-id="${notification.id}">
                                <div class="notification-title">
                                    ${icon}
                                    ${notification.title}
                                    ${projectBadge}
                                </div>
                                <div class="notification-message">${notification.message}</div>
                                <div class="notification-time">${timeAgo}</div>
                            </div>
                        `;
                    }).join('');
                    
                    // Adicionar event listeners para as notificaﾃｧﾃｵes
                    notificationList.querySelectorAll('.notification-item').forEach(item => {
                        item.addEventListener('click', () => {
                            const notificationId = item.dataset.id;
                            this.handleNotificationClick(notificationId, item);
                        });
                    });
                }
            },
            
            // Funﾃｧﾃ｣o para obter o ﾃｭcone da notificaﾃｧﾃ｣o baseado no tipo
            getNotificationIcon: function(type) {
                const icons = {
                    'task_assignment': '搭',
                    'project_update': '刀',
                    'deadline': '竢ｰ',
                    'comment': '町',
                    'system': '粕'
                };
                
                return `<span class="notification-icon">${icons[type] || '粕'}</span>`;
            },
            
            // Funﾃｧﾃ｣o para calcular tempo relativo
            getTimeAgo: function(dateString) {
                const date = new Date(dateString);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                if (diffMins < 1) return 'Agora mesmo';
                if (diffMins < 60) return `${diffMins} min atrﾃ｡s`;
                if (diffHours < 24) return `${diffHours} h atrﾃ｡s`;
                if (diffDays < 7) return `${diffDays} dias atrﾃ｡s`;
                
                return date.toLocaleDateString('pt-BR');
            },
            
            // Funﾃｧﾃ｣o para lidar com clique em notificaﾃｧﾃ｣o
            handleNotificationClick: function(notificationId, element) {
                const notification = dataService.notifications.find(n => n.id === notificationId);
                if (!notification) return;
                
                // Marcar como lida
                if (!notification.read) {
                    dataService.markNotificationAsRead(notificationId);
                    element.classList.remove('unread');
                    element.classList.add('read');
                }
                
                // Fechar dropdown
                this.hideNotificationDropdown();
                
                // Navegar para o projeto/tarefa se aplicﾃ｡vel
                if (notification.projectId && dataService.currentProjectId !== notification.projectId) {
                    App.openProject(notification.projectId);
                }
                
                // Mostrar toast de confirmaﾃｧﾃ｣o
                uiService.showToast('Notificaﾃｧﾃ｣o marcada como lida', 'success');
            },
            
            // Funﾃｧﾃ｣o para alternar visibilidade do dropdown de notificaﾃｧﾃｵes
            toggleNotificationDropdown: function() {
                if (this.notificationDropdownVisible) {
                    this.hideNotificationDropdown();
                } else {
                    this.showNotificationDropdown();
                }
            },
            
            // Funﾃｧﾃ｣o para mostrar dropdown de notificaﾃｧﾃｵes
            showNotificationDropdown: function() {
                const dropdown = document.getElementById('notification-dropdown');
                dropdown.classList.add('show');
                this.notificationDropdownVisible = true;
                
                // Adicionar event listener para fechar ao clicar fora
                setTimeout(() => {
                    document.addEventListener('click', this.handleClickOutsideNotifications);
                }, 10);
            },
            
            // Funﾃｧﾃ｣o para esconder dropdown de notificaﾃｧﾃｵes
            hideNotificationDropdown: function() {
                const dropdown = document.getElementById('notification-dropdown');
                dropdown.classList.remove('show');
                this.notificationDropdownVisible = false;
                
                // Remover event listener
                document.removeEventListener('click', this.handleClickOutsideNotifications);
            },
            
            // Funﾃｧﾃ｣o para lidar com clique fora do dropdown de notificaﾃｧﾃｵes
            handleClickOutsideNotifications: function(event) {
                const notificationBell = document.querySelector('.notification-bell');
                const dropdown = document.getElementById('notification-dropdown');
                
                if (!notificationBell.contains(event.target) && !dropdown.contains(event.target)) {
                    uiService.hideNotificationDropdown();
                }
            },

            // --- NOVO: SISTEMA DE ANEXOS ---
            
            // Funﾃｧﾃ｣o para lidar com upload de arquivos
            handleFileUpload: async function(files) {
                if (!files || files.length === 0) return;
                
                const taskId = document.getElementById('task-id').value;
                const projectId = dataService.currentProjectId;
                
                if (!taskId) {
                    uiService.showToast('Salve a tarefa antes de adicionar anexos.', 'error');
                    return;
                }
                
                document.getElementById('loader').style.display = 'flex';
                
                try {
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        
                        // Verificar tamanho do arquivo (limite de 10MB)
                        if (file.size > 10 * 1024 * 1024) {
                            uiService.showToast(`Arquivo ${file.name} ﾃｩ muito grande (mﾃ｡ximo 10MB)`, 'error');
                            continue;
                        }
                        
                        // Fazer upload do arquivo
                        const attachment = await dataService.uploadAttachment(file, taskId, projectId);
                        
                        // Adicionar ﾃ lista de anexos na UI
                        this.addAttachmentToUI(attachment);
                        
                        uiService.showToast(`Arquivo ${file.name} adicionado com sucesso!`, 'success');
                    }
                } catch (error) {
                    console.error('Erro ao fazer upload de arquivos:', error);
                    uiService.showToast('Erro ao fazer upload dos arquivos', 'error');
                } finally {
                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('file-upload').value = '';
                }
            },
            
            // Funﾃｧﾃ｣o para adicionar anexo ﾃ UI
            addAttachmentToUI: function(attachment) {
                const container = document.getElementById('attachments-container');
                
                const attachmentItem = document.createElement('div');
                attachmentItem.className = 'attachment-item';
                attachmentItem.dataset.fileName = attachment.name;
                
                const fileIcon = dataService.getFileIcon(attachment.name);
                const fileSize = this.formatFileSize(attachment.size);
                
                attachmentItem.innerHTML = `
                    <div class="attachment-info">
                        <span class="attachment-icon">${fileIcon}</span>
                        <span class="attachment-name" title="${attachment.name}">${attachment.name}</span>
                        <span class="text-xs text-gray-500">(${fileSize})</span>
                    </div>
                    <div class="attachment-actions">
                        <a href="${attachment.url}" target="_blank" class="attachment-btn attachment-download" download="${attachment.name}">
                            Baixar
                        </a>
                        <button class="attachment-btn attachment-delete" data-file-name="${attachment.name}">
                            Excluir
                        </button>
                    </div>
                `;
                
                container.appendChild(attachmentItem);
                
                // Adicionar event listener para o botﾃ｣o de exclusﾃ｣o
                attachmentItem.querySelector('.attachment-delete').addEventListener('click', async (e) => {
                    const fileName = e.target.dataset.fileName;
                    await this.deleteAttachment(fileName);
                });
            },
            
            // Funﾃｧﾃ｣o para excluir anexo
            deleteAttachment: async function(fileName) {
                const taskId = document.getElementById('task-id').value;
                const projectId = dataService.currentProjectId;
                
                if (!taskId) {
                    uiService.showToast('Erro: ID da tarefa nﾃ｣o encontrado', 'error');
                    return;
                }
                
                const confirmed = await this.showConfirmModalPromise(`Excluir o arquivo ${fileName}?`);
                
                if (confirmed) {
                    document.getElementById('loader').style.display = 'flex';
                    
                    try {
                        await dataService.deleteAttachment(fileName, taskId, projectId);
                        
                        // Remover da UI
                        const attachmentItem = document.querySelector(`.attachment-item[data-file-name="${fileName}"]`);
                        if (attachmentItem) {
                            attachmentItem.remove();
                        }
                        
                        uiService.showToast('Arquivo excluﾃｭdo com sucesso!', 'success');
                    } catch (error) {
                        console.error('Erro ao excluir arquivo:', error);
                        uiService.showToast('Erro ao excluir arquivo', 'error');
                    } finally {
                        document.getElementById('loader').style.display = 'none';
                    }
                }
            },
            
            // Funﾃｧﾃ｣o para formatar tamanho do arquivo
            formatFileSize: function(bytes) {
                if (bytes === 0) return '0 Bytes';
                
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            },
            
            // Funﾃｧﾃ｣o para renderizar anexos existentes
            renderAttachments: function(attachments) {
                const container = document.getElementById('attachments-container');
                container.innerHTML = '';
                
                if (!attachments || attachments.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-4">Nenhum arquivo anexado</div>';
                    return;
                }
                
                attachments.forEach(attachment => {
                    this.addAttachmentToUI(attachment);
                });
            },

            // --- NOVO: SISTEMA DE MENﾃﾃ髭S ---
            
            // Funﾃｧﾃ｣o para lidar com input de menﾃｧﾃｵes
            handleMentionInput: function(e) {
                const input = e.target;
                const value = input.value;
                const cursorPosition = input.selectionStart;
                
                // Verificar se o usuﾃ｡rio estﾃ｡ digitando uma menﾃｧﾃ｣o (@)
                const lastAtSymbol = value.lastIndexOf('@', cursorPosition - 1);
                
                if (lastAtSymbol !== -1) {
                    // Encontrar o texto apﾃｳs o @
                    const textAfterAt = value.substring(lastAtSymbol + 1, cursorPosition);
                    
                    // Se nﾃ｣o hﾃ｡ espaﾃｧo apﾃｳs o @, mostrar sugestﾃｵes
                    if (!textAfterAt.includes(' ')) {
                        this.showMentionSuggestions(textAfterAt, lastAtSymbol, input);
                        return;
                    }
                }
                
                // Esconder sugestﾃｵes se nﾃ｣o estﾃ｡ digitando uma menﾃｧﾃ｣o
                this.hideMentionSuggestions();
            },
            
            // Funﾃｧﾃ｣o para mostrar sugestﾃｵes de menﾃｧﾃ｣o
            showMentionSuggestions: function(searchText, mentionStart, input) {
                const suggestionsContainer = document.getElementById('mention-suggestions');
                suggestionsContainer.innerHTML = '';
                
                // Filtrar usuﾃ｡rios baseado no texto de busca
                const filteredUsers = dataService.users.filter(user => 
                    user.name?.toLowerCase().includes(searchText.toLowerCase()) || 
                    user.email.toLowerCase().includes(searchText.toLowerCase())
                );
                
                if (filteredUsers.length === 0) {
                    this.hideMentionSuggestions();
                    return;
                }
                
                // Adicionar sugestﾃｵes ao container
                filteredUsers.forEach((user, index) => {
                    const suggestion = document.createElement('div');
                    suggestion.className = 'mention-suggestion';
                    suggestion.dataset.userId = user.id;
                    suggestion.dataset.userName = user.name || user.email.split('@')[0];
                    
                    if (index === 0) {
                        suggestion.classList.add('active');
                    }
                    
                    suggestion.innerHTML = `
                        <strong>${user.name || user.email.split('@')[0]}</strong>
                        <span class="text-xs text-gray-500">${user.email}</span>
                    `;
                    
                    suggestion.addEventListener('click', () => {
                        this.selectMention(user, mentionStart, input);
                    });
                    
                    suggestionsContainer.appendChild(suggestion);
                });
                
                // Posicionar o container de sugestﾃｵes
                this.positionMentionSuggestions(input, suggestionsContainer);
                suggestionsContainer.style.display = 'block';
                this.mentionSuggestionsVisible = true;
                this.currentMentionStart = mentionStart;
            },
            
            // Funﾃｧﾃ｣o para posicionar o container de sugestﾃｵes
            positionMentionSuggestions: function(input, suggestionsContainer) {
                const rect = input.getBoundingClientRect();
                suggestionsContainer.style.top = `${rect.bottom + window.scrollY}px`;
                suggestionsContainer.style.left = `${rect.left + window.scrollX}px`;
                suggestionsContainer.style.width = `${rect.width}px`;
            },
            
            // Funﾃｧﾃ｣o para esconder sugestﾃｵes de menﾃｧﾃ｣o
            hideMentionSuggestions: function() {
                const suggestionsContainer = document.getElementById('mention-suggestions');
                suggestionsContainer.style.display = 'none';
                suggestionsContainer.innerHTML = '';
                this.mentionSuggestionsVisible = false;
                this.currentMentionStart = -1;
            },
            
            // Funﾃｧﾃ｣o para lidar com teclas no input de menﾃｧﾃｵes
            handleMentionKeydown: function(e) {
                if (!this.mentionSuggestionsVisible) return;
                
                const suggestionsContainer = document.getElementById('mention-suggestions');
                const activeSuggestion = suggestionsContainer.querySelector('.mention-suggestion.active');
                const suggestions = suggestionsContainer.querySelectorAll('.mention-suggestion');
                
                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        this.selectNextSuggestion(suggestions, activeSuggestion);
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        this.selectPreviousSuggestion(suggestions, activeSuggestion);
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (activeSuggestion) {
                            const userId = activeSuggestion.dataset.userId;
                            const userName = activeSuggestion.dataset.userName;
                            const user = dataService.users.find(u => u.id === userId);
                            if (user) {
                                this.selectMention(user, this.currentMentionStart, e.target);
                            }
                        }
                        break;
                    case 'Escape':
                        e.preventDefault();
                        this.hideMentionSuggestions();
                        break;
                }
            },
            
            // Funﾃｧﾃ｣o para selecionar prﾃｳxima sugestﾃ｣o
            selectNextSuggestion: function(suggestions, activeSuggestion) {
                const currentIndex = Array.from(suggestions).indexOf(activeSuggestion);
                const nextIndex = (currentIndex + 1) % suggestions.length;
                
                activeSuggestion.classList.remove('active');
                suggestions[nextIndex].classList.add('active');
            },
            
            // Funﾃｧﾃ｣o para selecionar sugestﾃ｣o anterior
            selectPreviousSuggestion: function(suggestions, activeSuggestion) {
                const currentIndex = Array.from(suggestions).indexOf(activeSuggestion);
                const prevIndex = (currentIndex - 1 + suggestions.length) % suggestions.length;
                
                activeSuggestion.classList.remove('active');
                suggestions[prevIndex].classList.add('active');
            },
            
            // Funﾃｧﾃ｣o para selecionar uma menﾃｧﾃ｣o
            selectMention: function(user, mentionStart, input) {
                const value = input.value;
                const userName = user.name || user.email.split('@')[0];
                
                // Substituir o texto da menﾃｧﾃ｣o pelo formato [Nome](ID)
                const newValue = value.substring(0, mentionStart) + 
                               `@[${userName}](${user.id})` + 
                               value.substring(input.selectionStart);
                
                input.value = newValue;
                
                // Adicionar o usuﾃ｡rio ﾃ lista de mencionados
                this.mentionedUsers.push(user.id);
                
                // Esconder sugestﾃｵes
                this.hideMentionSuggestions();
                
                // Focar no input novamente
                input.focus();
                
                // Posicionar o cursor apﾃｳs a menﾃｧﾃ｣o
                const newCursorPosition = mentionStart + `@[${userName}](${user.id})`.length;
                input.setSelectionRange(newCursorPosition, newCursorPosition);
            },
            
            // Funﾃｧﾃ｣o para processar menﾃｧﾃｵes em comentﾃ｡rios
            processMentionsInComment: async function(commentText, taskId, taskName, projectId, projectName) {
                // Extrair menﾃｧﾃｵes do formato [Nome](ID)
                const mentionRegex = /@\[([^\]]+)\]\(([^)]+)\)/g;
                let match;
                const mentionedUserIds = [];
                
                while ((match = mentionRegex.exec(commentText)) !== null) {
                    const userId = match[2];
                    mentionedUserIds.push(userId);
                }
                
                // Enviar notificaﾃｧﾃｵes para usuﾃ｡rios mencionados
                for (const userId of mentionedUserIds) {
                    await dataService.sendMentionNotification(userId, taskId, taskName, projectId, projectName, commentText);
                }
                
                return mentionedUserIds;
            },

            // --- NOVO: SISTEMA DE ATIVIDADE ---
            
            // Funﾃｧﾃ｣o para alternar entre abas
            switchTab: function(tabName) {
                // Atualizar abas
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.tab === tabName);
                });
                
                // Atualizar conteﾃｺdo
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.toggle('active', content.id === `${tabName}-tab`);
                });
                
                // Se for a aba de atividade, carregar o histﾃｳrico
                if (tabName === 'activity') {
                    this.loadActivityHistory();
                }
            },
            
            // Funﾃｧﾃ｣o para carregar histﾃｳrico de atividade
            loadActivityHistory: async function() {
                const taskId = document.getElementById('task-id').value;
                const projectId = dataService.currentProjectId;
                
                if (!taskId) return;
                
                document.getElementById('loader').style.display = 'flex';
                
                try {
                    const activities = await dataService.getActivityHistory(taskId, projectId);
                    this.renderActivityHistory(activities);
                } catch (error) {
                    console.error('Erro ao carregar histﾃｳrico de atividade:', error);
                    uiService.showToast('Erro ao carregar histﾃｳrico de atividade', 'error');
                } finally {
                    document.getElementById('loader').style.display = 'none';
                }
            },
            
            // Funﾃｧﾃ｣o para renderizar histﾃｳrico de atividade
            renderActivityHistory: function(activities) {
                const container = document.getElementById('activity-list');
                
                if (!activities || activities.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-4">Nenhuma atividade registrada</div>';
                    return;
                }
                
                container.innerHTML = activities.map(activity => {
                    const time = new Date(activity.timestamp).toLocaleString('pt-BR');
                    let actionText = '';
                    
                    switch (activity.action) {
                        case 'created':
                            actionText = `criou a tarefa`;
                            break;
                        case 'updated':
                            actionText = `alterou ${activity.details}`;
                            if (activity.oldValue && activity.newValue) {
                                actionText += ` de "${activity.oldValue}" para "${activity.newValue}"`;
                            }
                            break;
                        case 'commented':
                            actionText = `comentou: "${activity.details}"`;
                            break;
                        case 'attachment_added':
                            actionText = `adicionou o anexo "${activity.details}"`;
                            break;
                        case 'attachment_deleted':
                            actionText = `removeu o anexo "${activity.details}"`;
                            break;
                        default:
                            actionText = activity.details;
                    }
                    
                    return `
                        <div class="activity-item">
                            <div class="font-medium">${activity.userName}</div>
                            <div>${actionText}</div>
                            <div class="activity-time">${time}</div>
                        </div>
                    `;
                }).join('');
            },

            // --- VIEW/MODAL MANAGEMENT ---
            showView(viewId) {
                document.getElementById('project-view').classList.add('hidden');
                document.getElementById('dashboard-view').classList.add('hidden');
                document.getElementById(viewId).classList.remove('hidden');
            },
            switchView(viewName) {
                document.getElementById('table-view').classList.toggle('hidden', viewName === 'gantt');
                document.getElementById('gantt-view').classList.toggle('hidden', viewName === 'table');
                if (viewName === 'gantt') this.renderGanttChart(dataService.getCurrentProject().tasks, document.getElementById('task-filter-input').value);
            },
            renderProjectDashboard(project, filter = '') {
                const filteredTasks = project.tasks.filter(t => 
                    t.name.toLowerCase().includes(filter.toLowerCase()) || 
                    (t.assignedUsers && t.assignedUsers.some(uid => {
                        const user = dataService.users.find(u => u.id === uid);
                        return user && user.email.toLowerCase().includes(filter.toLowerCase());
                    }))
                );

                document.getElementById('project-title').textContent = project.name;
                
                // NOVO: Atualizar exibiﾃｧﾃ｣o das datas do projeto
                this.updateProjectDatesDisplay(project);
                
                this.renderTaskTable(filteredTasks);
                this.updateKpis(project.tasks); 
                this.renderAssigneeSummary(project.tasks);
                if (document.getElementById('view-switcher').value === 'gantt') {
                    this.renderGanttChart(filteredTasks);
                }
            },

            // NOVA FUNﾃﾃグ: Atualizar exibiﾃｧﾃ｣o das datas do projeto
            updateProjectDatesDisplay: function(project) {
                const startDateEl = document.getElementById('project-start-date-display');
                const endDateEl = document.getElementById('project-end-date-display');
                const autoBadge = document.getElementById('project-date-auto');
                const manualBadge = document.getElementById('project-date-manual');
                
                if (project.startDate && project.endDate) {
                    startDateEl.textContent = new Date(project.startDate).toLocaleDateString('pt-BR');
                    endDateEl.textContent = new Date(project.endDate).toLocaleDateString('pt-BR');
                    
                    // Mostrar badge apropriado baseado no modo
                    if (project.dateMode === 'auto') {
                        autoBadge.classList.remove('hidden');
                        manualBadge.classList.add('hidden');
                    } else {
                        autoBadge.classList.add('hidden');
                        manualBadge.classList.remove('hidden');
                    }
                } else {
                    startDateEl.textContent = 'Nﾃ｣o definida';
                    endDateEl.textContent = 'Nﾃ｣o definida';
                    autoBadge.classList.add('hidden');
                    manualBadge.classList.add('hidden');
                }
            },

            openModal(modalId) { 
                const modal = document.getElementById(modalId);
                modal.classList.remove('modal-hidden');
                modal.classList.add('modal-visible');
            },
            closeModal(modalId) {
                const modal = document.getElementById(modalId);
                modal.classList.remove('modal-visible');
                modal.classList.add('modal-hidden');
            },
            closeAllModals() {
                document.querySelectorAll('.modal-transition').forEach(modal => this.closeModal(modal.id));
            },

            // FUNﾃﾃグ openTaskModal ATUALIZADA para o novo layout com anexos e atividade
            openTaskModal(mode, data = {}) {
                document.getElementById('task-form').reset();
                this.populateAssignedUsersCheckboxes(); 
                this.hideMentionSuggestions();
                this.mentionedUsers = [];
                
                const { parentId, taskId } = data;
                const project = dataService.getCurrentProject();
                const task = taskId ? project.tasks.find(t => t.id === taskId) : {};
                const isParent = taskId ? project.tasks.some(t => t.parentId === taskId) : false;
                
                // Preencher checkboxes de usuﾃ｡rios atribuﾃｭdos
                if (mode === 'edit') {
                    const assignedUsers = task.assignedUsers || [];
                    document.querySelectorAll('.user-checkbox').forEach(checkbox => {
                        checkbox.checked = assignedUsers.includes(checkbox.value);
                    });
                } else {
                    document.querySelectorAll('.user-checkbox').forEach(checkbox => {
                        checkbox.checked = false;
                    });
                }
                
                const startDateInput = document.getElementById('start-date');
                const endDateInput = document.getElementById('end-date');
                const rescheduleBtnContainer = document.getElementById('reschedule-button-container');
                const dateHistoryContainer = document.getElementById('date-history-container');
                const dateHistoryList = document.getElementById('date-history-list');

                document.getElementById('progress-info').classList.toggle('hidden', !isParent);
                document.getElementById('task-progress').disabled = isParent;
                document.getElementById('task-progress-range').disabled = isParent;

                document.getElementById('modal-title').textContent = mode === 'add' ? 'Adicionar Tarefa' : 'Editar Tarefa';
                document.getElementById('task-id').value = task.id || '';
                document.getElementById('parent-id').value = parentId || (task ? task.parentId : '') || '';
                document.getElementById('task-name').value = task.name || '';
                document.getElementById('task-priority').value = task.priority || 'Mﾃｩdia';
                document.getElementById('task-status').value = task.status || 'Nﾃ｣o Iniciada';
                document.getElementById('task-progress').value = task.progress || 0;
                document.getElementById('task-progress-range').value = task.progress || 0;
                document.getElementById('task-risk').checked = task.risk || false;
                
                const dependencySelect = document.getElementById('task-dependency');
                dependencySelect.innerHTML = '<option value="">Nenhuma</option>';
                project?.tasks.forEach(t => {
                    if (t.id !== task.id) { 
                        const option = document.createElement('option');
                        option.value = t.id;
                        option.textContent = t.name;
                        dependencySelect.appendChild(option);
                    }
                });
                dependencySelect.value = task.dependsOn || '';

                this.renderComments(task.comments || []);
                document.getElementById('new-comment-input').value = '';

                // NOVO: Renderizar anexos
                this.renderAttachments(task.attachments || []);

                // NOVO: Resetar aba para comentﾃ｡rios
                this.switchTab('comments');

                if (mode === 'edit') {
                    const latestDates = dataService.getLatestDates(task);
                    startDateInput.value = latestDates.startDate;
                    endDateInput.value = latestDates.endDate;
                    startDateInput.disabled = true;
                    endDateInput.disabled = true;
                    rescheduleBtnContainer.classList.remove('hidden');
                    dateHistoryContainer.classList.remove('hidden');
                    
                    dateHistoryList.innerHTML = (task.dateHistory || []).map((d, i) => 
                        `<p>${i + 1}: ${new Date(d.startDate+'T00:00:00').toLocaleDateString('pt-BR')} - ${new Date(d.endDate+'T00:00:00').toLocaleDateString('pt-BR')}</p>`
                    ).join('');
                    
                    const rescheduleHandler = () => {
                        startDateInput.disabled = false;
                        endDateInput.disabled = false;
                        document.getElementById('reschedule-btn').classList.add('hidden');
                    };

                    document.getElementById('reschedule-btn').classList.remove('hidden');
                    document.getElementById('reschedule-btn').onclick = rescheduleHandler;

                } else { 
                    startDateInput.disabled = false;
                    endDateInput.disabled = false;
                    startDateInput.value = '';
                    endDateInput.value = '';
                    rescheduleBtnContainer.classList.add('hidden');
                    dateHistoryContainer.classList.add('hidden');
                }
                
                this.openModal('task-modal');
            },

            getTaskFormData() {
                const startDateInput = document.getElementById('start-date');
                const endDateInput = document.getElementById('end-date');
                
                // Coletar usuﾃ｡rios selecionados
                const selectedUsers = Array.from(document.querySelectorAll('.user-checkbox:checked'))
                                         .map(checkbox => checkbox.value)
                                         .filter(uid => uid);

                const commentsList = document.getElementById('comments-list');
                const comments = Array.from(commentsList.querySelectorAll('.comment-item')).map(item => ({
                    id: item.dataset.commentId,
                    text: item.dataset.text, 
                    timestamp: item.dataset.timestamp,
                    author: item.dataset.author
                }));

                // NOVO: Coletar anexos
                const attachmentsContainer = document.getElementById('attachments-container');
                const attachments = Array.from(attachmentsContainer.querySelectorAll('.attachment-item')).map(item => ({
                    name: item.dataset.fileName,
                    // Outras informaﾃｧﾃｵes dos anexos seriam coletadas de um data attribute
                }));

                const data = {
                    id: document.getElementById('task-id').value ? parseFloat(document.getElementById('task-id').value) : null, // CORREﾃﾃグ: Usar parseFloat
                    parentId: document.getElementById('parent-id').value ? parseFloat(document.getElementById('parent-id').value) : null, // CORREﾃﾃグ: Usar parseFloat
                    name: document.getElementById('task-name').value, 
                    assignedUsers: selectedUsers, 
                    priority: document.getElementById('task-priority').value, 
                    status: document.getElementById('task-status').value,
                    progress: parseInt(document.getElementById('task-progress').value), 
                    risk: document.getElementById('task-risk').checked,
                    dependsOn: document.getElementById('task-dependency').value ? parseFloat(document.getElementById('task-dependency').value) : null, // CORREﾃﾃグ: Usar parseFloat
                    comments: comments,
                    attachments: attachments, // NOVO: Incluir anexos
                    newStartDate: startDateInput.value,
                    newEndDate: endDateInput.value,
                };
                return data;
            },
            
            showConfirmModal(body, onConfirm) {
                document.getElementById('confirm-modal-body').textContent = body;
                this.openModal('confirm-modal');
                const confirmBtn = document.getElementById('confirm-ok-btn');
                const cancelBtn = document.getElementById('confirm-cancel-btn');
                
                const newConfirmBtn = confirmBtn.cloneNode(true);
                const newCancelBtn = cancelBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                
                newConfirmBtn.addEventListener('click', () => { onConfirm(); this.closeModal('confirm-modal'); });
                newCancelBtn.addEventListener('click', () => { this.closeModal('confirm-modal'); });
            },
            
            // MELHORIA: Funﾃｧﾃ｣o melhorada para renderizar comentﾃ｡rios com autor
            renderComments: function(comments) {
                const listEl = document.getElementById('comments-list');
                listEl.innerHTML = '';
                
                // Ordenar comentﾃ｡rios do mais recente para o mais antigo
                comments.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                        .forEach(comment => {
                    const commentItem = document.createElement('div');
                    commentItem.className = "comment-item border-b border-[var(--border-color)] pb-1 mb-1 text-xs last:border-b-0 relative";
                    commentItem.dataset.commentId = comment.id || Date.now() + Math.random();
                    commentItem.dataset.timestamp = comment.timestamp;
                    commentItem.dataset.text = comment.text;
                    commentItem.dataset.author = comment.author || dataService.users.find(u => u.id === dataService.userId)?.name || 'Utilizador';
                    
                    const dateString = new Date(comment.timestamp).toLocaleDateString('pt-BR');
                    const timeString = new Date(comment.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    
                    commentItem.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="font-semibold text-gray-500">${commentItem.dataset.author}</span>
                                    <span class="text-gray-400 text-xs">${dateString} ${timeString}</span>
                                </div>
                                <span class="comment-text">${comment.text}</span>
                            </div>
                            <div class="comment-actions flex gap-1 ml-2">
                                <button class="edit-comment-btn text-blue-500 hover:text-blue-700" title="Editar comentﾃ｡rio">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                    </svg>
                                </button>
                                <button class="delete-comment-btn text-red-500 hover:text-red-700" title="Excluir comentﾃ｡rio">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 000-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                    listEl.appendChild(commentItem);
                });

                // Adicionar event listeners para os botﾃｵes de ediﾃｧﾃ｣o e exclusﾃ｣o
                listEl.querySelectorAll('.edit-comment-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const commentItem = e.target.closest('.comment-item');
                        this.editComment(commentItem);
                    });
                });

                listEl.querySelectorAll('.delete-comment-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const commentItem = e.target.closest('.comment-item');
                        this.deleteComment(commentItem);
                    });
                });
            },

            // MELHORIA: Funﾃｧﾃ｣o para editar comentﾃ｡rio
            editComment: function(commentItem) {
                const commentText = commentItem.querySelector('.comment-text');
                const currentText = commentText.textContent;
                
                // Criar input de ediﾃｧﾃ｣o
                const editInput = document.createElement('input');
                editInput.type = 'text';
                editInput.className = 'edit-comment-input';
                editInput.value = currentText;
                
                // Substituir texto pelo input
                commentText.replaceWith(editInput);
                editInput.focus();
                
                // Adicionar botﾃｵes de confirmaﾃｧﾃ｣o/cancelamento
                const actionButtons = commentItem.querySelector('.comment-actions');
                actionButtons.innerHTML = `
                    <button class="save-comment-btn text-green-500 hover:text-green-700" title="Salvar">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <button class="cancel-edit-comment-btn text-gray-500 hover:text-gray-700" title="Cancelar">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                
                // Event listeners para os novos botﾃｵes
                commentItem.querySelector('.save-comment-btn').addEventListener('click', () => {
                    const newText = editInput.value.trim();
                    if (newText) {
                        commentItem.dataset.text = newText;
                        const newCommentText = document.createElement('span');
                        newCommentText.className = 'comment-text';
                        newCommentText.textContent = newText;
                        editInput.replaceWith(newCommentText);
                        this.restoreCommentButtons(commentItem);
                    }
                });
                
                commentItem.querySelector('.cancel-edit-comment-btn').addEventListener('click', () => {
                    const originalCommentText = document.createElement('span');
                    originalCommentText.className = 'comment-text';
                    originalCommentText.textContent = currentText;
                    editInput.replaceWith(originalCommentText);
                    this.restoreCommentButtons(commentItem);
                });
                
                // Salvar ao pressionar Enter
                editInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        commentItem.querySelector('.save-comment-btn').click();
                    }
                });
            },

            // MELHORIA: Restaurar botﾃｵes padrﾃ｣o do comentﾃ｡rio
            restoreCommentButtons: function(commentItem) {
                const actionButtons = commentItem.querySelector('.comment-actions');
                actionButtons.innerHTML = `
                    <button class="edit-comment-btn text-blue-500 hover:text-blue-700" title="Editar comentﾃ｡rio">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                        </svg>
                    </button>
                    <button class="delete-comment-btn text-red-500 hover:text-red-700" title="Excluir comentﾃ｡rio">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 000-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                
                // Re-adicionar event listeners
                actionButtons.querySelector('.edit-comment-btn').addEventListener('click', (e) => {
                    this.editComment(commentItem);
                });
                actionButtons.querySelector('.delete-comment-btn').addEventListener('click', (e) => {
                    this.deleteComment(commentItem);
                });
            },

            // MELHORIA: Funﾃｧﾃ｣o para excluir comentﾃ｡rio
            deleteComment: function(commentItem) {
                commentItem.remove();
            },

            // MELHORIA: Funﾃｧﾃ｣o para adicionar comentﾃ｡rio (atualizada com autor e menﾃｧﾃｵes)
            addComment: async function(text) {
                if (!text.trim()) return;
                
                const listEl = document.getElementById('comments-list');
                const commentItem = document.createElement('div');
                const commentId = Date.now() + Math.random();
                const timestamp = new Date().toISOString();
                const currentUser = dataService.users.find(u => u.id === dataService.userId);
                const authorName = currentUser?.name || currentUser?.email.split('@')[0] || 'Utilizador';
                
                // NOVO: Processar menﾃｧﾃｵes no comentﾃ｡rio
                const taskId = document.getElementById('task-id').value;
                const taskName = document.getElementById('task-name').value;
                const projectId = dataService.currentProjectId;
                const project = dataService.getCurrentProject();
                const projectName = project ? project.name : '';
                
                if (taskId && projectId) {
                    await dataService.processMentions(text, taskId, taskName, projectId, projectName);
                }
                
                commentItem.className = "comment-item border-b border-[var(--border-color)] pb-1 mb-1 text-xs last:border-b-0 relative";
                commentItem.dataset.commentId = commentId;
                commentItem.dataset.timestamp = timestamp;
                commentItem.dataset.text = text;
                commentItem.dataset.author = authorName;
                
                const dateString = new Date(timestamp).toLocaleDateString('pt-BR');
                const timeString = new Date(timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                
                // NOVO: Processar texto para destacar menﾃｧﾃｵes
                let processedText = text;
                const mentionRegex = /@\[([^\]]+)\]\(([^)]+)\)/g;
                processedText = processedText.replace(mentionRegex, '<span class="mention-highlight">@$1</span>');
                
                commentItem.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-semibold text-gray-500">${authorName}</span>
                                <span class="text-gray-400 text-xs">${dateString} ${timeString}</span>
                            </div>
                            <span class="comment-text">${processedText}</span>
                        </div>
                        <div class="comment-actions flex gap-1 ml-2">
                            <button class="edit-comment-btn text-blue-500 hover:text-blue-700" title="Editar comentﾃ｡rio">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                </svg>
                            </button>
                            <button class="delete-comment-btn text-red-500 hover:text-red-700" title="Excluir comentﾃ｡rio">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 000-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                
                listEl.prepend(commentItem);
                
                // Adicionar event listeners para os novos botﾃｵes
                commentItem.querySelector('.edit-comment-btn').addEventListener('click', (e) => {
                    this.editComment(commentItem);
                });
                commentItem.querySelector('.delete-comment-btn').addEventListener('click', (e) => {
                    this.deleteComment(commentItem);
                });
                
                // NOVO: Registrar atividade de comentﾃ｡rio
                if (taskId && projectId) {
                    await dataService.logActivity(
                        taskId, 
                        projectId, 
                        'commented', 
                        text,
                        null,
                        null
                    );
                }
            },

            showToast(message, type = 'success') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                const colors = { success: 'bg-green-600', error: 'bg-red-600' };
                toast.className = `toast text-white ${colors[type]}`;
                toast.innerHTML = `<p>${message}</p>`;
                container.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 3000);
            },
            
            initTheme() {
                const theme = localStorage.getItem('theme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (theme === 'dark' || (!theme && prefersDark)) {
                    document.documentElement.classList.add('dark');
                }
                this.updateThemeIcons();
            },
            toggleTheme() {
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
                this.updateThemeIcons();
                this.updateMainDashboard(dataService.projects);
                if (document.getElementById('view-switcher').value === 'gantt' && dataService.currentProjectId) {
                    this.renderGanttChart(dataService.getCurrentProject().tasks, document.getElementById('task-filter-input').value);
                }
            },
            updateThemeIcons() {
                const isDark = document.documentElement.classList.contains('dark');
                document.getElementById('theme-icon-sun').style.display = isDark ? 'block' : 'none';
                document.getElementById('theme-icon-moon').style.display = isDark ? 'none' : 'block';
            },

            updateKpis: function(tasks) {
                const kpiDashboard = document.getElementById('kpi-dashboard');
                const overallProgress = dataService.getProjectProgress(tasks);
                const kpis = [
                    { label: 'Progresso Geral', value: `${overallProgress}%` },
                    { label: 'Total de Tarefas', value: tasks.length },
                    { label: 'Concluﾃｭdas', value: tasks.filter(t => t.status === 'Concluﾃｭda').length },
                    { label: 'Atrasadas', value: tasks.filter(t => reportService.getTaskStatusClass(t.status, dataService.getLatestDates(t).endDate).name === 'Atrasada').length },
                    { label: 'Em Risco', value: tasks.filter(t => t.risk).length },
                ];
                kpiDashboard.innerHTML = kpis.map(kpi => `
                    <div class="bg-[var(--card-bg)] p-4 rounded-lg shadow-md flex items-center gap-4 border border-[var(--border-color)]">
                        <div> <div class="text-3xl font-bold">${kpi.value}</div> <div class="text-sm text-gray-400">${kpi.label}</div> </div>
                    </div>`).join('');
            },
            renderAssigneeSummary(tasks) {
                const summaryContainer = document.getElementById('assignee-summary-list');
                const uidToName = new Map(dataService.users.map(u => [u.id, u.name || u.email.split('@')[0]]));

                const summary = tasks.reduce((acc, task) => {
                    (task.assignedUsers || []).forEach(uid => {
                        const userName = uidToName.get(uid) || `UID: ${uid.substring(0, 4)}`;
                        if (!acc[userName]) acc[userName] = 0;
                        acc[userName]++;
                    });
                    return acc;
                }, {});

                summaryContainer.innerHTML = Object.entries(summary).map(([name, count]) => `
                    <div class="flex justify-between items-center">
                        <span>${name}</span>
                        <span class="font-bold bg-gray-200 dark:bg-gray-700 text-xs px-2 py-1 rounded-full">${count}</span>
                    </div>
                `).join('');
            },

            // CORREﾃﾃグ: Dashboard com grﾃ｡ficos funcionais e fontes melhoradas
            updateMainDashboard: function(projects) { 
                const mainDashboard = document.getElementById('main-dashboard');
                
                // Destruir grﾃ｡ficos existentes
                Object.values(this.mainDashboardCharts).forEach(chart => {
                    if (chart) chart.destroy();
                });
                this.mainDashboardCharts = {};
                
                // Calcular mﾃｩtricas
                let inProgressCount = 0, overdueCount = 0, atRiskCount = 0;
                const totalProjects = projects.length;

                const overdueProjects = [];
                const inProgressProjects = [];
                const atRiskProjects = [];

                projects.forEach(project => {
                    const progress = dataService.getProjectProgress(project.tasks);
                    if (progress > 0 && progress < 100) {
                        inProgressCount++;
                        inProgressProjects.push(project);
                    }
                    
                    const hasOverdue = project.tasks.some(t => reportService.getTaskStatusClass(t.status, dataService.getLatestDates(t).endDate).name === 'Atrasada');
                    if (hasOverdue) {
                        overdueCount++;
                        overdueProjects.push(project);
                    }
                    
                    const hasRisk = project.tasks.some(t => t.risk);
                    if (hasRisk) {
                        atRiskCount++;
                        atRiskProjects.push(project);
                    }
                });
                
                // Criar container para os grﾃ｡ficos
                mainDashboard.innerHTML = `
                    <div class="bg-[var(--card-bg)] p-6 rounded-lg shadow-md border border-[var(--border-color)]">
                        <h3 class="text-lg font-semibold mb-4">Total de Projetos</h3>
                        <div class="relative">
                            <canvas id="total-projects-chart" height="120"></canvas>
                        </div>
                    </div>
                    <div class="bg-[var(--card-bg)] p-6 rounded-lg shadow-md border border-[var(--border-color)]">
                        <h3 class="text-lg font-semibold mb-4">Projetos em Andamento</h3>
                        <div class="relative">
                            <canvas id="in-progress-chart" height="120"></canvas>
                        </div>
                    </div>
                    <div class="bg-[var(--card-bg)] p-6 rounded-lg shadow-md border border-[var(--border-color)]">
                        <h3 class="text-lg font-semibold mb-4">Projetos Atrasados</h3>
                        <div class="relative">
                            <canvas id="overdue-chart" height="120"></canvas>
                        </div>
                    </div>
                    <div class="bg-[var(--card-bg)] p-6 rounded-lg shadow-md border border-[var(--border-color)]">
                        <h3 class="text-lg font-semibold mb-4">Projetos em Risco</h3>
                        <div class="relative">
                            <canvas id="at-risk-chart" height="120"></canvas>
                        </div>
                    </div>
                `;

                // CORREﾃﾃグ: Criar grﾃ｡ficos com cores corretas e fontes melhoradas
                this.createDashboardChart('total-projects-chart', totalProjects, 0, 'Total', '#3b82f6', projects);
                this.createDashboardChart('in-progress-chart', inProgressCount, totalProjects - inProgressCount, 'Em Andamento', '#f59e0b', inProgressProjects);
                this.createDashboardChart('overdue-chart', overdueCount, totalProjects - overdueCount, 'Atrasados', '#ef4444', overdueProjects);
                this.createDashboardChart('at-risk-chart', atRiskCount, totalProjects - atRiskCount, 'Em Risco', '#f97316', atRiskProjects);
            },

            // CORREﾃﾃグ: Funﾃｧﾃ｣o para criar grﾃ｡ficos do dashboard com fontes melhoradas
            createDashboardChart: function(canvasId, value, remaining, label, color, projects) {
                const ctx = document.getElementById(canvasId);
                if (!ctx) return;
                
                const total = value + remaining;
                
                // Destruir grﾃ｡fico existente se houver
                if (this.mainDashboardCharts[canvasId]) {
                    this.mainDashboardCharts[canvasId].destroy();
                }
                
                this.mainDashboardCharts[canvasId] = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        datasets: [{
                            data: [value, remaining],
                            backgroundColor: [color, '#e5e7eb'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        cutout: '70%',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed;
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${value} projetos (${percentage}%)`;
                                    },
                                    afterBody: function(context) {
                                        if (context[0].dataIndex === 0 && projects.length > 0) {
                                            const projectNames = projects.map(p => p.name).slice(0, 5);
                                            const remainingCount = projects.length - 5;
                                            let tooltipText = ['', 'Projetos:'];
                                            tooltipText = tooltipText.concat(projectNames);
                                            if (remainingCount > 0) {
                                                tooltipText.push(`... e mais ${remainingCount}`);
                                            }
                                            return tooltipText;
                                        }
                                        return '';
                                    }
                                }
                            }
                        }
                    },
                    plugins: [{
                        id: 'centerText',
                        afterDraw(chart) {
                            const { ctx, chartArea: { width, height } } = chart;
                            ctx.save();
                            
                            // FONTE MELHORADA para o valor central
                            ctx.font = 'bold 24px "Inter", -apple-system, BlinkMacSystemFont, sans-serif';
                            ctx.fillStyle = chart.config.data.datasets[0].backgroundColor[0];
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.fillText(value.toString(), width / 2, height / 2 - 12);
                            
                            // FONTE MELHORADA para o label
                            ctx.font = '600 14px "Inter", -apple-system, BlinkMacSystemFont, sans-serif';
                            ctx.fillStyle = '#6b7280';
                            ctx.fillText(label, width / 2, height / 2 + 15);
                            ctx.restore();
                        }
                    }]
                });
            },

            // FUNﾃﾃ髭S ADICIONADAS PARA CORRIGIR OS ERROS
            renderProjectList: function(projects) {
                const projectListContainer = document.getElementById('project-list');
                
                if (!projects || projects.length === 0) {
                    projectListContainer.innerHTML = `
                        <div class="col-span-full text-center py-8">
                            <p class="text-gray-400">Nenhum projeto encontrado.</p>
                            <p class="text-sm text-gray-500 mt-2">Crie seu primeiro projeto clicando no botﾃ｣o acima.</p>
                        </div>
                    `;
                    return;
                }

                projectListContainer.innerHTML = projects.map(project => {
                    const progress = dataService.getProjectProgress(project.tasks);
                    const statusInfo = reportService.getTaskStatusClass(
                        progress === 100 ? 'Concluﾃｭda' : progress > 0 ? 'Em Andamento' : 'Nﾃ｣o Iniciada', 
                        ''
                    );
                    
                    const canDelete = dataService.userRole === 'Gestor' || project.creatorId === dataService.userId;
                    
                    // CORREﾃﾃグ: Usar nome do responsﾃ｡vel em vez de UID
                    const managerName = dataService.getManagerName(project.manager);
                    
                    // NOVO: Exibir datas do projeto no card
                    const startDate = project.startDate ? new Date(project.startDate).toLocaleDateString('pt-BR') : 'Nﾃ｣o definida';
                    const endDate = project.endDate ? new Date(project.endDate).toLocaleDateString('pt-BR') : 'Nﾃ｣o definida';
                    
                    // Verificar se o projeto estﾃ｡ atrasado
                    const today = new Date();
                    const endDateObj = project.endDate ? new Date(project.endDate) : null;
                    const isOverdue = endDateObj && endDateObj < today && progress < 100;
                    const cardClass = isOverdue ? 'project-overdue' : '';
                    
                    // NOVO: Obter informaﾃｧﾃｵes das tarefas
                    const todayTask = dataService.taskService.getFirstTodayTask(project);
                    const overdueTasks = dataService.taskService.getOverdueTasks(project);
                    
                    return `
                        <div class="project-card-link bg-[var(--card-bg)] rounded-lg shadow-md p-6 border border-[var(--border-color)] hover:shadow-lg transition-shadow cursor-pointer ${cardClass}" data-project-id="${project.id}">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-xl font-semibold text-[var(--text-color)]">${project.name}</h3>
                                ${canDelete ? `
                                    <button class="delete-project-btn text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 dark:hover:bg-red-900 transition-colors" data-project-id="${project.id}" title="Excluir projeto">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                ` : ''}
                            </div>
                            
                            <div class="mb-4">
                                <div class="flex justify-between text-sm text-gray-400 mb-1">
                                    <span>Progresso</span>
                                    <span>${progress}%</span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: ${progress}%"></div>
                                </div>
                            </div>
                            
                            <!-- NOVO: Datas do projeto -->
                            <div class="mb-3 text-xs text-gray-500">
                                <div class="flex justify-between">
                                    <span>Inﾃｭcio:</span>
                                    <span>${startDate}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Conclusﾃ｣o:</span>
                                    <span>${endDate}</span>
                                </div>
                            </div>
                            
                            <!-- NOVO: Informaﾃｧﾃｵes das tarefas -->
                            <div class="task-info-container">
                                ${todayTask ? `
                                    <div class="flex items-center text-xs text-green-600 mb-1">
                                        <span class="mr-1">套</span>
                                        <span class="font-medium">Hoje:</span>
                                        <span class="ml-1 truncate">${todayTask.name}</span>
                                        <span class="today-task-badge task-info-badge">Hoje</span>
                                    </div>
                                ` : ''}
                                
                                ${overdueTasks.length > 0 ? `
                                    <div class="flex items-center text-xs text-red-600">
                                        <span class="mr-1">笞ｸ</span>
                                        <span class="font-medium">Atrasadas:</span>
                                        <span class="ml-1">${overdueTasks.length} tarefa(s)</span>
                                        <span class="overdue-task-badge task-info-badge">${overdueTasks.length}</span>
                                    </div>
                                ` : ''}
                                
                                ${!todayTask && overdueTasks.length === 0 ? `
                                    <div class="text-xs text-gray-500">
                                        Nenhuma tarefa em execuﾃｧﾃ｣o hoje
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div class="flex justify-between items-center text-sm mt-3">
                                <div class="flex items-center gap-4">
                                    <span class="px-2 py-1 rounded-full text-xs ${isOverdue ? 'bg-red-600 text-white' : statusInfo.badge}">
                                        ${isOverdue ? 'Atrasado' : progress === 100 ? 'Concluﾃｭdo' : progress > 0 ? 'Em Andamento' : 'Nﾃ｣o Iniciado'}
                                    </span>
                                    <span class="text-gray-400">${project.tasks?.length || 0} tarefas</span>
                                </div>
                                <div class="text-gray-400 text-xs">
                                    Responsﾃ｡vel: ${managerName}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            // NOVA FUNﾃﾃグ: Atualizar informaﾃｧﾃｵes das tarefas de hoje no header
            updateTodayTasksInfo: function(todayTasksCount) {
                let todayInfoEl = document.getElementById('today-tasks-info');
                
                if (!todayInfoEl) {
                    // Criar elemento se nﾃ｣o existir
                    const projectTitle = document.getElementById('project-title');
                    if (projectTitle && projectTitle.parentNode) {
                        const headerContainer = projectTitle.parentNode;
                        todayInfoEl = document.createElement('div');
                        todayInfoEl.id = 'today-tasks-info';
                        todayInfoEl.className = 'mt-2 text-sm';
                        headerContainer.appendChild(todayInfoEl);
                    }
                }
                
                if (todayInfoEl) {
                    const today = new Date().toLocaleDateString('pt-BR');
                    if (todayTasksCount > 0) {
                        todayInfoEl.innerHTML = `
                            <span class="bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-3 py-1 rounded-full font-medium animate-pulse">
                                套 Hoje (${today}): ${todayTasksCount} tarefa(s) em execuﾃｧﾃ｣o
                            </span>
                        `;
                    } else {
                        todayInfoEl.innerHTML = `
                            <span class="bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 px-3 py-1 rounded-full">
                                套 Hoje (${today}): Nenhuma tarefa em execuﾃｧﾃ｣o
                            </span>
                        `;
                    }
                }
            },

            renderTaskTable: function(tasks) {
                const tableBody = document.getElementById('task-table-body');
                
                if (!tasks || tasks.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="8" class="p-4 text-center text-gray-400">
                                Nenhuma tarefa encontrada. Clique em "Nova Tarefa" para comeﾃｧar.
                            </td>
                        </tr>
                    `;
                    return;
                }

                const processTasksForTable = (parentId, level) => {
                    let html = '';
                    
                    // Ordenar tarefas pela ordem definida
                    const childTasks = tasks
                        .filter(t => t.parentId === parentId)
                        .sort((a, b) => {
                            // Primeiro pela ordem, depois pela data de inﾃｭcio
                            const orderA = a.order || 0;
                            const orderB = b.order || 0;
                            if (orderA !== orderB) return orderA - orderB;
                            
                            const dateA = new Date(dataService.getLatestDates(a).startDate);
                            const dateB = new Date(dataService.getLatestDates(b).startDate);
                            return dateA - dateB;
                        });

                    childTasks.forEach(task => {
                        const latestDates = dataService.getLatestDates(task);
                        const duration = reportService.calculateDuration(latestDates.startDate, latestDates.endDate);
                        const statusInfo = reportService.getTaskStatusClass(task.status, latestDates.endDate);
                        const isParent = tasks.some(t => t.parentId === task.id);
                        
                        // NOVO: Verificar se a tarefa estﾃ｡ em execuﾃｧﾃ｣o hoje
                        const isRunningToday = dataService.taskService.isTaskRunningToday(task);
                        
                        // CORREﾃﾃグ: Usar nomes em vez de UIDs
                        const assignedUsersText = dataService.getAssignedUserNames(task.assignedUsers);

                        const commentsPreview = (task.comments || [])
                            .slice(0, 2)
                            .map(c => `${c.author || 'Utilizador'}: ${c.text.substring(0, 30)}${c.text.length > 30 ? '...' : ''}`)
                            .join('; ');

                        // NOVO: Adicionar classe de destaque para tarefas em execuﾃｧﾃ｣o hoje
                        const rowClass = level > 0 ? 'subtask-row draggable-subtask' : '';
                        const todayHighlightClass = isRunningToday ? 'today-running-task' : '';
                        const dragHandle = level > 0 ? '<span class="drag-handle" title="Arrastar para reordenar">站ｮ站ｮ</span>' : '';

                        // NOVO: ﾃ皇one de "hoje" para tarefas em execuﾃｧﾃ｣o
                        const todayIcon = isRunningToday ? 
                            '<span class="ml-2 text-green-500 animate-pulse" title="Em execuﾃｧﾃ｣o hoje">泙</span>' : '';

                        html += `
                            <tr class="border-b border-[var(--border-color)] hover:bg-gray-100 dark:hover:bg-gray-700 ${rowClass} ${todayHighlightClass}" data-task-id="${task.id}">
                                <td class="p-3">
                                    <div style="padding-left: ${level * 20}px" class="flex items-center gap-2">
                                        ${dragHandle}
                                        ${isParent ? '<span class="text-blue-500">刀</span>' : '<span class="text-gray-400">塘</span>'}
                                        <span class="task-edit-trigger cursor-pointer hover:text-blue-500 hover:underline" data-task-id="${task.id}">
                                            ${task.name}
                                        </span>
                                        ${todayIcon}
                                        ${task.risk ? '<span class="text-red-500 text-xs" title="Tarefa em risco">笞ｸ</span>' : ''}
                                    </div>
                                </td>
                                <td class="p-3">${duration}</td>
                                <td class="p-3">${new Date(latestDates.startDate + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                                <td class="p-3">${new Date(latestDates.endDate + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                                <td class="p-3">
                                    <span class="px-2 py-1 rounded-full text-xs ${statusInfo.badge}">
                                        ${statusInfo.name}
                                    </span>
                                </td>
                                <td class="p-3 text-xs text-gray-500 max-w-xs truncate" title="${assignedUsersText}">
                                    ${assignedUsersText}
                                </td>
                                <td class="p-3 text-xs text-gray-500 max-w-xs truncate" title="${commentsPreview}">
                                    ${commentsPreview || '-'}
                                </td>
                                <td class="p-3 text-center no-print">
                                    <div class="flex justify-center gap-1">
                                        <button class="add-subtask-btn bg-green-500 text-white p-1 rounded hover:bg-green-600" 
                                                data-task-id="${task.id}" data-parent-id="${task.id}" title="Adicionar subtarefa">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                                            </svg>
                                        </button>
                                        <button class="edit-task-btn bg-blue-500 text-white p-1 rounded hover:bg-blue-600" 
                                                data-task-id="${task.id}" title="Editar tarefa">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                            </svg>
                                        </button>
                                        <button class="delete-task-btn bg-red-500 text-white p-1 rounded hover:bg-red-600" 
                                                data-task-id="${task.id}" title="Excluir tarefa">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 000-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                        
                        // Processar subtarefas recursivamente
                        html += processTasksForTable(task.id, level + 1);
                    });
                    
                    return html;
                };

                tableBody.innerHTML = processTasksForTable(null, 0);
                
                // NOVO: Adicionar contador de tarefas em execuﾃｧﾃ｣o hoje
                const todayTasksCount = tasks.filter(task => 
                    dataService.taskService.isTaskRunningToday(task)
                ).length;
                
                // Atualizar o header do dashboard com informaﾃｧﾃ｣o das tarefas de hoje
                this.updateTodayTasksInfo(todayTasksCount);
                
                // Configurar drag and drop apﾃｳs renderizar a tabela
                setTimeout(() => {
                    this.setupSubtasksDragAndDrop();
                    
                    // Debug: Verificar se as linhas estﾃ｣o configuradas corretamente
                    const draggableRows = document.querySelectorAll('tr[draggable="true"]');
                    console.log(`笨 ${draggableRows.length} linhas configuradas para drag and drop`);
                }, 300);
            },

            renderGanttChart: function(tasks) {
                const ganttView = document.getElementById('gantt-view');
                if (!tasks || tasks.length === 0 || ganttView.classList.contains('hidden')) return;

                const taskNamesContainer = document.getElementById('gantt-task-names');
                const timelineBody = document.getElementById('gantt-timeline-body');
                const ganttHeader = document.getElementById('gantt-header');
                const dependencyLines = document.getElementById('gantt-dependency-lines');
                taskNamesContainer.innerHTML = ''; timelineBody.innerHTML = ''; ganttHeader.innerHTML = ''; dependencyLines.innerHTML = '';

                const allDates = tasks.flatMap(t => t.dateHistory.flatMap(d => [new Date(d.startDate), new Date(d.endDate)]))
                                        .filter(d => !isNaN(d.getTime()));
                if (allDates.length === 0) return;

                let minDate = new Date(Math.min.apply(null, allDates));
                let maxDate = new Date(Math.max.apply(null, allDates));
                minDate.setDate(minDate.getDate() - 2); maxDate.setDate(maxDate.getDate() + 2);

                const totalDays = reportService.calculateDuration(minDate.toISOString().split('T')[0], maxDate.toISOString().split('T')[0]);
                if (totalDays <= 0) return;
                const dayWidth = 40; 
                
                timelineBody.style.width = `${totalDays * dayWidth}px`;
                ganttHeader.style.width = `${totalDays * dayWidth}px`;
                
                let currentDate = new Date(minDate);
                ganttHeader.style.display = 'flex';
                for (let i = 1; i <= totalDays; i++) {
                    const dayCell = document.createElement('div');
                    const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
                    dayCell.className = `text-center text-xs p-1 border-r border-b border-[var(--border-color)] shrink-0 ${isWeekend ? 'bg-gray-300 dark:bg-gray-800 font-semibold' : ''}`;
                    dayCell.style.width = `${dayWidth}px`;
                    dayCell.textContent = `${currentDate.getDate()}/${currentDate.getMonth()+1}`;
                    ganttHeader.appendChild(dayCell);
                    currentDate.setDate(currentDate.getDate() + 1);
                }

                let taskOrder = [];
                const processGanttTasks = (parentId, level) => {
                    tasks.filter(t => t.parentId === parentId).sort((a,b) => {
                        const dateA = new Date(dataService.getLatestDates(a).startDate);
                        const dateB = new Date(dataService.getLatestDates(b).startDate);
                        return dateA - dateB;
                    }).forEach(task => { taskOrder.push({ ...task, level }); processGanttTasks(task.id, level + 1); });
                };
                processGanttTasks(null, 0);

                taskOrder.forEach(task => {
                    const latestDates = dataService.getLatestDates(task);
                    if (!latestDates.startDate || !latestDates.endDate) return;

                    const taskNameDiv = document.createElement('div');
                    taskNameDiv.className = 'gantt-task-name h-8 flex items-center border-b border-[var(--border-color)] text-sm';
                    taskNameDiv.style.paddingLeft = `${task.level * 16 + 8}px`;
                    taskNameDiv.textContent = task.name;
                    taskNamesContainer.appendChild(taskNameDiv);

                    const start = new Date(latestDates.startDate + 'T00:00:00');
                    const end = new Date(latestDates.endDate + 'T00:00:00');
                    const startOffset = reportService.calculateDuration(minDate.toISOString().split('T')[0], latestDates.startDate);
                    const taskDuration = reportService.calculateDuration(latestDates.startDate, latestDates.endDate);

                    const taskBar = document.createElement('div');
                    taskBar.className = `gantt-bar ${task.level === 0 ? 'gantt-bar-parent' : ''}`;
                    taskBar.style.left = `${startOffset * dayWidth}px`;
                    taskBar.style.width = `${taskDuration * dayWidth}px`;
                    taskBar.style.top = `${taskOrder.indexOf(task) * 32 + (task.level === 0 ? 8 : 20)}px`;
                    taskBar.style.backgroundColor = task.risk ? '#ef4444' : (task.status === 'Concluﾃｭda' ? '#10b981' : (task.status === 'Em Andamento' ? '#f59e0b' : '#6b7280'));
                    taskBar.textContent = taskDuration > 2 ? task.name : '';
                    taskBar.title = `${task.name}: ${latestDates.startDate} a ${latestDates.endDate}`;
                    taskBar.addEventListener('click', () => uiService.openTaskModal('edit', { taskId: task.id }));
                    timelineBody.appendChild(taskBar);
                });
            }
        };

        // Report Service - Handles exports and reporting
        const reportService = {
            calculateDuration: (startDate, endDate) => {
                if (!startDate || !endDate) return 0;
                const start = new Date(startDate + 'T00:00:00');
                const end = new Date(endDate + 'T00:00:00');
                const timeDiff = end.getTime() - start.getTime();
                return Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1;
            },
            getTaskStatusClass: (status, endDate) => {
                const today = new Date();
                const end = new Date(endDate + 'T00:00:00');
                if (status === 'Concluﾃｭda') return { name: 'Concluﾃｭda', badge: 'bg-green-600 text-white' };
                if (status === 'Em Andamento' && end < today) return { name: 'Atrasada', badge: 'bg-red-600 text-white' };
                if (status === 'Em Andamento') return { name: 'Em Andamento', badge: 'bg-yellow-500 text-black' };
                if (end < today) return { name: 'Atrasada', badge: 'bg-red-600 text-white' };
                return { name: 'Nﾃ｣o Iniciada', badge: 'bg-gray-500 text-white' };
            },
            exportExcel: (project) => {
                if (!project) return uiService.showToast('Nenhum projeto selecionado.', 'error');
                const tasks = project.tasks || [];
                const data = tasks.map(t => {
                    const latestDates = dataService.getLatestDates(t);
                    return {
                        'Tarefa': t.name,
                        'Data Inﾃｭcio': latestDates.startDate,
                        'Data Termino': latestDates.endDate,
                        'Duraﾃｧﾃ｣o (dias)': reportService.calculateDuration(latestDates.startDate, latestDates.endDate),
                        'Status': t.status,
                        'Progresso (%)': t.progress,
                        'Prioridade': t.priority,
                        'Responsﾃ｡vel': dataService.getAssignedUserNames(t.assignedUsers),
                        'Risco': t.risk ? 'Sim' : 'Nﾃ｣o',
                        'Tarefa Pai': tasks.find(pt => pt.id === t.parentId)?.name || ''
                    };
                });
                const worksheet = XLSX.utils.json_to_sheet(data);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Tarefas');
                XLSX.writeFile(workbook, `${project.name}_tarefas.xlsx`);
                uiService.showToast('Exportado para Excel com sucesso!');
            },
            generatePdf: (project) => {
                if (!project) return uiService.showToast('Nenhum projeto selecionado.', 'error');
                const element = document.getElementById('content-area');
                const opt = {
                    margin: [10, 10, 10, 10],
                    filename: `${project.name}_relatorio.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
                };
                html2pdf().set(opt).from(element).save();
                uiService.showToast('PDF gerado com sucesso!');
            },
            downloadExcelTemplate: () => {
                const template = [
                    {
                        'Tarefa': 'Nome da tarefa',
                        'Data Inﾃｭcio': '2024-01-01',
                        'Data Termino': '2024-01-05',
                        'Status': 'Nﾃ｣o Iniciada',
                        'Progresso (%)': 0,
                        'Prioridade': 'Mﾃｩdia',
                        'Atribuﾃｭdo a (Nomes Separados por Vﾃｭrgula)': 'nome1, nome2',
                        'Risco (Sim/Nao)': 'Nao',
                        'Tarefa Pai (Nome)': 'Nome da tarefa pai (opcional)'
                    }
                ];
                const worksheet = XLSX.utils.json_to_sheet(template);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Template');
                XLSX.writeFile(workbook, 'template_importacao_tarefas.xlsx');
                uiService.showToast('Template baixado com sucesso!');
            }
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
