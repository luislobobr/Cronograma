<!DOCTYPE html>
<html lang="pt-BR" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Projetos Aprimorado</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (xlsx) library for Excel export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Chart.js library for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- html2pdf.js for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* Estilos personalizados */
        :root { --background-color: #f3f4f6; --text-color: #374151; --card-bg: #ffffff; --card-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); --border-color: #e5e7eb; }
        html.dark { --background-color: #111827; --text-color: #d1d5db; --card-bg: #1f2937; --card-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.2), 0 2px 4px -2px rgb(0 0 0 / 0.2); --border-color: #374151; }
        body { background-color: var(--background-color); color: var(--text-color); font-family: 'Inter', sans-serif; transition: background-color 0.3s ease, color 0.3s ease; }
        @import url('https://rsms.me/inter/inter.css');
        .gantt-chart-container { display: grid; grid-template-columns: 250px 1fr; overflow-x: auto; position: relative; }
        .gantt-task-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .gantt-bar { position: absolute; height: 24px; border-radius: 4px; color: white; font-size: 12px; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer; z-index: 10; }
        .gantt-bar-parent { height: 12px; top: 8px; }
        #gantt-dependency-lines { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; overflow: visible; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; z-index: 9999; backdrop-filter: blur(4px); transition: opacity 0.3s ease; }
        html.dark #loader { background-color: rgba(17, 24, 39, 0.8); }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Transitions for Modals */
        .modal-transition { transition: opacity 0.3s ease, transform 0.3s ease; }
        .modal-hidden { opacity: 0; transform: scale(0.95); pointer-events: none; }
        .modal-visible { opacity: 1; transform: scale(1); }
        /* Toast Notifications */
        #toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 100; display: flex; flex-direction: column; gap: 0.75rem; }
        .toast { display: flex; align-items: center; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); transform: translateX(120%); opacity: 0; transition: all 0.4s cubic-bezier(0.21, 1.02, 0.73, 1); }
        .toast.show { transform: translateX(0); opacity: 1; }
        /* Estilos para Impressão */
        @media print { .no-print { display: none !important; } body { background-color: #ffffff !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; } .container, #dashboard-view, main#content-area, .bg-white { padding: 0 !important; margin: 0 !important; max-width: 100% !important; box-shadow: none !important; border: none !important; } .gantt-timeline-container, .overflow-x-auto { overflow: visible !important; } }
    </style>
</head>
<body class="antialiased">
    <!-- Tela de Carregamento -->
    <div id="loader" class="no-print"><div class="spinner"></div></div>
    
    <!-- Toast Notification Container -->
    <div id="toast-container" class="no-print"></div>

    <!-- Modals -->
    <div id="project-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 no-print modal-transition modal-hidden">
        <div class="bg-[var(--card-bg)] rounded-lg shadow-xl p-6 w-full max-w-md">
            <h2 id="project-modal-title" class="text-2xl font-bold mb-4 text-[var(--text-color)]">Novo Projeto</h2>
            <form id="project-form">
                <div class="mb-4">
                    <label for="project-name" class="block text-sm font-medium text-gray-400">Nome do Projeto</label>
                    <input type="text" id="project-name" class="mt-1 block w-full border border-[var(--border-color)] rounded-md shadow-sm p-2 bg-transparent" required>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" class="cancel-btn bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Salvar Projeto</button>
                </div>
            </form>
        </div>
    </div>

    <div id="task-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 no-print modal-transition modal-hidden">
        <div class="bg-[var(--card-bg)] rounded-lg shadow-xl p-6 w-full max-w-2xl">
            <h2 id="modal-title" class="text-2xl font-bold mb-6 text-[var(--text-color)]">Adicionar Nova Tarefa</h2>
            <form id="task-form" class="flex flex-col md:flex-row gap-6">
                <!-- Coluna Esquerda: Detalhes da Tarefa -->
                <div class="flex-grow">
                    <input type="hidden" id="task-id"><input type="hidden" id="parent-id">
                     <div class="mb-4">
                        <label for="task-name" class="block text-sm font-medium text-gray-400">Nome da Tarefa</label>
                        <input type="text" id="task-name" class="mt-1 block w-full border border-[var(--border-color)] bg-transparent rounded-md shadow-sm p-2" required>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div><label for="assigned-to" class="block text-sm font-medium text-gray-400">Atribuído a</label><input type="text" id="assigned-to" class="mt-1 block w-full border border-[var(--border-color)] bg-transparent rounded-md shadow-sm p-2"></div>
                        <div><label for="task-priority" class="block text-sm font-medium text-gray-400">Prioridade</label><select id="task-priority" class="mt-1 block w-full border border-[var(--border-color)] bg-[var(--card-bg)] rounded-md shadow-sm p-2"><option value="Baixa">Baixa</option><option value="Média">Média</option><option value="Alta">Alta</option></select></div>
                    </div>
                     <!-- Seção de Datas -->
                    <div id="date-section">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2">
                            <div><label for="start-date" class="block text-sm font-medium text-gray-400">Data de Início</label><input type="date" id="start-date" class="mt-1 block w-full border border-[var(--border-color)] bg-transparent rounded-md shadow-sm p-2" required></div>
                            <div><label for="end-date" class="block text-sm font-medium text-gray-400">Data de Término</label><input type="date" id="end-date" class="mt-1 block w-full border border-[var(--border-color)] bg-transparent rounded-md shadow-sm p-2" required></div>
                        </div>
                        <div id="reschedule-button-container" class="mb-4 hidden">
                             <button type="button" id="reschedule-btn" class="text-sm text-blue-500 hover:underline">Reprogramar Datas</button>
                        </div>
                    </div>
    
                    <!-- Histórico de Datas -->
                    <div id="date-history-container" class="mb-4 hidden">
                        <h4 class="text-sm font-medium text-gray-400 mb-2">Histórico de Prazos</h4>
                        <div id="date-history-list" class="text-xs text-gray-500 max-h-20 overflow-y-auto bg-gray-100 dark:bg-gray-800 p-2 rounded"></div>
                    </div>
    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div><label for="task-status" class="block text-sm font-medium text-gray-400">Status</label><select id="task-status" class="mt-1 block w-full border border-[var(--border-color)] bg-[var(--card-bg)] rounded-md shadow-sm p-2"><option value="Não Iniciada">Não Iniciada</option><option value="Em Andamento">Em Andamento</option><option value="Concluída">Concluída</option></select></div>
                        <div>
                            <label for="task-progress" class="block text-sm font-medium text-gray-400">Progresso (%)</label>
                            <input type="number" id="task-progress" min="0" max="100" class="mt-1 block w-full border border-[var(--border-color)] bg-transparent rounded-md shadow-sm p-2" required>
                            <p id="progress-info" class="text-xs text-gray-500 mt-1 hidden">O progresso de tarefas-pai é calculado automaticamente.</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="task-dependency" class="block text-sm font-medium text-gray-400">Depende de</label>
                            <select id="task-dependency" class="mt-1 block w-full border border-[var(--border-color)] bg-[var(--card-bg)] rounded-md shadow-sm p-2">
                                <option value="">Nenhuma</option>
                            </select>
                        </div>
                        <div class="flex items-end pb-2">
                            <label class="flex items-center"><input type="checkbox" id="task-risk" class="h-4 w-4 text-red-600 border-gray-300 rounded"><span class="ml-2 text-sm font-medium">Tarefa em Risco</span></label>
                        </div>
                    </div>
                </div>

                <!-- Coluna Direita: Comentários -->
                <div class="md:w-1/3 md:border-l md:pl-6 border-[var(--border-color)] flex flex-col">
                    <h4 class="text-sm font-medium text-gray-400 mb-2">Comentários</h4>
                    <div id="comments-list" class="flex-grow text-sm text-gray-500 max-h-48 overflow-y-auto bg-gray-100 dark:bg-gray-800 p-2 rounded mb-4"></div>
                    <div class="flex gap-2">
                        <input type="text" id="new-comment-input" class="flex-grow border border-[var(--border-color)] bg-transparent rounded-md shadow-sm p-2" placeholder="Adicionar comentário...">
                        <button type="button" id="add-comment-btn" class="bg-gray-200 dark:bg-gray-600 px-3 rounded-md text-[var(--text-color)] hover:bg-gray-300 dark:hover:bg-gray-500">&rarr;</button>
                    </div>
                </div>

                <div class="flex justify-end gap-2 md:col-span-2 w-full absolute bottom-6 right-6">
                    <button type="button" class="cancel-btn bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Salvar Tarefa</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 no-print modal-transition modal-hidden">
        <div class="bg-[var(--card-bg)] rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h2 id="confirm-modal-title" class="text-xl font-bold mb-4 text-[var(--text-color)]">Confirmar Ação</h2>
            <p id="confirm-modal-body" class="mb-6 text-gray-400">Você tem certeza?</p>
            <div class="flex justify-end gap-2">
                <button id="confirm-cancel-btn" class="bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500">Cancelar</button>
                <button id="confirm-ok-btn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="relative min-h-screen">
        <input type="file" id="import-excel-input" class="hidden" accept=".xlsx, .xls">
        <button id="theme-toggle" class="no-print fixed top-4 right-4 z-50 p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
            <svg id="theme-icon-sun" class="h-6 w-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
            <svg id="theme-icon-moon" class="h-6 w-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
        </button>
        
        <div id="project-view" class="container mx-auto p-4 md:p-8 no-print">
            <header class="mb-8">
                <h1 class="text-4xl font-bold">Meus Projetos</h1>
                <p class="text-gray-400">Selecione um projeto para gerenciar ou crie um novo.</p>
            </header>
            <div id="main-dashboard" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"></div>
            <div class="mb-6"><button id="add-project-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>Novo Projeto</button></div>
            <div id="project-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <div id="dashboard-view" class="container mx-auto p-4 md:p-8 hidden">
             <header class="mb-8">
                <button id="back-to-projects-btn" class="text-sm text-blue-500 hover:underline mb-2 flex items-center gap-1 no-print">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
                    Voltar para Projetos
                </button>
                <h1 id="project-title" class="text-4xl font-bold">Nome do Projeto</h1>
                <p class="text-gray-400">Painel de controle com o cronograma de execução.</p>
            </header>
            <div id="kpi-dashboard" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-8"></div>
            
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">
                <div class="lg:col-span-3 bg-[var(--card-bg)] p-4 rounded-lg shadow-md flex flex-wrap items-center justify-between gap-4 no-print border border-[var(--border-color)]">
                    <div class="flex items-center gap-4 flex-wrap">
                        <button id="add-task-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center gap-2">Nova Tarefa</button>
                        <button id="import-excel-btn" class="bg-teal-600 text-white px-4 py-2 rounded-md hover:bg-teal-700 flex items-center gap-2">Importar</button>
                        <button id="download-template-btn" class="text-sm text-blue-500 hover:underline">Baixar Template</button>
                    </div>
                    <div class="relative">
                        <input type="text" id="task-filter-input" placeholder="Filtrar tarefas..." class="border border-[var(--border-color)] bg-transparent rounded-md shadow-sm p-2 pl-8 text-sm">
                        <svg class="absolute left-2 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2"><label for="view-switcher" class="text-sm font-medium">Visualização:</label><select id="view-switcher" class="border border-[var(--border-color)] rounded-md p-2 text-sm bg-[var(--card-bg)]"><option value="table" selected>Tabela</option><option value="gantt">Gantt</option></select></div>
                        <button id="export-excel-btn" class="bg-green-600 text-white px-3 py-2 rounded-md hover:bg-green-700" title="Exportar para Excel">Excel</button>
                        <button id="generate-pdf-report-btn" class="bg-red-600 text-white px-3 py-2 rounded-md hover:bg-red-700" title="Gerar Relatório PDF">PDF</button>
                        <button id="print-view-btn" class="bg-gray-500 text-white px-3 py-2 rounded-md hover:bg-gray-600" title="Imprimir">Imprimir</button>
                    </div>
                </div>
                 <div id="assignee-summary" class="bg-[var(--card-bg)] p-4 rounded-lg shadow-md border border-[var(--border-color)] no-print">
                    <h3 class="font-bold mb-2">Tarefas por Responsável</h3>
                    <div id="assignee-summary-list" class="text-sm space-y-2 max-h-48 overflow-y-auto"></div>
                </div>
            </div>
            <main id="content-area" class="bg-[var(--card-bg)] p-4 rounded-lg shadow-md border border-[var(--border-color)]">
                <div id="table-view">
                     <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-400">
                            <thead class="text-xs uppercase bg-gray-700 text-gray-400">
                                <tr>
                                    <!-- ORDEM SOLICITADA: Tarefa - Duração - Data Início - Data Término - Status - Comentários - Ações -->
                                    <th class="p-3 min-w-[250px]">Tarefa</th>
                                    <th class="p-3">Duração (dias)</th>
                                    <th class="p-3">Data de Início</th>
                                    <th class="p-3">Data de Término</th>
                                    <th class="p-3">Status</th>
                                    <th class="p-3">Comentários</th>
                                    <th class="p-3 text-center no-print">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="task-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <div id="gantt-view" class="hidden">
                     <div class="gantt-chart-container border border-[var(--border-color)] rounded-lg">
                        <svg id="gantt-dependency-lines" width="100%" height="100%"></svg>
                        <div class="gantt-tasks bg-gray-700 bg-opacity-20 border-r border-[var(--border-color)] p-2 font-bold">
                            <div class="h-10 flex items-center">Tarefa</div><div id="gantt-task-names" class="relative"></div>
                        </div>
                        <div class="gantt-timeline-container overflow-x-auto">
                            <div id="gantt-header" class="sticky top-0 bg-gray-700 bg-opacity-20 z-10 border-b border-[var(--border-color)]"></div><div id="gantt-timeline-body" class="relative"></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- TODO O CÓDIGO JAVASCRIPT CONSOLIDADO EM UM ÚNICO MÓDULO -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setDoc, doc, collection, onSnapshot, addDoc, deleteDoc, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Variáveis Globais de Firebase
        let firebaseApp;
        let db;
        let auth;
        let unsubscribeProjects = () => {};
        
        // --- CONFIGURAÇÃO FIREBASE HARDCODADA DO UTILIZADOR ---
        // A chave API está aqui. Para produção, isto deve ser guardado de forma segura.
        const appId = "cronograma-85bf4"; // ID do projeto, usado no caminho de segurança
        const firebaseConfig = {
            apiKey: "AIzaSyDB_q9kdQGNiLf34PPZFL2YuBDOj7XdwkA",
            authDomain: "cronograma-85bf4.firebaseapp.com",
            projectId: "cronograma-85bf4",
            storageBucket: "cronograma-85bf4.firebasestorage.app",
            messagingSenderId: "802190123207",
            appId: "1:802190123207:web:adaf51b25010f677bbdee2"
        };
        // Mantemos a verificação do token para o mecanismo de autenticação do ambiente
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;


        // dataService Interface (Definida no escopo do módulo para ser aumentada)
        const dataService = {
            projects: [],
            currentProjectId: null,
            userId: null, 
            isAuthReady: false,
            
            // --- FIREBASE IMPLEMENTATIONS ---
            initFirebase: async () => {
                try {
                    firebaseApp = initializeApp(firebaseConfig);
                    db = getFirestore(firebaseApp);
                    auth = getAuth(firebaseApp);

                    // Autenticação: Tenta com token personalizado, faz fallback para anónimo em caso de erro
                    if (initialAuthToken) {
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } catch (error) {
                            console.warn("Autenticação com token personalizado falhou, usando autenticação anónima:", error.code);
                            await signInAnonymously(auth);
                        }
                    } else {
                        await signInAnonymously(auth);
                    }

                    // Listener para o estado de autenticação (garante que o userId esteja pronto)
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            dataService.userId = user.uid;
                            dataService.isAuthReady = true;
                            console.log(`Firebase: User authenticated. UID: ${dataService.userId}`);
                            
                            // Inicia o listener de projetos após a autenticação
                            dataService.listenToProjects();
                        } else {
                            console.error("Firebase: User not authenticated.");
                            dataService.isAuthReady = false;
                            dataService.projects = [];
                            uiService.showToast('Erro de autenticação. Os dados não serão salvos.', 'error');
                        }
                        document.getElementById('loader').style.display = 'none';
                    });

                } catch (error) {
                    console.error("Erro na inicialização do Firebase:", error);
                    uiService.showToast('Erro ao conectar ao banco de dados!', 'error');
                    document.getElementById('loader').style.display = 'none';
                }
            },
            getProjectCollectionRef: () => {
                 // Caminho: /artifacts/{appId}/users/{userId}/projects
                if (!dataService.userId) throw new Error("Usuário não autenticado para buscar a coleção.");
                return collection(db, 'artifacts', appId, 'users', dataService.userId, 'projects');
            },
            listenToProjects: () => {
                // Remove listener anterior se existir
                unsubscribeProjects(); 

                if (!dataService.isAuthReady) return;
                
                const projectsRef = dataService.getProjectCollectionRef();
                const projectsQuery = query(projectsRef);

                unsubscribeProjects = onSnapshot(projectsQuery, (snapshot) => {
                    const newProjects = [];
                    snapshot.forEach(doc => {
                        const projectData = doc.data();
                        newProjects.push({ id: doc.id, ...projectData }); 
                    });

                    dataService.projects = newProjects;
                    dataService.recalculateAllProgress();
                    
                    if (dataService.currentProjectId) {
                        const currentProject = dataService.getProjectById(dataService.currentProjectId);
                        if (currentProject) {
                            uiService.renderProjectDashboard(currentProject, document.getElementById('task-filter-input').value);
                        } else {
                            App.showProjectView(); 
                        }
                    } else {
                        App.showProjectView();
                    }
                }, (error) => {
                    console.error("Erro ao ouvir projetos:", error);
                    uiService.showToast('Erro de sincronização em tempo real.', 'error');
                });
            },
            load: () => { /* Mantido para compatibilidade com a assinatura App.init */ },
            
            addProject: async (projectData) => {
                try {
                    const newProjectData = { name: projectData.name, tasks: [] };
                    await addDoc(dataService.getProjectCollectionRef(), newProjectData);
                } catch (error) {
                    console.error("Erro ao adicionar projeto:", error);
                    uiService.showToast('Falha ao adicionar projeto.', 'error');
                }
            },
            deleteProject: async (projectId) => {
                try {
                    const projectDocRef = doc(dataService.getProjectCollectionRef(), projectId.toString());
                    await deleteDoc(projectDocRef);
                } catch (error) {
                    console.error("Erro ao deletar projeto:", error);
                    uiService.showToast('Falha ao deletar projeto.', 'error');
                }
            },
            
            getProjectById: (id) => dataService.projects.find(p => p.id === id),
            getCurrentProject: () => dataService.getProjectById(dataService.currentProjectId),

            // Função utilitária para salvar um documento de projeto (adicionar ou editar)
            saveProjectDocument: async (project) => {
                try {
                    const projectId = project.id.toString(); 
                    const projectDocRef = doc(dataService.getProjectCollectionRef(), projectId);
                    await setDoc(projectDocRef, { name: project.name, tasks: project.tasks }, { merge: true });
                } catch (error) {
                    console.error("Erro ao salvar projeto/tarefas:", error);
                    uiService.showToast('Falha ao salvar dados.', 'error');
                }
            },

            saveTask: async (taskData) => {
                const project = dataService.getCurrentProject();
                if (!project) return;

                const { newStartDate, newEndDate, ...restOfTaskData } = taskData;
                
                let updatedTasks;

                if (taskData.id) { // Editando tarefa existente
                    updatedTasks = project.tasks.map(t => {
                        if (t.id === restOfTaskData.id) {
                            const updatedTask = { ...t, ...restOfTaskData };
                            if (newStartDate && newEndDate) {
                                const latestDates = dataService.getLatestDates(t);
                                if (latestDates.startDate !== newStartDate || latestDates.endDate !== newEndDate) {
                                    updatedTask.dateHistory = [...(updatedTask.dateHistory || []), { startDate: newStartDate, endDate: newEndDate }];
                                }
                            }
                            return updatedTask;
                        }
                        return t;
                    });
                } else { // Adicionando nova tarefa
                    const newTask = { 
                        ...restOfTaskData, 
                        id: Date.now(), 
                        dateHistory: [{ startDate: newStartDate, endDate: newEndDate }],
                        comments: taskData.comments || [], 
                    };
                    updatedTasks = [...project.tasks, newTask];
                }
                
                project.tasks = updatedTasks;
                dataService.recalculateAllProgress();
                await dataService.saveProjectDocument(project);
            },

            deleteTask: async (taskId) => {
                const project = dataService.getCurrentProject();
                if (!project) return;
                
                const idsToDelete = [taskId];
                const findChildren = (pid) => { 
                    project.tasks.filter(t => t.parentId === pid).forEach(c => { 
                        idsToDelete.push(c.id); findChildren(c.id); 
                    }); 
                };
                findChildren(taskId);
                
                let updatedTasks = project.tasks.filter(t => !idsToDelete.includes(t.id));
                
                updatedTasks = updatedTasks.map(t => {
                    if (idsToDelete.includes(t.dependsOn)) { t.dependsOn = null; }
                    return t;
                });

                project.tasks = updatedTasks;
                dataService.recalculateAllProgress();
                await dataService.saveProjectDocument(project);
            },
            
            importTasksFromExcel: async (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet);

                            const project = dataService.getCurrentProject();
                            const newTasks = [];
                            let maxId = project.tasks.reduce((max, task) => Math.max(max, task.id), 0);
                            
                            const createValidatedTask = (row, id) => {
                                const taskName = (row['Tarefa'] || '').trim();
                                if (!taskName) return null;
                                const dateKeys = Object.keys(row).filter(k => k.toLowerCase().includes('data')).sort();
                                const startDateRaw = row['Data Início'] || row['Data Inicio'] || row[dateKeys[0]];
                                const endDateRaw = row['Data Término'] || row['Data Termino'] || row[dateKeys[1]];

                                if (!startDateRaw || !endDateRaw) { console.warn(`Pulando tarefa "${taskName}" por data ausente.`); return null; }
                                const parseDate = (dateRaw) => {
                                    if (dateRaw instanceof Date) return dateRaw.toISOString().split('T')[0];
                                    if (typeof dateRaw === 'number') {
                                        const date = new Date(Math.round((dateRaw - 25569) * 86400 * 1000));
                                        return date.toISOString().split('T')[0];
                                    }
                                    return new Date(dateRaw).toISOString().split('T')[0];
                                };

                                try {
                                    const startDate = parseDate(startDateRaw);
                                    const endDate = parseDate(endDateRaw);

                                    return {
                                        id: id, name: taskName, assignedTo: (row['Atribuído a'] || row['Atribuido a'] || '').trim(),
                                        priority: (row['Prioridade'] || 'Média').trim(), dateHistory: [{ startDate: startDate, endDate: endDate }],
                                        status: (row['Status'] || 'Não Iniciada').trim(), progress: parseInt(row['Progresso (%)'], 10) || 0,
                                        risk: ((row['Risco (Sim/Nao)'] || '').trim()).toLowerCase() === 'sim',
                                        parentName: (row['Tarefa Pai (Nome)'] || '').trim(), parentId: null, comments: [], dependsOn: null
                                    };
                                } catch (e) { console.warn(`Pulando tarefa "${taskName}" devido a erro de parsing de data:`, e); return null; }
                            };

                            const parentRows = jsonData.filter(row => !(row['Tarefa Pai (Nome)'] || '').trim());
                            const childRows = jsonData.filter(row => !!(row['Tarefa Pai (Nome)'] || '').trim());
                            const taskNameMap = new Map();
                            project.tasks.forEach(t => taskNameMap.set(t.name.toLowerCase(), t.id));

                            parentRows.forEach(row => {
                                const task = createValidatedTask(row, ++maxId);
                                if (task) { newTasks.push(task); taskNameMap.set(task.name.toLowerCase(), task.id); }
                            });
                            childRows.forEach(row => {
                                const task = createValidatedTask(row, ++maxId);
                                if (task) {
                                    const parentNameLower = task.parentName.toLowerCase();
                                    if (taskNameMap.has(parentNameLower)) { task.parentId = taskNameMap.get(parentNameLower); } 
                                    newTasks.push(task);
                                }
                            });

                            newTasks.forEach(task => { delete task.parentName; project.tasks.push(task); });
                            
                            dataService.recalculateAllProgress();
                            await dataService.saveProjectDocument(project);
                            resolve();
                        } catch (err) { reject(err); }
                    };
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });
            },

            getLatestDates: (task) => {
                if (!task.dateHistory || task.dateHistory.length === 0) return { startDate: '', endDate: '' };
                return task.dateHistory[task.dateHistory.length - 1];
            },
            recalculateAllProgress: () => {
                dataService.projects.forEach(project => {
                    const tasks = project.tasks;
                    if (!tasks || tasks.length === 0) return;
                    const taskMap = new Map(tasks.map(t => [t.id, t]));
                    const childrenMap = new Map([...taskMap.keys()].map(k => [k, []]));
                    tasks.forEach(t => { if (t.parentId && childrenMap.has(t.parentId)) childrenMap.get(t.parentId).push(t.id); });

                    const calculateTaskProgress = (taskId) => {
                        const childrenIds = childrenMap.get(taskId);
                        const task = taskMap.get(taskId);
                        if (!childrenIds || childrenIds.length === 0) return task.progress;
                        
                        const childrenProgress = childrenIds.map(childId => calculateTaskProgress(childId));
                        const totalProgress = childrenProgress.reduce((sum, prog) => sum + prog, 0);
                        const averageProgress = Math.round(totalProgress / childrenIds.length);
                        
                        task.progress = averageProgress;
                        if (averageProgress === 100) task.status = 'Concluída';
                        else if (averageProgress > 0) task.status = 'Em Andamento';
                        else task.status = 'Não Iniciada';

                        return averageProgress;
                    };
                    tasks.filter(t => t.parentId === null).forEach(t => calculateTaskProgress(t.id));
                });
            },
            getProjectProgress: (tasks) => {
                if (!tasks || tasks.length === 0) return 0;
                const topLevelTasks = tasks.filter(t => t.parentId === null);
                if (topLevelTasks.length === 0) return 0;
                const totalProgress = topLevelTasks.reduce((sum, task) => sum + task.progress, 0);
                return Math.round(totalProgress / topLevelTasks.length);
            }
        };

        // App Controller - Initializes and coordinates modules
        const App = {
            async init() {
                await dataService.initFirebase(); 
                uiService.initTheme();
                this.bindEvents();
            },
            
            showProjectView() {
                dataService.currentProjectId = null;
                uiService.showView('project-view');
                uiService.renderProjectList(dataService.projects);
                uiService.updateMainDashboard(dataService.projects);
            },
            
            openProject(projectId) {
                dataService.currentProjectId = projectId; 
                const project = dataService.getProjectById(dataService.currentProjectId);
                if (project) {
                    uiService.showView('dashboard-view');
                    uiService.renderProjectDashboard(project);
                }
            },

            bindEvents() {
                document.getElementById('theme-toggle').addEventListener('click', () => uiService.toggleTheme());
                document.getElementById('add-project-btn').addEventListener('click', () => uiService.openModal('project-modal'));
                document.getElementById('project-form').addEventListener('submit', event => {
                    event.preventDefault();
                    const name = document.getElementById('project-name').value.trim();
                    if (name) {
                        dataService.addProject({ name });
                        uiService.closeModal('project-modal');
                        uiService.showToast('Projeto criado com sucesso! Sincronizando...', 'success');
                    }
                });
                
                // --- LISTENERS ATUALIZADOS PARA CLIQUE NO CARD ---
                document.getElementById('project-list').addEventListener('click', event => {
                    const deleteBtn = event.target.closest('.delete-project-btn');
                    
                    if (deleteBtn) {
                        // Ação de deletar: Impede a abertura do projeto
                        event.stopPropagation();
                        const projectId = deleteBtn.dataset.projectId;
                        uiService.showConfirmModal('Excluir este projeto e todas as suas tarefas? Esta ação é permanente.', async () => {
                            document.getElementById('loader').style.display = 'flex';
                            await dataService.deleteProject(projectId);
                            document.getElementById('loader').style.display = 'none';
                            uiService.showToast('Projeto excluído. Sincronizando...', 'error');
                        });
                        return; // Sai se o botão delete foi clicado
                    }
                    
                    const card = event.target.closest('.project-card-link');
                    if (card) {
                        this.openProject(card.dataset.projectId);
                    }
                });
                // --- FIM DOS LISTENERS ATUALIZADOS ---
                
                document.getElementById('back-to-projects-btn').addEventListener('click', () => this.showProjectView());
                document.getElementById('add-task-btn').addEventListener('click', () => uiService.openTaskModal('add'));
                
                document.getElementById('task-form').addEventListener('submit', async event => {
                    event.preventDefault();
                    const taskData = uiService.getTaskFormData();
                    
                    if (new Date(taskData.newStartDate) > new Date(taskData.newEndDate)) {
                        uiService.showToast('Data de Início não pode ser posterior à Data de Término!', 'error');
                        return;
                    }
                    
                    document.getElementById('loader').style.display = 'flex';
                    await dataService.saveTask(taskData); 
                    document.getElementById('loader').style.display = 'none';

                    uiService.closeModal('task-modal');
                    uiService.showToast('Tarefa salva! Sincronizando...');
                });

                document.getElementById('add-comment-btn').addEventListener('click', () => {
                    const input = document.getElementById('new-comment-input');
                    const text = input.value.trim();
                    if(text) {
                        uiService.addComment(text);
                        input.value = '';
                    }
                });

                document.getElementById('task-table-body').addEventListener('click', event => {
                    const button = event.target.closest('button');
                    if (!button) return;
                    const taskId = parseInt(button.dataset.taskId); 
                    const parentId = parseInt(button.dataset.parentId);
                    
                    if (button.classList.contains('add-subtask-btn')) uiService.openTaskModal('add', { parentId });
                    if (button.classList.contains('edit-task-btn')) uiService.openTaskModal('edit', { taskId });
                    
                    if (button.classList.contains('delete-task-btn')) {
                        uiService.showConfirmModal('Excluir esta tarefa e suas subtarefas?', async () => {
                            document.getElementById('loader').style.display = 'flex';
                            await dataService.deleteTask(taskId);
                            document.getElementById('loader').style.display = 'none';
                            uiService.showToast('Tarefa excluída. Sincronizando...', 'error');
                        });
                    }
                });

                document.getElementById('task-filter-input').addEventListener('input', (e) => {
                    uiService.renderProjectDashboard(dataService.getCurrentProject(), e.target.value);
                });

                document.getElementById('view-switcher').addEventListener('change', (e) => uiService.switchView(e.target.value));
                document.getElementById('export-excel-btn').addEventListener('click', () => reportService.exportExcel(dataService.getCurrentProject()));
                document.getElementById('generate-pdf-report-btn').addEventListener('click', () => reportService.generatePdf(dataService.getCurrentProject()));
                document.getElementById('print-view-btn').addEventListener('click', () => window.print());
                document.getElementById('download-template-btn').addEventListener('click', () => reportService.downloadExcelTemplate());
                document.getElementById('import-excel-btn').addEventListener('click', () => document.getElementById('import-excel-input').click());
                document.getElementById('import-excel-input').addEventListener('change', async (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        document.getElementById('loader').style.display = 'flex';
                        try {
                            await dataService.importTasksFromExcel(file); 
                            uiService.showToast('Tarefas importadas com sucesso! Sincronizando...');
                        } catch (error) {
                            console.error(error);
                            uiService.showToast('Erro ao importar o arquivo. Verifique o console.', 'error');
                        } finally {
                            document.getElementById('loader').style.display = 'none';
                            event.target.value = ''; 
                        }
                    }
                });
                document.querySelectorAll('.cancel-btn').forEach(btn => btn.addEventListener('click', () => uiService.closeAllModals()));
            }
        };

        // UI Service - Manages all DOM interactions
        const uiService = {
            mainDashboardCharts: {},

            showView(viewId) {
                document.getElementById('project-view').classList.add('hidden');
                document.getElementById('dashboard-view').classList.add('hidden');
                document.getElementById(viewId).classList.remove('hidden');
            },
            switchView(viewName) {
                document.getElementById('table-view').classList.toggle('hidden', viewName === 'gantt');
                document.getElementById('gantt-view').classList.toggle('hidden', viewName === 'table');
                if (viewName === 'gantt') this.renderGanttChart(dataService.getCurrentProject().tasks, document.getElementById('task-filter-input').value);
            },
            renderProjectDashboard(project, filter = '') {
                const filteredTasks = project.tasks.filter(t => 
                    t.name.toLowerCase().includes(filter.toLowerCase()) || 
                    (t.assignedTo && t.assignedTo.toLowerCase().includes(filter.toLowerCase()))
                );

                document.getElementById('project-title').textContent = project.name;
                this.renderTaskTable(filteredTasks);
                this.updateKpis(project.tasks); 
                this.renderAssigneeSummary(project.tasks);
                if (document.getElementById('view-switcher').value === 'gantt') {
                    this.renderGanttChart(filteredTasks);
                }
            },

            openModal(modalId) { 
                const modal = document.getElementById(modalId);
                modal.classList.remove('modal-hidden');
                modal.classList.add('modal-visible');
            },
            closeModal(modalId) {
                const modal = document.getElementById(modalId);
                modal.classList.remove('modal-visible');
                modal.classList.add('modal-hidden');
            },
            closeAllModals() {
                document.querySelectorAll('.modal-transition').forEach(modal => this.closeModal(modal.id));
            },
            openTaskModal(mode, data = {}) {
                document.getElementById('task-form').reset();
                const { parentId, taskId } = data;
                const project = dataService.getCurrentProject();
                const task = taskId ? project.tasks.find(t => t.id === taskId) : {};
                const isParent = taskId ? project.tasks.some(t => t.parentId === taskId) : false;
                
                const startDateInput = document.getElementById('start-date');
                const endDateInput = document.getElementById('end-date');
                const rescheduleBtnContainer = document.getElementById('reschedule-button-container');
                const dateHistoryContainer = document.getElementById('date-history-container');
                const dateHistoryList = document.getElementById('date-history-list');

                document.getElementById('progress-info').classList.toggle('hidden', !isParent);
                document.getElementById('task-progress').disabled = isParent;

                document.getElementById('modal-title').textContent = mode === 'add' ? 'Adicionar Tarefa' : 'Editar Tarefa';
                document.getElementById('task-id').value = task.id || '';
                document.getElementById('parent-id').value = parentId || (task ? task.parentId : '') || '';
                document.getElementById('task-name').value = task.name || '';
                document.getElementById('assigned-to').value = task.assignedTo || '';
                document.getElementById('task-priority').value = task.priority || 'Média';
                document.getElementById('task-status').value = task.status || 'Não Iniciada';
                document.getElementById('task-progress').value = task.progress || 0;
                document.getElementById('task-risk').checked = task.risk || false;
                
                const dependencySelect = document.getElementById('task-dependency');
                dependencySelect.innerHTML = '<option value="">Nenhuma</option>';
                project?.tasks.forEach(t => {
                    if (t.id !== task.id) { 
                        const option = document.createElement('option');
                        option.value = t.id;
                        option.textContent = t.name;
                        dependencySelect.appendChild(option);
                    }
                });
                dependencySelect.value = task.dependsOn || '';

                this.renderComments(task.comments || []);
                document.getElementById('new-comment-input').value = '';

                if (mode === 'edit') {
                    const latestDates = dataService.getLatestDates(task);
                    startDateInput.value = latestDates.startDate;
                    endDateInput.value = latestDates.endDate;
                    startDateInput.disabled = true;
                    endDateInput.disabled = true;
                    rescheduleBtnContainer.classList.remove('hidden');
                    dateHistoryContainer.classList.remove('hidden');
                    
                    dateHistoryList.innerHTML = (task.dateHistory || []).map((d, i) => 
                        `<p>${i + 1}: ${new Date(d.startDate+'T00:00:00').toLocaleDateString('pt-BR')} - ${new Date(d.endDate+'T00:00:00').toLocaleDateString('pt-BR')}</p>`
                    ).join('');
                    
                    const rescheduleHandler = () => {
                        startDateInput.disabled = false;
                        endDateInput.disabled = false;
                        document.getElementById('reschedule-btn').classList.add('hidden');
                    };

                    document.getElementById('reschedule-btn').classList.remove('hidden');
                    document.getElementById('reschedule-btn').onclick = rescheduleHandler;

                } else { 
                    startDateInput.disabled = false;
                    endDateInput.disabled = false;
                    startDateInput.value = '';
                    endDateInput.value = '';
                    rescheduleBtnContainer.classList.add('hidden');
                    dateHistoryContainer.classList.add('hidden');
                }
                
                this.openModal('task-modal');
            },
            getTaskFormData() {
                const startDateInput = document.getElementById('start-date');
                const endDateInput = document.getElementById('end-date');
                
                const commentsList = document.getElementById('comments-list');
                const comments = Array.from(commentsList.querySelectorAll('p')).map(p => ({
                    text: p.dataset.text, 
                    timestamp: p.dataset.timestamp
                }));

                const data = {
                    id: document.getElementById('task-id').value ? parseInt(document.getElementById('task-id').value) : null,
                    parentId: document.getElementById('parent-id').value ? parseInt(document.getElementById('parent-id').value) : null,
                    name: document.getElementById('task-name').value, assignedTo: document.getElementById('assigned-to').value,
                    priority: document.getElementById('task-priority').value, 
                    status: document.getElementById('task-status').value,
                    progress: parseInt(document.getElementById('task-progress').value), risk: document.getElementById('task-risk').checked,
                    dependsOn: document.getElementById('task-dependency').value ? parseInt(document.getElementById('task-dependency').value) : null,
                    comments: comments,
                    newStartDate: startDateInput.value,
                    newEndDate: endDateInput.value,
                };
                return data;
            },
            showConfirmModal(body, onConfirm) {
                document.getElementById('confirm-modal-body').textContent = body;
                this.openModal('confirm-modal');
                const confirmBtn = document.getElementById('confirm-ok-btn');
                const cancelBtn = document.getElementById('confirm-cancel-btn');
                
                const newConfirmBtn = confirmBtn.cloneNode(true);
                const newCancelBtn = cancelBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                
                newConfirmBtn.addEventListener('click', () => { onConfirm(); this.closeModal('confirm-modal'); });
                newCancelBtn.addEventListener('click', () => { this.closeModal('confirm-modal'); });
            },
            
            renderComments(comments) {
                const listEl = document.getElementById('comments-list');
                listEl.innerHTML = '';
                comments.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(comment => {
                    const p = document.createElement('p');
                    p.className = "border-b border-[var(--border-color)] pb-1 mb-1 text-xs last:border-b-0";
                    const dateString = new Date(comment.timestamp).toLocaleDateString('pt-BR');
                    const timeString = new Date(comment.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    p.innerHTML = `<span class="font-semibold text-gray-500">${dateString} ${timeString}:</span> ${comment.text}`;
                    p.dataset.timestamp = comment.timestamp;
                    p.dataset.text = comment.text; 
                    listEl.appendChild(p);
                });
            },
            addComment(text) {
                const listEl = document.getElementById('comments-list');
                const p = document.createElement('p');
                const timestamp = new Date().toISOString();
                p.className = "border-b border-[var(--border-color)] pb-1 mb-1 text-xs last:border-b-0";
                const dateString = new Date(timestamp).toLocaleDateString('pt-BR');
                const timeString = new Date(timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                p.innerHTML = `<span class="font-semibold text-gray-500">${dateString} ${timeString}:</span> ${text}`;
                p.dataset.timestamp = timestamp;
                p.dataset.text = text; 
                listEl.prepend(p); 
            },

            showToast(message, type = 'success') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                const colors = { success: 'bg-green-600', error: 'bg-red-600' };
                toast.className = `toast text-white ${colors[type]}`;
                toast.innerHTML = `<p>${message}</p>`;
                container.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 3000);
            },
            
            initTheme() {
                const theme = localStorage.getItem('theme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (theme === 'dark' || (!theme && prefersDark)) {
                    document.documentElement.classList.add('dark');
                }
                this.updateThemeIcons();
            },
            toggleTheme() {
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
                this.updateThemeIcons();
                this.updateMainDashboard(dataService.projects);
                if (document.getElementById('view-switcher').value === 'gantt' && dataService.currentProjectId) {
                    this.renderGanttChart(dataService.getCurrentProject().tasks, document.getElementById('task-filter-input').value);
                }
            },
            updateThemeIcons() {
                const isDark = document.documentElement.classList.contains('dark');
                document.getElementById('theme-icon-sun').style.display = isDark ? 'block' : 'none';
                document.getElementById('theme-icon-moon').style.display = isDark ? 'none' : 'block';
            },

            renderProjectList(projects) {
                const listEl = document.getElementById('project-list');
                listEl.innerHTML = '';
                if (projects.length === 0) {
                    listEl.innerHTML = `<p class="text-gray-500 col-span-full">Nenhum projeto encontrado. Crie o seu primeiro!</p>`;
                    return;
                }
                projects.forEach(project => {
                    const progress = dataService.getProjectProgress(project.tasks);
                    const completedTasks = project.tasks.filter(t => t.status === 'Concluída').length;
                    const totalTasks = project.tasks.length;
                    
                    // --- MUDANÇA: Novo card com classe clicável e ID do projeto ---
                    const card = document.createElement('div');
                    card.className = 'project-card-link bg-[var(--card-bg)] p-6 rounded-lg shadow-md border border-[var(--border-color)] flex flex-col justify-between cursor-pointer transition-all duration-300 hover:scale-[1.02] hover:shadow-xl';
                    card.dataset.projectId = project.id; 
                    
                    // --- MUDANÇA: Removendo o botão "Abrir" e integrando o ícone de ação ---
                    card.innerHTML = `
                        <div>
                            <h3 class="text-xl font-bold mb-2">${project.name}</h3>
                            <p class="text-sm text-gray-400 mb-4">${completedTasks} de ${totalTasks} tarefas concluídas</p>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs font-semibold">Progresso</span>
                                <span class="text-xs font-semibold">${progress}%</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mb-4">
                                <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${progress}%"></div>
                            </div>
                            <div class="flex justify-end">
                                <button class="delete-project-btn bg-red-500 bg-opacity-10 text-red-500 px-3 py-2 rounded-md hover:bg-opacity-20 transition-colors" data-project-id="${project.id}" title="Excluir Projeto">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        </div>`;
                    listEl.appendChild(card);
                });
            },
            
            renderTaskTable: function(tasks) {
                const tableBody = document.getElementById('task-table-body');
                tableBody.innerHTML = '';
                const tasksToRender = [];
                
                const processTasks = (parentId, level) => {
                    tasks.filter(t => t.parentId === parentId)
                        .sort((a,b) => {
                            const dateA = new Date(dataService.getLatestDates(a).startDate);
                            const dateB = new Date(dataService.getLatestDates(b).startDate);
                            return dateA - dateB;
                        })
                        .forEach(task => { tasksToRender.push({ ...task, level }); processTasks(task.id, level + 1); });
                };
                processTasks(null, 0);

                tasksToRender.forEach(task => {
                    const latestDates = dataService.getLatestDates(task);
                    const statusInfo = reportService.getTaskStatusClass(task.status, latestDates.endDate);
                    const duration = reportService.calculateDuration(latestDates.startDate, latestDates.endDate);
                    const isParent = tasks.some(t => t.parentId === task.id);
                    const riskClass = task.risk ? 'border-l-4 border-red-500' : '';
                    const commentCount = (task.comments || []).length;
                    
                    const row = document.createElement('tr');
                    row.className = `border-b border-[var(--border-color)] hover:bg-gray-100 dark:hover:bg-gray-800 ${riskClass}`;
                    row.innerHTML = `
                        <!-- 1. Tarefa -->
                        <td class="p-3"><div style="padding-left: ${task.level * 20}px;" class="font-medium ${isParent ? 'font-bold' : ''} flex items-center gap-2">
                            ${task.risk ? '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-red-500"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>' : ''}
                            ${task.name}
                        </div></td>
                        <!-- 2. Duração em dias -->
                        <td class="p-3">${duration} dias</td>
                        <!-- 3. Data de Início -->
                        <td class="p-3">${new Date(latestDates.startDate + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                        <!-- 4. Data de Término -->
                        <td class="p-3">${new Date(latestDates.endDate + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                        <!-- 5. Status -->
                        <td class="p-3"><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusInfo.badge}">${statusInfo.name}</span></td>
                        <!-- 6. Comentários (Botão para abrir modal de edição e ver/adicionar comentários) -->
                        <td class="p-3 text-center">
                            <button class="edit-task-btn flex items-center justify-center gap-1 mx-auto" data-task-id="${task.id}" title="${commentCount > 0 ? commentCount + ' Comentário(s). Clique para ver/adicionar.' : 'Adicionar Comentário'}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${commentCount > 0 ? 'text-blue-500' : 'text-gray-400'}"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                                ${commentCount > 0 ? `(${commentCount})` : ''}
                            </button>
                        </td>
                        <!-- Ações (Botões Edit/Delete/Subtask - Removido da impressão) -->
                        <td class="p-3 flex items-center justify-center gap-2 no-print">
                            <button class="add-subtask-btn" data-parent-id="${task.id}" title="Adicionar Subtarefa"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-500"><path d="M3 10h12v8H3zM3 10V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-7M18 18v-5h-5"/></svg></button>
                            <button class="edit-task-btn" data-task-id="${task.id}" title="Editar"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-gray-500"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg></button>
                            <button class="delete-task-btn" data-task-id="${task.id}" title="Excluir"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-red-500"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                        </td>`;
                    tableBody.appendChild(row);
                });
            },
            updateKpis: function(tasks) {
                const kpiDashboard = document.getElementById('kpi-dashboard');
                const overallProgress = dataService.getProjectProgress(tasks);
                const kpis = [
                    { label: 'Progresso Geral', value: `${overallProgress}%` },
                    { label: 'Total de Tarefas', value: tasks.length },
                    { label: 'Concluídas', value: tasks.filter(t => t.status === 'Concluída').length },
                    { label: 'Atrasadas', value: tasks.filter(t => reportService.getTaskStatusClass(t.status, dataService.getLatestDates(t).endDate).name === 'Atrasada').length },
                    { label: 'Em Risco', value: tasks.filter(t => t.risk).length },
                ];
                kpiDashboard.innerHTML = kpis.map(kpi => `
                    <div class="bg-[var(--card-bg)] p-4 rounded-lg shadow-md flex items-center gap-4 border border-[var(--border-color)]">
                        <div> <div class="text-3xl font-bold">${kpi.value}</div> <div class="text-sm text-gray-400">${kpi.label}</div> </div>
                    </div>`).join('');
            },
            renderAssigneeSummary(tasks) {
                const summaryContainer = document.getElementById('assignee-summary-list');
                const summary = tasks.reduce((acc, task) => {
                    const assignee = task.assignedTo || 'Não atribuído';
                    if (!acc[assignee]) acc[assignee] = 0;
                    acc[assignee]++;
                    return acc;
                }, {});

                summaryContainer.innerHTML = Object.entries(summary).map(([name, count]) => `
                    <div class="flex justify-between items-center">
                        <span>${name}</span>
                        <span class="font-bold bg-gray-200 dark:bg-gray-700 text-xs px-2 py-1 rounded-full">${count}</span>
                    </div>
                `).join('');
            },
            updateMainDashboard(projects) { 
                const mainDashboard = document.getElementById('main-dashboard');
                
                let inProgressCount = 0, overdueCount = 0, atRiskCount = 0;
                const totalProjects = projects.length;

                projects.forEach(project => {
                    const progress = dataService.getProjectProgress(project.tasks);
                    if (progress > 0 && progress < 100) inProgressCount++;
                    if (project.tasks.some(t => reportService.getTaskStatusClass(t.status, dataService.getLatestDates(t).endDate).name === 'Atrasada')) overdueCount++;
                    if (project.tasks.some(t => t.risk)) atRiskCount++;
                });
                
                const icons = {
                    total: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>`,
                    inProgress: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
                    overdue: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
                    atRisk: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>`
                };
                
                mainDashboard.innerHTML = `
                    <div class="bg-blue-100 dark:bg-blue-900/50 p-5 rounded-lg shadow-md flex items-center gap-5 border border-blue-200 dark:border-blue-800">
                        <div class="bg-blue-500 p-3 rounded-full">${icons.total}</div>
                        <div>
                            <div class="text-3xl font-bold text-blue-700 dark:text-blue-300">${totalProjects}</div>
                            <div class="text-sm text-blue-600 dark:text-blue-400">Total de Projetos</div>
                        </div>
                    </div>
                    <div class="bg-yellow-100 dark:bg-yellow-900/50 p-5 rounded-lg shadow-md flex items-center gap-5 border border-yellow-200 dark:border-yellow-800">
                        <div class="bg-yellow-500 p-3 rounded-full">${icons.inProgress}</div>
                        <div>
                            <div class="text-3xl font-bold text-yellow-700 dark:text-yellow-300">${inProgressCount}</div>
                            <div class="text-sm text-yellow-600 dark:text-yellow-400">Em Andamento</div>
                        </div>
                    </div>
                    <div class="bg-red-100 dark:bg-red-900/50 p-5 rounded-lg shadow-md flex items-center gap-5 border border-red-200 dark:border-red-800">
                        <div class="bg-red-500 p-3 rounded-full">${icons.overdue}</div>
                        <div>
                            <div class="text-3xl font-bold text-red-700 dark:text-red-300">${overdueCount}</div>
                            <div class="text-sm text-red-600 dark:text-red-400">Projetos Atrasados</div>
                        </div>
                    </div>
                    <div class="bg-orange-100 dark:bg-orange-900/50 p-5 rounded-lg shadow-md flex items-center gap-5 border border-orange-200 dark:border-orange-800">
                        <div class="bg-orange-500 p-3 rounded-full">${icons.atRisk}</div>
                        <div>
                            <div class="text-3xl font-bold text-orange-700 dark:text-orange-300">${atRiskCount}</div>
                            <div class="text-sm text-orange-600 dark:text-orange-400">Projetos em Risco</div>
                        </div>
                    </div>
                `;
            },
            renderGanttChart: function(tasks) {
                const ganttView = document.getElementById('gantt-view');
                if (!tasks || tasks.length === 0 || ganttView.classList.contains('hidden')) return;

                const taskNamesContainer = document.getElementById('gantt-task-names');
                const timelineBody = document.getElementById('gantt-timeline-body');
                const ganttHeader = document.getElementById('gantt-header');
                const dependencyLines = document.getElementById('gantt-dependency-lines');
                taskNamesContainer.innerHTML = ''; timelineBody.innerHTML = ''; ganttHeader.innerHTML = ''; dependencyLines.innerHTML = '';

                const allDates = tasks.flatMap(t => t.dateHistory.flatMap(d => [new Date(d.startDate), new Date(d.endDate)]))
                                        .filter(d => !isNaN(d.getTime()));
                if (allDates.length === 0) return;

                let minDate = new Date(Math.min.apply(null, allDates));
                let maxDate = new Date(Math.max.apply(null, allDates));
                minDate.setDate(minDate.getDate() - 2); maxDate.setDate(maxDate.getDate() + 2);

                const totalDays = reportService.calculateDuration(minDate.toISOString().split('T')[0], maxDate.toISOString().split('T')[0]);
                if (totalDays <= 0) return;
                const dayWidth = 40; 
                
                timelineBody.style.width = `${totalDays * dayWidth}px`;
                ganttHeader.style.width = `${totalDays * dayWidth}px`;
                
                let currentDate = new Date(minDate);
                ganttHeader.style.display = 'flex';
                for (let i = 1; i <= totalDays; i++) {
                    const dayCell = document.createElement('div');
                    const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
                    dayCell.className = `text-center text-xs p-1 border-r border-b border-[var(--border-color)] shrink-0 ${isWeekend ? 'bg-gray-300 dark:bg-gray-800 font-semibold' : ''}`;
                    dayCell.style.width = `${dayWidth}px`;
                    dayCell.textContent = `${currentDate.getDate()}/${currentDate.getMonth()+1}`;
                    ganttHeader.appendChild(dayCell);
                    currentDate.setDate(currentDate.getDate() + 1);
                }

                let taskOrder = [];
                const processGanttTasks = (parentId, level) => {
                    tasks.filter(t => t.parentId === parentId).sort((a,b) => {
                        const dateA = new Date(dataService.getLatestDates(a).startDate);
                        const dateB = new Date(dataService.getLatestDates(b).startDate);
                        return dateA - dateB;
                    }).forEach(task => { taskOrder.push({ ...task, level }); processGanttTasks(task.id, level + 1); });
                };
                processGanttTasks(null, 0);
                
                const taskPositions = new Map();
                taskOrder.forEach((task, index) => {
                    const isParent = tasks.some(t => t.parentId === task.id);
                    const nameDiv = document.createElement('div');
                    nameDiv.className = `gantt-task-name h-10 flex items-center border-b border-[var(--border-color)] p-2 ${isParent ? 'font-bold' : ''}`;
                    nameDiv.style.paddingLeft = `${task.level * 15 + 8}px`;
                    nameDiv.textContent = task.name;
                    taskNamesContainer.appendChild(nameDiv);

                    const latestDates = dataService.getLatestDates(task);
                    const startDate = new Date(latestDates.startDate + 'T00:00:00');
                    const endDate = new Date(latestDates.endDate + 'T00:00:00');
                    if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) { return; }

                    const duration = reportService.calculateDuration(latestDates.startDate, latestDates.endDate);
                    const startDay = reportService.calculateDuration(minDate.toISOString().split('T')[0], latestDates.startDate);
                    const bar = document.createElement('div');
                    const statusInfo = reportService.getTaskStatusClass(task.status, latestDates.endDate);
                    
                    let barColor;
                    if (isParent) { barColor = 'bg-gray-500 dark:bg-gray-600'; 
                    } else if (statusInfo.name === 'Atrasada') { barColor = 'bg-red-500';
                    } else if (statusInfo.name === 'Concluída') { barColor = 'bg-green-500';
                    } else { barColor = 'bg-blue-500'; }

                    bar.className = `gantt-bar ${isParent ? 'gantt-bar-parent' : ''} ${barColor}`;
                    bar.style.left = `${(startDay - 1) * dayWidth}px`;
                    bar.style.width = `${duration * dayWidth}px`;
                    bar.style.top = `${index * 40}px`;
                    bar.title = `${task.name}\nProgresso: ${task.progress}%\nInício: ${startDate.toLocaleDateString('pt-BR')}\nTérmino: ${endDate.toLocaleDateString('pt-BR')}`;
                    
                    if (!isParent) {
                        const progressOverlay = document.createElement('div');
                        progressOverlay.style.width = `${task.progress}%`;
                        progressOverlay.style.height = '100%';
                        progressOverlay.className = `absolute top-0 left-0 bg-opacity-70 ${barColor}`;
                        progressOverlay.style.backgroundColor = barColor.replace('bg-', 'bg-');
                        const progressText = document.createElement('span');
                        progressText.className = 'absolute inset-0 text-white flex items-center justify-center';
                        progressText.textContent = `${task.progress}%`;
                        
                        bar.innerHTML = '';
                        bar.style.backgroundColor = '#ccc'; 
                        bar.style.color = '#1f2937'; 
                        bar.appendChild(progressOverlay);
                        bar.appendChild(progressText);
                    } else {
                        bar.textContent = task.name;
                        bar.classList.add('text-xs');
                    }

                    timelineBody.appendChild(bar);
                    
                    taskPositions.set(task.id, {
                        x_start: (startDay - 1) * dayWidth,
                        x_end: ((startDay - 1) + duration) * dayWidth,
                        y: (index * 40) + (isParent ? 14 : 20) 
                    });
                });
                
                taskOrder.forEach(task => {
                    if (task.dependsOn && taskPositions.has(task.dependsOn) && taskPositions.has(task.id)) {
                        const fromTask = taskPositions.get(task.dependsOn);
                        const toTask = taskPositions.get(task.id);
                        const line = document.createElementNS("http://www.w3.org/2000/svg", "path");
                        const x1 = fromTask.x_end;
                        const y1 = fromTask.y;
                        const x2 = toTask.x_start;
                        const y2 = toTask.y;
                        const curve = `M ${x1} ${y1} C ${x1 + 25} ${y1} ${x2 - 25} ${y2} ${x2} ${y2}`;
                        
                        line.setAttribute("d", curve);
                        line.setAttribute("stroke", "#6b7280");
                        line.setAttribute("stroke-width", "1.5");
                        line.setAttribute("fill", "none");
                        line.setAttribute("marker-end", "url(#arrow)");
                        dependencyLines.appendChild(line);
                    }
                });
                if (dependencyLines.innerHTML !== '') {
                    const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
                    defs.innerHTML = `<marker id="arrow" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#6b7280" /></marker>`;
                    dependencyLines.prepend(defs); 
                }
            },
        };
        
        // Report Service - Handles PDF, Excel generation and Template
        const reportService = {
            downloadExcelTemplate() {
                const headers = ['Tarefa', 'Duração (dias)', 'Data Início', 'Data Termino', 'Status', 'Progresso (%)', 'Prioridade', 'Atribuído a', 'Risco (Sim/Nao)', 'Tarefa Pai (Nome)'];
                const exampleData = [
                    { 'Tarefa': 'Planejamento Geral', 'Duração (dias)': 5, 'Data Início': '2025-11-01', 'Data Termino': '2025-11-05', 'Status': 'Não Iniciada', 'Progresso (%)': 0, 'Prioridade': 'Alta', 'Atribuído a': 'Gerente de Projeto', 'Risco (Sim/Nao)': 'Nao', 'Tarefa Pai (Nome)': '' },
                    { 'Tarefa': 'Definir Escopo', 'Duração (dias)': 2, 'Data Início': '2025-11-01', 'Data Termino': '2025-11-02', 'Status': 'Não Iniciada', 'Progresso (%)': 0, 'Prioridade': 'Alta', 'Atribuído a': 'Analista', 'Risco (Sim/Nao)': 'Nao', 'Tarefa Pai (Nome)': 'Planejamento Geral' }
                ];
                const worksheet = XLSX.utils.json_to_sheet(exampleData, { header: headers });
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Tarefas");
                worksheet['!cols'] = [ { wch: 40 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 20 }, { wch: 15 }, { wch: 40 } ];
                XLSX.writeFile(workbook, "template_importacao.xlsx");
            },
            calculateDuration: (start, end) => {
                if (!start || !end) return 0;
                const diffTime = new Date(end) - new Date(start);
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            },
            getTaskStatusClass: (status, endDate) => {
                const today = new Date(); today.setHours(0,0,0,0);
                const taskEndDate = new Date(endDate + 'T00:00:00');
                if (status !== 'Concluída' && taskEndDate < today) return { badge: 'bg-red-600 text-white', name: 'Atrasada' };
                switch (status) {
                    case 'Concluída': return { badge: 'bg-green-600 text-white', name: 'Concluída' };
                    case 'Em Andamento': return { badge: 'bg-yellow-500 text-black', name: 'Em Andamento' };
                    default: return { badge: 'bg-gray-500 text-white', name: 'Não Iniciada' };
                }
            },
            exportExcel: function(project) {
                if (!project) return;
                const dataToExport = [];
                const processTasksForExport = (parentId, level) => {
                    project.tasks.filter(t => t.parentId === parentId)
                        .sort((a,b) => {
                            const dateA = new Date(dataService.getLatestDates(a).startDate);
                            const dateB = new Date(dataService.getLatestDates(b).startDate);
                            return dateA - dateB;
                        })
                        .forEach(task => {
                            const latestDates = dataService.getLatestDates(task);
                            const duration = this.calculateDuration(latestDates.startDate, latestDates.endDate);
                            const statusInfo = this.getTaskStatusClass(task.status, latestDates.endDate);
                            const commentsString = (task.comments || [])
                                .map(c => `${new Date(c.timestamp).toLocaleDateString('pt-BR')}: ${c.text}`)
                                .join(' | ');

                            dataToExport.push({
                                'Tarefa': `${'  '.repeat(level)}${task.name}`, 
                                'Duração (dias)': duration, 
                                'Data de Início': new Date(latestDates.startDate + 'T00:00:00').toLocaleDateString('pt-BR'), 
                                'Data de Término': new Date(latestDates.endDate + 'T00:00:00').toLocaleDateString('pt-BR'),
                                'Status': statusInfo.name, 
                                'Comentários': commentsString,
                                'Progresso (%)': task.progress, 
                                'Atribuído a': task.assignedTo, 
                                'Prioridade': task.priority,
                                'Em Risco': task.risk ? 'Sim' : 'Não'
                            });
                            processTasksForExport(task.id, level + 1);
                        });
                };
                processTasksForExport(null, 0);
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Cronograma");
                worksheet['!cols'] = [ { wch: 40 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 60 }, { wch: 15 }, { wch: 20 }, { wch: 15 }, { wch: 15 } ];
                XLSX.writeFile(workbook, `${project.name.replace(/ /g,"_")}_Relatorio.xlsx`);
            },
            generatePdf: function(project) {
                const loader = document.getElementById('loader');
                loader.style.display = 'flex';
                if (!project) { loader.style.display = 'none'; return; }
                const reportElement = document.createElement('div');
                reportElement.className = 'p-8 bg-white dark:bg-gray-800';
                reportElement.style.width = '1123px'; 
                const titleHeader = document.querySelector('#dashboard-view header').cloneNode(true);
                titleHeader.querySelector('button.no-print')?.remove();
                const kpiDashboardClone = document.getElementById('kpi-dashboard').cloneNode(true);
                const currentViewId = document.getElementById('view-switcher').value === 'table' ? 'table-view' : 'gantt-view';
                const activeViewClone = document.getElementById(currentViewId).cloneNode(true);
                activeViewClone.classList.remove('hidden');
                activeViewClone.style.display = 'block';

                if (currentViewId === 'table-view') {
                    const thead = activeViewClone.querySelector('thead');
                    thead.querySelector('th:last-child')?.remove();
                    activeViewClone.querySelectorAll('tbody td.no-print').forEach(cell => cell.remove());
                }

                const scrollableContent = activeViewClone.querySelector('.overflow-x-auto, .gantt-timeline-container');
                if (scrollableContent) scrollableContent.style.overflow = 'visible';
                
                reportElement.appendChild(titleHeader);
                reportElement.appendChild(kpiDashboardClone);
                reportElement.appendChild(activeViewClone);
                
                reportElement.style.position = 'absolute';
                reportElement.style.left = '-9999px';
                document.body.appendChild(reportElement);

                setTimeout(() => {
                    const opt = { 
                        margin: 10, 
                        filename: `${project.name.replace(/ /g,"_")}_Relatorio.pdf`, 
                        image: { type: 'jpeg', quality: 0.98 }, 
                        html2canvas: { scale: 2, useCORS: true, logging: false, backgroundColor: null }, 
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' } 
                    };
                    html2pdf().from(reportElement).set(opt).save().then(() => {
                        loader.style.display = 'none';
                        document.body.removeChild(reportElement);
                    }).catch(err => {
                        console.error("Erro ao gerar PDF:", err);
                        loader.style.display = 'none';
                        document.body.removeChild(reportElement);
                    });
                }, 300);
            }
        };

        // --- Kick off the app ---
        document.addEventListener('DOMContentLoaded', () => App.init());
        
    </script>
</body>
</html>
