<!DOCTYPE html>
<html lang="pt-BR" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Projetos - Vinci Highways</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* Estilos personalizados */
        :root { --background-color: #f3f4f6; --text-color: #374151; --card-bg: #ffffff; --card-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); --border-color: #e5e7eb; }
        html.dark { --background-color: #111827; --text-color: #d1d5db; --card-bg: #1f2937; --card-shadow: 0 4px 6px -1p-1px rgb(0 0 0 / 0.2), 0 2px 4px -2px rgb(0 0 0 / 0.2); --border-color: #374151; }
        body { background-color: var(--background-color); color: var(--text-color); font-family: 'Inter', sans-serif; transition: background-color 0.3s ease, color 0.3s ease; }
        @import url('https://rsms.me/inter/inter.css');
        .gantt-chart-container { display: grid; grid-template-columns: 250px 1fr; overflow-x: auto; position: relative; }
        .gantt-task-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .gantt-bar { position: absolute; height: 24px; border-radius: 4px; color: white; font-size: 12px; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer; z-index: 10; }
        .gantt-bar-parent { height: 12px; top: 8px; }
        #gantt-dependency-lines { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; overflow: visible; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; z-index: 9999; backdrop-filter: blur(4px); transition: opacity 0.3s ease; }
        html.dark #loader { background-color: rgba(17, 24, 39, 0.8); }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Transitions for Modals */
        .modal-transition { transition: opacity 0.3s ease, transform 0.3s ease; }
        .modal-hidden { opacity: 0; transform: scale(0.95); pointer-events: none; }
        .modal-visible { opacity: 1; transform: scale(1); }
        /* Toast Notifications */
        #toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 100; display: flex; flex-direction: column; gap: 0.75rem; }
        .toast { display: flex; align-items: center; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); transform: translateX(120%); opacity: 0; transition: all 0.4s cubic-bezier(0.21, 1.02, 0.73, 1); }
        .toast.show { transform: translateX(0); opacity: 1; }
        /* Estilos para Impress√£o */
        @media print { 
            .no-print { display: none !important; } 
            body { background-color: #ffffff !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; } 
            .container, #dashboard-view, main#content-area, .bg-white { padding: 0 !important; margin: 0 !important; max-width: 100% !important; box-shadow: none !important; border: none !important; } 
            .gantt-timeline-container, .overflow-x-auto { overflow: visible !important; } 
            .gantt-bar { color: #000 !important; font-weight: bold; }
            .bg-blue-500 { background-color: #3b82f6 !important; }
            .bg-green-500 { background-color: #10b981 !important; }
            .bg-red-500 { background-color: #ef4444 !important; }
            .bg-gray-500 { background-color: #6b7280 !important; }
        }
        
        /* Z-index para modais */
        .modal-z-50 { z-index: 50; }
        .modal-z-60 { z-index: 60; }
        
        /* Estilos para coment√°rios edit√°veis */
        .comment-item { position: relative; }
        .comment-actions { position: absolute; right: 0; top: 0; display: none; }
        .comment-item:hover .comment-actions { display: flex; }
        .edit-comment-input { width: 100%; border: 1px solid #d1d5db; border-radius: 4px; padding: 4px 8px; }
        
        /* Estilos para ajuste de importa√ß√£o */
        .import-error-row { background-color: #fef2f2 !important; }
        .import-valid-row { background-color: #f0fdf4 !important; }

        /* Estilos para tooltip dos gr√°ficos */
        .chart-tooltip { position: absolute; background: rgba(0, 0, 0, 0.8); color: white; padding: 8px 12px; border-radius: 4px; font-size: 12px; pointer-events: none; z-index: 1000; max-width: 300px; }
        
        /* Estilos para caixa de sele√ß√£o de usu√°rios */
        .assigned-users-container { max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; padding: 8px; }
        .user-checkbox-item { display: flex; align-items: center; padding: 4px 0; }
        .user-checkbox-item input { margin-right: 8px; }
    </style>
</head>
<body class="antialiased">
    <div id="loader" class="no-print"><div class="spinner"></div></div>
    
    <div id="toast-container" class="no-print"></div>

    <div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50 modal-transition modal-visible">
        <div class="bg-[var(--card-bg)] rounded-xl shadow-2xl p-8 w-full max-w-md">
            <h2 class="text-3xl font-bold mb-2 text-blue-600">Vinci Highways Projects</h2>
            <p class="text-gray-400 mb-6">Acesso restrito ao dom√≠nio @vinci-highways.com.br</p>

            <form id="auth-form" class="space-y-4">
                <input type="email" id="auth-email" placeholder="E-mail (@vinci-highways.com.br)" class="mt-1 block w-full border border-[var(--border-color)] rounded-md shadow-sm p-3 bg-transparent" required>
                <input type="password" id="auth-password" placeholder="Senha" class="mt-1 block w-full border border-[var(--border-color)] rounded-md shadow-sm p-3 bg-transparent" required>
                
                <div id="secret-code-container" class="hidden">
                    <input type="text" id="auth-secret-code" placeholder="C√≥digo de Acesso (Apenas Gestor)" class="mt-1 block w-full border border-yellow-400 rounded-md shadow-sm p-3 bg-transparent">
                    <p class="text-xs text-yellow-500 mt-1">Use "MASTER_GESTOR" no registro para obter o papel de Gestor.</p>
                </div>

                <div class="flex justify-between items-center">
                    <button type="button" id="toggle-auth-mode" class="text-sm text-blue-500 hover:underline transition-colors">Precisa de uma conta? Registrar</button>
                    <button type="button" id="toggle-secret-code" class="text-xs text-gray-500 hover:underline transition-colors">C√≥digo Secreto?</button>
                </div>

                <div class="flex justify-end gap-2">
                    <button type="submit" id="auth-submit-btn" class="w-full bg-blue-600 text-white px-4 py-3 rounded-md font-semibold hover:bg-blue-700 transition-colors">Login</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Cadastro de Usu√°rio - MAIOR Z-INDEX -->
    <div id="add-user-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center no-print modal-transition modal-hidden modal-z-60">
        <div class="bg-[var(--card-bg)] rounded-lg shadow-xl p-6 w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4 text-[var(--text-color)]">Cadastrar Novo Usu√°rio</h2>
            <form id="add-user-form">
                <div class="mb-4">
                    <label for="new-user-name" class="block text-sm font-medium text-gray-400">Nome Completo</label>
                    <input type="text" id="new-user-name" class="mt-1 block w-full border border-[var(--border-color)] rounded-md shadow-sm p-2 bg-transparent">
                    <p class="text-xs text-gray-500 mt-1">Opcional - ser√° preenchido automaticamente com o nome do e-mail</p>
                </div>
                <div class="mb-4">
                    <label for="new-user-email" class="block text-sm font-medium text-gray-400">E-mail</label>
                    <input type="email" id="new-user-email" class="mt-1 block w-full border border-[var(--border-color)] rounded-md shadow-sm p-2 bg-transparent" required>
                    <p class="text-xs text-gray-500 mt-1">Deve terminar com @vinci-highways.com.br</p>
                </div>
                <div class="mb-4">
                    <label for="new-user-role" class="block text-sm font-medium text-gray-400">Papel</label>
                    <select id="new-user-role" class="mt-1 block w-full border border-[var(--border-color)] bg-[var(--card-bg)] rounded-md shadow-sm p-2">
                        <option value="Usuario">Usu√°rio</option>
                        <option value="Gestor">Gestor</option>
                    </select>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" class="cancel-btn bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Cadastrar Usu√°rio</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Gest√£o de Usu√°rios - MENOR Z-INDEX -->
    <div id="user-management-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center no-print modal-transition modal-hidden modal-z-50">
        <div class="bg-[var(--card-bg)] rounded-lg shadow-xl p-6 w-full max-w-6xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-[var(--text-color)]">Gest√£o de Utilizadores e Pap√©is</h2>
                <button id="add-user-btn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    Cadastrar Usu√°rio
                </button>
            </div>
            <div id="user-list-container" class="overflow-y-auto max-h-96">
                <table class="w-full text-sm text-left text-gray-400">
                    <thead class="text-xs uppercase bg-gray-700 text-gray-400 sticky top-0">
                        <tr>
                            <th class="p-3">Nome</th>
                            <th class="p-3">E-mail</th>
                            <th class="p-3">Papel Atual</th>
                            <th class="p-3">Status</th>
                            <th class="p-3 text-center">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="user-management-table-body">
                    </tbody>
                </table>
            </div>
            <div class="flex justify-end mt-4">
                <button type="button" class="cancel-btn bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Ajustes de Importa√ß√£o -->
    <div id="import-adjustment-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 no-print modal-transition modal-hidden">
        <div class="bg-[var(--card-bg)] rounded-lg shadow-xl p-6 w-full max-w-6xl max-h-[90vh] overflow-hidden">
            <h2 class="text-2xl font-bold mb-4 text-[var(--text-color)]">Ajustar Tarefas Importadas</h2>
            
            <div class="mb-4 p-4 bg-yellow-100 dark:bg-yellow-900 rounded-lg">
                <h3 class="font-bold text-yellow-800 dark:text-yellow-200 mb-2">Problemas Encontrados:</h3>
                <div id="import-errors-list" class="text-sm text-yellow-700 dark:text-yellow-300"></div>
            </div>
            
            <div class="overflow-y-auto max-h-96 mb-4">
                <table class="w-full text-sm text-left text-gray-400">
                    <thead class="text-xs uppercase bg-gray-700 text-gray-400 sticky top-0">
                        <tr>
                            <th class="p-2">Linha</th>
                            <th class="p-2">Tarefa</th>
                            <th class="p-2">Data In√≠cio</th>
                            <th class="p-2">Data T√©rmino</th>
                            <th class="p-2">Status</th>
                            <th class="p-2">Respons√°veis</th>
                            <th class="p-2">Tarefa Pai</th>
                            <th class="p-2">Problemas</th>
                            <th class="p-2 text-center">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="import-adjustment-table-body">
                    </tbody>
                </table>
            </div>
            
            <div class="flex justify-between items-center">
                <div class="text-sm text-gray-400">
                    <span id="import-valid-count">0</span> tarefas v√°lidas de 
                    <span id="import-total-count">0</span> total
                </div>
                <div class="flex gap-2">
                    <button id="cancel-import-btn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">
                        Cancelar
                    </button>
                    <button id="confirm-import-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        Importar Tarefas V√°lidas (<span id="confirm-count">0</span>)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="project-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 no-print modal-transition modal-hidden">
        <div class="bg-[var(--card-bg)] rounded-lg shadow-xl p-6 w-full max-w-md">
            <h2 id="project-modal-title" class="text-2xl font-bold mb-4 text-[var(--text-color)]">Novo Projeto</h2>
            <form id="project-form">
                <div class="mb-4">
                    <label for="project-name" class="block text-sm font-medium text-gray-400">Nome do Projeto</label>
                    <input type="text" id="project-name" class="mt-1 block w-full border border-[var(--border-color)] rounded-md shadow-sm p-2 bg-transparent" required>
                </div>
                <div class="mb-4">
                    <label for="project-manager" class="block text-sm font-medium text-gray-400">Respons√°vel</label>
                    <select id="project-manager" class="mt-1 block w-full border border-[var(--border-color)] rounded-md shadow-sm p-2 bg-transparent" required>
                        <option value="">Selecione um respons√°vel</option>
                    </select>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" class="cancel-btn bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Salvar Projeto</button>
                </div>
            </form>
        </div>
    </div>

    <div id="task-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 no-print modal-transition modal-hidden">
        <div class="bg-[var(--card-bg)] rounded-lg shadow-xl p-8 w-full max-w-3xl">
            <h2 id="modal-title" class="text-2xl font-bold mb-6 text-[var(--text-color)]">Adicionar Nova Tarefa</h2>
            <form id="task-form" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <div class="lg:col-span-2 space-y-4">
                    <input type="hidden" id="task-id"><input type="hidden" id="parent-id">
                     <div class="mb-4">
                        <label for="task-name" class="block text-sm font-medium text-gray-400">Nome da Tarefa</label>
                        <input type="text" id="task-name" class="mt-1 block w-full border border-[var(--border-color)] bg-transparent rounded-md shadow-sm p-2" required>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Atribu√≠do a (Utilizadores)</label>
                            <div id="assigned-users-container" class="assigned-users-container">
                                <!-- Checkboxes ser√£o inseridos aqui dinamicamente -->
                            </div>
                        </div>
                        <div><label for="task-priority" class="block text-sm font-medium text-gray-400">Prioridade</label><select id="task-priority" class="mt-1 block w-full border border-[var(--border-color)] bg-[var(--card-bg)] rounded-md shadow-sm p-2"><option value="Baixa">Baixa</option><option value="M√©dia">M√©dia</option><option value="Alta">Alta</option></select></div>
                    </div>

                    <div id="date-section">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <div><label for="start-date" class="block text-sm font-medium text-gray-400">Data de In√≠cio</label><input type="date" id="start-date" class="mt-1 block w-full border border-[var(--border-color)] bg-transparent rounded-md shadow-sm p-2" required></div>
                            <div><label for="end-date" class="block text-sm font-medium text-gray-400">Data de T√©rmino</label><input type="date" id="end-date" class="mt-1 block w-full border border-[var(--border-color)] bg-transparent rounded-md shadow-sm p-2" required></div>
                        </div>
                        <div id="reschedule-button-container" class="mt-2 hidden">
                             <button type="button" id="reschedule-btn" class="text-sm text-blue-500 hover:underline">Reprogramar Datas</button>
                        </div>
                    </div>
    
                    <div id="date-history-container" class="mt-4 hidden">
                        <h4 class="text-sm font-medium text-gray-400 mb-2">Hist√≥rico de Prazos</h4>
                        <div id="date-history-list" class="text-xs text-gray-500 max-h-20 overflow-y-auto bg-gray-100 dark:bg-gray-800 p-2 rounded"></div>
                    </div>
    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div><label for="task-status" class="block text-sm font-medium text-gray-400">Status</label><select id="task-status" class="mt-1 block w-full border border-[var(--border-color)] bg-[var(--card-bg)] rounded-md shadow-sm p-2"><option value="N√£o Iniciada">N√£o Iniciada</option><option value="Em Andamento">Em Andamento</option><option value="Conclu√≠da">Conclu√≠da</option></select></div>
                        <div>
                            <label for="task-progress" class="block text-sm font-medium text-gray-400">Progresso (%)</label>
                            <input type="number" id="task-progress" min="0" max="100" class="mt-1 block w-full border border-[var(--border-color)] bg-transparent rounded-md shadow-sm p-2" required>
                            <p id="progress-info" class="text-xs text-gray-500 mt-1 hidden">O progresso de tarefas-pai √© calculado automaticamente.</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div>
                            <label for="task-dependency" class="block text-sm font-medium text-gray-400">Depende de</label>
                            <select id="task-dependency" class="mt-1 block w-full border border-[var(--border-color)] bg-[var(--card-bg)] rounded-md shadow-sm p-2">
                                <option value="">Nenhuma</option>
                            </select>
                        </div>
                        <div class="flex items-end pb-2">
                            <label class="flex items-center"><input type="checkbox" id="task-risk" class="h-4 w-4 text-red-600 border-gray-300 rounded"><span class="ml-2 text-sm font-medium">Tarefa em Risco</span></label>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-1 border-t lg:border-t-0 lg:border-l lg:pl-6 pt-4 lg:pt-0 border-[var(--border-color)] flex flex-col space-y-4">
                    <h4 class="text-sm font-medium text-gray-400">Coment√°rios</h4>
                    <div id="comments-list" class="flex-grow text-sm text-gray-500 max-h-64 overflow-y-auto bg-gray-100 dark:bg-gray-800 p-3 rounded shadow-inner"></div>
                    <div class="flex gap-2">
                        <input type="text" id="new-comment-input" class="flex-grow border border-[var(--border-color)] bg-transparent rounded-md shadow-sm p-2" placeholder="Adicionar coment√°rio (Enter)">
                        <button type="button" id="add-comment-btn" class="bg-gray-200 dark:bg-gray-600 px-3 rounded-md text-[var(--text-color)] hover:bg-gray-300 dark:hover:bg-gray-500" title="Adicionar Coment√°rio">&rarr;</button>
                    </div>
                </div>

                <div class="lg:col-span-3 flex justify-end gap-2 pt-4 border-t border-[var(--border-color)]">
                    <button type="button" class="cancel-btn bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Salvar Tarefa</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 no-print modal-transition modal-hidden">
        <div class="bg-[var(--card-bg)] rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h2 id="confirm-modal-title" class="text-xl font-bold mb-4 text-[var(--text-color)]">Confirmar A√ß√£o</h2>
            <p id="confirm-modal-body" class="mb-6 text-gray-400">Voc√™ tem certeza?</p>
            <div class="flex justify-end gap-2">
                <button id="confirm-cancel-btn" class="bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500">Cancelar</button>
                <button id="confirm-ok-btn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>

    <div class="relative min-h-screen">
        <input type="file" id="import-excel-input" class="hidden" accept=".xlsx, .xls">
        <div id="logged-in-container" class="hidden">
            <button id="theme-toggle" class="no-print fixed top-4 right-4 z-50 p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                <svg id="theme-icon-sun" class="h-6 w-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <svg id="theme-icon-moon" class="h-6 w-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
            <button id="user-management-btn" class="no-print fixed top-4 right-16 z-50 p-2 rounded-full bg-yellow-500 text-white hover:bg-yellow-600 transition-colors hidden" title="Gerir Utilizadores">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.38 0 2.5 1.12 2.5 2.5S13.38 10 12 10 9.5 8.88 9.5 7.5 10.62 5 12 5zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.8 6-3.8s5.97 1.81 6 3.8c-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
            </button>
            <button id="logout-btn" class="no-print fixed top-4 right-28 z-50 p-2 rounded-full bg-red-500 text-white hover:bg-red-600 transition-colors" title="Logout">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5-5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
            </button>
        </div>
        
        <div id="project-view" class="container mx-auto p-4 md:p-8 hidden">
            <header class="mb-8">
                <h1 class="text-4xl font-bold">Cronogramas</h1>
                <p class="text-gray-400">Selecione um projeto para gerenciar ou crie um novo.</p>
                <p id="user-role-display" class="text-sm font-semibold mt-2 px-3 py-1 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded-full inline-block">Papel: Carregando...</p>
            </header>
            
            <!-- Dashboard Gr√°fico -->
            <div id="main-dashboard" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Os gr√°ficos ser√£o inseridos aqui dinamicamente -->
            </div>
            
            <div class="mb-6"><button id="add-project-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>Novo Projeto</button></div>
            <div id="project-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <div id="dashboard-view" class="container mx-auto p-4 md:p-8 hidden">
             <header class="mb-8">
                <button id="back-to-projects-btn" class="text-sm text-blue-500 hover:underline mb-2 flex items-center gap-1 no-print">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
                   Voltar para Cronogramas
                </button>
                <h1 id="project-title" class="text-4xl font-bold">Nome do Projeto</h1>
                <p class="text-gray-400">Painel de controle com o cronograma de execu√ß√£o.</p>
            </header>
            <div id="kpi-dashboard" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-8"></div>
            
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">
                <div class="lg:col-span-3 bg-[var(--card-bg)] p-4 rounded-lg shadow-md flex flex-wrap items-center justify-between gap-4 no-print border border-[var(--border-color)]">
                    <div class="flex items-center gap-4 flex-wrap">
                        <button id="add-task-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center gap-2">Nova Tarefa</button>
                        <button id="import-excel-btn" class="bg-teal-600 text-white px-4 py-2 rounded-md hover:bg-teal-700 flex items-center gap-2">Importar</button>
                        <button id="download-template-btn" class="text-sm text-blue-500 hover:underline">Baixar Template</button>
                    </div>
                    <div class="relative">
                        <input type="text" id="task-filter-input" placeholder="Filtrar tarefas..." class="border border-[var(--border-color)] bg-transparent rounded-md shadow-sm p-2 pl-8 text-sm">
                        <svg class="absolute left-2 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2"><label for="view-switcher" class="text-sm font-medium">Visualiza√ß√£o:</label><select id="view-switcher" class="border border-[var(--border-color)] rounded-md p-2 text-sm bg-[var(--card-bg)]"><option value="table" selected>Tabela</option><option value="gantt">Gantt</option></select></div>
                        <button id="export-excel-btn" class="bg-green-600 text-white px-3 py-2 rounded-md hover:bg-green-700" title="Exportar para Excel">Excel</button>
                        <button id="generate-pdf-report-btn" class="bg-red-600 text-white px-3 py-2 rounded-md hover:bg-red-700" title="Gerar Relat√≥rio PDF">PDF</button>
                        <button id="print-view-btn" class="bg-gray-500 text-white px-3 py-2 rounded-md hover:bg-gray-600" title="Imprimir">Imprimir</button>
                    </div>
                </div>
                 <div id="assignee-summary" class="bg-[var(--card-bg)] p-4 rounded-lg shadow-md border border-[var(--border-color)] no-print">
                    <h3 class="font-bold mb-2">Tarefas por Respons√°vel</h3>
                    <div id="assignee-summary-list" class="text-sm space-y-2 max-h-48 overflow-y-auto"></div>
                </div>
            </div>
            <main id="content-area" class="bg-[var(--card-bg)] p-4 rounded-lg shadow-md border border-[var(--border-color)]">
                <div id="table-view">
                     <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-400">
                            <thead class="text-xs uppercase bg-gray-700 text-gray-400">
                                <tr>
                                    <th class="p-3 min-w-[250px]">Tarefa</th>
                                    <th class="p-3">Dura√ß√£o (dias)</th>
                                    <th class="p-3">Data de In√≠cio</th>
                                    <th class="p-3">Data de T√©rmino</th>
                                    <th class="p-3">Status</th>
                                    <th class="p-3">Respons√°vel</th>
                                    <th class="p-3">Coment√°rios</th>
                                    <th class="p-3 text-center no-print">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="task-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <div id="gantt-view" class="hidden">
                     <div class="gantt-chart-container border border-[var(--border-color)] rounded-lg">
                        <svg id="gantt-dependency-lines" width="100%" height="100%"></svg>
                        <div class="gantt-tasks bg-gray-700 bg-opacity-20 border-r border-[var(--border-color)] p-2 font-bold">
                            <div class="h-10 flex items-center">Tarefa</div><div id="gantt-task-names" class="relative"></div>
                        </div>
                        <div class="gantt-timeline-container overflow-x-auto">
                            <div id="gantt-header" class="sticky top-0 bg-gray-700 bg-opacity-20 z-10 border-b border-[var(--border-color)]"></div><div id="gantt-timeline-body" class="relative"></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setDoc, doc, collection, onSnapshot, addDoc, deleteDoc, query, collectionGroup, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Vari√°veis Globais de Firebase
        let firebaseApp;
        let db;
        let auth;
        let unsubscribeProjects = () => {};
        let unsubscribeUsers = () => {};
        
        // --- CONSTANTES E CONFIGURA√á√ÉO ---
        const ALLOWED_DOMAIN = "@vinci-highways.com.br";
        const GESTOR_SECRET_CODE = "MASTER_GESTOR";
        
        // SUAS CREDENCIAIS DO BANCO DE DADOS
        const appId = "cronograma-85bf4"; 
        const firebaseConfig = {
            apiKey: "AIzaSyDB_q9kdQGNiLf34PPZFL2YuBDOj7XdwkA",
            authDomain: "cronograma-85bf4.firebaseapp.com",
            projectId: "cronograma-85bf4",
            storageBucket: "cronograma-85bf4.firebasestorage.app",
            messagingSenderId: "802190123207",
            appId: "1:802190123207:web:adaf51b25010f677bbdee2"
        };

        // dataService Interface
        const dataService = {
            projects: [],
            users: [], 
            currentProjectId: null,
            userId: null,
            userRole: null, 
            isAuthReady: false,
            
            // --- FIREBASE IMPLEMENTATIONS ---
            initFirebase: async () => {
                try {
                    firebaseApp = initializeApp(firebaseConfig);
                    db = getFirestore(firebaseApp);
                    auth = getAuth(firebaseApp);

                    // Listener do estado de autentica√ß√£o inicia o fluxo da UI
                    onAuthStateChanged(auth, async (user) => {
                        if (user && user.email?.endsWith(ALLOWED_DOMAIN)) {
                            // Usu√°rio autenticado e com dom√≠nio correto
                            dataService.userId = user.uid;
                            dataService.isAuthReady = true;
                            
                            await dataService.getUserProfile(user.uid); 
                            
                            uiService.showView('project-view');
                            document.getElementById('logged-in-container').classList.remove('hidden');
                            uiService.closeModal('auth-modal');
                            document.getElementById('loader').style.display = 'none';

                            dataService.listenToUsers();
                            dataService.listenToProjects();

                            uiService.updateUserRoleDisplay();
                        } else {
                            // Nenhuma autentica√ß√£o ou dom√≠nio inv√°lido
                            dataService.userId = null;
                            dataService.isAuthReady = true; 
                            dataService.projects = [];
                            dataService.userRole = null;
                            
                            document.getElementById('logged-in-container').classList.add('hidden');
                            uiService.openModal('auth-modal');
                            document.getElementById('loader').style.display = 'none';
                            unsubscribeProjects();
                            unsubscribeUsers();
                        }
                    });
                } catch (error) {
                    console.error("Erro na inicializa√ß√£o do Firebase:", error);
                    uiService.showToast('Erro ao conectar ao banco de dados! Verifique a API Key e a configura√ß√£o.', 'error');
                    document.getElementById('loader').style.display = 'none';
                }
            },

            // --- USER MANAGEMENT ---
            getUserProfile: async (uid) => {
                const userDocRef = doc(db, 'users_data', uid);
                const userSnapshot = await getDoc(userDocRef); 

                if (userSnapshot.exists()) {
                    dataService.userRole = userSnapshot.data().role;
                } else {
                    dataService.userRole = 'Usuario';
                }
            },
            
            listenToUsers: () => {
                unsubscribeUsers();
                if (!dataService.isAuthReady) return;

                const usersRef = collection(db, 'users_data');

                unsubscribeUsers = onSnapshot(usersRef, (snapshot) => {
                    dataService.users = [];
                    snapshot.forEach(doc => {
                        if (doc.data().email && doc.data().email.endsWith(ALLOWED_DOMAIN)) {
                           dataService.users.push({ id: doc.id, ...doc.data() });
                        }
                    });

                    if (document.getElementById('user-management-modal').classList.contains('modal-visible') && dataService.userRole === 'Gestor') {
                         uiService.renderUserManagementTable();
                    }
                    uiService.populateAssignedUsersCheckboxes();
                }, (error) => {
                    console.error("Erro ao ouvir usu√°rios:", error);
                });
            },
            
            updateUserRole: async (uid, newRole) => {
                try {
                    const userDocRef = doc(db, 'users_data', uid);
                    await setDoc(userDocRef, { role: newRole }, { merge: true });

                    await auth.currentUser.getIdToken(true);
                    
                    uiService.showToast(`Papel de ${dataService.users.find(u => u.id === uid)?.email} atualizado para ${newRole}.`);
                } catch (error) {
                    console.error("Erro ao atualizar papel:", error);
                    uiService.showToast('Falha ao atualizar papel do utilizador.', 'error');
                }
            },

            // --- CADASTRO DE USU√ÅRIOS PELO GESTOR ---
            createUserByGestor: async (userData) => {
                try {
                    const { name, email, role } = userData;
                    
                    if (!email.endsWith(ALLOWED_DOMAIN)) {
                        throw new Error(`E-mail deve terminar com ${ALLOWED_DOMAIN}`);
                    }

                    // Verificar se usu√°rio j√° existe
                    const usersSnapshot = await getDocs(collection(db, 'users_data'));
                    const existingUser = usersSnapshot.docs.find(doc => doc.data().email === email);
                    
                    if (existingUser) {
                        throw new Error('Este e-mail j√° est√° cadastrado no sistema');
                    }

                    // MELHORIA 02: Usar nome do e-mail se nome n√£o for fornecido
                    const userName = name || email.split('@')[0];
                    
                    // Gerar senha tempor√°ria
                    const tempPassword = Math.random().toString(36).slice(-8) + 'A1!';
                    
                    // Criar usu√°rio no Authentication
                    const userCredential = await createUserWithEmailAndPassword(auth, email, tempPassword);
                    const newUserId = userCredential.user.uid;

                    // Salvar dados do usu√°rio no Firestore
                    await setDoc(doc(db, 'users_data', newUserId), {
                        name: userName,
                        email: email,
                        role: role,
                        appId: appId,
                        createdAt: new Date().toISOString(),
                        createdBy: dataService.userId
                    });

                    // Enviar email de boas-vindas com instru√ß√µes de login
                    await dataService.sendWelcomeEmail(email, userName, tempPassword);
                    
                    // Fazer logout do usu√°rio tempor√°rio criado
                    await signOut(auth);
                    
                    // Refazer login do gestor
                    const currentUser = auth.currentUser;
                    if (currentUser) {
                        await signInWithEmailAndPassword(auth, currentUser.email, document.getElementById('auth-password').value);
                    }

                    return { success: true, tempPassword };
                } catch (error) {
                    console.error("Erro ao criar usu√°rio:", error);
                    throw error;
                }
            },

            sendWelcomeEmail: async (email, name, tempPassword) => {
                // Simula√ß√£o de envio de email
                console.log(`üìß Email enviado para: ${email}`);
                console.log(`üëã Conte√∫do do email:
                    
                    Ol√° ${name},
                    
                    Bem-vindo(a) ao Vinci Highways Projects!
                    
                    Sua conta foi criada com sucesso.
                    
                    Seus dados de acesso:
                    E-mail: ${email}
                    Senha tempor√°ria: ${tempPassword}
                    
                    Por seguran√ßa, recomendamos que altere sua senha no primeiro acesso.
                    
                    Acesse o sistema em: ${window.location.origin}
                    
                    Atenciosamente,
                    Equipe Vinci Highways
                `);

                return true;
            },

            resetUserPassword: async (email) => {
                try {
                    await sendPasswordResetEmail(auth, email);
                    uiService.showToast(`Email de redefini√ß√£o de senha enviado para ${email}`);
                } catch (error) {
                    console.error("Erro ao enviar email de redefini√ß√£o:", error);
                    uiService.showToast('Falha ao enviar email de redefini√ß√£o de senha.', 'error');
                }
            },

            // --- PROJECT DATA ACCESS ---
            getProjectCollectionRef: (uid) => {
                const targetUid = uid || dataService.userId;
                if (!targetUid) throw new Error("Usu√°rio n√£o autenticado.");
                return collection(db, 'artifacts', appId, 'users', targetUid, 'projects');
            },

            listenToProjects: () => {
                unsubscribeProjects(); 
                if (!dataService.isAuthReady) return;
                
                let projectsQuery;
                
                if (dataService.userRole === 'Gestor') {
                    projectsQuery = query(collectionGroup(db, 'projects'));
                } else {
                    projectsQuery = query(dataService.getProjectCollectionRef());
                }
                
                unsubscribeProjects = onSnapshot(projectsQuery, (snapshot) => {
                    console.log("üì¶ Dados recebidos do Firebase:", snapshot.size, "documentos");
                    
                    snapshot.forEach(doc => {
                        console.log("üìÑ Documento:", doc.id, doc.data());
                    });

                    let newProjects = [];
                    snapshot.forEach(doc => {
                        const projectData = doc.data();
                        const creatorId = projectData.creatorId || doc.ref.parent.parent.id; 
                        
                        const tasksWithDefaults = projectData.tasks?.map(t => ({
                            ...t,
                            assignedUsers: t.assignedUsers || [], 
                        })) || [];

                        const project = { 
                            id: doc.id, 
                            manager: projectData.manager || 'N√£o Definido', 
                            creatorId: creatorId, 
                            tasks: tasksWithDefaults,
                            ...projectData 
                        };
                        newProjects.push(project); 
                    });

                    if (dataService.userRole === 'Usuario') {
                        newProjects = newProjects.filter(project => {
                            const isCreator = project.creatorId === dataService.userId;
                            const isAssigned = project.tasks.some(task => 
                                (task.assignedUsers || []).includes(dataService.userId)
                            );
                            return isCreator || isAssigned;
                        });
                    }

                    dataService.projects = newProjects;
                    dataService.recalculateAllProgress();
                    
                    if (dataService.currentProjectId) {
                        const currentProject = dataService.getProjectById(dataService.currentProjectId);
                        if (currentProject) {
                            uiService.renderProjectDashboard(currentProject, document.getElementById('task-filter-input').value);
                        } else {
                            App.showProjectView(); 
                        }
                    } else {
                        App.showProjectView();
                    }
                }, (error) => {
                    console.error("Erro ao ouvir projetos:", error);
                    uiService.showToast('Erro de sincroniza√ß√£o em tempo real.', 'error');
                });
            },
            
            getLatestDates: (task) => {
                if (!task.dateHistory || task.dateHistory.length === 0) return { startDate: '', endDate: '' };
                return task.dateHistory[task.dateHistory.length - 1];
            },
            
            getProjectById: (id) => { return dataService.projects.find(p => p.id === id); },
            getCurrentProject: () => { return dataService.getProjectById(dataService.currentProjectId); },
            
            getProjectOwnerUid: (projectId) => {
                const project = dataService.getProjectById(projectId);
                return project ? project.creatorId : dataService.userId;
            },

            // --- CRUD HELPERS ---
            addProject: async (projectData) => {
                try {
                    const projectCollection = dataService.getProjectCollectionRef();
                    const newProjectData = { 
                        name: projectData.name, 
                        manager: projectData.manager, 
                        tasks: [],
                        creatorId: dataService.userId
                    };
                    await addDoc(projectCollection, newProjectData);
                } catch (error) {
                    console.error("Erro ao adicionar projeto:", error);
                    uiService.showToast('Falha ao adicionar projeto.', 'error');
                }
            },

            deleteProject: async (projectId) => {
                try {
                    const ownerUid = dataService.getProjectOwnerUid(projectId);
                    const projectDocRef = doc(dataService.getProjectCollectionRef(ownerUid), projectId);
                    await deleteDoc(projectDocRef);
                } catch (error) {
                    console.error("Erro ao deletar projeto:", error);
                    uiService.showToast('Falha ao deletar projeto. Verifique suas permiss√µes.', 'error');
                }
            },
            
            saveProjectDocument: async (project) => {
                try {
                    const projectId = project.id; 
                    const ownerUid = project.creatorId; 
                    const projectDocRef = doc(dataService.getProjectCollectionRef(ownerUid), projectId);

                    await setDoc(projectDocRef, { 
                        name: project.name, 
                        manager: project.manager, 
                        tasks: project.tasks,
                        creatorId: ownerUid
                    }, { merge: true });

                } catch (error) {
                    console.error("Erro ao salvar projeto/tarefas:", error);
                    uiService.showToast('Falha ao salvar dados. Verifique a conex√£o.', 'error');
                }
            },

            saveTask: async (taskData) => {
                const project = dataService.getCurrentProject();
                if (!project) return;

                const { newStartDate, newEndDate, dependsOn, ...restOfTaskData } = taskData;
                
                // CORRE√á√ÉO: Se houver depend√™ncia, define a tarefa pai
                if (dependsOn) {
                    // Encontra a tarefa da qual esta depende
                    const parentTask = project.tasks.find(t => t.id === dependsOn);
                    if (parentTask) {
                        // Define esta tarefa como filha da tarefa pai
                        restOfTaskData.parentId = dependsOn;
                        
                        // Valida√ß√£o de datas conforme j√° existe
                        const parentDates = dataService.getLatestDates(parentTask);
                        const parentStart = new Date(parentDates.startDate);
                        const parentEnd = new Date(parentDates.endDate);
                        const childStart = new Date(newStartDate);
                        const childEnd = new Date(newEndDate);

                        if (childStart < parentStart) {
                            uiService.showToast('A subtarefa n√£o pode come√ßar antes da tarefa pai!', 'error');
                            return;
                        }

                        if (childEnd > parentEnd) {
                            uiService.showToast('A subtarefa n√£o pode terminar depois da tarefa pai!', 'error');
                            return;
                        }
                    }
                }

                let updatedTasks;

                if (taskData.id) { 
                    updatedTasks = project.tasks.map(t => {
                        if (t.id === restOfTaskData.id) {
                            const updatedTask = { ...t, ...restOfTaskData };
                            // Remove dependsOn se agora √© uma subtarefa
                            if (updatedTask.parentId) {
                                updatedTask.dependsOn = null;
                            }
                            if (newStartDate && newEndDate) {
                                const latestDates = dataService.getLatestDates(t);
                                if (latestDates.startDate !== newStartDate || latestDates.endDate !== newEndDate) {
                                    updatedTask.dateHistory = [...(updatedTask.dateHistory || []), { startDate: newStartDate, endDate: newEndDate }];
                                }
                            }
                            return updatedTask;
                        }
                        return t;
                    });
                } else { 
                    const newTask = { 
                        ...restOfTaskData, 
                        id: Date.now() + Math.random(), // CORRE√á√ÉO: Usar Math.random() para evitar IDs duplicados
                        dateHistory: [{ startDate: newStartDate, endDate: newEndDate }],
                        comments: taskData.comments || [],
                        // Garante que dependsOn seja limpo se √© uma subtarefa
                        dependsOn: restOfTaskData.parentId ? null : dependsOn
                    };
                    updatedTasks = [...project.tasks, newTask];
                }
                
                project.tasks = updatedTasks;
                
                // MELHORIA 01: Atualizar datas da tarefa pai automaticamente
                if (restOfTaskData.parentId) {
                    dataService.updateParentTaskDates(restOfTaskData.parentId);
                }
                
                dataService.recalculateAllProgress();
                await dataService.saveProjectDocument(project);
            },

            // MELHORIA 01: Fun√ß√£o para atualizar datas da tarefa pai
            updateParentTaskDates: function(parentTaskId) {
                const project = dataService.getCurrentProject();
                if (!project) return;

                const parentTask = project.tasks.find(t => t.id === parentTaskId);
                if (!parentTask) return;

                const childTasks = project.tasks.filter(t => t.parentId === parentTaskId);
                if (childTasks.length === 0) return;

                // Encontrar a data de in√≠cio mais antiga e data de t√©rmino mais recente entre as subtarefas
                let earliestStartDate = null;
                let latestEndDate = null;

                childTasks.forEach(child => {
                    const childDates = dataService.getLatestDates(child);
                    const childStart = new Date(childDates.startDate);
                    const childEnd = new Date(childDates.endDate);

                    if (!earliestStartDate || childStart < earliestStartDate) {
                        earliestStartDate = childStart;
                    }
                    if (!latestEndDate || childEnd > latestEndDate) {
                        latestEndDate = childEnd;
                    }
                });

                if (earliestStartDate && latestEndDate) {
                    const parentDates = dataService.getLatestDates(parentTask);
                    const parentStart = new Date(parentDates.startDate);
                    const parentEnd = new Date(parentDates.endDate);

                    // Atualizar apenas se as datas forem diferentes
                    if (earliestStartDate.getTime() !== parentStart.getTime() || 
                        latestEndDate.getTime() !== parentEnd.getTime()) {
                        
                        const newStartDate = earliestStartDate.toISOString().split('T')[0];
                        const newEndDate = latestEndDate.toISOString().split('T')[0];

                        // Atualizar a tarefa pai
                        const updatedTasks = project.tasks.map(t => {
                            if (t.id === parentTaskId) {
                                const updatedTask = { ...t };
                                if (updatedTask.dateHistory && updatedTask.dateHistory.length > 0) {
                                    const latestDates = updatedTask.dateHistory[updatedTask.dateHistory.length - 1];
                                    if (latestDates.startDate !== newStartDate || latestDates.endDate !== newEndDate) {
                                        updatedTask.dateHistory = [
                                            ...updatedTask.dateHistory,
                                            { startDate: newStartDate, endDate: newEndDate }
                                        ];
                                    }
                                } else {
                                    updatedTask.dateHistory = [{ startDate: newStartDate, endDate: newEndDate }];
                                }
                                return updatedTask;
                            }
                            return t;
                        });

                        project.tasks = updatedTasks;
                    }
                }
            },

            deleteTask: async (taskId) => {
                const project = dataService.getCurrentProject();
                if (!project) return;
                
                const idsToDelete = [taskId];
                const findChildren = (pid) => { 
                    project.tasks.filter(t => t.parentId === pid).forEach(c => { 
                        idsToDelete.push(c.id); findChildren(c.id); 
                    }); 
                };
                findChildren(taskId);
                
                let updatedTasks = project.tasks.filter(t => !idsToDelete.includes(t.id));
                
                updatedTasks = updatedTasks.map(t => {
                    if (idsToDelete.includes(t.dependsOn)) { t.dependsOn = null; }
                    return t;
                });

                project.tasks = updatedTasks;
                dataService.recalculateAllProgress();
                await dataService.saveProjectDocument(project);
            },
            
            // --- CALCULATION LOGIC ---
            recalculateAllProgress: () => {
                dataService.projects.forEach(project => {
                    const tasks = project.tasks;
                    if (!tasks || tasks.length === 0) return;
                    const taskMap = new Map(tasks.map(t => [t.id, t]));
                    const childrenMap = new Map([...taskMap.keys()].map(k => [k, []]));
                    tasks.forEach(t => { if (t.parentId && childrenMap.has(t.parentId)) childrenMap.get(t.parentId).push(t.id); });

                    const calculateTaskProgress = (taskId) => {
                        const childrenIds = childrenMap.get(taskId);
                        const task = taskMap.get(taskId);
                        if (!childrenIds || childrenIds.length === 0) return task.progress;
                        
                        const childrenProgress = childrenIds.map(childId => calculateTaskProgress(childId));
                        const totalProgress = childrenProgress.reduce((sum, prog) => sum + prog, 0);
                        const averageProgress = Math.round(totalProgress / childrenIds.length);
                        
                        task.progress = averageProgress;
                        if (averageProgress === 100) task.status = 'Conclu√≠da';
                        else if (averageProgress > 0) task.status = 'Em Andamento';
                        else task.status = 'N√£o Iniciada';

                        return averageProgress;
                    };
                    tasks.filter(t => t.parentId === null).forEach(t => calculateTaskProgress(t.id));
                });
            },
            getProjectProgress: (tasks) => {
                if (!tasks || tasks.length === 0) return 0;
                const topLevelTasks = tasks.filter(t => t.parentId === null);
                if (topLevelTasks.length === 0) return 0;
                const totalProgress = topLevelTasks.reduce((sum, task) => sum + task.progress, 0);
                return Math.round(totalProgress / topLevelTasks.length);
            },

            // NOVA FUN√á√ÉO: Obter nome do respons√°vel pelo UID
            getManagerName: (managerUid) => {
                if (!managerUid) return 'N√£o definido';
                const user = dataService.users.find(u => u.id === managerUid);
                return user ? (user.name || user.email.split('@')[0]) : `UID:${managerUid.substring(0,4)}`;
            },

            // NOVA FUN√á√ÉO: Obter nomes dos usu√°rios atribu√≠dos
            getAssignedUserNames: (assignedUsers) => {
                if (!assignedUsers || assignedUsers.length === 0) return '-';
                return assignedUsers.map(uid => {
                    const user = dataService.users.find(u => u.id === uid);
                    return user ? (user.name || user.email.split('@')[0]) : `UID:${uid.substring(0,4)}`;
                }).join(', ');
            },

            // NOVA FUN√á√ÉO: Processar importa√ß√£o com valida√ß√£o detalhada
            processImportWithValidation: async function(file) {
                try {
                    const project = dataService.getCurrentProject();
                    if (!project) {
                        throw new Error('Nenhum projeto selecionado');
                    }

                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        
                        reader.onload = async (e) => {
                            try {
                                const data = new Uint8Array(e.target.result);
                                const workbook = XLSX.read(data, { type: 'array' });
                                
                                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                                
                                if (jsonData.length === 0) {
                                    throw new Error('A planilha est√° vazia');
                                }

                                const importResults = {
                                    validTasks: [],
                                    invalidTasks: [],
                                    errors: [],
                                    taskNameMap: new Map()
                                };

                                // Mapear tarefas existentes
                                project.tasks.forEach(task => {
                                    importResults.taskNameMap.set(task.name.trim().toLowerCase(), task.id);
                                });

                                // Validar cada linha
                                jsonData.forEach((row, index) => {
                                    const result = this.validateImportRow(row, index + 2, importResults.taskNameMap);
                                    if (result.isValid) {
                                        importResults.validTasks.push(result.task);
                                    } else {
                                        importResults.invalidTasks.push({
                                            row: index + 2,
                                            data: row,
                                            errors: result.errors,
                                            task: result.task
                                        });
                                    }
                                });

                                // Se h√° tarefas inv√°lidas, mostrar modal de ajustes
                                if (importResults.invalidTasks.length > 0) {
                                    uiService.showImportAdjustmentModal(importResults);
                                    resolve({ needsAdjustment: true, results: importResults });
                                } else {
                                    // Todas v√°lidas, importar diretamente
                                    await this.finalizeImport(importResults.validTasks, project);
                                    resolve({ needsAdjustment: false, count: importResults.validTasks.length });
                                }

                            } catch (error) {
                                reject(error);
                            }
                        };

                        reader.onerror = (error) => reject(error);
                        reader.readAsArrayBuffer(file);
                    });

                } catch (error) {
                    console.error('Erro na importa√ß√£o:', error);
                    throw error;
                }
            },

            // FUN√á√ÉO: Validar linha individual
            validateImportRow: function(row, rowNumber, taskNameMap) {
                const errors = [];
                const task = {};

                // Validar nome da tarefa
                const taskName = row['Tarefa']?.toString().trim();
                if (!taskName) {
                    errors.push('Nome da tarefa √© obrigat√≥rio');
                } else {
                    task.name = taskName;
                }

                // Validar e converter datas
                const startDate = this.parseExcelDate(row['Data In√≠cio']);
                const endDate = this.parseExcelDate(row['Data Termino']);
                
                if (!startDate) errors.push('Data de in√≠cio inv√°lida');
                if (!endDate) errors.push('Data de t√©rmino inv√°lida');
                
                if (startDate && endDate) {
                    if (new Date(startDate) > new Date(endDate)) {
                        errors.push('Data de in√≠cio n√£o pode ser posterior √† data de t√©rmino');
                    } else {
                        task.startDate = startDate;
                        task.endDate = endDate;
                    }
                }

                // Validar status
                const status = row['Status']?.toString().trim();
                const validStatuses = ['N√£o Iniciada', 'Em Andamento', 'Conclu√≠da'];
                if (status && validStatuses.includes(status)) {
                    task.status = status;
                } else if (status) {
                    errors.push(`Status inv√°lido: "${status}". Use: ${validStatuses.join(', ')}`);
                } else {
                    task.status = 'N√£o Iniciada';
                }

                // Validar progresso
                const progress = parseInt(row['Progresso (%)']) || 0;
                if (progress < 0 || progress > 100) {
                    errors.push('Progresso deve estar entre 0 e 100');
                } else {
                    task.progress = progress;
                }

                // Validar prioridade
                const priority = row['Prioridade']?.toString().trim();
                const validPriorities = ['Baixa', 'M√©dia', 'Alta'];
                if (priority && validPriorities.includes(priority)) {
                    task.priority = priority;
                } else if (priority) {
                    errors.push(`Prioridade inv√°lida: "${priority}". Use: ${validPriorities.join(', ')}`);
                } else {
                    task.priority = 'M√©dia';
                }

                // Processar respons√°veis
                const assignedNames = row['Atribu√≠do a (Nomes Separados por V√≠rgula)']?.toString();
                if (assignedNames) {
                    task.assignedUsers = this.findUserIdsByNames(assignedNames.split(',').map(name => name.trim()));
                    if (task.assignedUsers.length === 0) {
                        errors.push('Nenhum respons√°vel v√°lido encontrado');
                    }
                } else {
                    task.assignedUsers = [];
                }

                // Validar risco
                const risk = row['Risco (Sim/Nao)']?.toString().trim().toLowerCase();
                task.risk = risk === 'sim';

                // Processar tarefa pai
                const parentTaskName = row['Tarefa Pai (Nome)']?.toString().trim();
                if (parentTaskName) {
                    task.parentId = taskNameMap.get(parentTaskName.toLowerCase());
                    if (!task.parentId) {
                        errors.push(`Tarefa pai n√£o encontrada: "${parentTaskName}"`);
                    }
                } else {
                    task.parentId = null;
                }

                // CORRE√á√ÉO: Gerar ID √∫nico usando Math.random() para evitar duplica√ß√£o
                task.id = Date.now() + Math.random();
                task.comments = [];
                task.dateHistory = [{ startDate: task.startDate, endDate: task.endDate }];

                return {
                    isValid: errors.length === 0,
                    task: task,
                    errors: errors
                };
            },

            // FUN√á√ÉO: Finalizar importa√ß√£o
            finalizeImport: async function(validTasks, project) {
                project.tasks = [...project.tasks, ...validTasks];
                dataService.recalculateAllProgress();
                await dataService.saveProjectDocument(project);
                return validTasks.length;
            },

            // Fun√ß√£o auxiliar para converter datas do Excel
            parseExcelDate: function(excelDate) {
                if (!excelDate) return null;
                
                try {
                    // Se for n√∫mero (formato Excel)
                    if (typeof excelDate === 'number') {
                        const date = new Date((excelDate - 25569) * 86400 * 1000);
                        return date.toISOString().split('T')[0];
                    }
                    
                    // Se for string, tentar parse
                    if (typeof excelDate === 'string') {
                        // Remover espa√ßos e tentar diferentes formatos
                        const cleanDate = excelDate.trim();
                        
                        // Formato YYYY-MM-DD
                        if (/^\d{4}-\d{2}-\d{2}$/.test(cleanDate)) {
                            return cleanDate;
                        }
                        
                        // Formato DD/MM/YYYY
                        if (/^\d{2}\/\d{2}\/\d{4}$/.test(cleanDate)) {
                            const parts = cleanDate.split('/');
                            return `${parts[2]}-${parts[1]}-${parts[0]}`;
                        }
                        
                        // Tentar parse autom√°tico
                        const parsedDate = new Date(cleanDate);
                        if (!isNaN(parsedDate.getTime())) {
                            return parsedDate.toISOString().split('T')[0];
                        }
                    }
                    
                    return null;
                } catch (error) {
                    console.warn('Erro ao converter data:', excelDate, error);
                    return null;
                }
            },

            // Fun√ß√£o para encontrar IDs de usu√°rio pelos nomes
            findUserIdsByNames: function(names) {
                return names.map(name => {
                    const user = dataService.users.find(u => 
                        u.name?.toLowerCase().includes(name.toLowerCase()) || 
                        u.email.toLowerCase().includes(name.toLowerCase())
                    );
                    return user?.id || null;
                }).filter(id => id !== null);
            }
        };

        // App Controller
        const App = {
            async init() {
                document.getElementById('loader').style.display = 'flex';
                await dataService.initFirebase(); 
                uiService.initTheme();
                this.bindEvents();
            },
            
            async logout() {
                document.getElementById('loader').style.display = 'flex';
                await signOut(auth);
                document.getElementById('loader').style.display = 'none';
                uiService.showToast('Sess√£o encerrada com sucesso.', 'success');
            },

            showProjectView() {
                dataService.currentProjectId = null;
                uiService.showView('project-view');
                uiService.renderProjectList(dataService.projects);
                uiService.updateMainDashboard(dataService.projects);
            },
            
            openProject(projectId) {
                dataService.currentProjectId = projectId; 
                const project = dataService.getProjectById(dataService.currentProjectId);
                if (project) {
                    uiService.showView('dashboard-view');
                    uiService.renderProjectDashboard(project);
                }
            },

            bindEvents() {
                document.getElementById('theme-toggle').addEventListener('click', () => uiService.toggleTheme());
                document.getElementById('logout-btn').addEventListener('click', () => App.logout());
                document.getElementById('user-management-btn').addEventListener('click', () => uiService.openUserManagementModal());
                
                // CORRE√á√ÉO: Fechar modal de gest√£o antes de abrir cadastro
                document.getElementById('add-user-btn').addEventListener('click', () => {
                    uiService.closeModal('user-management-modal');
                    setTimeout(() => {
                        uiService.openAddUserModal();
                    }, 300);
                });

                // --- AUTENTICA√á√ÉO ---
                const authForm = document.getElementById('auth-form');
                const authEmail = document.getElementById('auth-email');
                const authPassword = document.getElementById('auth-password');
                const authSecretCode = document.getElementById('auth-secret-code');
                const authSubmitBtn = document.getElementById('auth-submit-btn');
                const secretCodeContainer = document.getElementById('secret-code-container');
                let isLoginMode = true;

                document.getElementById('toggle-auth-mode').addEventListener('click', (e) => {
                    isLoginMode = !isLoginMode;
                    authSubmitBtn.textContent = isLoginMode ? 'Login' : 'Registrar';
                    e.target.textContent = isLoginMode ? 'Precisa de uma conta? Registrar' : 'J√° tenho conta. Login';
                    secretCodeContainer.classList.add('hidden'); // Esconde o c√≥digo secreto ao alternar
                });
                document.getElementById('toggle-secret-code').addEventListener('click', () => {
                    if (!isLoginMode) { // S√≥ permite ver o campo no modo Registro
                         secretCodeContainer.classList.toggle('hidden');
                    }
                });

                authForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = authEmail.value;
                    const password = authPassword.value;
                    const secretCode = authSecretCode.value;

                    if (!email.endsWith(ALLOWED_DOMAIN)) {
                        uiService.showToast(`E-mail inv√°lido. Use o dom√≠nio ${ALLOWED_DOMAIN}.`, 'error');
                        return;
                    }

                    document.getElementById('loader').style.display = 'flex';
                    try {
                        let userCredential;
                        if (isLoginMode) {
                            userCredential = await signInWithEmailAndPassword(auth, email, password);
                        } else {
                            userCredential = await createUserWithEmailAndPassword(auth, email, password);
                            let role = 'Usuario';
                            if (secretCode === GESTOR_SECRET_CODE) {
                                role = 'Gestor';
                            }
                            await setDoc(doc(db, 'users_data', userCredential.user.uid), {
                                email: email,
                                role: role,
                                appId: appId
                            });
                        }
                    } catch (error) {
                        let errorMessage = error.message;
                        if (error.code === 'auth/email-already-in-use') errorMessage = 'Este e-mail j√° est√° em uso.';
                        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') errorMessage = 'Credenciais inv√°lidas.';
                        if (error.code === 'auth/weak-password') errorMessage = 'A senha deve ter pelo menos 6 caracteres.';
                        uiService.showToast(`Erro de Autentica√ß√£o: ${errorMessage}`, 'error');
                        document.getElementById('loader').style.display = 'none';
                    }
                });
                // --- FIM AUTENTICA√á√ÉO ---
                
                // --- CADASTRO DE USU√ÅRIOS ---
                document.getElementById('add-user-form').addEventListener('submit', async (event) => {
                    event.preventDefault();
                    const name = document.getElementById('new-user-name').value.trim();
                    const email = document.getElementById('new-user-email').value.trim();
                    const role = document.getElementById('new-user-role').value;

                    if (!email) {
                        uiService.showToast('Preencha o e-mail.', 'error');
                        return;
                    }

                    if (!email.endsWith(ALLOWED_DOMAIN)) {
                        uiService.showToast(`E-mail deve terminar com ${ALLOWED_DOMAIN}`, 'error');
                        return;
                    }

                    document.getElementById('loader').style.display = 'flex';
                    try {
                        await dataService.createUserByGestor({ name, email, role });
                        uiService.closeModal('add-user-modal');
                        uiService.showToast('Usu√°rio cadastrado com sucesso! Email de boas-vindas enviado.', 'success');
                        document.getElementById('add-user-form').reset();
                        
                        // Reabrir modal de gest√£o ap√≥s cadastro
                        setTimeout(() => {
                            uiService.openUserManagementModal();
                        }, 500);
                        
                    } catch (error) {
                        console.error('Erro ao cadastrar usu√°rio:', error);
                        uiService.showToast(`Erro ao cadastrar usu√°rio: ${error.message}`, 'error');
                    } finally {
                        document.getElementById('loader').style.display = 'none';
                    }
                });

                // MELHORIA 02: Preencher automaticamente o nome do e-mail
                document.getElementById('new-user-email').addEventListener('blur', function() {
                    const email = this.value.trim();
                    const nameInput = document.getElementById('new-user-name');
                    
                    if (email && email.endsWith(ALLOWED_DOMAIN) && (!nameInput.value || nameInput.value === '')) {
                        const nameFromEmail = email.split('@')[0];
                        // Capitalizar primeira letra
                        const capitalizedName = nameFromEmail.charAt(0).toUpperCase() + nameFromEmail.slice(1);
                        nameInput.value = capitalizedName;
                    }
                });
                
                document.getElementById('add-project-btn').addEventListener('click', () => {
                    uiService.populateProjectManagerSelect(); // NOVA LINHA - Popula o select de respons√°veis
                    uiService.openModal('project-modal');
                });
                
                document.getElementById('project-form').addEventListener('submit', event => {
                    event.preventDefault();
                    const name = document.getElementById('project-name').value.trim();
                    const manager = document.getElementById('project-manager').value;
                    
                    if (name && manager) {
                        dataService.addProject({ name, manager });
                        uiService.closeModal('project-modal');
                        uiService.showToast('Projeto criado com sucesso! Sincronizando...', 'success');
                    } else {
                        uiService.showToast('Preencha todos os campos obrigat√≥rios.', 'error');
                    }
                });
                
                document.getElementById('project-list').addEventListener('click', event => {
                    const deleteBtn = event.target.closest('.delete-project-btn');
                    
                    if (deleteBtn) {
                        event.stopPropagation();
                        const projectId = deleteBtn.dataset.projectId;
                        uiService.showConfirmModal('Excluir este projeto e todas as suas tarefas? Esta a√ß√£o √© permanente.', async () => {
                            document.getElementById('loader').style.display = 'flex';
                            await dataService.deleteProject(projectId);
                            document.getElementById('loader').style.display = 'none';
                            uiService.showToast('Projeto exclu√≠do. Sincronizando...', 'error');
                        });
                        return; 
                    }
                    
                    const card = event.target.closest('.project-card-link');
                    if (card) {
                        this.openProject(card.dataset.projectId);
                    }
                });
                
                document.getElementById('back-to-projects-btn').addEventListener('click', () => this.showProjectView());
                document.getElementById('add-task-btn').addEventListener('click', () => uiService.openTaskModal('add'));
                
                document.getElementById('task-form').addEventListener('submit', async event => {
                    event.preventDefault();
                    const taskData = uiService.getTaskFormData();
                    
                    // Valida√ß√£o b√°sica de datas
                    if (new Date(taskData.newStartDate) > new Date(taskData.newEndDate)) {
                        uiService.showToast('Data de In√≠cio n√£o pode ser posterior √† Data de T√©rmino!', 'error');
                        return;
                    }

                    // MELHORIA 01: Valida√ß√£o adicional para subtarefas
                    if (taskData.parentId) {
                        const project = dataService.getCurrentProject();
                        const parentTask = project.tasks.find(t => t.id === taskData.parentId);
                        if (parentTask) {
                            const parentDates = dataService.getLatestDates(parentTask);
                            const parentStart = new Date(parentDates.startDate);
                            const childStart = new Date(taskData.newStartDate);

                            if (childStart < parentStart) {
                                uiService.showToast('A subtarefa n√£o pode come√ßar antes da tarefa pai!', 'error');
                                return;
                            }
                        }
                    }
                    
                    document.getElementById('loader').style.display = 'flex';
                    await dataService.saveTask(taskData); 
                    document.getElementById('loader').style.display = 'none';

                    uiService.closeModal('task-modal');
                    uiService.showToast('Tarefa salva! Sincronizando...');
                });

                document.getElementById('add-comment-btn').addEventListener('click', () => {
                    const input = document.getElementById('new-comment-input');
                    const text = input.value.trim();
                    if(text) {
                        uiService.addComment(text);
                        input.value = '';
                    }
                });
                
                document.getElementById('new-comment-input').addEventListener('keypress', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault(); 
                        document.getElementById('add-comment-btn').click(); 
                    }
                });


                document.getElementById('task-table-body').addEventListener('click', event => {
                    const button = event.target.closest('button');
                    const taskNameEl = event.target.closest('.task-edit-trigger');

                    if (taskNameEl) {
                        const taskId = parseFloat(taskNameEl.dataset.taskId); // CORRE√á√ÉO: Usar parseFloat para IDs com decimais
                        uiService.openTaskModal('edit', { taskId });
                        return;
                    }

                    if (!button) return;
                    const taskId = parseFloat(button.dataset.taskId); // CORRE√á√ÉO: Usar parseFloat para IDs com decimais
                    const parentId = parseFloat(button.dataset.parentId);
                    
                    if (button.classList.contains('add-subtask-btn')) uiService.openTaskModal('add', { parentId });
                    if (button.classList.contains('edit-task-btn')) uiService.openTaskModal('edit', { taskId });
                    
                    if (button.classList.contains('delete-task-btn')) {
                        uiService.showConfirmModal('Excluir esta tarefa e suas subtarefas?', async () => {
                            document.getElementById('loader').style.display = 'flex';
                            await dataService.deleteTask(taskId);
                            document.getElementById('loader').style.display = 'none';
                            uiService.showToast('Tarefa exclu√≠da. Sincronizando...', 'error');
                        });
                    }
                });

                document.getElementById('task-filter-input').addEventListener('input', (e) => {
                    uiService.renderProjectDashboard(dataService.getCurrentProject(), e.target.value);
                });

                document.getElementById('view-switcher').addEventListener('change', (e) => uiService.switchView(e.target.value));
                document.getElementById('export-excel-btn').addEventListener('click', () => reportService.exportExcel(dataService.getCurrentProject()));
                document.getElementById('generate-pdf-report-btn').addEventListener('click', () => reportService.generatePdf(dataService.getCurrentProject()));
                document.getElementById('print-view-btn').addEventListener('click', () => window.print());
                document.getElementById('download-template-btn').addEventListener('click', () => reportService.downloadExcelTemplate());
                document.getElementById('import-excel-btn').addEventListener('click', () => document.getElementById('import-excel-input').click());
                
                // ATUALIZADO: Evento de importa√ß√£o com nova funcionalidade
                document.getElementById('import-excel-input').addEventListener('change', async (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        document.getElementById('loader').style.display = 'flex';
                        try {
                            // Usar a nova fun√ß√£o de importa√ß√£o com valida√ß√£o
                            const result = await dataService.processImportWithValidation(file);
                            
                            if (!result.needsAdjustment) {
                                uiService.showToast(`${result.count} tarefas importadas com sucesso!`, 'success');
                            }
                            // Se needsAdjustment = true, o modal de ajustes j√° foi aberto automaticamente
                            
                        } catch (error) {
                            console.error('Erro na importa√ß√£o:', error);
                            
                            // Mensagens de erro mais espec√≠ficas
                            let errorMessage = 'Erro ao importar arquivo. ';
                            
                            if (error.message.includes('vazia')) {
                                errorMessage += 'A planilha est√° vazia.';
                            } else if (error.message.includes('formato')) {
                                errorMessage += 'Formato de arquivo inv√°lido. Use .xlsx ou .xls.';
                            } else if (error.message.includes('projeto')) {
                                errorMessage += 'Nenhum projeto selecionado.';
                            } else {
                                errorMessage += `Detalhes: ${error.message}`;
                            }
                            
                            uiService.showToast(errorMessage, 'error');
                        } finally {
                            document.getElementById('loader').style.display = 'none';
                            event.target.value = '';
                        }
                    }
                });
                document.querySelectorAll('.cancel-btn').forEach(btn => btn.addEventListener('click', () => uiService.closeAllModals()));
            }
        };

        // UI Service - Manages all DOM interactions
        const uiService = {
            mainDashboardCharts: {},
            editingCommentId: null, // Para controle de edi√ß√£o de coment√°rios

            // --- AUTH UI ---
            updateUserRoleDisplay: () => {
                const roleEl = document.getElementById('user-role-display');
                const btn = document.getElementById('user-management-btn');
                
                if (dataService.userRole) {
                    roleEl.textContent = `Papel: ${dataService.userRole}`;
                    roleEl.classList.remove('bg-blue-100', 'dark:bg-blue-900', 'text-blue-700', 'dark:text-blue-300', 'bg-green-100', 'dark:bg-green-900', 'text-green-700', 'dark:text-green-300');
                    
                    if (dataService.userRole === 'Gestor') {
                        roleEl.classList.add('bg-green-100', 'dark:bg-green-900', 'text-green-700', 'dark:text-green-300');
                        btn.classList.remove('hidden');
                    } else {
                         roleEl.classList.add('bg-blue-100', 'dark:bg-blue-900', 'text-blue-700', 'dark:text-blue-300');
                         btn.classList.add('hidden');
                    }
                }
            },
            
            // --- USER MANAGEMENT UI (Gestor) ---
            openUserManagementModal: () => {
                if (dataService.userRole !== 'Gestor') {
                    uiService.showToast('Acesso negado: Apenas Gestores podem gerir utilizadores.', 'error');
                    return;
                }
                uiService.renderUserManagementTable();
                uiService.openModal('user-management-modal');
            },

            openAddUserModal: () => {
                if (dataService.userRole !== 'Gestor') {
                    uiService.showToast('Acesso negado: Apenas Gestores podem cadastrar usu√°rios.', 'error');
                    return;
                }
                document.getElementById('add-user-form').reset();
                uiService.openModal('add-user-modal');
            },
            
            renderUserManagementTable: () => {
                const tbody = document.getElementById('user-management-table-body');
                tbody.innerHTML = '';

                dataService.users.forEach(user => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-[var(--border-color)]';
                    
                    const roleOptions = ['Usuario', 'Gestor'].map(role => 
                        `<option value="${role}" ${user.role === role ? 'selected' : ''}>${role}</option>`
                    ).join('');

                    // Desabilita a edi√ß√£o do pr√≥prio papel
                    const isSelf = user.id === dataService.userId;
                    const isDisabled = isSelf ? 'disabled' : '';

                    row.innerHTML = `
                        <td class="p-3 font-medium">${user.name || 'N√£o informado'}</td>
                        <td class="p-3">${user.email}</td>
                        <td class="p-3">
                            <select data-user-id="${user.id}" class="user-role-select border border-[var(--border-color)] rounded-md p-1 bg-[var(--card-bg)] text-gray-800 dark:text-gray-200" ${isDisabled}>
                                ${roleOptions}
                            </select>
                        </td>
                        <td class="p-3">
                            <span class="px-2 py-1 rounded-full text-xs ${user.role === 'Gestor' ? 'bg-green-600 text-white' : 'bg-blue-600 text-white'}">
                                ${user.role}
                            </span>
                        </td>
                        <td class="p-3 text-center">
                            <div class="flex justify-center gap-2">
                                <button data-user-id="${user.id}" class="save-role-btn bg-blue-500 text-white px-3 py-1 rounded-md text-xs hover:bg-blue-600 ${isDisabled ? 'opacity-50 cursor-not-allowed' : ''}" ${isDisabled}>Salvar Papel</button>
                                <button data-user-email="${user.email}" class="reset-password-btn bg-orange-500 text-white px-3 py-1 rounded-md text-xs hover:bg-orange-600">Redefinir Senha</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                tbody.querySelectorAll('.save-role-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const uid = btn.dataset.userId;
                        const selectEl = tbody.querySelector(`select[data-user-id="${uid}"]`);
                        const newRole = selectEl.value;
                        
                        document.getElementById('loader').style.display = 'flex';
                        await dataService.updateUserRole(uid, newRole);
                        document.getElementById('loader').style.display = 'none';
                    });
                });

                tbody.querySelectorAll('.reset-password-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const email = btn.dataset.userEmail;
                        uiService.showConfirmModal(`Enviar email de redefini√ß√£o de senha para ${email}?`, async () => {
                            document.getElementById('loader').style.display = 'flex';
                            await dataService.resetUserPassword(email);
                            document.getElementById('loader').style.display = 'none';
                        });
                    });
                });
            },

            // --- TASK UI HELPERS ---
            populateAssignedUsersCheckboxes: function() {
                const container = document.getElementById('assigned-users-container');
                container.innerHTML = '';
                
                dataService.users.filter(u => u.email).forEach(user => {
                    const checkboxItem = document.createElement('div');
                    checkboxItem.className = 'user-checkbox-item';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = user.id;
                    checkbox.id = `user-${user.id}`;
                    checkbox.className = 'user-checkbox';
                    
                    const label = document.createElement('label');
                    label.htmlFor = `user-${user.id}`;
                    label.textContent = `${user.name || user.email.split('@')[0]} (${user.role})`;
                    label.className = 'text-sm text-gray-700 dark:text-gray-300';
                    
                    checkboxItem.appendChild(checkbox);
                    checkboxItem.appendChild(label);
                    container.appendChild(checkboxItem);
                });
            },

            // NOVA FUN√á√ÉO: Popula o select de respons√°veis do projeto
            populateProjectManagerSelect: function() {
                const selectEl = document.getElementById('project-manager');
                selectEl.innerHTML = '<option value="">Selecione um respons√°vel</option>';
                
                dataService.users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.name || user.email.split('@')[0]} (${user.role})`;
                    selectEl.appendChild(option);
                });
            },

            // NOVA FUN√á√ÉO: Mostrar modal de ajustes de importa√ß√£o
            showImportAdjustmentModal: function(importResults) {
                this.openModal('import-adjustment-modal');
                
                // Atualizar contadores
                document.getElementById('import-valid-count').textContent = importResults.validTasks.length;
                document.getElementById('import-total-count').textContent = importResults.validTasks.length + importResults.invalidTasks.length;
                document.getElementById('confirm-count').textContent = importResults.validTasks.length;
                
                // Listar erros gerais
                const errorsList = document.getElementById('import-errors-list');
                const errorMessages = [...new Set(importResults.invalidTasks.flatMap(item => item.errors))];
                errorsList.innerHTML = errorMessages.map(error => 
                    `<div>‚Ä¢ ${error}</div>`
                ).join('');
                
                // Preencher tabela de ajustes
                const tableBody = document.getElementById('import-adjustment-table-body');
                tableBody.innerHTML = '';
                
                importResults.invalidTasks.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-[var(--border-color)] import-error-row';
                    
                    // Buscar op√ß√µes de tarefas pai
                    const parentOptions = this.getParentTaskOptions(importResults.taskNameMap);
                    
                    row.innerHTML = `
                        <td class="p-2">${item.row}</td>
                        <td class="p-2">
                            <input type="text" class="adjust-task-name border border-[var(--border-color)] rounded p-1 w-full text-black" 
                                   value="${item.data['Tarefa'] || ''}" data-index="${index}">
                        </td>
                        <td class="p-2">
                            <input type="date" class="adjust-start-date border border-[var(--border-color)] rounded p-1 w-full text-black" 
                                   value="${item.task.startDate || ''}" data-index="${index}">
                        </td>
                        <td class="p-2">
                            <input type="date" class="adjust-end-date border border-[var(--border-color)] rounded p-1 w-full text-black" 
                                   value="${item.task.endDate || ''}" data-index="${index}">
                        </td>
                        <td class="p-2">
                            <select class="adjust-status border border-[var(--border-color)] rounded p-1 w-full text-black" data-index="${index}">
                                <option value="N√£o Iniciada" ${item.task.status === 'N√£o Iniciada' ? 'selected' : ''}>N√£o Iniciada</option>
                                <option value="Em Andamento" ${item.task.status === 'Em Andamento' ? 'selected' : ''}>Em Andamento</option>
                                <option value="Conclu√≠da" ${item.task.status === 'Conclu√≠da' ? 'selected' : ''}>Conclu√≠da</option>
                            </select>
                        </td>
                        <td class="p-2">
                            <input type="text" class="adjust-assigned border border-[var(--border-color)] rounded p-1 w-full text-black" 
                                   value="${item.data['Atribu√≠do a (Nomes Separados por V√≠rgula)'] || ''}" 
                                   placeholder="Nomes separados por v√≠rgula" data-index="${index}">
                        </td>
                        <td class="p-2">
                            <select class="adjust-parent border border-[var(--border-color)] rounded p-1 w-full text-black" data-index="${index}">
                                <option value="">Nenhuma</option>
                                ${parentOptions}
                            </select>
                        </td>
                        <td class="p-2 text-red-500 text-xs">
                            ${item.errors.join(', ')}
                        </td>
                        <td class="p-2 text-center">
                            <button class="validate-row-btn bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600" data-index="${index}">
                                Validar
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                    
                    // Configurar tarefa pai se existir
                    if (item.data['Tarefa Pai (Nome)']) {
                        const parentSelect = row.querySelector('.adjust-parent');
                        const parentName = item.data['Tarefa Pai (Nome)'].toLowerCase();
                        Array.from(parentSelect.options).forEach(option => {
                            if (option.text.toLowerCase() === parentName) {
                                option.selected = true;
                            }
                        });
                    }
                });
                
                // Configurar event listeners
                this.setupImportAdjustmentEvents(importResults);
            },

            // FUN√á√ÉO: Obter op√ß√µes de tarefas pai
            getParentTaskOptions: function(taskNameMap) {
                let options = '';
                taskNameMap.forEach((id, name) => {
                    // Capitalizar nome para exibi√ß√£o
                    const displayName = name.charAt(0).toUpperCase() + name.slice(1);
                    options += `<option value="${id}">${displayName}</option>`;
                });
                return options;
            },

            // FUN√á√ÉO: Configurar eventos do modal de ajustes
            setupImportAdjustmentEvents: function(importResults) {
                let currentResults = importResults;
                
                // Bot√£o validar linha
                document.querySelectorAll('.validate-row-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        this.validateSingleRow(index, currentResults);
                    });
                });
                
                // Bot√£o cancelar
                document.getElementById('cancel-import-btn').onclick = () => {
                    this.closeModal('import-adjustment-modal');
                    uiService.showToast('Importa√ß√£o cancelada', 'error');
                };
                
                // Bot√£o confirmar importa√ß√£o
                document.getElementById('confirm-import-btn').onclick = async () => {
                    document.getElementById('loader').style.display = 'flex';
                    try {
                        await dataService.finalizeImport(currentResults.validTasks, dataService.getCurrentProject());
                        this.closeModal('import-adjustment-modal');
                        uiService.showToast(`${currentResults.validTasks.length} tarefas importadas com sucesso!`, 'success');
                    } catch (error) {
                        console.error('Erro ao finalizar importa√ß√£o:', error);
                        uiService.showToast('Erro ao importar tarefas', 'error');
                    } finally {
                        document.getElementById('loader').style.display = 'none';
                    }
                };
            },

            // FUN√á√ÉO: Validar linha individual no modal
            validateSingleRow: function(rowIndex, importResults) {
                const row = importResults.invalidTasks[rowIndex];
                const rowElement = document.querySelectorAll('#import-adjustment-table-body tr')[rowIndex];
                
                // Coletar dados atualizados
                const updatedData = {
                    'Tarefa': rowElement.querySelector('.adjust-task-name').value,
                    'Data In√≠cio': rowElement.querySelector('.adjust-start-date').value,
                    'Data Termino': rowElement.querySelector('.adjust-end-date').value,
                    'Status': rowElement.querySelector('.adjust-status').value,
                    'Atribu√≠do a (Nomes Separados por V√≠rgula)': rowElement.querySelector('.adjust-assigned').value,
                    'Tarefa Pai (Nome)': rowElement.querySelector('.adjust-parent').selectedOptions[0]?.text || ''
                };
                
                // Validar novamente
                const validationResult = dataService.validateImportRow(updatedData, row.row, importResults.taskNameMap);
                
                if (validationResult.isValid) {
                    // Mover para v√°lidas
                    importResults.validTasks.push(validationResult.task);
                    importResults.invalidTasks.splice(rowIndex, 1);
                    
                    // Atualizar UI
                    this.showImportAdjustmentModal(importResults);
                    uiService.showToast('Linha corrigida e validada!', 'success');
                } else {
                    // Atualizar erros
                    row.errors = validationResult.errors;
                    const errorCell = rowElement.querySelector('td:nth-child(8)');
                    errorCell.innerHTML = validationResult.errors.join(', ');
                    errorCell.className = 'p-2 text-red-500 text-xs';
                    
                    uiService.showToast('Ainda h√° problemas na linha', 'error');
                }
            },

            // --- VIEW/MODAL MANAGEMENT ---
            showView(viewId) {
                document.getElementById('project-view').classList.add('hidden');
                document.getElementById('dashboard-view').classList.add('hidden');
                document.getElementById(viewId).classList.remove('hidden');
            },
            switchView(viewName) {
                document.getElementById('table-view').classList.toggle('hidden', viewName === 'gantt');
                document.getElementById('gantt-view').classList.toggle('hidden', viewName === 'table');
                if (viewName === 'gantt') this.renderGanttChart(dataService.getCurrentProject().tasks, document.getElementById('task-filter-input').value);
            },
            renderProjectDashboard(project, filter = '') {
                const filteredTasks = project.tasks.filter(t => 
                    t.name.toLowerCase().includes(filter.toLowerCase()) || 
                    (t.assignedUsers && t.assignedUsers.some(uid => {
                        const user = dataService.users.find(u => u.id === uid);
                        return user && user.email.toLowerCase().includes(filter.toLowerCase());
                    }))
                );

                document.getElementById('project-title').textContent = project.name;
                this.renderTaskTable(filteredTasks);
                this.updateKpis(project.tasks); 
                this.renderAssigneeSummary(project.tasks);
                if (document.getElementById('view-switcher').value === 'gantt') {
                    this.renderGanttChart(filteredTasks);
                }
            },

            openModal(modalId) { 
                const modal = document.getElementById(modalId);
                modal.classList.remove('modal-hidden');
                modal.classList.add('modal-visible');
            },
            closeModal(modalId) {
                const modal = document.getElementById(modalId);
                modal.classList.remove('modal-visible');
                modal.classList.add('modal-hidden');
            },
            closeAllModals() {
                document.querySelectorAll('.modal-transition').forEach(modal => this.closeModal(modal.id));
            },
            openTaskModal(mode, data = {}) {
                document.getElementById('task-form').reset();
                this.populateAssignedUsersCheckboxes(); 
                
                const { parentId, taskId } = data;
                const project = dataService.getCurrentProject();
                const task = taskId ? project.tasks.find(t => t.id === taskId) : {};
                const isParent = taskId ? project.tasks.some(t => t.parentId === taskId) : false;
                
                // Preencher checkboxes de usu√°rios atribu√≠dos
                if (mode === 'edit') {
                    const assignedUsers = task.assignedUsers || [];
                    document.querySelectorAll('.user-checkbox').forEach(checkbox => {
                        checkbox.checked = assignedUsers.includes(checkbox.value);
                    });
                } else {
                    document.querySelectorAll('.user-checkbox').forEach(checkbox => {
                        checkbox.checked = false;
                    });
                }
                
                const startDateInput = document.getElementById('start-date');
                const endDateInput = document.getElementById('end-date');
                const rescheduleBtnContainer = document.getElementById('reschedule-button-container');
                const dateHistoryContainer = document.getElementById('date-history-container');
                const dateHistoryList = document.getElementById('date-history-list');

                document.getElementById('progress-info').classList.toggle('hidden', !isParent);
                document.getElementById('task-progress').disabled = isParent;

                document.getElementById('modal-title').textContent = mode === 'add' ? 'Adicionar Tarefa' : 'Editar Tarefa';
                document.getElementById('task-id').value = task.id || '';
                document.getElementById('parent-id').value = parentId || (task ? task.parentId : '') || '';
                document.getElementById('task-name').value = task.name || '';
                document.getElementById('task-priority').value = task.priority || 'M√©dia';
                document.getElementById('task-status').value = task.status || 'N√£o Iniciada';
                document.getElementById('task-progress').value = task.progress || 0;
                document.getElementById('task-risk').checked = task.risk || false;
                
                const dependencySelect = document.getElementById('task-dependency');
                dependencySelect.innerHTML = '<option value="">Nenhuma</option>';
                project?.tasks.forEach(t => {
                    if (t.id !== task.id) { 
                        const option = document.createElement('option');
                        option.value = t.id;
                        option.textContent = t.name;
                        dependencySelect.appendChild(option);
                    }
                });
                dependencySelect.value = task.dependsOn || '';

                this.renderComments(task.comments || []);
                document.getElementById('new-comment-input').value = '';

                if (mode === 'edit') {
                    const latestDates = dataService.getLatestDates(task);
                    startDateInput.value = latestDates.startDate;
                    endDateInput.value = latestDates.endDate;
                    startDateInput.disabled = true;
                    endDateInput.disabled = true;
                    rescheduleBtnContainer.classList.remove('hidden');
                    dateHistoryContainer.classList.remove('hidden');
                    
                    dateHistoryList.innerHTML = (task.dateHistory || []).map((d, i) => 
                        `<p>${i + 1}: ${new Date(d.startDate+'T00:00:00').toLocaleDateString('pt-BR')} - ${new Date(d.endDate+'T00:00:00').toLocaleDateString('pt-BR')}</p>`
                    ).join('');
                    
                    const rescheduleHandler = () => {
                        startDateInput.disabled = false;
                        endDateInput.disabled = false;
                        document.getElementById('reschedule-btn').classList.add('hidden');
                    };

                    document.getElementById('reschedule-btn').classList.remove('hidden');
                    document.getElementById('reschedule-btn').onclick = rescheduleHandler;

                } else { 
                    startDateInput.disabled = false;
                    endDateInput.disabled = false;
                    startDateInput.value = '';
                    endDateInput.value = '';
                    rescheduleBtnContainer.classList.add('hidden');
                    dateHistoryContainer.classList.add('hidden');
                }
                
                this.openModal('task-modal');
            },
            getTaskFormData() {
                const startDateInput = document.getElementById('start-date');
                const endDateInput = document.getElementById('end-date');
                
                // Coletar usu√°rios selecionados
                const selectedUsers = Array.from(document.querySelectorAll('.user-checkbox:checked'))
                                         .map(checkbox => checkbox.value)
                                         .filter(uid => uid);

                const commentsList = document.getElementById('comments-list');
                const comments = Array.from(commentsList.querySelectorAll('.comment-item')).map(item => ({
                    id: item.dataset.commentId,
                    text: item.dataset.text, 
                    timestamp: item.dataset.timestamp,
                    author: item.dataset.author
                }));

                const data = {
                    id: document.getElementById('task-id').value ? parseFloat(document.getElementById('task-id').value) : null, // CORRE√á√ÉO: Usar parseFloat
                    parentId: document.getElementById('parent-id').value ? parseFloat(document.getElementById('parent-id').value) : null, // CORRE√á√ÉO: Usar parseFloat
                    name: document.getElementById('task-name').value, 
                    assignedUsers: selectedUsers, 
                    priority: document.getElementById('task-priority').value, 
                    status: document.getElementById('task-status').value,
                    progress: parseInt(document.getElementById('task-progress').value), 
                    risk: document.getElementById('task-risk').checked,
                    dependsOn: document.getElementById('task-dependency').value ? parseFloat(document.getElementById('task-dependency').value) : null, // CORRE√á√ÉO: Usar parseFloat
                    comments: comments,
                    newStartDate: startDateInput.value,
                    newEndDate: endDateInput.value,
                };
                return data;
            },
            
            showConfirmModal(body, onConfirm) {
                document.getElementById('confirm-modal-body').textContent = body;
                this.openModal('confirm-modal');
                const confirmBtn = document.getElementById('confirm-ok-btn');
                const cancelBtn = document.getElementById('confirm-cancel-btn');
                
                const newConfirmBtn = confirmBtn.cloneNode(true);
                const newCancelBtn = cancelBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                
                newConfirmBtn.addEventListener('click', () => { onConfirm(); this.closeModal('confirm-modal'); });
                newCancelBtn.addEventListener('click', () => { this.closeModal('confirm-modal'); });
            },
            
            // MELHORIA: Fun√ß√£o melhorada para renderizar coment√°rios com autor
            renderComments: function(comments) {
                const listEl = document.getElementById('comments-list');
                listEl.innerHTML = '';
                
                // Ordenar coment√°rios do mais recente para o mais antigo
                comments.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                        .forEach(comment => {
                    const commentItem = document.createElement('div');
                    commentItem.className = "comment-item border-b border-[var(--border-color)] pb-1 mb-1 text-xs last:border-b-0 relative";
                    commentItem.dataset.commentId = comment.id || Date.now() + Math.random();
                    commentItem.dataset.timestamp = comment.timestamp;
                    commentItem.dataset.text = comment.text;
                    commentItem.dataset.author = comment.author || dataService.users.find(u => u.id === dataService.userId)?.name || 'Utilizador';
                    
                    const dateString = new Date(comment.timestamp).toLocaleDateString('pt-BR');
                    const timeString = new Date(comment.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    
                    commentItem.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="font-semibold text-gray-500">${commentItem.dataset.author}</span>
                                    <span class="text-gray-400 text-xs">${dateString} ${timeString}</span>
                                </div>
                                <span class="comment-text">${comment.text}</span>
                            </div>
                            <div class="comment-actions flex gap-1 ml-2">
                                <button class="edit-comment-btn text-blue-500 hover:text-blue-700" title="Editar coment√°rio">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                    </svg>
                                </button>
                                <button class="delete-comment-btn text-red-500 hover:text-red-700" title="Excluir coment√°rio">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 000-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                    listEl.appendChild(commentItem);
                });

                // Adicionar event listeners para os bot√µes de edi√ß√£o e exclus√£o
                listEl.querySelectorAll('.edit-comment-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const commentItem = e.target.closest('.comment-item');
                        this.editComment(commentItem);
                    });
                });

                listEl.querySelectorAll('.delete-comment-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const commentItem = e.target.closest('.comment-item');
                        this.deleteComment(commentItem);
                    });
                });
            },

            // MELHORIA: Fun√ß√£o para editar coment√°rio
            editComment: function(commentItem) {
                const commentText = commentItem.querySelector('.comment-text');
                const currentText = commentText.textContent;
                
                // Criar input de edi√ß√£o
                const editInput = document.createElement('input');
                editInput.type = 'text';
                editInput.className = 'edit-comment-input';
                editInput.value = currentText;
                
                // Substituir texto pelo input
                commentText.replaceWith(editInput);
                editInput.focus();
                
                // Adicionar bot√µes de confirma√ß√£o/cancelamento
                const actionButtons = commentItem.querySelector('.comment-actions');
                actionButtons.innerHTML = `
                    <button class="save-comment-btn text-green-500 hover:text-green-700" title="Salvar">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <button class="cancel-edit-comment-btn text-gray-500 hover:text-gray-700" title="Cancelar">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                
                // Event listeners para os novos bot√µes
                commentItem.querySelector('.save-comment-btn').addEventListener('click', () => {
                    const newText = editInput.value.trim();
                    if (newText) {
                        commentItem.dataset.text = newText;
                        const newCommentText = document.createElement('span');
                        newCommentText.className = 'comment-text';
                        newCommentText.textContent = newText;
                        editInput.replaceWith(newCommentText);
                        this.restoreCommentButtons(commentItem);
                    }
                });
                
                commentItem.querySelector('.cancel-edit-comment-btn').addEventListener('click', () => {
                    const originalCommentText = document.createElement('span');
                    originalCommentText.className = 'comment-text';
                    originalCommentText.textContent = currentText;
                    editInput.replaceWith(originalCommentText);
                    this.restoreCommentButtons(commentItem);
                });
                
                // Salvar ao pressionar Enter
                editInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        commentItem.querySelector('.save-comment-btn').click();
                    }
                });
            },

            // MELHORIA: Restaurar bot√µes padr√£o do coment√°rio
            restoreCommentButtons: function(commentItem) {
                const actionButtons = commentItem.querySelector('.comment-actions');
                actionButtons.innerHTML = `
                    <button class="edit-comment-btn text-blue-500 hover:text-blue-700" title="Editar coment√°rio">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                        </svg>
                    </button>
                    <button class="delete-comment-btn text-red-500 hover:text-red-700" title="Excluir coment√°rio">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 000-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                
                // Re-adicionar event listeners
                actionButtons.querySelector('.edit-comment-btn').addEventListener('click', (e) => {
                    this.editComment(commentItem);
                });
                actionButtons.querySelector('.delete-comment-btn').addEventListener('click', (e) => {
                    this.deleteComment(commentItem);
                });
            },

            // MELHORIA: Fun√ß√£o para excluir coment√°rio
            deleteComment: function(commentItem) {
                commentItem.remove();
            },

            // MELHORIA: Fun√ß√£o para adicionar coment√°rio (atualizada com autor)
            addComment: function(text) {
                const listEl = document.getElementById('comments-list');
                const commentItem = document.createElement('div');
                const commentId = Date.now() + Math.random();
                const timestamp = new Date().toISOString();
                const currentUser = dataService.users.find(u => u.id === dataService.userId);
                const authorName = currentUser?.name || currentUser?.email.split('@')[0] || 'Utilizador';
                
                commentItem.className = "comment-item border-b border-[var(--border-color)] pb-1 mb-1 text-xs last:border-b-0 relative";
                commentItem.dataset.commentId = commentId;
                commentItem.dataset.timestamp = timestamp;
                commentItem.dataset.text = text;
                commentItem.dataset.author = authorName;
                
                const dateString = new Date(timestamp).toLocaleDateString('pt-BR');
                const timeString = new Date(timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                
                commentItem.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-semibold text-gray-500">${authorName}</span>
                                <span class="text-gray-400 text-xs">${dateString} ${timeString}</span>
                            </div>
                            <span class="comment-text">${text}</span>
                        </div>
                        <div class="comment-actions flex gap-1 ml-2">
                            <button class="edit-comment-btn text-blue-500 hover:text-blue-700" title="Editar coment√°rio">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                </svg>
                            </button>
                            <button class="delete-comment-btn text-red-500 hover:text-red-700" title="Excluir coment√°rio">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 000-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                
                listEl.prepend(commentItem);
                
                // Adicionar event listeners para os novos bot√µes
                commentItem.querySelector('.edit-comment-btn').addEventListener('click', (e) => {
                    this.editComment(commentItem);
                });
                commentItem.querySelector('.delete-comment-btn').addEventListener('click', (e) => {
                    this.deleteComment(commentItem);
                });
            },

            showToast(message, type = 'success') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                const colors = { success: 'bg-green-600', error: 'bg-red-600' };
                toast.className = `toast text-white ${colors[type]}`;
                toast.innerHTML = `<p>${message}</p>`;
                container.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 3000);
            },
            
            initTheme() {
                const theme = localStorage.getItem('theme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (theme === 'dark' || (!theme && prefersDark)) {
                    document.documentElement.classList.add('dark');
                }
                this.updateThemeIcons();
            },
            toggleTheme() {
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
                this.updateThemeIcons();
                this.updateMainDashboard(dataService.projects);
                if (document.getElementById('view-switcher').value === 'gantt' && dataService.currentProjectId) {
                    this.renderGanttChart(dataService.getCurrentProject().tasks, document.getElementById('task-filter-input').value);
                }
            },
            updateThemeIcons() {
                const isDark = document.documentElement.classList.contains('dark');
                document.getElementById('theme-icon-sun').style.display = isDark ? 'block' : 'none';
                document.getElementById('theme-icon-moon').style.display = isDark ? 'none' : 'block';
            },

            updateKpis: function(tasks) {
                const kpiDashboard = document.getElementById('kpi-dashboard');
                const overallProgress = dataService.getProjectProgress(tasks);
                const kpis = [
                    { label: 'Progresso Geral', value: `${overallProgress}%` },
                    { label: 'Total de Tarefas', value: tasks.length },
                    { label: 'Conclu√≠das', value: tasks.filter(t => t.status === 'Conclu√≠da').length },
                    { label: 'Atrasadas', value: tasks.filter(t => reportService.getTaskStatusClass(t.status, dataService.getLatestDates(t).endDate).name === 'Atrasada').length },
                    { label: 'Em Risco', value: tasks.filter(t => t.risk).length },
                ];
                kpiDashboard.innerHTML = kpis.map(kpi => `
                    <div class="bg-[var(--card-bg)] p-4 rounded-lg shadow-md flex items-center gap-4 border border-[var(--border-color)]">
                        <div> <div class="text-3xl font-bold">${kpi.value}</div> <div class="text-sm text-gray-400">${kpi.label}</div> </div>
                    </div>`).join('');
            },
            renderAssigneeSummary(tasks) {
                const summaryContainer = document.getElementById('assignee-summary-list');
                const uidToName = new Map(dataService.users.map(u => [u.id, u.name || u.email.split('@')[0]]));

                const summary = tasks.reduce((acc, task) => {
                    (task.assignedUsers || []).forEach(uid => {
                        const userName = uidToName.get(uid) || `UID: ${uid.substring(0, 4)}`;
                        if (!acc[userName]) acc[userName] = 0;
                        acc[userName]++;
                    });
                    return acc;
                }, {});

                summaryContainer.innerHTML = Object.entries(summary).map(([name, count]) => `
                    <div class="flex justify-between items-center">
                        <span>${name}</span>
                        <span class="font-bold bg-gray-200 dark:bg-gray-700 text-xs px-2 py-1 rounded-full">${count}</span>
                    </div>
                `).join('');
            },

            // CORRE√á√ÉO: Dashboard com gr√°ficos funcionais
            updateMainDashboard: function(projects) { 
                const mainDashboard = document.getElementById('main-dashboard');
                
                // Destruir gr√°ficos existentes
                Object.values(this.mainDashboardCharts).forEach(chart => {
                    if (chart) chart.destroy();
                });
                this.mainDashboardCharts = {};
                
                // Calcular m√©tricas
                let inProgressCount = 0, overdueCount = 0, atRiskCount = 0;
                const totalProjects = projects.length;

                const overdueProjects = [];
                const inProgressProjects = [];
                const atRiskProjects = [];

                projects.forEach(project => {
                    const progress = dataService.getProjectProgress(project.tasks);
                    if (progress > 0 && progress < 100) {
                        inProgressCount++;
                        inProgressProjects.push(project);
                    }
                    
                    const hasOverdue = project.tasks.some(t => reportService.getTaskStatusClass(t.status, dataService.getLatestDates(t).endDate).name === 'Atrasada');
                    if (hasOverdue) {
                        overdueCount++;
                        overdueProjects.push(project);
                    }
                    
                    const hasRisk = project.tasks.some(t => t.risk);
                    if (hasRisk) {
                        atRiskCount++;
                        atRiskProjects.push(project);
                    }
                });
                
                // Criar container para os gr√°ficos
                mainDashboard.innerHTML = `
                    <div class="bg-[var(--card-bg)] p-6 rounded-lg shadow-md border border-[var(--border-color)]">
                        <h3 class="text-lg font-semibold mb-4">Total de Projetos</h3>
                        <div class="relative">
                            <canvas id="total-projects-chart" height="120"></canvas>
                        </div>
                    </div>
                    <div class="bg-[var(--card-bg)] p-6 rounded-lg shadow-md border border-[var(--border-color)]">
                        <h3 class="text-lg font-semibold mb-4">Projetos em Andamento</h3>
                        <div class="relative">
                            <canvas id="in-progress-chart" height="120"></canvas>
                        </div>
                    </div>
                    <div class="bg-[var(--card-bg)] p-6 rounded-lg shadow-md border border-[var(--border-color)]">
                        <h3 class="text-lg font-semibold mb-4">Projetos Atrasados</h3>
                        <div class="relative">
                            <canvas id="overdue-chart" height="120"></canvas>
                        </div>
                    </div>
                    <div class="bg-[var(--card-bg)] p-6 rounded-lg shadow-md border border-[var(--border-color)]">
                        <h3 class="text-lg font-semibold mb-4">Projetos em Risco</h3>
                        <div class="relative">
                            <canvas id="at-risk-chart" height="120"></canvas>
                        </div>
                    </div>
                `;

                // CORRE√á√ÉO: Criar gr√°ficos com cores corretas
                this.createDashboardChart('total-projects-chart', totalProjects, 0, 'Total', '#3b82f6', projects);
                this.createDashboardChart('in-progress-chart', inProgressCount, totalProjects - inProgressCount, 'Em Andamento', '#f59e0b', inProgressProjects);
                this.createDashboardChart('overdue-chart', overdueCount, totalProjects - overdueCount, 'Atrasados', '#ef4444', overdueProjects);
                this.createDashboardChart('at-risk-chart', atRiskCount, totalProjects - atRiskCount, 'Em Risco', '#f97316', atRiskProjects);
            },

            // CORRE√á√ÉO: Fun√ß√£o para criar gr√°ficos do dashboard
            createDashboardChart: function(canvasId, value, remaining, label, color, projects) {
                const ctx = document.getElementById(canvasId);
                if (!ctx) return;
                
                const total = value + remaining;
                
                // Destruir gr√°fico existente se houver
                if (this.mainDashboardCharts[canvasId]) {
                    this.mainDashboardCharts[canvasId].destroy();
                }
                
                this.mainDashboardCharts[canvasId] = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        datasets: [{
                            data: [value, remaining],
                            backgroundColor: [color, '#e5e7eb'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        cutout: '70%',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed;
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${value} projetos (${percentage}%)`;
                                    },
                                    afterBody: function(context) {
                                        if (context[0].dataIndex === 0 && projects.length > 0) {
                                            const projectNames = projects.map(p => p.name).slice(0, 5);
                                            const remainingCount = projects.length - 5;
                                            let tooltipText = ['', 'Projetos:'];
                                            tooltipText = tooltipText.concat(projectNames);
                                            if (remainingCount > 0) {
                                                tooltipText.push(`... e mais ${remainingCount}`);
                                            }
                                            return tooltipText;
                                        }
                                        return '';
                                    }
                                }
                            }
                        }
                    },
                    plugins: [{
                        id: 'centerText',
                        afterDraw(chart) {
                            const { ctx, chartArea: { width, height } } = chart;
                            ctx.save();
                            ctx.font = 'bold 20px Inter';
                            ctx.fillStyle = chart.config.data.datasets[0].backgroundColor[0];
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.fillText(value.toString(), width / 2, height / 2 - 10);
                            
                            ctx.font = '12px Inter';
                            ctx.fillStyle = '#6b7280';
                            ctx.fillText(label, width / 2, height / 2 + 15);
                            ctx.restore();
                        }
                    }]
                });
            },

            // FUN√á√ïES ADICIONADAS PARA CORRIGIR OS ERROS
            renderProjectList: function(projects) {
                const projectListContainer = document.getElementById('project-list');
                
                if (!projects || projects.length === 0) {
                    projectListContainer.innerHTML = `
                        <div class="col-span-full text-center py-8">
                            <p class="text-gray-400">Nenhum projeto encontrado.</p>
                            <p class="text-sm text-gray-500 mt-2">Crie seu primeiro projeto clicando no bot√£o acima.</p>
                        </div>
                    `;
                    return;
                }

                projectListContainer.innerHTML = projects.map(project => {
                    const progress = dataService.getProjectProgress(project.tasks);
                    const statusInfo = reportService.getTaskStatusClass(
                        progress === 100 ? 'Conclu√≠da' : progress > 0 ? 'Em Andamento' : 'N√£o Iniciada', 
                        ''
                    );
                    
                    const canDelete = dataService.userRole === 'Gestor' || project.creatorId === dataService.userId;
                    
                    // CORRE√á√ÉO: Usar nome do respons√°vel em vez de UID
                    const managerName = dataService.getManagerName(project.manager);
                    
                    return `
                        <div class="project-card-link bg-[var(--card-bg)] rounded-lg shadow-md p-6 border border-[var(--border-color)] hover:shadow-lg transition-shadow cursor-pointer" data-project-id="${project.id}">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-xl font-semibold text-[var(--text-color)]">${project.name}</h3>
                                ${canDelete ? `
                                    <button class="delete-project-btn text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 dark:hover:bg-red-900 transition-colors" data-project-id="${project.id}" title="Excluir projeto">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                ` : ''}
                            </div>
                            
                            <div class="mb-4">
                                <div class="flex justify-between text-sm text-gray-400 mb-1">
                                    <span>Progresso</span>
                                    <span>${progress}%</span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: ${progress}%"></div>
                                </div>
                            </div>
                            
                            <div class="flex justify-between items-center text-sm">
                                <div class="flex items-center gap-4">
                                    <span class="px-2 py-1 rounded-full text-xs ${statusInfo.badge}">
                                        ${progress === 100 ? 'Conclu√≠do' : progress > 0 ? 'Em Andamento' : 'N√£o Iniciado'}
                                    </span>
                                    <span class="text-gray-400">${project.tasks?.length || 0} tarefas</span>
                                </div>
                                <div class="text-gray-400 text-xs">
                                    Respons√°vel: ${managerName}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            renderTaskTable: function(tasks) {
                const tableBody = document.getElementById('task-table-body');
                
                if (!tasks || tasks.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="8" class="p-4 text-center text-gray-400">
                                Nenhuma tarefa encontrada. Clique em "Nova Tarefa" para come√ßar.
                            </td>
                        </tr>
                    `;
                    return;
                }

                const processTasksForTable = (parentId, level) => {
                    let html = '';
                    const childTasks = tasks
                        .filter(t => t.parentId === parentId)
                        .sort((a, b) => {
                            const dateA = new Date(dataService.getLatestDates(a).startDate);
                            const dateB = new Date(dataService.getLatestDates(b).startDate);
                            return dateA - dateB;
                        });

                    childTasks.forEach(task => {
                        const latestDates = dataService.getLatestDates(task);
                        const duration = reportService.calculateDuration(latestDates.startDate, latestDates.endDate);
                        const statusInfo = reportService.getTaskStatusClass(task.status, latestDates.endDate);
                        const isParent = tasks.some(t => t.parentId === task.id);
                        
                        // CORRE√á√ÉO: Usar nomes em vez de UIDs
                        const assignedUsersText = dataService.getAssignedUserNames(task.assignedUsers);

                        const commentsPreview = (task.comments || [])
                            .slice(0, 2)
                            .map(c => `${c.author || 'Utilizador'}: ${c.text.substring(0, 30)}${c.text.length > 30 ? '...' : ''}`)
                            .join('; ');

                        html += `
                            <tr class="border-b border-[var(--border-color)] hover:bg-gray-100 dark:hover:bg-gray-700">
                                <td class="p-3">
                                    <div style="padding-left: ${level * 20}px" class="flex items-center gap-2">
                                        ${isParent ? '<span class="text-blue-500">üìÅ</span>' : '<span class="text-gray-400">üìÑ</span>'}
                                        <span class="task-edit-trigger cursor-pointer hover:text-blue-500 hover:underline" data-task-id="${task.id}">
                                            ${task.name}
                                        </span>
                                        ${task.risk ? '<span class="text-red-500 text-xs" title="Tarefa em risco">‚ö†Ô∏è</span>' : ''}
                                    </div>
                                </td>
                                <td class="p-3">${duration}</td>
                                <td class="p-3">${new Date(latestDates.startDate + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                                <td class="p-3">${new Date(latestDates.endDate + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                                <td class="p-3">
                                    <span class="px-2 py-1 rounded-full text-xs ${statusInfo.badge}">
                                        ${statusInfo.name}
                                    </span>
                                </td>
                                <td class="p-3 text-xs text-gray-500 max-w-xs truncate" title="${assignedUsersText}">
                                    ${assignedUsersText}
                                </td>
                                <td class="p-3 text-xs text-gray-500 max-w-xs truncate" title="${commentsPreview}">
                                    ${commentsPreview || '-'}
                                </td>
                                <td class="p-3 text-center no-print">
                                    <div class="flex justify-center gap-1">
                                        <button class="add-subtask-btn bg-green-500 text-white p-1 rounded hover:bg-green-600" 
                                                data-task-id="${task.id}" data-parent-id="${task.id}" title="Adicionar subtarefa">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                                            </svg>
                                        </button>
                                        <button class="edit-task-btn bg-blue-500 text-white p-1 rounded hover:bg-blue-600" 
                                                data-task-id="${task.id}" title="Editar tarefa">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                            </svg>
                                        </button>
                                        <button class="delete-task-btn bg-red-500 text-white p-1 rounded hover:bg-red-600" 
                                                data-task-id="${task.id}" title="Excluir tarefa">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 000-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                        
                        // Processar subtarefas recursivamente
                        html += processTasksForTable(task.id, level + 1);
                    });
                    
                    return html;
                };

                tableBody.innerHTML = processTasksForTable(null, 0);
            },

            renderGanttChart: function(tasks) {
                const ganttView = document.getElementById('gantt-view');
                if (!tasks || tasks.length === 0 || ganttView.classList.contains('hidden')) return;

                const taskNamesContainer = document.getElementById('gantt-task-names');
                const timelineBody = document.getElementById('gantt-timeline-body');
                const ganttHeader = document.getElementById('gantt-header');
                const dependencyLines = document.getElementById('gantt-dependency-lines');
                taskNamesContainer.innerHTML = ''; timelineBody.innerHTML = ''; ganttHeader.innerHTML = ''; dependencyLines.innerHTML = '';

                const allDates = tasks.flatMap(t => t.dateHistory.flatMap(d => [new Date(d.startDate), new Date(d.endDate)]))
                                        .filter(d => !isNaN(d.getTime()));
                if (allDates.length === 0) return;

                let minDate = new Date(Math.min.apply(null, allDates));
                let maxDate = new Date(Math.max.apply(null, allDates));
                minDate.setDate(minDate.getDate() - 2); maxDate.setDate(maxDate.getDate() + 2);

                const totalDays = reportService.calculateDuration(minDate.toISOString().split('T')[0], maxDate.toISOString().split('T')[0]);
                if (totalDays <= 0) return;
                const dayWidth = 40; 
                
                timelineBody.style.width = `${totalDays * dayWidth}px`;
                ganttHeader.style.width = `${totalDays * dayWidth}px`;
                
                let currentDate = new Date(minDate);
                ganttHeader.style.display = 'flex';
                for (let i = 1; i <= totalDays; i++) {
                    const dayCell = document.createElement('div');
                    const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
                    dayCell.className = `text-center text-xs p-1 border-r border-b border-[var(--border-color)] shrink-0 ${isWeekend ? 'bg-gray-300 dark:bg-gray-800 font-semibold' : ''}`;
                    dayCell.style.width = `${dayWidth}px`;
                    dayCell.textContent = `${currentDate.getDate()}/${currentDate.getMonth()+1}`;
                    ganttHeader.appendChild(dayCell);
                    currentDate.setDate(currentDate.getDate() + 1);
                }

                let taskOrder = [];
                const processGanttTasks = (parentId, level) => {
                    tasks.filter(t => t.parentId === parentId).sort((a,b) => {
                        const dateA = new Date(dataService.getLatestDates(a).startDate);
                        const dateB = new Date(dataService.getLatestDates(b).startDate);
                        return dateA - dateB;
                    }).forEach(task => { taskOrder.push({ ...task, level }); processGanttTasks(task.id, level + 1); });
                };
                processGanttTasks(null, 0);
                
                const taskPositions = new Map();
                taskOrder.forEach((task, index) => {
                    const isParent = tasks.some(t => t.parentId === task.id);
                    const nameDiv = document.createElement('div');
                    nameDiv.className = `gantt-task-name h-10 flex items-center border-b border-[var(--border-color)] p-2 ${isParent ? 'font-bold' : ''}`;
                    nameDiv.style.paddingLeft = `${task.level * 15 + 8}px`;
                    nameDiv.textContent = task.name;
                    taskNamesContainer.appendChild(nameDiv);

                    const latestDates = dataService.getLatestDates(task);
                    const startDate = new Date(latestDates.startDate + 'T00:00:00');
                    const endDate = new Date(latestDates.endDate + 'T00:00:00');
                    if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) { return; }

                    const duration = reportService.calculateDuration(latestDates.startDate, latestDates.endDate);
                    const startDay = reportService.calculateDuration(minDate.toISOString().split('T')[0], latestDates.startDate);
                    const bar = document.createElement('div');
                    const statusInfo = reportService.getTaskStatusClass(task.status, latestDates.endDate);
                    
                    let barColor;
                    if (isParent) { barColor = 'bg-gray-500 dark:bg-gray-600'; 
                    } else if (statusInfo.name === 'Atrasada') { barColor = 'bg-red-500';
                    } else if (statusInfo.name === 'Conclu√≠da') { barColor = 'bg-green-500';
                    } else { barColor = 'bg-blue-500'; }

                    bar.className = `gantt-bar ${isParent ? 'gantt-bar-parent' : ''} ${barColor}`;
                    bar.style.left = `${(startDay - 1) * dayWidth}px`;
                    bar.style.width = `${duration * dayWidth}px`;
                    bar.style.top = `${index * 40}px`;
                    bar.title = `${task.name}\nProgresso: ${task.progress}%\nIn√≠cio: ${startDate.toLocaleDateString('pt-BR')}\nT√©rmino: ${endDate.toLocaleDateString('pt-BR')}`;
                    
                    if (!isParent) {
                        const progressOverlay = document.createElement('div');
                        progressOverlay.style.width = `${task.progress}%`;
                        progressOverlay.style.height = '100%';
                        progressOverlay.className = `absolute top-0 left-0 bg-opacity-70 ${barColor}`;
                        progressOverlay.style.backgroundColor = barColor.replace('bg-', 'bg-');
                        const progressText = document.createElement('span');
                        progressText.className = 'absolute inset-0 text-white flex items-center justify-center';
                        progressText.textContent = `${task.progress}%`;
                        
                        bar.innerHTML = '';
                        bar.style.backgroundColor = '#ccc'; 
                        bar.style.color = '#1f2937'; 
                        bar.appendChild(progressOverlay);
                        bar.appendChild(progressText);
                    } else {
                        bar.textContent = task.name;
                        bar.classList.add('text-xs');
                    }

                    timelineBody.appendChild(bar);
                    
                    taskPositions.set(task.id, {
                        x_start: (startDay - 1) * dayWidth,
                        x_end: ((startDay - 1) + duration) * dayWidth,
                        y: (index * 40) + (isParent ? 14 : 20) 
                    });
                });
                
                taskOrder.forEach(task => {
                    if (task.dependsOn && taskPositions.has(task.dependsOn) && taskPositions.has(task.id)) {
                        const fromTask = taskPositions.get(task.dependsOn);
                        const toTask = taskPositions.get(task.id);
                        const line = document.createElementNS("http://www.w3.org/2000/svg", "path");
                        const x1 = fromTask.x_end;
                        const y1 = fromTask.y;
                        const x2 = toTask.x_start;
                        const y2 = toTask.y;
                        const curve = `M ${x1} ${y1} C ${x1 + 25} ${y1} ${x2 - 25} ${y2} ${x2} ${y2}`;
                        
                        line.setAttribute("d", curve);
                        line.setAttribute("stroke", "#6b7280");
                        line.setAttribute("stroke-width", "1.5");
                        line.setAttribute("fill", "none");
                        line.setAttribute("marker-end", "url(#arrow)");
                        dependencyLines.appendChild(line);
                    }
                });
                if (dependencyLines.innerHTML !== '') {
                    const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
                    defs.innerHTML = `<marker id="arrow" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#6b7280" /></marker>`;
                    dependencyLines.prepend(defs); 
                }
            },
        };
        
        // Report Service - Handles PDF, Excel generation and Template
        const reportService = {
            downloadExcelTemplate() {
                const headers = ['Tarefa', 'Dura√ß√£o (dias)', 'Data In√≠cio', 'Data Termino', 'Status', 'Progresso (%)', 'Prioridade', 'Atribu√≠do a (Nomes Separados por V√≠rgula)', 'Risco (Sim/Nao)', 'Tarefa Pai (Nome)'];
                const exampleData = [
                    { 
                        'Tarefa': 'Planejamento Geral', 
                        'Dura√ß√£o (dias)': 5, 
                        'Data In√≠cio': '2025-11-01', 
                        'Data Termino': '2025-11-05', 
                        'Status': 'N√£o Iniciada', 
                        'Progresso (%)': 0, 
                        'Prioridade': 'Alta', 
                        'Atribu√≠do a (Nomes Separados por V√≠rgula)': 'Jo√£o Silva, Maria Santos', 
                        'Risco (Sim/Nao)': 'Nao', 
                        'Tarefa Pai (Nome)': '' 
                    },
                    { 
                        'Tarefa': 'Definir Escopo', 
                        'Dura√ß√£o (dias)': 2, 
                        'Data In√≠cio': '2025-11-01', 
                        'Data Termino': '2025-11-02', 
                        'Status': 'N√£o Iniciada', 
                        'Progresso (%)': 0, 
                        'Prioridade': 'Alta', 
                        'Atribu√≠do a (Nomes Separados por V√≠rgula)': 'Jo√£o Silva', 
                        'Risco (Sim/Nao)': 'Nao', 
                        'Tarefa Pai (Nome)': 'Planejamento Geral' 
                    }
                ];
                
                const workbook = XLSX.utils.book_new();
                
                // Garantir a ordem das colunas
                const worksheet = XLSX.utils.json_to_sheet(exampleData, { header: headers });
                
                worksheet['!cols'] = [
                    { wch: 40 }, // Tarefa
                    { wch: 15 }, // Dura√ß√£o (dias)
                    { wch: 15 }, // Data In√≠cio
                    { wch: 15 }, // Data Termino
                    { wch: 15 }, // Status
                    { wch: 15 }, // Progresso (%)
                    { wch: 15 }, // Prioridade
                    { wch: 40 }, // Atribu√≠do a (Nomes Separados por V√≠rgula)
                    { wch: 15 }, // Risco (Sim/Nao)
                    { wch: 40 }  // Tarefa Pai (Nome)
                ];
                
                XLSX.utils.book_append_sheet(workbook, worksheet, "Template Importa√ß√£o");
                
                // Adicionar uma aba de instru√ß√µes
                const instructions = [
                    ['INSTRU√á√ïES DE PREENCHIMENTO'],
                    [''],
                    ['Campo', 'Descri√ß√£o', 'Exemplo'],
                    ['Tarefa', 'Nome completo da tarefa', 'Planejamento Geral'],
                    ['Dura√ß√£o (dias)', 'N√∫mero de dias da tarefa', '5'],
                    ['Data In√≠cio', 'Data de in√≠cio (YYYY-MM-DD)', '2025-11-01'],
                    ['Data Termino', 'Data de t√©rmino (YYYY-MM-DD)', '2025-11-05'],
                    ['Status', 'N√£o Iniciada, Em Andamento ou Conclu√≠da', 'N√£o Iniciada'],
                    ['Progresso (%)', '0 a 100', '0'],
                    ['Prioridade', 'Baixa, M√©dia ou Alta', 'Alta'],
                    ['Atribu√≠do a', 'Nomes separados por v√≠rgula', 'Jo√£o Silva, Maria Santos'],
                    ['Risco', 'Sim ou Nao', 'Nao'],
                    ['Tarefa Pai', 'Nome da tarefa pai (deixe vazio para tarefas de n√≠vel superior)', 'Planejamento Geral'],
                    [''],
                    ['IMPORTANTE:'],
                    ['- Use o formato YYYY-MM-DD para datas'],
                    ['- Para tarefas subtarefas, preencha o nome da tarefa pai na √∫ltima coluna'],
                    ['- Os nomes dos respons√°veis devem corresponder exatamente aos cadastrados no sistema']
                ];
                
                const instructionSheet = XLSX.utils.aoa_to_sheet(instructions);
                instructionSheet['!cols'] = [
                    { wch: 25 },
                    { wch: 50 },
                    { wch: 30 }
                ];
                
                XLSX.utils.book_append_sheet(workbook, instructionSheet, "Instru√ß√µes");
                
                XLSX.writeFile(workbook, "template_importacao_correto.xlsx");
            },
            
            calculateDuration: (start, end) => {
                if (!start || !end) return 0;
                const diffTime = new Date(end) - new Date(start);
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            },
            
            getTaskStatusClass: (status, endDate) => {
                const today = new Date(); today.setHours(0,0,0,0);
                const taskEndDate = new Date(endDate + 'T00:00:00');
                if (status !== 'Conclu√≠da' && taskEndDate < today) return { badge: 'bg-red-600 text-white', name: 'Atrasada' };
                switch (status) {
                    case 'Conclu√≠da': return { badge: 'bg-green-600 text-white', name: 'Conclu√≠da' };
                    case 'Em Andamento': return { badge: 'bg-yellow-500 text-black', name: 'Em Andamento' };
                    default: return { badge: 'bg-gray-500 text-white', name: 'N√£o Iniciada' };
                }
            },
            
            exportExcel: function(project) {
                if (!project) return;
                
                const workbook = XLSX.utils.book_new();
                
                // Dados para exporta√ß√£o
                const dataToExport = [];
                const processTasksForExport = (parentId, level) => {
                    project.tasks.filter(t => t.parentId === parentId)
                        .sort((a,b) => {
                            const dateA = new Date(dataService.getLatestDates(a).startDate);
                            const dateB = new Date(dataService.getLatestDates(b).startDate);
                            return dateA - dateB;
                        })
                        .forEach(task => {
                            const latestDates = dataService.getLatestDates(task);
                            const duration = this.calculateDuration(latestDates.startDate, latestDates.endDate);
                            const statusInfo = this.getTaskStatusClass(task.status, latestDates.endDate);
                            const commentsString = (task.comments || [])
                                .map(c => `${c.author || 'Utilizador'}: ${c.text} (${new Date(c.timestamp).toLocaleDateString('pt-BR')})`)
                                .join(' | ');

                            // CORRE√á√ÉO: Usar nomes em vez de UIDs
                            const assignedUserNames = dataService.getAssignedUserNames(task.assignedUsers);

                            dataToExport.push({
                                'Tarefa': `${'  '.repeat(level)}${task.name}`, 
                                'Dura√ß√£o (dias)': duration, 
                                'Data de In√≠cio': new Date(latestDates.startDate + 'T00:00:00').toLocaleDateString('pt-BR'), 
                                'Data de T√©rmino': new Date(latestDates.endDate + 'T00:00:00').toLocaleDateString('pt-BR'),
                                'Status': statusInfo.name, 
                                'Progresso (%)': task.progress,
                                'Prioridade': task.priority,
                                'Respons√°veis': assignedUserNames, // Nomes em vez de UIDs
                                'Em Risco': task.risk ? 'Sim' : 'N√£o',
                                'Coment√°rios': commentsString
                            });
                            processTasksForExport(task.id, level + 1);
                        });
                };
                processTasksForExport(null, 0);
                
                // Criar worksheet principal
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                
                // Aplicar formata√ß√£o
                worksheet['!cols'] = [
                    { wch: 40 }, // Tarefa
                    { wch: 15 }, // Dura√ß√£o
                    { wch: 15 }, // Data In√≠cio
                    { wch: 15 }, // Data T√©rmino
                    { wch: 15 }, // Status
                    { wch: 15 }, // Progresso
                    { wch: 15 }, // Prioridade
                    { wch: 30 }, // Respons√°veis
                    { wch: 15 }, // Em Risco
                    { wch: 50 }  // Coment√°rios
                ];
                
                XLSX.utils.book_append_sheet(workbook, worksheet, "Cronograma");
                
                // Adicionar resumo do projeto
                const summaryData = [
                    ['RELAT√ìRIO DO PROJETO'],
                    [''],
                    ['Nome do Projeto:', project.name],
                    ['Respons√°vel:', dataService.getManagerName(project.manager)],
                    ['Progresso Geral:', `${dataService.getProjectProgress(project.tasks)}%`],
                    ['Total de Tarefas:', project.tasks.length],
                    ['Tarefas Conclu√≠das:', project.tasks.filter(t => t.status === 'Conclu√≠da').length],
                    ['Tarefas Atrasadas:', project.tasks.filter(t => this.getTaskStatusClass(t.status, dataService.getLatestDates(t).endDate).name === 'Atrasada').length],
                    ['Tarefas em Risco:', project.tasks.filter(t => t.risk).length],
                    [''],
                    ['Gerado em:', new Date().toLocaleDateString('pt-BR')]
                ];
                
                const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
                summarySheet['!cols'] = [
                    { wch: 25 },
                    { wch: 30 }
                ];
                
                XLSX.utils.book_append_sheet(workbook, summarySheet, "Resumo");
                
                XLSX.writeFile(workbook, `${project.name.replace(/ /g,"_")}_Relatorio_Formatado.xlsx`);
            },
            
            // CORRE√á√ÉO COMPLETA: Fun√ß√£o generatePdf corrigida para n√£o gerar PDF em branco
            generatePdf: function(project) {
                const loader = document.getElementById('loader');
                loader.style.display = 'flex';
                
                if (!project) { 
                    loader.style.display = 'none'; 
                    uiService.showToast('Nenhum projeto selecionado para gerar PDF', 'error');
                    return; 
                }

                try {
                    // Criar um elemento HTML espec√≠fico para o PDF
                    const pdfContainer = document.createElement('div');
                    pdfContainer.style.padding = '20px';
                    pdfContainer.style.backgroundColor = 'white';
                    pdfContainer.style.color = 'black';
                    pdfContainer.style.fontFamily = 'Arial, sans-serif';
                    pdfContainer.style.width = '100%';
                    
                    // Cabe√ßalho do relat√≥rio
                    const header = `
                        <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px;">
                            <h1 style="font-size: 24px; font-weight: bold; margin: 0;">${project.name}</h1>
                            <p style="color: #666; margin: 5px 0;">Relat√≥rio Gerado em ${new Date().toLocaleDateString('pt-BR')}</p>
                            <p style="color: #666; margin: 0;">Respons√°vel: ${dataService.getManagerName(project.manager)}</p>
                        </div>
                    `;
                    
                    // KPIs
                    const overallProgress = dataService.getProjectProgress(project.tasks);
                    const kpis = `
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px;">
                            <div style="text-align: center; padding: 10px; background: #f0f0f0; border-radius: 5px;">
                                <div style="font-size: 18px; font-weight: bold;">${overallProgress}%</div>
                                <div style="font-size: 12px;">Progresso Geral</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: #f0f0f0; border-radius: 5px;">
                                <div style="font-size: 18px; font-weight: bold;">${project.tasks.length}</div>
                                <div style="font-size: 12px;">Total de Tarefas</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: #f0f0f0; border-radius: 5px;">
                                <div style="font-size: 18px; font-weight: bold;">${project.tasks.filter(t => t.status === 'Conclu√≠da').length}</div>
                                <div style="font-size: 12px;">Conclu√≠das</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: #f0f0f0; border-radius: 5px;">
                                <div style="font-size: 18px; font-weight: bold;">${project.tasks.filter(t => this.getTaskStatusClass(t.status, dataService.getLatestDates(t).endDate).name === 'Atrasada').length}</div>
                                <div style="font-size: 12px;">Atrasadas</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: #f0f0f0; border-radius: 5px;">
                                <div style="font-size: 18px; font-weight: bold;">${project.tasks.filter(t => t.risk).length}</div>
                                <div style="font-size: 12px;">Em Risco</div>
                            </div>
                        </div>
                    `;
                    
                    // Tabela de tarefas
                    let tasksTable = `
                        <div style="margin-top: 20px;">
                            <h2 style="font-size: 18px; margin-bottom: 10px;">Tarefas do Projeto</h2>
                            <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
                                <thead>
                                    <tr style="background-color: #333; color: white;">
                                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Tarefa</th>
                                        <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Dura√ß√£o</th>
                                        <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">In√≠cio</th>
                                        <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">T√©rmino</th>
                                        <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Status</th>
                                        <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Progresso</th>
                                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Respons√°veis</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    // Processar tarefas para a tabela
                    const processTasksForPdf = (parentId, level) => {
                        project.tasks.filter(t => t.parentId === parentId)
                            .sort((a, b) => {
                                const dateA = new Date(dataService.getLatestDates(a).startDate);
                                const dateB = new Date(dataService.getLatestDates(b).startDate);
                                return dateA - dateB;
                            })
                            .forEach(task => {
                                const latestDates = dataService.getLatestDates(task);
                                const duration = this.calculateDuration(latestDates.startDate, latestDates.endDate);
                                const statusInfo = this.getTaskStatusClass(task.status, latestDates.endDate);
                                const assignedUsersText = dataService.getAssignedUserNames(task.assignedUsers);
                                
                                const statusColor = statusInfo.name === 'Conclu√≠da' ? '#10b981' : 
                                                 statusInfo.name === 'Atrasada' ? '#ef4444' : 
                                                 statusInfo.name === 'Em Andamento' ? '#f59e0b' : '#6b7280';
                                
                                tasksTable += `
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 6px; text-align: left; padding-left: ${level * 15 + 8}px;">
                                            ${task.name} ${task.risk ? '‚ö†Ô∏è' : ''}
                                        </td>
                                        <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${duration}d</td>
                                        <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${new Date(latestDates.startDate + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                                        <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${new Date(latestDates.endDate + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                                        <td style="border: 1px solid #ddd; padding: 6px; text-align: center; background-color: ${statusColor}; color: white; font-weight: bold;">
                                            ${statusInfo.name}
                                        </td>
                                        <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${task.progress}%</td>
                                        <td style="border: 1px solid #ddd; padding: 6px; text-align: left;">${assignedUsersText}</td>
                                    </tr>
                                `;
                                
                                processTasksForPdf(task.id, level + 1);
                            });
                    };
                    
                    processTasksForPdf(null, 0);
                    
                    tasksTable += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    // Montar o conte√∫do completo
                    pdfContainer.innerHTML = header + kpis + tasksTable;
                    
                    // Adicionar ao DOM temporariamente
                    pdfContainer.style.position = 'absolute';
                    pdfContainer.style.left = '-9999px';
                    document.body.appendChild(pdfContainer);
                    
                    // Configura√ß√µes do PDF
                    const opt = {
                        margin: 10,
                        filename: `${project.name.replace(/ /g, '_')}_Relatorio.pdf`,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { 
                            scale: 2,
                            useCORS: true,
                            logging: false,
                            backgroundColor: '#FFFFFF',
                            width: pdfContainer.scrollWidth,
                            height: pdfContainer.scrollHeight
                        },
                        jsPDF: { 
                            unit: 'mm', 
                            format: 'a4', 
                            orientation: 'portrait' 
                        }
                    };

                    // Gerar PDF com timeout para garantir que o conte√∫do seja renderizado
                    setTimeout(() => {
                        html2pdf().set(opt).from(pdfContainer).save().then(() => {
                            loader.style.display = 'none';
                            document.body.removeChild(pdfContainer);
                            uiService.showToast('PDF gerado com sucesso!', 'success');
                        }).catch(err => {
                            console.error('Erro ao gerar PDF:', err);
                            loader.style.display = 'none';
                            document.body.removeChild(pdfContainer);
                            uiService.showToast('Erro ao gerar PDF. Tente novamente.', 'error');
                        });
                    }, 500);

                } catch (error) {
                    console.error('Erro no processo de PDF:', error);
                    loader.style.display = 'none';
                    uiService.showToast('Erro ao gerar PDF.', 'error');
                }
            }
        };

        // --- Kick off the app ---
        document.addEventListener('DOMContentLoaded', () => App.init());
        
    </script>
</body>
</html>
