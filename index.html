<!DOCTYPE html>
<html lang="pt-BR" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Projetos - Vinci Highways</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* Estilos personalizados */
        :root { --background-color: #f3f4f6; --text-color: #374151; --card-bg: #ffffff; --card-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); --border-color: #e5e7eb; }
        html.dark { --background-color: #111827; --text-color: #d1d5db; --card-bg: #1f2937; --card-shadow: 0 4px 6px -1p-1px rgb(0 0 0 / 0.2), 0 2px 4px -2px rgb(0 0 0 / 0.2); --border-color: #374151; }
        body { background-color: var(--background-color); color: var(--text-color); font-family: 'Inter', sans-serif; transition: background-color 0.3s ease, color 0.3s ease; }
        @import url('https://rsms.me/inter/inter.css');
        .gantt-chart-container { display: grid; grid-template-columns: 250px 1fr; overflow-x: auto; position: relative; }
        .gantt-task-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .gantt-bar { position: absolute; height: 24px; border-radius: 4px; color: white; font-size: 12px; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer; z-index: 10; }
        .gantt-bar-parent { height: 12px; top: 8px; }
        #gantt-dependency-lines { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; overflow: visible; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; z-index: 9999; backdrop-filter: blur(4px); transition: opacity 0.3s ease; }
        html.dark #loader { background-color: rgba(17, 24, 39, 0.8); }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Transitions for Modals */
        .modal-transition { transition: opacity 0.3s ease, transform 0.3s ease; }
        .modal-hidden { opacity: 0; transform: scale(0.95); pointer-events: none; }
        .modal-visible { opacity: 1; transform: scale(1); }
        /* Toast Notifications */
        #toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 100; display: flex; flex-direction: column; gap: 0.75rem; }
        .toast { display: flex; align-items: center; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); transform: translateX(120%); opacity: 0; transition: all 0.4s cubic-bezier(0.21, 1.02, 0.73, 1); }
        .toast.show { transform: translateX(0); opacity: 1; }
        /* Estilos para Impress√£o */
        @media print { .no-print { display: none !important; } body { background-color: #ffffff !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; } .container, #dashboard-view, main#content-area, .bg-white { padding: 0 !important; margin: 0 !important; max-width: 100% !important; box-shadow: none !important; border: none !important; } .gantt-timeline-container, .overflow-x-auto { overflow: visible !important; } }
    </style>
</head>
<body class="antialiased">
    <div id="loader" class="no-print"><div class="spinner"></div></div>
    
    <div id="toast-container" class="no-print"></div>

    <div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50 modal-transition modal-visible">
        <div class="bg-[var(--card-bg)] rounded-xl shadow-2xl p-8 w-full max-w-md">
            <h2 class="text-3xl font-bold mb-2 text-blue-600">Vinci Highways Projects</h2>
            <p class="text-gray-400 mb-6">Acesso restrito ao dom√≠nio @vinci-highways.com.br</p>

            <form id="auth-form" class="space-y-4">
                <input type="email" id="auth-email" placeholder="E-mail (@vinci-highways.com.br)" class="mt-1 block w-full border border-[var(--border-color)] rounded-md shadow-sm p-3 bg-transparent" required>
                <input type="password" id="auth-password" placeholder="Senha" class="mt-1 block w-full border border-[var(--border-color)] rounded-md shadow-sm p-3 bg-transparent" required>
                
                <div id="secret-code-container" class="hidden">
                    <input type="text" id="auth-secret-code" placeholder="C√≥digo de Acesso (Apenas Gestor)" class="mt-1 block w-full border border-yellow-400 rounded-md shadow-sm p-3 bg-transparent">
                    <p class="text-xs text-yellow-500 mt-1">Use "MASTER_GESTOR" no registro para obter o papel de Gestor.</p>
                </div>

                <div class="flex justify-between items-center">
                    <button type="button" id="toggle-auth-mode" class="text-sm text-blue-500 hover:underline transition-colors">Precisa de uma conta? Registrar</button>
                    <button type="button" id="toggle-secret-code" class="text-xs text-gray-500 hover:underline transition-colors">C√≥digo Secreto?</button>
                </div>

                <div class="flex justify-end gap-2">
                    <button type="submit" id="auth-submit-btn" class="w-full bg-blue-600 text-white px-4 py-3 rounded-md font-semibold hover:bg-blue-700 transition-colors">Login</button>
                </div>
            </form>
        </div>
    </div>


    <div id="user-management-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 no-print modal-transition modal-hidden">
        <div class="bg-[var(--card-bg)] rounded-lg shadow-xl p-6 w-full max-w-4xl">
            <h2 class="text-2xl font-bold mb-4 text-[var(--text-color)]">Gest√£o de Utilizadores e Pap√©is</h2>
            <div id="user-list-container" class="overflow-y-auto max-h-96">
                <table class="w-full text-sm text-left text-gray-400">
                    <thead class="text-xs uppercase bg-gray-700 text-gray-400 sticky top-0">
                        <tr>
                            <th class="p-3">UID</th>
                            <th class="p-3">E-mail</th>
                            <th class="p-3">Papel Atual</th>
                            <th class="p-3 text-center">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="user-management-table-body">
                        </tbody>
                </table>
            </div>
            <div class="flex justify-end mt-4">
                <button type="button" class="cancel-btn bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500">Fechar</button>
            </div>
        </div>
    </div>

    <div id="project-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 no-print modal-transition modal-hidden">
        <div class="bg-[var(--card-bg)] rounded-lg shadow-xl p-6 w-full max-w-md">
            <h2 id="project-modal-title" class="text-2xl font-bold mb-4 text-[var(--text-color)]">Novo Projeto</h2>
            <form id="project-form">
                <div class="mb-4">
                    <label for="project-name" class="block text-sm font-medium text-gray-400">Nome do Projeto</label>
                    <input type="text" id="project-name" class="mt-1 block w-full border border-[var(--border-color)] rounded-md shadow-sm p-2 bg-transparent" required>
                </div>
                <div class="mb-4">
                    <label for="project-manager" class="block text-sm font-medium text-gray-400">Respons√°vel (Opcional)</label>
                    <input type="text" id="project-manager" class="mt-1 block w-full border border-[var(--border-color)] rounded-md shadow-sm p-2 bg-transparent">
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" class="cancel-btn bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Salvar Projeto</button>
                </div>
            </form>
        </div>
    </div>

    <div id="task-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 no-print modal-transition modal-hidden">
        <div class="bg-[var(--card-bg)] rounded-lg shadow-xl p-8 w-full max-w-3xl">
            <h2 id="modal-title" class="text-2xl font-bold mb-6 text-[var(--text-color)]">Adicionar Nova Tarefa</h2>
            <form id="task-form" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <div class="lg:col-span-2 space-y-4">
                    <input type="hidden" id="task-id"><input type="hidden" id="parent-id">
                     <div class="mb-4">
                        <label for="task-name" class="block text-sm font-medium text-gray-400">Nome da Tarefa</label>
                        <input type="text" id="task-name" class="mt-1 block w-full border border-[var(--border-color)] bg-transparent rounded-md shadow-sm p-2" required>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="assigned-users-select" class="block text-sm font-medium text-gray-400">Atribu√≠do a (Utilizadores)</label>
                            <select id="assigned-users-select" multiple class="mt-1 block w-full border border-[var(--border-color)] bg-[var(--card-bg)] rounded-md shadow-sm p-2 h-20">
                                </select>
                        </div>
                        <div><label for="task-priority" class="block text-sm font-medium text-gray-400">Prioridade</label><select id="task-priority" class="mt-1 block w-full border border-[var(--border-color)] bg-[var(--card-bg)] rounded-md shadow-sm p-2"><option value="Baixa">Baixa</option><option value="M√©dia">M√©dia</option><option value="Alta">Alta</option></select></div>
                    </div>

                    <div id="date-section">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <div><label for="start-date" class="block text-sm font-medium text-gray-400">Data de In√≠cio</label><input type="date" id="start-date" class="mt-1 block w-full border border-[var(--border-color)] bg-transparent rounded-md shadow-sm p-2" required></div>
                            <div><label for="end-date" class="block text-sm font-medium text-gray-400">Data de T√©rmino</label><input type="date" id="end-date" class="mt-1 block w-full border border-[var(--border-color)] bg-transparent rounded-md shadow-sm p-2" required></div>
                        </div>
                        <div id="reschedule-button-container" class="mt-2 hidden">
                             <button type="button" id="reschedule-btn" class="text-sm text-blue-500 hover:underline">Reprogramar Datas</button>
                        </div>
                    </div>
    
                    <div id="date-history-container" class="mt-4 hidden">
                        <h4 class="text-sm font-medium text-gray-400 mb-2">Hist√≥rico de Prazos</h4>
                        <div id="date-history-list" class="text-xs text-gray-500 max-h-20 overflow-y-auto bg-gray-100 dark:bg-gray-800 p-2 rounded"></div>
                    </div>
    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div><label for="task-status" class="block text-sm font-medium text-gray-400">Status</label><select id="task-status" class="mt-1 block w-full border border-[var(--border-color)] bg-[var(--card-bg)] rounded-md shadow-sm p-2"><option value="N√£o Iniciada">N√£o Iniciada</option><option value="Em Andamento">Em Andamento</option><option value="Conclu√≠da">Conclu√≠da</option></select></div>
                        <div>
                            <label for="task-progress" class="block text-sm font-medium text-gray-400">Progresso (%)</label>
                            <input type="number" id="task-progress" min="0" max="100" class="mt-1 block w-full border border-[var(--border-color)] bg-transparent rounded-md shadow-sm p-2" required>
                            <p id="progress-info" class="text-xs text-gray-500 mt-1 hidden">O progresso de tarefas-pai √© calculado automaticamente.</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div>
                            <label for="task-dependency" class="block text-sm font-medium text-gray-400">Depende de</label>
                            <select id="task-dependency" class="mt-1 block w-full border border-[var(--border-color)] bg-[var(--card-bg)] rounded-md shadow-sm p-2">
                                <option value="">Nenhuma</option>
                            </select>
                        </div>
                        <div class="flex items-end pb-2">
                            <label class="flex items-center"><input type="checkbox" id="task-risk" class="h-4 w-4 text-red-600 border-gray-300 rounded"><span class="ml-2 text-sm font-medium">Tarefa em Risco</span></label>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-1 border-t lg:border-t-0 lg:border-l lg:pl-6 pt-4 lg:pt-0 border-[var(--border-color)] flex flex-col space-y-4">
                    <h4 class="text-sm font-medium text-gray-400">Coment√°rios</h4>
                    <div id="comments-list" class="flex-grow text-sm text-gray-500 max-h-64 overflow-y-auto bg-gray-100 dark:bg-gray-800 p-3 rounded shadow-inner"></div>
                    <div class="flex gap-2">
                        <input type="text" id="new-comment-input" class="flex-grow border border-[var(--border-color)] bg-transparent rounded-md shadow-sm p-2" placeholder="Adicionar coment√°rio (Enter)">
                        <button type="button" id="add-comment-btn" class="bg-gray-200 dark:bg-gray-600 px-3 rounded-md text-[var(--text-color)] hover:bg-gray-300 dark:hover:bg-gray-500" title="Adicionar Coment√°rio">&rarr;</button>
                    </div>
                </div>

                <div class="lg:col-span-3 flex justify-end gap-2 pt-4 border-t border-[var(--border-color)]">
                    <button type="button" class="cancel-btn bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Salvar Tarefa</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 no-print modal-transition modal-hidden">
        <div class="bg-[var(--card-bg)] rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h2 id="confirm-modal-title" class="text-xl font-bold mb-4 text-[var(--text-color)]">Confirmar A√ß√£o</h2>
            <p id="confirm-modal-body" class="mb-6 text-gray-400">Voc√™ tem certeza?</p>
            <div class="flex justify-end gap-2">
                <button id="confirm-cancel-btn" class="bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500">Cancelar</button>
                <button id="confirm-ok-btn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>

    <div class="relative min-h-screen">
        <input type="file" id="import-excel-input" class="hidden" accept=".xlsx, .xls">
        <div id="logged-in-container" class="hidden">
            <button id="theme-toggle" class="no-print fixed top-4 right-4 z-50 p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                <svg id="theme-icon-sun" class="h-6 w-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <svg id="theme-icon-moon" class="h-6 w-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
            <button id="user-management-btn" class="no-print fixed top-4 right-16 z-50 p-2 rounded-full bg-yellow-500 text-white hover:bg-yellow-600 transition-colors hidden" title="Gerir Utilizadores">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.38 0 2.5 1.12 2.5 2.5S13.38 10 12 10 9.5 8.88 9.5 7.5 10.62 5 12 5zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.8 6-3.8s5.97 1.81 6 3.8c-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
            </button>
            <button id="logout-btn" class="no-print fixed top-4 right-28 z-50 p-2 rounded-full bg-red-500 text-white hover:bg-red-600 transition-colors" title="Logout">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5-5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
            </button>
        </div>
        
        <div id="project-view" class="container mx-auto p-4 md:p-8 hidden">
            <header class="mb-8">
                <h1 class="text-4xl font-bold">Meus Projetos</h1>
                <p class="text-gray-400">Selecione um projeto para gerenciar ou crie um novo.</p>
                <p id="user-role-display" class="text-sm font-semibold mt-2 px-3 py-1 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded-full inline-block">Papel: Carregando...</p>
            </header>
            <div id="main-dashboard" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"></div>
            <div class="mb-6"><button id="add-project-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>Novo Projeto</button></div>
            <div id="project-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <div id="dashboard-view" class="container mx-auto p-4 md:p-8 hidden">
             <header class="mb-8">
                <button id="back-to-projects-btn" class="text-sm text-blue-500 hover:underline mb-2 flex items-center gap-1 no-print">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
                    Voltar para Projetos
                </button>
                <h1 id="project-title" class="text-4xl font-bold">Nome do Projeto</h1>
                <p class="text-gray-400">Painel de controle com o cronograma de execu√ß√£o.</p>
            </header>
            <div id="kpi-dashboard" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-8"></div>
            
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">
                <div class="lg:col-span-3 bg-[var(--card-bg)] p-4 rounded-lg shadow-md flex flex-wrap items-center justify-between gap-4 no-print border border-[var(--border-color)]">
                    <div class="flex items-center gap-4 flex-wrap">
                        <button id="add-task-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center gap-2">Nova Tarefa</button>
                        <button id="import-excel-btn" class="bg-teal-600 text-white px-4 py-2 rounded-md hover:bg-teal-700 flex items-center gap-2">Importar</button>
                        <button id="download-template-btn" class="text-sm text-blue-500 hover:underline">Baixar Template</button>
                    </div>
                    <div class="relative">
                        <input type="text" id="task-filter-input" placeholder="Filtrar tarefas..." class="border border-[var(--border-color)] bg-transparent rounded-md shadow-sm p-2 pl-8 text-sm">
                        <svg class="absolute left-2 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2"><label for="view-switcher" class="text-sm font-medium">Visualiza√ß√£o:</label><select id="view-switcher" class="border border-[var(--border-color)] rounded-md p-2 text-sm bg-[var(--card-bg)]"><option value="table" selected>Tabela</option><option value="gantt">Gantt</option></select></div>
                        <button id="export-excel-btn" class="bg-green-600 text-white px-3 py-2 rounded-md hover:bg-green-700" title="Exportar para Excel">Excel</button>
                        <button id="generate-pdf-report-btn" class="bg-red-600 text-white px-3 py-2 rounded-md hover:bg-red-700" title="Gerar Relat√≥rio PDF">PDF</button>
                        <button id="print-view-btn" class="bg-gray-500 text-white px-3 py-2 rounded-md hover:bg-gray-600" title="Imprimir">Imprimir</button>
                    </div>
                </div>
                 <div id="assignee-summary" class="bg-[var(--card-bg)] p-4 rounded-lg shadow-md border border-[var(--border-color)] no-print">
                    <h3 class="font-bold mb-2">Tarefas por Respons√°vel</h3>
                    <div id="assignee-summary-list" class="text-sm space-y-2 max-h-48 overflow-y-auto"></div>
                </div>
            </div>
            <main id="content-area" class="bg-[var(--card-bg)] p-4 rounded-lg shadow-md border border-[var(--border-color)]">
                <div id="table-view">
                     <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-400">
                            <thead class="text-xs uppercase bg-gray-700 text-gray-400">
                                <tr>
                                    <th class="p-3 min-w-[250px]">Tarefa</th>
                                    <th class="p-3">Dura√ß√£o (dias)</th>
                                    <th class="p-3">Data de In√≠cio</th>
                                    <th class="p-3">Data de T√©rmino</th>
                                    <th class="p-3">Status</th>
                                    <th class="p-3">Coment√°rios</th>
                                    <th class="p-3 text-center no-print">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="task-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <div id="gantt-view" class="hidden">
                     <div class="gantt-chart-container border border-[var(--border-color)] rounded-lg">
                        <svg id="gantt-dependency-lines" width="100%" height="100%"></svg>
                        <div class="gantt-tasks bg-gray-700 bg-opacity-20 border-r border-[var(--border-color)] p-2 font-bold">
                            <div class="h-10 flex items-center">Tarefa</div><div id="gantt-task-names" class="relative"></div>
                        </div>
                        <div class="gantt-timeline-container overflow-x-auto">
                            <div id="gantt-header" class="sticky top-0 bg-gray-700 bg-opacity-20 z-10 border-b border-[var(--border-color)]"></div><div id="gantt-timeline-body" class="relative"></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setDoc, doc, collection, onSnapshot, addDoc, deleteDoc, query, collectionGroup, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Vari√°veis Globais de Firebase
        let firebaseApp;
        let db;
        let auth;
        let unsubscribeProjects = () => {};
        let unsubscribeUsers = () => {};
        
        // --- CONSTANTES E CONFIGURA√á√ÉO ---
        const ALLOWED_DOMAIN = "@vinci-highways.com.br";
        const GESTOR_SECRET_CODE = "MASTER_GESTOR";
        
        // SUAS CREDENCIAIS DO BANCO DE DADOS
        const appId = "cronograma-85bf4"; 
        const firebaseConfig = {
            apiKey: "AIzaSyDB_q9kdQGNiLf34PPZFL2YuBDOj7XdwkA",
            authDomain: "cronograma-85bf4.firebaseapp.com",
            projectId: "cronograma-85bf4",
            storageBucket: "cronograma-85bf4.firebasestorage.app",
            messagingSenderId: "802190123207",
            appId: "1:802190123207:web:adaf51b25010f677bbdee2"
        };
        const initialAuthToken = null; // Token inicial n√£o √© usado no fluxo de Email/Senha


        // dataService Interface
        const dataService = {
            projects: [],
            users: [], 
            currentProjectId: null,
            userId: null,
            userRole: null, 
            isAuthReady: false,
            
            // --- FIREBASE IMPLEMENTATIONS ---
            initFirebase: async () => {
                try {
                    firebaseApp = initializeApp(firebaseConfig);
                    db = getFirestore(firebaseApp);
                    auth = getAuth(firebaseApp);

                    // Listener do estado de autentica√ß√£o inicia o fluxo da UI
                    onAuthStateChanged(auth, async (user) => {
                        if (user && user.email?.endsWith(ALLOWED_DOMAIN)) {
                            // Usu√°rio autenticado e com dom√≠nio correto
                            dataService.userId = user.uid;
                            dataService.isAuthReady = true;
                            
                            await dataService.getUserProfile(user.uid); 
                            
                            uiService.showView('project-view');
                            document.getElementById('logged-in-container').classList.remove('hidden');
                            uiService.closeModal('auth-modal');
                            document.getElementById('loader').style.display = 'none';

                            dataService.listenToUsers();
                            dataService.listenToProjects();

                            uiService.updateUserRoleDisplay();
                        } else {
                            // Nenhuma autentica√ß√£o ou dom√≠nio inv√°lido
                            dataService.userId = null;
                            dataService.isAuthReady = true; 
                            dataService.projects = [];
                            dataService.userRole = null;
                            
                            document.getElementById('logged-in-container').classList.add('hidden');
                            uiService.openModal('auth-modal');
                            document.getElementById('loader').style.display = 'none';
                            unsubscribeProjects();
                            unsubscribeUsers();
                        }
                    });
                } catch (error) {
                    console.error("Erro na inicializa√ß√£o do Firebase:", error);
                    uiService.showToast('Erro ao conectar ao banco de dados! Verifique a API Key e a configura√ß√£o.', 'error');
                    document.getElementById('loader').style.display = 'none';
                }
            },

            // --- USER MANAGEMENT ---
            getUserProfile: async (uid) => {
                const userDocRef = doc(db, 'users_data', uid);
                const userSnapshot = await getDoc(userDocRef); 

                if (userSnapshot.exists()) {
                    dataService.userRole = userSnapshot.data().role;
                } else {
                    dataService.userRole = 'Usuario';
                }
            },
            
            listenToUsers: () => {
                unsubscribeUsers();
                if (!dataService.isAuthReady) return;

                const usersRef = collection(db, 'users_data');

                unsubscribeUsers = onSnapshot(usersRef, (snapshot) => {
                    dataService.users = [];
                    snapshot.forEach(doc => {
                        if (doc.data().email && doc.data().email.endsWith(ALLOWED_DOMAIN)) {
                           dataService.users.push({ id: doc.id, ...doc.data() });
                        }
                    });

                    if (document.getElementById('user-management-modal').classList.contains('modal-visible') && dataService.userRole === 'Gestor') {
                         uiService.renderUserManagementTable();
                    }
                    uiService.populateAssignedUsersSelect();
                }, (error) => {
                    console.error("Erro ao ouvir usu√°rios:", error);
                });
            },
            
            updateUserRole: async (uid, newRole) => {
                try {
                    const userDocRef = doc(db, 'users_data', uid);
                    await setDoc(userDocRef, { role: newRole }, { merge: true });

                    await auth.currentUser.getIdToken(true);
                    
                    uiService.showToast(`Papel de ${dataService.users.find(u => u.id === uid)?.email} atualizado para ${newRole}.`);
                } catch (error) {
                    console.error("Erro ao atualizar papel:", error);
                    uiService.showToast('Falha ao atualizar papel do utilizador.', 'error');
                }
            },

            // --- PROJECT DATA ACCESS ---
            
            getProjectCollectionRef: (uid) => {
                const targetUid = uid || dataService.userId;
                if (!targetUid) throw new Error("Usu√°rio n√£o autenticado.");
                return collection(db, 'artifacts', appId, 'users', targetUid, 'projects');
            },

            listenToProjects: () => {
                unsubscribeProjects(); 
                if (!dataService.isAuthReady) return;
                
                let projectsQuery;
                
                if (dataService.userRole === 'Gestor') {
                    projectsQuery = query(collectionGroup(db, 'projects'));
                } else {
                    projectsQuery = query(dataService.getProjectCollectionRef());
                }
                
                unsubscribeProjects = onSnapshot(projectsQuery, (snapshot) => {
                    console.log("üì¶ Dados recebidos do Firebase:", snapshot.size, "documentos");
                    
                    snapshot.forEach(doc => {
                        console.log("üìÑ Documento:", doc.id, doc.data());
                    });

                    let newProjects = [];
                    snapshot.forEach(doc => {
                        const projectData = doc.data();
                        const creatorId = projectData.creatorId || doc.ref.parent.parent.id; 
                        
                        const tasksWithDefaults = projectData.tasks?.map(t => ({
                            ...t,
                            assignedUsers: t.assignedUsers || [], 
                        })) || [];

                        const project = { 
                            id: doc.id, 
                            manager: projectData.manager || 'N√£o Definido', 
                            creatorId: creatorId, 
                            tasks: tasksWithDefaults,
                            ...projectData 
                        };
                        newProjects.push(project); 
                    });

                    if (dataService.userRole === 'Usuario') {
                        newProjects = newProjects.filter(project => {
                            const isCreator = project.creatorId === dataService.userId;
                            const isAssigned = project.tasks.some(task => 
                                (task.assignedUsers || []).includes(dataService.userId)
                            );
                            return isCreator || isAssigned;
                        });
                    }

                    dataService.projects = newProjects;
                    dataService.recalculateAllProgress();
                    
                    if (dataService.currentProjectId) {
                        const currentProject = dataService.getProjectById(dataService.currentProjectId);
                        if (currentProject) {
                            uiService.renderProjectDashboard(currentProject, document.getElementById('task-filter-input').value);
                        } else {
                            App.showProjectView(); 
                        }
                    } else {
                        App.showProjectView();
                    }
                }, (error) => {
                    console.error("Erro ao ouvir projetos:", error);
                    uiService.showToast('Erro de sincroniza√ß√£o em tempo real.', 'error');
                });
            },
            
            getLatestDates: (task) => {
                if (!task.dateHistory || task.dateHistory.length === 0) return { startDate: '', endDate: '' };
                return task.dateHistory[task.dateHistory.length - 1];
            },
            
            getProjectById: (id) => { return dataService.projects.find(p => p.id === id); },
            getCurrentProject: () => { return dataService.getProjectById(dataService.currentProjectId); },
            
            getProjectOwnerUid: (projectId) => {
                const project = dataService.getProjectById(projectId);
                return project ? project.creatorId : dataService.userId;
            },

            // --- CRUD HELPERS ---

            addProject: async (projectData) => {
                try {
                    const projectCollection = dataService.getProjectCollectionRef();
                    const newProjectData = { 
                        name: projectData.name, 
                        manager: projectData.manager, 
                        tasks: [],
                        creatorId: dataService.userId
                    };
                    await addDoc(projectCollection, newProjectData);
                } catch (error) {
                    console.error("Erro ao adicionar projeto:", error);
                    uiService.showToast('Falha ao adicionar projeto.', 'error');
                }
            },

            deleteProject: async (projectId) => {
                try {
                    const ownerUid = dataService.getProjectOwnerUid(projectId);
                    const projectDocRef = doc(dataService.getProjectCollectionRef(ownerUid), projectId);
                    await deleteDoc(projectDocRef);
                } catch (error) {
                    console.error("Erro ao deletar projeto:", error);
                    uiService.showToast('Falha ao deletar projeto. Verifique suas permiss√µes.', 'error');
                }
            },
            
            saveProjectDocument: async (project) => {
                try {
                    const projectId = project.id; 
                    const ownerUid = project.creatorId; 
                    const projectDocRef = doc(dataService.getProjectCollectionRef(ownerUid), projectId);

                    await setDoc(projectDocRef, { 
                        name: project.name, 
                        manager: project.manager, 
                        tasks: project.tasks,
                        creatorId: ownerUid
                    }, { merge: true });

                } catch (error) {
                    console.error("Erro ao salvar projeto/tarefas:", error);
                    uiService.showToast('Falha ao salvar dados. Verifique a conex√£o.', 'error');
                }
            },

            saveTask: async (taskData) => {
                const project = dataService.getCurrentProject();
                if (!project) return;

                const { newStartDate, newEndDate, ...restOfTaskData } = taskData;
                
                let updatedTasks;

                if (taskData.id) { 
                    updatedTasks = project.tasks.map(t => {
                        if (t.id === restOfTaskData.id) {
                            const updatedTask = { ...t, ...restOfTaskData };
                            if (newStartDate && newEndDate) {
                                const latestDates = dataService.getLatestDates(t);
                                if (latestDates.startDate !== newStartDate || latestDates.endDate !== newEndDate) {
                                    updatedTask.dateHistory = [...(updatedTask.dateHistory || []), { startDate: newStartDate, endDate: newEndDate }];
                                }
                            }
                            return updatedTask;
                        }
                        return t;
                    });
                } else { 
                    const newTask = { 
                        ...restOfTaskData, 
                        id: Date.now(), 
                        dateHistory: [{ startDate: newStartDate, endDate: newEndDate }],
                        comments: taskData.comments || [], 
                    };
                    updatedTasks = [...project.tasks, newTask];
                }
                
                project.tasks = updatedTasks;
                dataService.recalculateAllProgress();
                await dataService.saveProjectDocument(project);
            },

            deleteTask: async (taskId) => {
                const project = dataService.getCurrentProject();
                if (!project) return;
                
                const idsToDelete = [taskId];
                const findChildren = (pid) => { 
                    project.tasks.filter(t => t.parentId === pid).forEach(c => { 
                        idsToDelete.push(c.id); findChildren(c.id); 
                    }); 
                };
                findChildren(taskId);
                
                let updatedTasks = project.tasks.filter(t => !idsToDelete.includes(t.id));
                
                updatedTasks = updatedTasks.map(t => {
                    if (idsToDelete.includes(t.dependsOn)) { t.dependsOn = null; }
                    return t;
                });

                project.tasks = updatedTasks;
                dataService.recalculateAllProgress();
                await dataService.saveProjectDocument(project);
            },
            
            // --- CALCULATION LOGIC ---
            recalculateAllProgress: () => {
                dataService.projects.forEach(project => {
                    const tasks = project.tasks;
                    if (!tasks || tasks.length === 0) return;
                    const taskMap = new Map(tasks.map(t => [t.id, t]));
                    const childrenMap = new Map([...taskMap.keys()].map(k => [k, []]));
                    tasks.forEach(t => { if (t.parentId && childrenMap.has(t.parentId)) childrenMap.get(t.parentId).push(t.id); });

                    const calculateTaskProgress = (taskId) => {
                        const childrenIds = childrenMap.get(taskId);
                        const task = taskMap.get(taskId);
                        if (!childrenIds || childrenIds.length === 0) return task.progress;
                        
                        const childrenProgress = childrenIds.map(childId => calculateTaskProgress(childId));
                        const totalProgress = childrenProgress.reduce((sum, prog) => sum + prog, 0);
                        const averageProgress = Math.round(totalProgress / childrenIds.length);
                        
                        task.progress = averageProgress;
                        if (averageProgress === 100) task.status = 'Conclu√≠da';
                        else if (averageProgress > 0) task.status = 'Em Andamento';
                        else task.status = 'N√£o Iniciada';

                        return averageProgress;
                    };
                    tasks.filter(t => t.parentId === null).forEach(t => calculateTaskProgress(t.id));
                });
            },
            getProjectProgress: (tasks) => {
                if (!tasks || tasks.length === 0) return 0;
                const topLevelTasks = tasks.filter(t => t.parentId === null);
                if (topLevelTasks.length === 0) return 0;
                const totalProgress = topLevelTasks.reduce((sum, task) => sum + task.progress, 0);
                return Math.round(totalProgress / topLevelTasks.length);
            }
        };

        // App Controller
        const App = {
            async init() {
                document.getElementById('loader').style.display = 'flex';
                await dataService.initFirebase(); 
                uiService.initTheme();
                this.bindEvents();
            },
            
            async logout() {
                document.getElementById('loader').style.display = 'flex';
                await signOut(auth);
                document.getElementById('loader').style.display = 'none';
                uiService.showToast('Sess√£o encerrada com sucesso.', 'success');
            },

            showProjectView() {
                dataService.currentProjectId = null;
                uiService.showView('project-view');
                uiService.renderProjectList(dataService.projects);
                uiService.updateMainDashboard(dataService.projects);
            },
            
            openProject(projectId) {
                dataService.currentProjectId = projectId; 
                const project = dataService.getProjectById(dataService.currentProjectId);
                if (project) {
                    uiService.showView('dashboard-view');
                    uiService.renderProjectDashboard(project);
                }
            },

            bindEvents() {
                document.getElementById('theme-toggle').addEventListener('click', () => uiService.toggleTheme());
                document.getElementById('logout-btn').addEventListener('click', () => App.logout());
                document.getElementById('user-management-btn').addEventListener('click', () => uiService.openUserManagementModal());

                // --- AUTENTICA√á√ÉO ---
                const authForm = document.getElementById('auth-form');
                const authEmail = document.getElementById('auth-email');
                const authPassword = document.getElementById('auth-password');
                const authSecretCode = document.getElementById('auth-secret-code');
                const authSubmitBtn = document.getElementById('auth-submit-btn');
                const secretCodeContainer = document.getElementById('secret-code-container');
                let isLoginMode = true;

                document.getElementById('toggle-auth-mode').addEventListener('click', (e) => {
                    isLoginMode = !isLoginMode;
                    authSubmitBtn.textContent = isLoginMode ? 'Login' : 'Registrar';
                    e.target.textContent = isLoginMode ? 'Precisa de uma conta? Registrar' : 'J√° tenho conta. Login';
                    secretCodeContainer.classList.add('hidden'); // Esconde o c√≥digo secreto ao alternar
                });
                document.getElementById('toggle-secret-code').addEventListener('click', () => {
                    if (!isLoginMode) { // S√≥ permite ver o campo no modo Registro
                         secretCodeContainer.classList.toggle('hidden');
                    }
                });

                authForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = authEmail.value;
                    const password = authPassword.value;
                    const secretCode = authSecretCode.value;

                    if (!email.endsWith(ALLOWED_DOMAIN)) {
                        uiService.showToast(`E-mail inv√°lido. Use o dom√≠nio ${ALLOWED_DOMAIN}.`, 'error');
                        return;
                    }

                    document.getElementById('loader').style.display = 'flex';
                    try {
                        let userCredential;
                        if (isLoginMode) {
                            userCredential = await signInWithEmailAndPassword(auth, email, password);
                        } else {
                            userCredential = await createUserWithEmailAndPassword(auth, email, password);
                            let role = 'Usuario';
                            if (secretCode === GESTOR_SECRET_CODE) {
                                role = 'Gestor';
                            }
                            await setDoc(doc(db, 'users_data', userCredential.user.uid), {
                                email: email,
                                role: role,
                                appId: appId
                            });
                        }
                    } catch (error) {
                        let errorMessage = error.message;
                        if (error.code === 'auth/email-already-in-use') errorMessage = 'Este e-mail j√° est√° em uso.';
                        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') errorMessage = 'Credenciais inv√°lidas.';
                        if (error.code === 'auth/weak-password') errorMessage = 'A senha deve ter pelo menos 6 caracteres.';
                        uiService.showToast(`Erro de Autentica√ß√£o: ${errorMessage}`, 'error');
                        document.getElementById('loader').style.display = 'none';
                    }
                });
                // --- FIM AUTENTICA√á√ÉO ---
                
                document.getElementById('add-project-btn').addEventListener('click', () => uiService.openModal('project-modal'));
                document.getElementById('project-form').addEventListener('submit', event => {
                    event.preventDefault();
                    const name = document.getElementById('project-name').value.trim();
                    const manager = document.getElementById('project-manager').value.trim() || 'N√£o Definido';
                    
                    if (name) {
                        dataService.addProject({ name, manager });
                        uiService.closeModal('project-modal');
                        uiService.showToast('Projeto criado com sucesso! Sincronizando...', 'success');
                    }
                });
                
                document.getElementById('project-list').addEventListener('click', event => {
                    const deleteBtn = event.target.closest('.delete-project-btn');
                    
                    if (deleteBtn) {
                        event.stopPropagation();
                        const projectId = deleteBtn.dataset.projectId;
                        uiService.showConfirmModal('Excluir este projeto e todas as suas tarefas? Esta a√ß√£o √© permanente.', async () => {
                            document.getElementById('loader').style.display = 'flex';
                            await dataService.deleteProject(projectId);
                            document.getElementById('loader').style.display = 'none';
                            uiService.showToast('Projeto exclu√≠do. Sincronizando...', 'error');
                        });
                        return; 
                    }
                    
                    const card = event.target.closest('.project-card-link');
                    if (card) {
                        this.openProject(card.dataset.projectId);
                    }
                });
                
                document.getElementById('back-to-projects-btn').addEventListener('click', () => this.showProjectView());
                document.getElementById('add-task-btn').addEventListener('click', () => uiService.openTaskModal('add'));
                
                document.getElementById('task-form').addEventListener('submit', async event => {
                    event.preventDefault();
                    const taskData = uiService.getTaskFormData();
                    
                    if (new Date(taskData.newStartDate) > new Date(taskData.newEndDate)) {
                        uiService.showToast('Data de In√≠cio n√£o pode ser posterior √† Data de T√©rmino!', 'error');
                        return;
                    }
                    
                    document.getElementById('loader').style.display = 'flex';
                    await dataService.saveTask(taskData); 
                    document.getElementById('loader').style.display = 'none';

                    uiService.closeModal('task-modal');
                    uiService.showToast('Tarefa salva! Sincronizando...');
                });

                document.getElementById('add-comment-btn').addEventListener('click', () => {
                    const input = document.getElementById('new-comment-input');
                    const text = input.value.trim();
                    if(text) {
                        uiService.addComment(text);
                        input.value = '';
                    }
                });
                
                document.getElementById('new-comment-input').addEventListener('keypress', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault(); 
                        document.getElementById('add-comment-btn').click(); 
                    }
                });


                document.getElementById('task-table-body').addEventListener('click', event => {
                    const button = event.target.closest('button');
                    const taskNameEl = event.target.closest('.task-edit-trigger');

                    if (taskNameEl) {
                        const taskId = parseInt(taskNameEl.dataset.taskId);
                        uiService.openTaskModal('edit', { taskId });
                        return;
                    }

                    if (!button) return;
                    const taskId = parseInt(button.dataset.taskId); 
                    const parentId = parseInt(button.dataset.parentId);
                    
                    if (button.classList.contains('add-subtask-btn')) uiService.openTaskModal('add', { parentId });
                    if (button.classList.contains('edit-task-btn')) uiService.openTaskModal('edit', { taskId });
                    
                    if (button.classList.contains('delete-task-btn')) {
                        uiService.showConfirmModal('Excluir esta tarefa e suas subtarefas?', async () => {
                            document.getElementById('loader').style.display = 'flex';
                            await dataService.deleteTask(taskId);
                            document.getElementById('loader').style.display = 'none';
                            uiService.showToast('Tarefa exclu√≠da. Sincronizando...', 'error');
                        });
                    }
                });

                document.getElementById('task-filter-input').addEventListener('input', (e) => {
                    uiService.renderProjectDashboard(dataService.getCurrentProject(), e.target.value);
                });

                document.getElementById('view-switcher').addEventListener('change', (e) => uiService.switchView(e.target.value));
                document.getElementById('export-excel-btn').addEventListener('click', () => reportService.exportExcel(dataService.getCurrentProject()));
                document.getElementById('generate-pdf-report-btn').addEventListener('click', () => reportService.generatePdf(dataService.getCurrentProject()));
                document.getElementById('print-view-btn').addEventListener('click', () => window.print());
                document.getElementById('download-template-btn').addEventListener('click', () => reportService.downloadExcelTemplate());
                document.getElementById('import-excel-btn').addEventListener('click', () => document.getElementById('import-excel-input').click());
                document.getElementById('import-excel-input').addEventListener('change', async (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        document.getElementById('loader').style.display = 'flex';
                        try {
                            await dataService.importTasksFromExcel(file); 
                            uiService.showToast('Tarefas importadas com sucesso! Sincronizando...');
                        } catch (error) {
                            console.error(error);
                            uiService.showToast('Erro ao importar o arquivo. Verifique o console.', 'error');
                        } finally {
                            document.getElementById('loader').style.display = 'none';
                            event.target.value = ''; 
                        }
                    }
                });
                document.querySelectorAll('.cancel-btn').forEach(btn => btn.addEventListener('click', () => uiService.closeAllModals()));
            }
        };

        // UI Service - Manages all DOM interactions
        const uiService = {
            mainDashboardCharts: {},

            // --- AUTH UI ---
            updateUserRoleDisplay: () => {
                const roleEl = document.getElementById('user-role-display');
                const btn = document.getElementById('user-management-btn');
                
                if (dataService.userRole) {
                    roleEl.textContent = `Papel: ${dataService.userRole}`;
                    roleEl.classList.remove('bg-blue-100', 'dark:bg-blue-900', 'text-blue-700', 'dark:text-blue-300', 'bg-green-100', 'dark:bg-green-900', 'text-green-700', 'dark:text-green-300');
                    
                    if (dataService.userRole === 'Gestor') {
                        roleEl.classList.add('bg-green-100', 'dark:bg-green-900', 'text-green-700', 'dark:text-green-300');
                        btn.classList.remove('hidden');
                    } else {
                         roleEl.classList.add('bg-blue-100', 'dark:bg-blue-900', 'text-blue-700', 'dark:text-blue-300');
                         btn.classList.add('hidden');
                    }
                }
            },
            
            // --- USER MANAGEMENT UI (Gestor) ---
            openUserManagementModal: () => {
                if (dataService.userRole !== 'Gestor') {
                    uiService.showToast('Acesso negado: Apenas Gestores podem gerir utilizadores.', 'error');
                    return;
                }
                uiService.renderUserManagementTable();
                uiService.openModal('user-management-modal');
            },
            
            renderUserManagementTable: () => {
                const tbody = document.getElementById('user-management-table-body');
                tbody.innerHTML = '';

                dataService.users.forEach(user => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-[var(--border-color)]';
                    
                    const roleOptions = ['Usuario', 'Gestor'].map(role => 
                        `<option value="${role}" ${user.role === role ? 'selected' : ''}>${role}</option>`
                    ).join('');

                    // Desabilita a edi√ß√£o do pr√≥prio papel
                    const isSelf = user.id === dataService.userId;
                    const isDisabled = isSelf ? 'disabled' : '';

                    row.innerHTML = `
                        <td class="p-3 text-xs font-mono">${user.id.substring(0, 8)}...</td>
                        <td class="p-3 font-medium">${user.email}</td>
                        <td class="p-3">
                            <select data-user-id="${user.id}" class="user-role-select border border-[var(--border-color)] rounded-md p-1 bg-[var(--card-bg)] text-gray-800 dark:text-gray-200" ${isDisabled}>
                                ${roleOptions}
                            </select>
                        </td>
                        <td class="p-3 text-center">
                            <button data-user-id="${user.id}" class="save-role-btn bg-blue-500 text-white px-3 py-1 rounded-md text-xs hover:bg-blue-600 ${isDisabled ? 'opacity-50 cursor-not-allowed' : ''}" ${isDisabled}>Salvar</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                tbody.querySelectorAll('.save-role-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const uid = btn.dataset.userId;
                        const selectEl = tbody.querySelector(`select[data-user-id="${uid}"]`);
                        const newRole = selectEl.value;
                        
                        document.getElementById('loader').style.display = 'flex';
                        await dataService.updateUserRole(uid, newRole);
                        document.getElementById('loader').style.display = 'none';
                    });
                });
            },

            // --- TASK UI HELPERS ---
            populateAssignedUsersSelect: () => {
                const selectEl = document.getElementById('assigned-users-select');
                selectEl.innerHTML = '';
                
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = "Selecione usu√°rios...";
                selectEl.appendChild(defaultOption);

                dataService.users.filter(u => u.email).forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.email.split('@')[0]} (${user.role})`;
                    selectEl.appendChild(option);
                });
            },

            // --- VIEW/MODAL MANAGEMENT ---
            showView(viewId) {
                document.getElementById('project-view').classList.add('hidden');
                document.getElementById('dashboard-view').classList.add('hidden');
                document.getElementById(viewId).classList.remove('hidden');
            },
            switchView(viewName) {
                document.getElementById('table-view').classList.toggle('hidden', viewName === 'gantt');
                document.getElementById('gantt-view').classList.toggle('hidden', viewName === 'table');
                if (viewName === 'gantt') this.renderGanttChart(dataService.getCurrentProject().tasks, document.getElementById('task-filter-input').value);
            },
            renderProjectDashboard(project, filter = '') {
                const filteredTasks = project.tasks.filter(t => 
                    t.name.toLowerCase().includes(filter.toLowerCase()) || 
                    (t.assignedUsers && t.assignedUsers.some(uid => {
                        const user = dataService.users.find(u => u.id === uid);
                        return user && user.email.toLowerCase().includes(filter.toLowerCase());
                    }))
                );

                document.getElementById('project-title').textContent = project.name;
                this.renderTaskTable(filteredTasks);
                this.updateKpis(project.tasks); 
                this.renderAssigneeSummary(project.tasks);
                if (document.getElementById('view-switcher').value === 'gantt') {
                    this.renderGanttChart(filteredTasks);
                }
            },

            openModal(modalId) { 
                const modal = document.getElementById(modalId);
                modal.classList.remove('modal-hidden');
                modal.classList.add('modal-visible');
            },
            closeModal(modalId) {
                const modal = document.getElementById(modalId);
                modal.classList.remove('modal-visible');
                modal.classList.add('modal-hidden');
            },
            closeAllModals() {
                document.querySelectorAll('.modal-transition').forEach(modal => this.closeModal(modal.id));
            },
            openTaskModal(mode, data = {}) {
                document.getElementById('task-form').reset();
                this.populateAssignedUsersSelect(); 
                
                const { parentId, taskId } = data;
                const project = dataService.getCurrentProject();
                const task = taskId ? project.tasks.find(t => t.id === taskId) : {};
                const isParent = taskId ? project.tasks.some(t => t.parentId === taskId) : false;
                
                const assignedUsersSelect = document.getElementById('assigned-users-select');
                assignedUsersSelect.value = null; 

                if (mode === 'edit') {
                    const assignedUsers = task.assignedUsers || [];
                    Array.from(assignedUsersSelect.options).forEach(option => {
                        option.selected = assignedUsers.includes(option.value);
                    });
                }
                
                const startDateInput = document.getElementById('start-date');
                const endDateInput = document.getElementById('end-date');
                const rescheduleBtnContainer = document.getElementById('reschedule-button-container');
                const dateHistoryContainer = document.getElementById('date-history-container');
                const dateHistoryList = document.getElementById('date-history-list');

                document.getElementById('progress-info').classList.toggle('hidden', !isParent);
                document.getElementById('task-progress').disabled = isParent;

                document.getElementById('modal-title').textContent = mode === 'add' ? 'Adicionar Tarefa' : 'Editar Tarefa';
                document.getElementById('task-id').value = task.id || '';
                document.getElementById('parent-id').value = parentId || (task ? task.parentId : '') || '';
                document.getElementById('task-name').value = task.name || '';
                document.getElementById('task-priority').value = task.priority || 'M√©dia';
                document.getElementById('task-status').value = task.status || 'N√£o Iniciada';
                document.getElementById('task-progress').value = task.progress || 0;
                document.getElementById('task-risk').checked = task.risk || false;
                
                const dependencySelect = document.getElementById('task-dependency');
                dependencySelect.innerHTML = '<option value="">Nenhuma</option>';
                project?.tasks.forEach(t => {
                    if (t.id !== task.id) { 
                        const option = document.createElement('option');
                        option.value = t.id;
                        option.textContent = t.name;
                        dependencySelect.appendChild(option);
                    }
                });
                dependencySelect.value = task.dependsOn || '';

                this.renderComments(task.comments || []);
                document.getElementById('new-comment-input').value = '';

                if (mode === 'edit') {
                    const latestDates = dataService.getLatestDates(task);
                    startDateInput.value = latestDates.startDate;
                    endDateInput.value = latestDates.endDate;
                    startDateInput.disabled = true;
                    endDateInput.disabled = true;
                    rescheduleBtnContainer.classList.remove('hidden');
                    dateHistoryContainer.classList.remove('hidden');
                    
                    dateHistoryList.innerHTML = (task.dateHistory || []).map((d, i) => 
                        `<p>${i + 1}: ${new Date(d.startDate+'T00:00:00').toLocaleDateString('pt-BR')} - ${new Date(d.endDate+'T00:00:00').toLocaleDateString('pt-BR')}</p>`
                    ).join('');
                    
                    const rescheduleHandler = () => {
                        startDateInput.disabled = false;
                        endDateInput.disabled = false;
                        document.getElementById('reschedule-btn').classList.add('hidden');
                    };

                    document.getElementById('reschedule-btn').classList.remove('hidden');
                    document.getElementById('reschedule-btn').onclick = rescheduleHandler;

                } else { 
                    startDateInput.disabled = false;
                    endDateInput.disabled = false;
                    startDateInput.value = '';
                    endDateInput.value = '';
                    rescheduleBtnContainer.classList.add('hidden');
                    dateHistoryContainer.classList.add('hidden');
                }
                
                this.openModal('task-modal');
            },
            getTaskFormData() {
                const startDateInput = document.getElementById('start-date');
                const endDateInput = document.getElementById('end-date');
                const assignedUsersSelect = document.getElementById('assigned-users-select');
                
                const commentsList = document.getElementById('comments-list');
                const comments = Array.from(commentsList.querySelectorAll('p')).map(p => ({
                    text: p.dataset.text, 
                    timestamp: p.dataset.timestamp
                }));

                const selectedUsers = Array.from(assignedUsersSelect.options)
                                         .filter(option => option.selected)
                                         .map(option => option.value)
                                         .filter(uid => uid); 

                const data = {
                    id: document.getElementById('task-id').value ? parseInt(document.getElementById('task-id').value) : null,
                    parentId: document.getElementById('parent-id').value ? parseInt(document.getElementById('parent-id').value) : null,
                    name: document.getElementById('task-name').value, 
                    assignedUsers: selectedUsers, 
                    priority: document.getElementById('task-priority').value, 
                    status: document.getElementById('task-status').value,
                    progress: parseInt(document.getElementById('task-progress').value), 
                    risk: document.getElementById('task-risk').checked,
                    dependsOn: document.getElementById('task-dependency').value ? parseInt(document.getElementById('task-dependency').value) : null,
                    comments: comments,
                    newStartDate: startDateInput.value,
                    newEndDate: endDateInput.value,
                };
                return data;
            },
            
            showConfirmModal(body, onConfirm) {
                document.getElementById('confirm-modal-body').textContent = body;
                this.openModal('confirm-modal');
                const confirmBtn = document.getElementById('confirm-ok-btn');
                const cancelBtn = document.getElementById('confirm-cancel-btn');
                
                const newConfirmBtn = confirmBtn.cloneNode(true);
                const newCancelBtn = cancelBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                
                newConfirmBtn.addEventListener('click', () => { onConfirm(); this.closeModal('confirm-modal'); });
                newCancelBtn.addEventListener('click', () => { this.closeModal('confirm-modal'); });
            },
            
            renderComments(comments) {
                const listEl = document.getElementById('comments-list');
                listEl.innerHTML = '';
                comments.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(comment => {
                    const p = document.createElement('p');
                    p.className = "border-b border-[var(--border-color)] pb-1 mb-1 text-xs last:border-b-0";
                    const dateString = new Date(comment.timestamp).toLocaleDateString('pt-BR');
                    const timeString = new Date(comment.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    p.innerHTML = `<span class="font-semibold text-gray-500">${dateString} ${timeString}:</span> ${comment.text}`;
                    p.dataset.timestamp = comment.timestamp;
                    p.dataset.text = comment.text; 
                    listEl.appendChild(p);
                });
            },
            addComment(text) {
                const listEl = document.getElementById('comments-list');
                const p = document.createElement('p');
                const timestamp = new Date().toISOString();
                p.className = "border-b border-[var(--border-color)] pb-1 mb-1 text-xs last:border-b-0";
                const dateString = new Date(timestamp).toLocaleDateString('pt-BR');
                const timeString = new Date(timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                p.innerHTML = `<span class="font-semibold text-gray-500">${dateString} ${timeString}:</span> ${text}`;
                p.dataset.timestamp = timestamp;
                p.dataset.text = text; 
                listEl.prepend(p); 
            },

            showToast(message, type = 'success') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                const colors = { success: 'bg-green-600', error: 'bg-red-600' };
                toast.className = `toast text-white ${colors[type]}`;
                toast.innerHTML = `<p>${message}</p>`;
                container.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 3000);
            },
            
            initTheme() {
                const theme = localStorage.getItem('theme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (theme === 'dark' || (!theme && prefersDark)) {
                    document.documentElement.classList.add('dark');
                }
                this.updateThemeIcons();
            },
            toggleTheme() {
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
                this.updateThemeIcons();
                this.updateMainDashboard(dataService.projects);
                if (document.getElementById('view-switcher').value === 'gantt' && dataService.currentProjectId) {
                    this.renderGanttChart(dataService.getCurrentProject().tasks, document.getElementById('task-filter-input').value);
                }
            },
            updateThemeIcons() {
                const isDark = document.documentElement.classList.contains('dark');
                document.getElementById('theme-icon-sun').style.display = isDark ? 'block' : 'none';
                document.getElementById('theme-icon-moon').style.display = isDark ? 'none' : 'block';
            },

            updateKpis: function(tasks) {
                const kpiDashboard = document.getElementById('kpi-dashboard');
                const overallProgress = dataService.getProjectProgress(tasks);
                const kpis = [
                    { label: 'Progresso Geral', value: `${overallProgress}%` },
                    { label: 'Total de Tarefas', value: tasks.length },
                    { label: 'Conclu√≠das', value: tasks.filter(t => t.status === 'Conclu√≠da').length },
                    { label: 'Atrasadas', value: tasks.filter(t => reportService.getTaskStatusClass(t.status, dataService.getLatestDates(t).endDate).name === 'Atrasada').length },
                    { label: 'Em Risco', value: tasks.filter(t => t.risk).length },
                ];
                kpiDashboard.innerHTML = kpis.map(kpi => `
                    <div class="bg-[var(--card-bg)] p-4 rounded-lg shadow-md flex items-center gap-4 border border-[var(--border-color)]">
                        <div> <div class="text-3xl font-bold">${kpi.value}</div> <div class="text-sm text-gray-400">${kpi.label}</div> </div>
                    </div>`).join('');
            },
            renderAssigneeSummary(tasks) {
                const summaryContainer = document.getElementById('assignee-summary-list');
                const uidToEmail = new Map(dataService.users.map(u => [u.id, u.email.split('@')[0]]));

                const summary = tasks.reduce((acc, task) => {
                    (task.assignedUsers || []).forEach(uid => {
                        const userIdentifier = uidToEmail.get(uid) || `UID: ${uid.substring(0, 4)}`;
                        if (!acc[userIdentifier]) acc[userIdentifier] = 0;
                        acc[userIdentifier]++;
                    });
                    return acc;
                }, {});

                summaryContainer.innerHTML = Object.entries(summary).map(([name, count]) => `
                    <div class="flex justify-between items-center">
                        <span>${name}</span>
                        <span class="font-bold bg-gray-200 dark:bg-gray-700 text-xs px-2 py-1 rounded-full">${count}</span>
                    </div>
                `).join('');
            },
            updateMainDashboard(projects) { 
                const mainDashboard = document.getElementById('main-dashboard');
                
                let inProgressCount = 0, overdueCount = 0, atRiskCount = 0;
                const totalProjects = projects.length;

                projects.forEach(project => {
                    const progress = dataService.getProjectProgress(project.tasks);
                    if (progress > 0 && progress < 100) inProgressCount++;
                    if (project.tasks.some(t => reportService.getTaskStatusClass(t.status, dataService.getLatestDates(t).endDate).name === 'Atrasada')) overdueCount++;
                    if (project.tasks.some(t => t.risk)) atRiskCount++;
                });
                
                const icons = {
                    total: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>`,
                    inProgress: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
                    overdue: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
                    atRisk: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>`
                };
                
                mainDashboard.innerHTML = `
                    <div class="bg-blue-100 dark:bg-blue-900/50 p-5 rounded-lg shadow-md flex items-center gap-5 border border-blue-200 dark:border-blue-800">
                        <div class="bg-blue-500 p-3 rounded-full">${icons.total}</div>
                        <div>
                            <div class="text-3xl font-bold text-blue-700 dark:text-blue-300">${totalProjects}</div>
                            <div class="text-sm text-blue-600 dark:text-blue-400">Total de Projetos</div>
                        </div>
                    </div>
                    <div class="bg-yellow-100 dark:bg-yellow-900/50 p-5 rounded-lg shadow-md flex items-center gap-5 border border-yellow-200 dark:border-yellow-800">
                        <div class="bg-yellow-500 p-3 rounded-full">${icons.inProgress}</div>
                        <div>
                            <div class="text-3xl font-bold text-yellow-700 dark:text-yellow-300">${inProgressCount}</div>
                            <div class="text-sm text-yellow-600 dark:text-yellow-400">Em Andamento</div>
                        </div>
                    </div>
                    <div class="bg-red-100 dark:bg-red-900/50 p-5 rounded-lg shadow-md flex items-center gap-5 border border-red-200 dark:border-red-800">
                        <div class="bg-red-500 p-3 rounded-full">${icons.overdue}</div>
                        <div>
                            <div class="text-3xl font-bold text-red-700 dark:text-red-300">${overdueCount}</div>
                            <div class="text-sm text-red-600 dark:text-red-400">Projetos Atrasados</div>
                        </div>
                    </div>
                    <div class="bg-orange-100 dark:bg-orange-900/50 p-5 rounded-lg shadow-md flex items-center gap-5 border border-orange-200 dark:border-orange-800">
                        <div class="bg-orange-500 p-3 rounded-full">${icons.atRisk}</div>
                        <div>
                            <div class="text-3xl font-bold text-orange-700 dark:text-orange-300">${atRiskCount}</div>
                            <div class="text-sm text-orange-600 dark:text-orange-400">Projetos em Risco</div>
                        </div>
                    </div>
                `;
            },

            // FUN√á√ïES ADICIONADAS PARA CORRIGIR OS ERROS
            renderProjectList: function(projects) {
                const projectListContainer = document.getElementById('project-list');
                
                if (!projects || projects.length === 0) {
                    projectListContainer.innerHTML = `
                        <div class="col-span-full text-center py-8">
                            <p class="text-gray-400">Nenhum projeto encontrado.</p>
                            <p class="text-sm text-gray-500 mt-2">Crie seu primeiro projeto clicando no bot√£o acima.</p>
                        </div>
                    `;
                    return;
                }

                projectListContainer.innerHTML = projects.map(project => {
                    const progress = dataService.getProjectProgress(project.tasks);
                    const statusInfo = reportService.getTaskStatusClass(
                        progress === 100 ? 'Conclu√≠da' : progress > 0 ? 'Em Andamento' : 'N√£o Iniciada', 
                        ''
                    );
                    
                    const canDelete = dataService.userRole === 'Gestor' || project.creatorId === dataService.userId;
                    
                    return `
                        <div class="project-card-link bg-[var(--card-bg)] rounded-lg shadow-md p-6 border border-[var(--border-color)] hover:shadow-lg transition-shadow cursor-pointer" data-project-id="${project.id}">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-xl font-semibold text-[var(--text-color)]">${project.name}</h3>
                                ${canDelete ? `
                                    <button class="delete-project-btn text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 dark:hover:bg-red-900 transition-colors" data-project-id="${project.id}" title="Excluir projeto">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                ` : ''}
                            </div>
                            
                            <div class="mb-4">
                                <div class="flex justify-between text-sm text-gray-400 mb-1">
                                    <span>Progresso</span>
                                    <span>${progress}%</span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: ${progress}%"></div>
                                </div>
                            </div>
                            
                            <div class="flex justify-between items-center text-sm">
                                <div class="flex items-center gap-4">
                                    <span class="px-2 py-1 rounded-full text-xs ${statusInfo.badge}">
                                        ${progress === 100 ? 'Conclu√≠do' : progress > 0 ? 'Em Andamento' : 'N√£o Iniciado'}
                                    </span>
                                    <span class="text-gray-400">${project.tasks?.length || 0} tarefas</span>
                                </div>
                                <div class="text-gray-400 text-xs">
                                    Respons√°vel: ${project.manager || 'N√£o definido'}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            renderTaskTable: function(tasks) {
                const tableBody = document.getElementById('task-table-body');
                
                if (!tasks || tasks.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="p-4 text-center text-gray-400">
                                Nenhuma tarefa encontrada. Clique em "Nova Tarefa" para come√ßar.
                            </td>
                        </tr>
                    `;
                    return;
                }

                const processTasksForTable = (parentId, level) => {
                    let html = '';
                    const childTasks = tasks
                        .filter(t => t.parentId === parentId)
                        .sort((a, b) => {
                            const dateA = new Date(dataService.getLatestDates(a).startDate);
                            const dateB = new Date(dataService.getLatestDates(b).startDate);
                            return dateA - dateB;
                        });

                    childTasks.forEach(task => {
                        const latestDates = dataService.getLatestDates(task);
                        const duration = reportService.calculateDuration(latestDates.startDate, latestDates.endDate);
                        const statusInfo = reportService.getTaskStatusClass(task.status, latestDates.endDate);
                        const isParent = tasks.some(t => t.parentId === task.id);
                        
                        const assignedUsersText = (task.assignedUsers || [])
                            .map(uid => {
                                const user = dataService.users.find(u => u.id === uid);
                                return user ? user.email.split('@')[0] : `UID:${uid.substring(0,4)}`;
                            })
                            .join(', ');

                        const commentsPreview = (task.comments || [])
                            .slice(0, 2)
                            .map(c => c.text.substring(0, 30) + (c.text.length > 30 ? '...' : ''))
                            .join('; ');

                        html += `
                            <tr class="border-b border-[var(--border-color)] hover:bg-gray-100 dark:hover:bg-gray-700">
                                <td class="p-3">
                                    <div style="padding-left: ${level * 20}px" class="flex items-center gap-2">
                                        ${isParent ? '<span class="text-blue-500">üìÅ</span>' : '<span class="text-gray-400">üìÑ</span>'}
                                        <span class="task-edit-trigger cursor-pointer hover:text-blue-500 hover:underline" data-task-id="${task.id}">
                                            ${task.name}
                                        </span>
                                        ${task.risk ? '<span class="text-red-500 text-xs" title="Tarefa em risco">‚ö†Ô∏è</span>' : ''}
                                    </div>
                                </td>
                                <td class="p-3">${duration}</td>
                                <td class="p-3">${new Date(latestDates.startDate + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                                <td class="p-3">${new Date(latestDates.endDate + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                                <td class="p-3">
                                    <span class="px-2 py-1 rounded-full text-xs ${statusInfo.badge}">
                                        ${statusInfo.name}
                                    </span>
                                </td>
                                <td class="p-3 text-xs text-gray-500 max-w-xs truncate" title="${commentsPreview}">
                                    ${commentsPreview || '-'}
                                </td>
                                <td class="p-3 text-center no-print">
                                    <div class="flex justify-center gap-1">
                                        <button class="add-subtask-btn bg-green-500 text-white p-1 rounded hover:bg-green-600" 
                                                data-task-id="${task.id}" data-parent-id="${task.id}" title="Adicionar subtarefa">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                                            </svg>
                                        </button>
                                        <button class="edit-task-btn bg-blue-500 text-white p-1 rounded hover:bg-blue-600" 
                                                data-task-id="${task.id}" title="Editar tarefa">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                            </svg>
                                        </button>
                                        <button class="delete-task-btn bg-red-500 text-white p-1 rounded hover:bg-red-600" 
                                                data-task-id="${task.id}" title="Excluir tarefa">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 000-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                        
                        // Processar subtarefas recursivamente
                        html += processTasksForTable(task.id, level + 1);
                    });
                    
                    return html;
                };

                tableBody.innerHTML = processTasksForTable(null, 0);
            },

            renderGanttChart: function(tasks) {
                const ganttView = document.getElementById('gantt-view');
                if (!tasks || tasks.length === 0 || ganttView.classList.contains('hidden')) return;

                const taskNamesContainer = document.getElementById('gantt-task-names');
                const timelineBody = document.getElementById('gantt-timeline-body');
                const ganttHeader = document.getElementById('gantt-header');
                const dependencyLines = document.getElementById('gantt-dependency-lines');
                taskNamesContainer.innerHTML = ''; timelineBody.innerHTML = ''; ganttHeader.innerHTML = ''; dependencyLines.innerHTML = '';

                const allDates = tasks.flatMap(t => t.dateHistory.flatMap(d => [new Date(d.startDate), new Date(d.endDate)]))
                                        .filter(d => !isNaN(d.getTime()));
                if (allDates.length === 0) return;

                let minDate = new Date(Math.min.apply(null, allDates));
                let maxDate = new Date(Math.max.apply(null, allDates));
                minDate.setDate(minDate.getDate() - 2); maxDate.setDate(maxDate.getDate() + 2);

                const totalDays = reportService.calculateDuration(minDate.toISOString().split('T')[0], maxDate.toISOString().split('T')[0]);
                if (totalDays <= 0) return;
                const dayWidth = 40; 
                
                timelineBody.style.width = `${totalDays * dayWidth}px`;
                ganttHeader.style.width = `${totalDays * dayWidth}px`;
                
                let currentDate = new Date(minDate);
                ganttHeader.style.display = 'flex';
                for (let i = 1; i <= totalDays; i++) {
                    const dayCell = document.createElement('div');
                    const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
                    dayCell.className = `text-center text-xs p-1 border-r border-b border-[var(--border-color)] shrink-0 ${isWeekend ? 'bg-gray-300 dark:bg-gray-800 font-semibold' : ''}`;
                    dayCell.style.width = `${dayWidth}px`;
                    dayCell.textContent = `${currentDate.getDate()}/${currentDate.getMonth()+1}`;
                    ganttHeader.appendChild(dayCell);
                    currentDate.setDate(currentDate.getDate() + 1);
                }

                let taskOrder = [];
                const processGanttTasks = (parentId, level) => {
                    tasks.filter(t => t.parentId === parentId).sort((a,b) => {
                        const dateA = new Date(dataService.getLatestDates(a).startDate);
                        const dateB = new Date(dataService.getLatestDates(b).startDate);
                        return dateA - dateB;
                    }).forEach(task => { taskOrder.push({ ...task, level }); processGanttTasks(task.id, level + 1); });
                };
                processGanttTasks(null, 0);
                
                const taskPositions = new Map();
                taskOrder.forEach((task, index) => {
                    const isParent = tasks.some(t => t.parentId === task.id);
                    const nameDiv = document.createElement('div');
                    nameDiv.className = `gantt-task-name h-10 flex items-center border-b border-[var(--border-color)] p-2 ${isParent ? 'font-bold' : ''}`;
                    nameDiv.style.paddingLeft = `${task.level * 15 + 8}px`;
                    nameDiv.textContent = task.name;
                    taskNamesContainer.appendChild(nameDiv);

                    const latestDates = dataService.getLatestDates(task);
                    const startDate = new Date(latestDates.startDate + 'T00:00:00');
                    const endDate = new Date(latestDates.endDate + 'T00:00:00');
                    if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) { return; }

                    const duration = reportService.calculateDuration(latestDates.startDate, latestDates.endDate);
                    const startDay = reportService.calculateDuration(minDate.toISOString().split('T')[0], latestDates.startDate);
                    const bar = document.createElement('div');
                    const statusInfo = reportService.getTaskStatusClass(task.status, latestDates.endDate);
                    
                    let barColor;
                    if (isParent) { barColor = 'bg-gray-500 dark:bg-gray-600'; 
                    } else if (statusInfo.name === 'Atrasada') { barColor = 'bg-red-500';
                    } else if (statusInfo.name === 'Conclu√≠da') { barColor = 'bg-green-500';
                    } else { barColor = 'bg-blue-500'; }

                    bar.className = `gantt-bar ${isParent ? 'gantt-bar-parent' : ''} ${barColor}`;
                    bar.style.left = `${(startDay - 1) * dayWidth}px`;
                    bar.style.width = `${duration * dayWidth}px`;
                    bar.style.top = `${index * 40}px`;
                    bar.title = `${task.name}\nProgresso: ${task.progress}%\nIn√≠cio: ${startDate.toLocaleDateString('pt-BR')}\nT√©rmino: ${endDate.toLocaleDateString('pt-BR')}`;
                    
                    if (!isParent) {
                        const progressOverlay = document.createElement('div');
                        progressOverlay.style.width = `${task.progress}%`;
                        progressOverlay.style.height = '100%';
                        progressOverlay.className = `absolute top-0 left-0 bg-opacity-70 ${barColor}`;
                        progressOverlay.style.backgroundColor = barColor.replace('bg-', 'bg-');
                        const progressText = document.createElement('span');
                        progressText.className = 'absolute inset-0 text-white flex items-center justify-center';
                        progressText.textContent = `${task.progress}%`;
                        
                        bar.innerHTML = '';
                        bar.style.backgroundColor = '#ccc'; 
                        bar.style.color = '#1f2937'; 
                        bar.appendChild(progressOverlay);
                        bar.appendChild(progressText);
                    } else {
                        bar.textContent = task.name;
                        bar.classList.add('text-xs');
                    }

                    timelineBody.appendChild(bar);
                    
                    taskPositions.set(task.id, {
                        x_start: (startDay - 1) * dayWidth,
                        x_end: ((startDay - 1) + duration) * dayWidth,
                        y: (index * 40) + (isParent ? 14 : 20) 
                    });
                });
                
                taskOrder.forEach(task => {
                    if (task.dependsOn && taskPositions.has(task.dependsOn) && taskPositions.has(task.id)) {
                        const fromTask = taskPositions.get(task.dependsOn);
                        const toTask = taskPositions.get(task.id);
                        const line = document.createElementNS("http://www.w3.org/2000/svg", "path");
                        const x1 = fromTask.x_end;
                        const y1 = fromTask.y;
                        const x2 = toTask.x_start;
                        const y2 = toTask.y;
                        const curve = `M ${x1} ${y1} C ${x1 + 25} ${y1} ${x2 - 25} ${y2} ${x2} ${y2}`;
                        
                        line.setAttribute("d", curve);
                        line.setAttribute("stroke", "#6b7280");
                        line.setAttribute("stroke-width", "1.5");
                        line.setAttribute("fill", "none");
                        line.setAttribute("marker-end", "url(#arrow)");
                        dependencyLines.appendChild(line);
                    }
                });
                if (dependencyLines.innerHTML !== '') {
                    const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
                    defs.innerHTML = `<marker id="arrow" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#6b7280" /></marker>`;
                    dependencyLines.prepend(defs); 
                }
            },
        };
        
        // Report Service - Handles PDF, Excel generation and Template
        const reportService = {
            downloadExcelTemplate() {
                const headers = ['Tarefa', 'Dura√ß√£o (dias)', 'Data In√≠cio', 'Data Termino', 'Status', 'Progresso (%)', 'Prioridade', 'Atribu√≠do a (UIDs Separados por V√≠rgula)', 'Risco (Sim/Nao)', 'Tarefa Pai (Nome)'];
                const exampleData = [
                    { 'Tarefa': 'Planejamento Geral', 'Dura√ß√£o (dias)': 5, 'Data In√≠cio': '2025-11-01', 'Data Termino': '2025-11-05', 'Status': 'N√£o Iniciada', 'Progresso (%)': 0, 'Prioridade': 'Alta', 'Atribu√≠do a (UIDs Separados por V√≠rgula)': '', 'Risco (Sim/Nao)': 'Nao', 'Tarefa Pai (Nome)': '' },
                    { 'Tarefa': 'Definir Escopo', 'Dura√ß√£o (dias)': 2, 'Data In√≠cio': '2025-11-01', 'Data Termino': '2025-11-02', 'Status': 'N√£o Iniciada', 'Progresso (%)': 0, 'Prioridade': 'Alta', 'Atribu√≠do a (UIDs Separados por V√≠rgula)': 'UID_EXEMPLO1,UID_EXEMPLO2', 'Risco (Sim/Nao)': 'Nao', 'Tarefa Pai (Nome)': 'Planejamento Geral' }
                ];
                const worksheet = XLSX.utils.json_to_sheet(exampleData, { header: headers });
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Tarefas");
                worksheet['!cols'] = [ { wch: 40 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 40 }, { wch: 15 }, { wch: 40 } ];
                XLSX.writeFile(workbook, "template_importacao.xlsx");
            },
            calculateDuration: (start, end) => {
                if (!start || !end) return 0;
                const diffTime = new Date(end) - new Date(start);
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            },
            getTaskStatusClass: (status, endDate) => {
                const today = new Date(); today.setHours(0,0,0,0);
                const taskEndDate = new Date(endDate + 'T00:00:00');
                if (status !== 'Conclu√≠da' && taskEndDate < today) return { badge: 'bg-red-600 text-white', name: 'Atrasada' };
                switch (status) {
                    case 'Conclu√≠da': return { badge: 'bg-green-600 text-white', name: 'Conclu√≠da' };
                    case 'Em Andamento': return { badge: 'bg-yellow-500 text-black', name: 'Em Andamento' };
                    default: return { badge: 'bg-gray-500 text-white', name: 'N√£o Iniciada' };
                }
            },
            exportExcel: function(project) {
                if (!project) return;
                const dataToExport = [];
                const processTasksForExport = (parentId, level) => {
                    project.tasks.filter(t => t.parentId === parentId)
                        .sort((a,b) => {
                            const dateA = new Date(dataService.getLatestDates(a).startDate);
                            const dateB = new Date(dataService.getLatestDates(b).startDate);
                            return dateA - dateB;
                        })
                        .forEach(task => {
                            const latestDates = dataService.getLatestDates(task);
                            const duration = this.calculateDuration(latestDates.startDate, latestDates.endDate);
                            const statusInfo = this.getTaskStatusClass(task.status, latestDates.endDate);
                            const commentsString = (task.comments || [])
                                .map(c => `${new Date(c.timestamp).toLocaleDateString('pt-BR')}: ${c.text}`)
                                .join(' | ');

                            dataToExport.push({
                                'Tarefa': `${'  '.repeat(level)}${task.name}`, 
                                'Dura√ß√£o (dias)': duration, 
                                'Data de In√≠cio': new Date(latestDates.startDate + 'T00:00:00').toLocaleDateString('pt-BR'), 
                                'Data de T√©rmino': new Date(latestDates.endDate + 'T00:00:00').toLocaleDateString('pt-BR'),
                                'Status': statusInfo.name, 
                                'Coment√°rios': commentsString,
                                'Progresso (%)': task.progress, 
                                'Atribu√≠do a (UIDs)': (task.assignedUsers || []).join(', '), // Exporta UIDs
                                'Prioridade': task.priority,
                                'Em Risco': task.risk ? 'Sim' : 'N√£o'
                            });
                            processTasksForExport(task.id, level + 1);
                        });
                };
                processTasksForExport(null, 0);
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Cronograma");
                worksheet['!cols'] = [ { wch: 40 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 60 }, { wch: 15 }, { wch: 30 }, { wch: 15 }, { wch: 15 } ];
                XLSX.writeFile(workbook, `${project.name.replace(/ /g,"_")}_Relatorio.xlsx`);
            },
            generatePdf: function(project) {
                const loader = document.getElementById('loader');
                loader.style.display = 'flex';
                if (!project) { loader.style.display = 'none'; return; }
                const reportElement = document.createElement('div');
                reportElement.className = 'p-8 bg-white dark:bg-gray-800';
                reportElement.style.width = '1123px'; 
                const titleHeader = document.querySelector('#dashboard-view header').cloneNode(true);
                titleHeader.querySelector('button.no-print')?.remove();
                const kpiDashboardClone = document.getElementById('kpi-dashboard').cloneNode(true);
                const currentViewId = document.getElementById('view-switcher').value === 'table' ? 'table-view' : 'gantt-view';
                const activeViewClone = document.getElementById(currentViewId).cloneNode(true);
                activeViewClone.classList.remove('hidden');
                activeViewClone.style.display = 'block';

                if (currentViewId === 'table-view') {
                    const thead = activeViewClone.querySelector('thead');
                    thead.querySelector('th:last-child')?.remove();
                    activeViewClone.querySelectorAll('tbody td.no-print').forEach(cell => cell.remove());
                }

                const scrollableContent = activeViewClone.querySelector('.overflow-x-auto, .gantt-timeline-container');
                if (scrollableContent) scrollableContent.style.overflow = 'visible';
                
                reportElement.appendChild(titleHeader);
                reportElement.appendChild(kpiDashboardClone);
                reportElement.appendChild(activeViewClone);
                
                reportElement.style.position = 'absolute';
                reportElement.style.left = '-9999px';
                document.body.appendChild(reportElement);

                setTimeout(() => {
                    const opt = { 
                        margin: 10, 
                        filename: `${project.name.replace(/ /g,"_")}_Relatorio.pdf`, 
                        image: { type: 'jpeg', quality: 0.98 }, 
                        html2canvas: { scale: 2, useCORS: true, logging: false, backgroundColor: null }, 
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' } 
                    };
                    html2pdf().from(reportElement).set(opt).save().then(() => {
                        loader.style.display = 'none';
                        document.body.removeChild(reportElement);
                    }).catch(err => {
                        console.error("Erro ao gerar PDF:", err);
                        loader.style.display = 'none';
                        document.body.removeChild(reportElement);
                    });
                }, 300);
            }
        };

        // --- Kick off the app ---
        document.addEventListener('DOMContentLoaded', () => App.init());
        
    </script>
</body>
</html>
